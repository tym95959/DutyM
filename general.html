<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Only - Leave Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .view-only-banner {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: var(--radius);
        }
        
        .phone-request-form {
            background: var(--neutral-50);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--neutral-200);
        }
        
        .staff-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .staff-option {
            padding: 0.75rem;
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .staff-option:hover {
            border-color: var(--primary-500);
            background-color: var(--primary-50);
        }
        
        .staff-option.selected {
            border-color: var(--primary-600);
            background-color: var(--primary-100);
        }
        
        .staff-rc {
            font-weight: 600;
            color: var(--primary-700);
        }
        
        .staff-name {
            font-size: 0.875rem;
            color: var(--neutral-700);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Leave Management System</h1>
                        <p>View Only Access</p>
                    </div>
                </div>
                
                <div class="user-nav">
                    <div class="user-profile">
                        <div class="avatar" id="userAvatar">V</div>
                        <div class="user-details">
                            <span class="user-name" id="userName">Viewer</span>
                            <span class="user-role" id="userRole">View Only</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="app.logout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- View Only Banner -->
            <div class="view-only-banner">
                <h3><i class="fas fa-eye"></i> View Only Access</h3>
                <p>You have view-only access to the system. You can also enter leave requests on behalf of staff via phone.</p>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="view">View Data</button>
                <button class="tab" data-tab="phone">Phone Request Entry</button>
            </div>

            <!-- View Data Tab -->
            <div id="viewTab" class="tab-content active">
                <div class="dashboard-grid">
                    <!-- View Leaves -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Leaves</h3>
                            <select class="form-control form-control-sm" id="viewLeaveType" style="width: auto;">
                                <option value="all">All Types</option>
                                <option value="SL">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        <div class="table-container">
                            <table class="table" id="viewLeavesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Staff</th>
                                        <th>Type</th>
                                        <th>Duty Time</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Leaves will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- View Duty Changes -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Duty Changes</h3>
                        </div>
                        <div class="table-container">
                            <table class="table" id="viewChangesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Time Swap</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Changes will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- View Roster -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Today's Roster</h3>
                            <input type="date" class="form-control form-control-sm" id="viewRosterDate" style="width: auto;">
                        </div>
                        <div class="table-container">
                            <table class="table" id="viewRosterTable">
                                <thead>
                                    <tr>
                                        <th>Staff</th>
                                        <th>Duty Time</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Roster will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phone Request Entry Tab -->
            <div id="phoneTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Phone Request Entry</h3>
                        <p class="text-muted mb-0">Enter leave requests on behalf of staff who call in</p>
                    </div>
                    <div class="card-body">
                        <div class="phone-request-form">
                            <h4 class="mb-3">Select Staff</h4>
                            <div class="staff-selector" id="staffSelector">
                                <!-- Staff options will be populated here -->
                            </div>
                            
                            <div id="selectedStaffInfo" class="mt-4" style="display: none;">
                                <h4 class="mb-3">Enter Leave Request for <span id="selectedStaffName"></span></h4>
                                <form id="phoneRequestForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Leave Type</label>
                                                <select class="form-control" name="leaveType" required>
                                                    <option value="">Select Type</option>
                                                    <option value="SL">Sick Leave (SL)</option>
                                                    <option value="FRL">FRL</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label">Date</label>
                                                <input type="date" class="form-control" name="date" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Reason</label>
                                        <textarea class="form-control" name="reason" rows="3" required placeholder="Reason for leave as provided over phone"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Caller Information</label>
                                        <input type="text" class="form-control" name="callerInfo" placeholder="Caller name/number (optional)">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" name="notes" rows="2" placeholder="Additional notes"></textarea>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" name="urgent" id="urgentCheck">
                                        <label class="form-check-label" for="urgentCheck">
                                            <i class="fas fa-exclamation-triangle text-warning"></i> Mark as Urgent
                                        </label>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="reset" class="btn btn-secondary">Clear</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-phone"></i> Submit Phone Request
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="mb-3">Recent Phone Requests</h4>
                            <div class="table-container">
                                <table class="table" id="phoneRequestsTable">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Staff</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Entered By</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Phone requests will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="users.js"></script>
    <script src="auth.js"></script>
    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
    <script>
        // General User Functions
        class GeneralUserFunctions {
            constructor() {
                this.currentUser = authManager.getCurrentUser();
                this.selectedStaff = null;
                this.init();
            }
            
            async init() {
                // Check if user is general
                if (!authManager.isGeneral()) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Load initial data
                await this.loadViewData();
                
                // Setup event listeners
                this.setupEventListeners();
                
                console.log('General user functions initialized');
            }
            
            async loadViewData() {
                try {
                    const [leaves, changes, roster] = await Promise.all([
                        this.getViewLeaves(),
                        this.getViewChanges(),
                        this.getViewRoster()
                    ]);
                    
                    this.updateLeavesTable(leaves);
                    this.updateChangesTable(changes);
                    this.updateRosterTable(roster);
                    this.loadStaffSelector();
                    
                } catch (error) {
                    console.error('Error loading view data:', error);
                    app.showError('Failed to load data');
                }
            }
            
            async getViewLeaves() {
                const today = new Date().toISOString().split('T')[0];
                const result = await dbHelper.query(
                    Collections.SICK_LEAVES,
                    [
                        { field: 'date', operator: '>=', value: today }
                    ],
                    { field: 'date', direction: 'desc' },
                    20
                );
                
                return result.success ? result.data : [];
            }
            
            async getViewChanges() {
                const result = await dbHelper.query(
                    Collections.DUTY_CHANGES,
                    [],
                    { field: 'createdAt', direction: 'desc' },
                    10
                );
                
                return result.success ? result.data : [];
            }
            
            async getViewRoster(date = null) {
                const viewDate = date || new Date().toISOString().split('T')[0];
                
                const result = await dbHelper.query(
                    Collections.ROSTERS,
                    [
                        { field: 'date', operator: '==', value: viewDate }
                    ],
                    { field: 'dutyTime', direction: 'asc' }
                );
                
                return result.success ? result.data : [];
            }
            
            updateLeavesTable(leaves) {
                const tbody = document.querySelector('#viewLeavesTable tbody');
                if (!tbody) return;
                
                if (leaves.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                No leaves found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = leaves.map(leave => `
                    <tr>
                        <td>${app.formatDate(leave.date)}</td>
                        <td>
                            <div class="font-semibold">${leave.name}</div>
                            <div class="text-muted text-xs">RC ${leave.rcNumber}</div>
                        </td>
                        <td>
                            <span class="badge ${leave.type === 'SL' ? 'badge-warning' : 'badge-success'}">
                                ${leave.type}
                            </span>
                        </td>
                        <td>${leave.dutyTime}</td>
                        <td>${leave.reason}</td>
                    </tr>
                `).join('');
            }
            
            updateChangesTable(changes) {
                const tbody = document.querySelector('#viewChangesTable tbody');
                if (!tbody) return;
                
                if (changes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                No duty changes found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = changes.map(change => `
                    <tr>
                        <td>${app.formatDate(change.changeDate)}</td>
                        <td>
                            <div class="font-semibold">${change.requesterName}</div>
                            <div class="text-muted text-xs">RC ${change.requesterRc}</div>
                        </td>
                        <td>
                            <div class="font-semibold">${change.requestedName}</div>
                            <div class="text-muted text-xs">RC ${change.requestedRc}</div>
                        </td>
                        <td>
                            <div class="text-center">
                                <div class="text-xs">${change.requesterDutyTime} â†” ${change.requestedDutyTime}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-${change.status === 'accepted' ? 'success' : 
                                                      change.status === 'rejected' ? 'danger' : 'warning'}">
                                ${change.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            updateRosterTable(roster) {
                const tbody = document.querySelector('#viewRosterTable tbody');
                if (!tbody) return;
                
                if (roster.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                No roster for selected date
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = roster.map(item => `
                    <tr>
                        <td>
                            <div class="font-semibold">${item.name}</div>
                            <div class="text-muted text-xs">RC ${item.rcNumber}</div>
                        </td>
                        <td><span class="badge badge-primary">${item.dutyTime}</span></td>
                        <td>${item.remarks || '-'}</td>
                    </tr>
                `).join('');
            }
            
            loadStaffSelector() {
                const staffList = authManager.getStaffUsers().filter(staff => 
                    staff.status === 'active'
                );
                
                const selector = document.getElementById('staffSelector');
                if (!selector) return;
                
                selector.innerHTML = staffList.map(staff => `
                    <div class="staff-option" data-rc="${staff.RCNo}">
                        <div class="staff-rc">${staff.RCNo}</div>
                        <div class="staff-name">${staff.name}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.staff-option').forEach(option => {
                    option.addEventListener('click', () => this.selectStaff(option));
                });
            }
            
            selectStaff(option) {
                // Remove previous selection
                document.querySelectorAll('.staff-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selection to clicked option
                option.classList.add('selected');
                
                // Get staff data
                const rcNumber = option.getAttribute('data-rc');
                this.selectedStaff = authManager.getUserByRC(rcNumber);
                
                // Show form
                const staffInfo = document.getElementById('selectedStaffInfo');
                const staffName = document.getElementById('selectedStaffName');
                
                if (this.selectedStaff) {
                    staffName.textContent = `${this.selectedStaff.name} (RC ${this.selectedStaff.RCNo})`;
                    staffInfo.style.display = 'block';
                }
            }
            
            setupEventListeners() {
                // Leave type filter
                const leaveTypeFilter = document.getElementById('viewLeaveType');
                if (leaveTypeFilter) {
                    leaveTypeFilter.addEventListener('change', async () => {
                        const type = leaveTypeFilter.value;
                        let conditions = [];
                        
                        if (type !== 'all') {
                            conditions.push({ field: 'type', operator: '==', value: type });
                        }
                        
                        const result = await dbHelper.query(
                            Collections.SICK_LEAVES,
                            conditions,
                            { field: 'date', direction: 'desc' },
                            20
                        );
                        
                        this.updateLeavesTable(result.success ? result.data : []);
                    });
                }
                
                // Roster date filter
                const rosterDateFilter = document.getElementById('viewRosterDate');
                if (rosterDateFilter) {
                    // Set default to today
                    const today = new Date().toISOString().split('T')[0];
                    rosterDateFilter.value = today;
                    
                    rosterDateFilter.addEventListener('change', async () => {
                        const date = rosterDateFilter.value;
                        const roster = await this.getViewRoster(date);
                        this.updateRosterTable(roster);
                    });
                }
                
                // Phone request form
                const phoneRequestForm = document.getElementById('phoneRequestForm');
                if (phoneRequestForm) {
                    phoneRequestForm.addEventListener('submit', (e) => this.handlePhoneRequest(e));
                }
                
                // Tab switching
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // Update active tab
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Show corresponding content
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `${tabId}Tab`) {
                                content.classList.add('active');
                            }
                        });
                    });
                });
            }
            
            async handlePhoneRequest(e) {
                e.preventDefault();
                
                if (!this.selectedStaff) {
                    app.showError('Please select a staff member first');
                    return;
                }
                
                const form = e.target;
                const formData = new FormData(form);
                const requestData = Object.fromEntries(formData);
                
                // Validation
                if (!requestData.leaveType || !requestData.date || !requestData.reason) {
                    app.showError('Please fill all required fields');
                    return;
                }
                
                try {
                    // Get duty time for the selected date
                    let dutyTime = '';
                    try {
                        const result = await dbHelper.query(
                            Collections.ROSTERS,
                            [
                                { field: 'rcNumber', operator: '==', value: this.selectedStaff.RCNo },
                                { field: 'date', operator: '==', value: requestData.date }
                            ]
                        );
                        
                        if (result.success && result.data.length > 0) {
                            dutyTime = result.data[0].dutyTime;
                        }
                    } catch (error) {
                        console.warn('Could not fetch duty time:', error);
                    }
                    
                    // Create leave request
                    const leaveData = {
                        rcNumber: this.selectedStaff.RCNo,
                        name: this.selectedStaff.name,
                        date: requestData.date,
                        dutyTime: dutyTime,
                        reason: requestData.reason,
                        type: requestData.leaveType,
                        status: 'pending',
                        appliedAt: new Date().toISOString(),
                        enteredBy: this.currentUser.rcNumber,
                        entryMethod: 'phone',
                        callerInfo: requestData.callerInfo,
                        notes: requestData.notes,
                        urgent: requestData.urgent === 'on'
                    };
                    
                    const collection = requestData.leaveType === 'SL' ? 
                        Collections.SICK_LEAVES : Collections.FR_LEAVES;
                    
                    const result = await dbHelper.add(collection, leaveData);
                    
                    if (result.success) {
                        app.showSuccess('Phone request submitted successfully');
                        form.reset();
                        
                        // Reset staff selection
                        document.querySelectorAll('.staff-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        document.getElementById('selectedStaffInfo').style.display = 'none';
                        this.selectedStaff = null;
                        
                        // Refresh tables
                        await this.loadViewData();
                    } else {
                        throw new Error(result.error);
                    }
                    
                } catch (error) {
                    console.error('Error submitting phone request:', error);
                    app.showError('Failed to submit phone request: ' + error.message);
                }
            }
        }
        
        // Initialize general user functions
        const general = new GeneralUserFunctions();
        window.general = general;
        
        // Update app with general user methods
        if (window.app) {
            window.app.updateUserInfo = function() {
                const userNameElement = document.getElementById('userName');
                const userAvatarElement = document.getElementById('userAvatar');
                
                if (userNameElement) {
                    userNameElement.textContent = this.currentUser.name;
                }
                
                if (userAvatarElement) {
                    userAvatarElement.textContent = this.currentUser.name.charAt(0);
                }
            };
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!authManager.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update user info
            if (window.app) {
                app.updateUserInfo();
            }
        });
    </script>
</body>
</html>
