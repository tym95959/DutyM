<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Report ‚Äì Passenger List (Multi-Database)</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your config files -->
    <script src="fireshift.js"></script>
    <script src="Co.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f0e1, #fff5e6);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ===== smaller top ribbon ===== */
        .shift-ribbon {
            background: linear-gradient(135deg, #8b6913, #e6b800);
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(230, 184, 0, 0.25);
            font-size: 0.9rem;
        }
        
        .shift-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .shift-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 14px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .date-value {
            font-weight: 500;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .refresh-shift {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 14px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        /* ===== main card ‚Äì more compact ===== */
        .card {
            background: white;
            border-radius: 20px;
            padding: 18px 22px;
            box-shadow: 0 8px 24px rgba(230, 184, 0, 0.15);
            border: 2px solid #e6b800;
            margin-bottom: 18px;
        }
        
        /* --- REARRANGED: date/flight on left, ops on right --- */
        .selection-flight-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        /* left block: date + flight selects */
        .left-selectors {
            display: flex;
            gap: 16px;
            flex: 2;
            min-width: 360px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }
        
        .form-group label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .form-control {
            padding: 8px 12px;
            border: 2px solid rgba(230, 184, 0, 0.25);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        /* right block: minimal quick info (optional) */
        .quick-shift-box {
            background: #fff9e6;
            border-radius: 30px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: #8b6913;
            border: 1px solid #e6b800;
            white-space: nowrap;
        }
        
        /* Database indicator */
        .database-badge {
            background: #4682b4;
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* flight panel ‚Äî two columns now: left (details + stats) and right (ops + buttons) */
        .flight-panel-revised {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 8px;
        }
        
        .left-details-block {
            background: #fff9e6;
            border-radius: 14px;
            padding: 14px 16px;
            border-left: 4px solid #e6b800;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .info-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 13px;
        }
        
        /* stats inside left block */
        .stats-mini {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: white;
            border-radius: 12px;
            padding: 10px 8px;
            border: 1px solid rgba(230,184,0,0.2);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: #8b6913;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .stat-number {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* right block: ops + buttons (under last pax) */
        .right-ops-block {
            background: white;
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(230, 184, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .ops-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .ops-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .ops-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .edit-field {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .edit-input {
            padding: 4px 8px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 6px;
            font-size: 12px;
            width: 100px;
        }
        
        .edit-btn {
            background: #e6b800;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* action buttons ‚Äì now only CLOSE / REOPEN / PRINT (SAVE ALL removed) */
        .action-buttons-vertical {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
            border-top: 1px dashed rgba(230,184,0,0.3);
            padding-top: 12px;
        }
        
        .close-btn, .reopen-btn, .print-btn {
            padding: 8px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            flex: 1 0 auto;
            min-width: 110px;
            white-space: nowrap;
        }
        
        .close-btn { background: #c68b5e; color: white; }
        .close-btn:disabled { background: #e0c0a8; cursor: not-allowed; opacity: 0.6; }
        .reopen-btn { background: #6b8e23; color: white; }
        .print-btn { background: #4a6fa5; color: white; }
        .print-btn:disabled { background: #a0b8d0; cursor: not-allowed; }
        
        /* passenger table unchanged */
        .table-container {
            background: white;
            border-radius: 16px;
            border: 2px solid #e6b800;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #faf3e0, #fff5e6);
            padding: 12px 18px;
            border-bottom: 2px solid #e6b800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #8b6913;
            font-size: 16px;
            font-weight: 600;
        }
        
        .passenger-count {
            background: #6b8e23;
            color: white;
            padding: 4px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 480px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background: #e6b800;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(230, 184, 0, 0.2);
            color: #2c3e50;
            font-size: 12px;
        }
        
        tr:hover td {
            background: rgba(230, 184, 0, 0.04);
        }
        
        .serial-no {
            font-weight: 600;
            color: #8b6913;
            font-family: monospace;
        }
        
        .action-cell {
            white-space: nowrap;
        }
        
        .table-action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 2px;
        }
        
        .edit-table-btn { background: #e6b800; color: white; }
        .delete-table-btn { background: #c68b5e; color: white; }
        .save-table-btn { background: #6b8e23; color: white; }
        .cancel-table-btn { background: #7f8c8d; color: white; }
        
        .edit-mode-input {
            width: 100%;
            padding: 4px 6px;
            border: 2px solid #e6b800;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .time-edit-input {
            width: 90px;
            padding: 4px 6px;
            border: 2px solid #e6b800;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .pax-warning {
            font-size: 10px;
            color: #c68b5e;
            margin-top: 2px;
        }
        
        .flight-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
        .status-open { background: #6b8e23; color: white; }
        .status-closed { background: #c68b5e; color: white; }
        
        .no-data, .loading { text-align: center; padding: 30px; color: #8b6913; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(230,184,0,0.3); border-radius: 50%; border-top-color: #e6b800; animation: spin 1s infinite; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* print-specific styles - header only on first page */
        @media print {
            body { background: white; padding: 0; margin: 0.5in; }
            .shift-ribbon, .card .selection-flight-row, .action-buttons-vertical, .edit-btn, .table-action-btn, .refresh-shift, .quick-shift-box, .database-badge { display: none; }
            .card { border: none; box-shadow: none; padding: 0; background: transparent; }
            .flight-panel-revised { display: block; }
            .left-details-block, .right-ops-block { background: transparent; border: none; padding: 0; }
            .stats-mini { border: 1px solid #ccc; }
            .table-container { border: 1px solid #000; margin-top: 20px; }
            th { background: #e6b800 !important; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .flight-status { border: 1px solid #000; background: #eee; }
            
            /* Header only on first page */
            .report-header-print {
                display: block !important;
            }
            
            /* Page break handling */
            tr, td, th {
                page-break-inside: avoid;
            }
            
            thead {
                display: table-header-group;
            }
            
            tfoot {
                display: table-footer-group;
            }
        }
        
        /* Print header - hidden normally, shown only in print */
        .report-header-print {
            display: none;
        }
        
        @media print {
            .report-header-print {
                display: block;
                margin-bottom: 20px;
            }
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-size: 18px;
            font-weight: 600;
            color: #8b6913;
        }
        
        .loading-spinner .spinner {
            width: 24px;
            height: 24px;
            border-width: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <span class="spinner"></span>
            <span id="loadingMessage">Loading data...</span>
        </div>
    </div>

    <div class="container">
        <!-- smaller ribbon -->
        <div class="shift-ribbon" id="shiftRibbon">
            <div class="shift-info">
                <span class="shift-badge" id="shiftBadge">LOADING...</span>
                <span class="date-value" id="ribbonDate">--</span>
            </div>
            <button class="refresh-shift" onclick="refreshAll()">‚Üª REFRESH ALL</button>
        </div>

        <!-- main card ‚Äì compact & rearranged -->
        <div class="card">
            <!-- Row: Date and Flight No on left side, extra right box for visual balance (optional) -->
            <div class="selection-flight-row">
                <div class="left-selectors">
                    <div class="form-group">
                        <label>üìÖ DATE</label>
                        <select id="dateSelect" class="form-control" onclick="loadDates()" onchange="onDateSelected()">
                            <option value="">-- Click to load dates --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‚úà FLIGHT NO</label>
                        <select id="flightSelect" class="form-control" onchange="onFlightSelected()" disabled>
                            <option value="">-- Select date first --</option>
                        </select>
                    </div>
                </div>
                <div class="quick-shift-box" id="quickShiftDisplay">
                    <span id="quickShiftText">Select flight</span>
                    <span id="databaseBadge" class="database-badge" style="display: none;"></span>
                </div>
            </div>
            
            <!-- flight panel ‚Äì now two columns: left details+stats, right ops+buttons under last pax -->
            <div id="flightPanel" style="display: none;">
                <div class="flight-panel-revised">
                    <!-- LEFT SIDE: airline, flight, date, status + stats -->
                    <div class="left-details-block">
                        <div class="info-grid">
                            <span class="info-label">Airline:</span><span class="info-value" id="airlineDisplay">-</span>
                            <span class="info-label">Flight No:</span><span class="info-value" id="flightNoDisplay">-</span>
                            <span class="info-label">Date:</span><span class="info-value" id="dateDisplay">-</span>
                            <span class="info-label">Database:</span><span class="info-value" id="databaseDisplay">-</span>
                            <span class="info-label">Status:</span>
                            <span class="info-value"><span id="flightStatus" class="flight-status status-open">OPEN</span></span>
                        </div>
                        <!-- stats moved inside left block (right below basic info) -->
                        <div class="stats-mini">
                            <div class="stat-item"><div class="stat-label">Total Pax</div><div class="stat-number" id="totalPaxStat">0</div></div>
                            <div class="stat-item"><div class="stat-label">First Pax</div><div class="stat-number" id="firstPaxStat">--:--</div></div>
                            <div class="stat-item"><div class="stat-label">Last Pax</div><div class="stat-number" id="lastPaxStat">--:--</div></div>
                        </div>
                    </div>

                    <!-- RIGHT SIDE: Shift, STD, Last Pax (with edit) + buttons under last pax -->
                    <div class="right-ops-block">
                        <div class="ops-grid">
                            <span class="ops-label">Shift:</span><span class="ops-value" id="shiftDisplay">-</span>
                            <span class="ops-label">STD:</span>
                            <div class="edit-field">
                                <input type="time" id="stdInput" class="edit-input" onchange="updateSTD()">
                                <button class="edit-btn" onclick="updateSTD()">Update</button>
                            </div>
                            <span class="ops-label">First Pax:</span><span class="ops-value first-pax" id="firstPaxDisplay">-</span>
                            <span class="ops-label">Last Pax:</span>
                            <div class="edit-field">
                                <input type="time" id="lastPaxInput" class="edit-input" onchange="updateLastPax()">
                                <button class="edit-btn" onclick="updateLastPax()">Update</button>
                            </div>
                        </div>
                        
                        <!-- BUTTONS: only CLOSE / REOPEN / PRINT -->
                        <div class="action-buttons-vertical">
                            <button id="closeFlightBtn" class="close-btn" onclick="closeFlight()" disabled>üîí CLOSE</button>
                            <button id="reopenFlightBtn" class="reopen-btn" onclick="reopenFlight()" style="display: none;">üîì REOPEN</button>
                            <button id="printReportBtn" class="print-btn" onclick="printReport()" disabled>üñ®Ô∏è PRINT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- passenger table ‚Äì unchanged -->
        <div id="tableContainer" class="table-container" style="display: none;">
            <div class="table-header">
                <h3>‚úà PASSENGER LIST</h3>
                <span class="passenger-count" id="passengerCount">0</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>No.</th><th>Name</th><th>Seat</th><th>Pax</th><th>FQTV</th><th>Serial No</th><th>Time</th><th>Remarks</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="passengerTableBody">
                        <tr><td colspan="9" class="no-data">Select a flight to view passengers</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    // ========== GLOBAL VARIABLES ==========
    let flightsByDate = {};
    let allDates = [];
    let currentFlightData = null;
    let editingRowId = null;
    let isLoadingDates = false;
    let databaseStats = {};
    let datesLoaded = false;
    let loadingTimeout = null;

    // ========== LOADING OVERLAY FUNCTIONS ==========
    function showLoading(message = 'Loading data...') {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // Auto-hide after 30 seconds (prevent infinite loading)
        if (loadingTimeout) clearTimeout(loadingTimeout);
        loadingTimeout = setTimeout(() => {
            hideLoading();
            alert('Loading timed out. Please check your connection and try again.');
        }, 30000);
    }
    
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
        if (loadingTimeout) {
            clearTimeout(loadingTimeout);
            loadingTimeout = null;
        }
    }

    // ========== MULTI-DATABASE HELPER FUNCTIONS ==========
    
    /**
     * Returns the appropriate Firestore database based on flight number
     */
    function getFirestoreForFlight(flightNo) {
        if (!flightNo || typeof flightNo !== 'string') {
            return window.defaultCardDb || window.db;
        }

        const flightPrefix = flightNo.substring(0, 2).toUpperCase();
        
        switch(flightPrefix) {
            case 'BA': return window.baDb;
            case 'EK': return window.ekDb;
            case 'QR': return window.qrDb;
            case 'SQ': return window.sqDb;
            default: return window.defaultCardDb;
        }
    }

    /**
     * Gets the friendly name of the database for a flight
     */
    function getFirestoreNameForFlight(flightNo) {
        if (!flightNo || typeof flightNo !== 'string') return "Default Database";
        
        const flightPrefix = flightNo.substring(0, 2).toUpperCase();
        
        switch(flightPrefix) {
            case 'BA': return "BA Database";
            case 'EK': return "EK Database";
            case 'QR': return "QR Database";
            case 'SQ': return "SQ Database";
            default: return "Default Database";
        }
    }

    /**
     * Gets all available databases
     */
    function getAllDatabases() {
        const databases = [];
        
        if (window.baDb) {
            databases.push({ 
                name: 'BA Database', 
                ref: window.baDb, 
                prefix: 'BA',
                projectId: 'cardentryba'
            });
        }
        
        if (window.ekDb) {
            databases.push({ 
                name: 'EK Database', 
                ref: window.ekDb, 
                prefix: 'EK',
                projectId: 'cardentryek'
            });
        }
        
        if (window.qrDb) {
            databases.push({ 
                name: 'QR Database', 
                ref: window.qrDb, 
                prefix: 'QR',
                projectId: 'cardentryqr'
            });
        }
        
        if (window.sqDb) {
            databases.push({ 
                name: 'SQ Database', 
                ref: window.sqDb, 
                prefix: 'SQ',
                projectId: 'dcleeli'
            });
        }
        
        if (window.defaultCardDb) {
            databases.push({ 
                name: 'Default Database', 
                ref: window.defaultCardDb, 
                prefix: 'OTHER',
                projectId: 'cardentry-7bad1'
            });
        }
        
        return databases;
    }

    // ========== CACHE MANAGEMENT ==========
    function loadFromCache() {
        try {
            const cached = localStorage.getItem('flightDates');
            if (cached) {
                const { timestamp, data } = JSON.parse(cached);
                // Cache for 5 minutes (300000 ms)
                if (Date.now() - timestamp < 300000) {
                    flightsByDate = data;
                    allDates = Object.keys(flightsByDate).sort().reverse();
                    updateDateDropdown();
                    datesLoaded = true;
                    console.log('üì¶ Loaded from cache');
                    return true;
                }
            }
        } catch (e) {
            console.log('Cache read error:', e);
        }
        return false;
    }

    function saveToCache() {
        try {
            localStorage.setItem('flightDates', JSON.stringify({
                timestamp: Date.now(),
                data: flightsByDate
            }));
            console.log('üíæ Saved to cache');
        } catch (e) {
            console.log('Cache write error:', e);
        }
    }

    function updateDateDropdown() {
        const dateSelect = document.getElementById('dateSelect');
        
        if (allDates.length === 0) {
            dateSelect.innerHTML = '<option value="">‚ùå No dates found</option>';
        } else {
            let options = '<option value="">üìÖ Select a date</option>';
            allDates.forEach(date => { 
                const flightCount = flightsByDate[date]?.length || 0;
                options += `<option value="${date}">${date} (${flightCount} flight${flightCount !== 1 ? 's' : ''})</option>`; 
            });
            dateSelect.innerHTML = options;
        }
        
        dateSelect.disabled = false;
    }

    // ========== UTILS ==========
    function calculatePaxFromSeat(seatNo) {
        if (!seatNo) return 1;
        const letters = seatNo.toString().match(/[A-Za-z]/g);
        return letters ? letters.length : 1;
    }

    function onSeatChange(docId) {
        const seatInput = document.getElementById(`edit-seatNo-${docId}`);
        const paxInput = document.getElementById(`edit-pax-${docId}`);
        const warningDiv = document.getElementById(`pax-warning-${docId}`);
        if (seatInput && paxInput) {
            const calculated = calculatePaxFromSeat(seatInput.value);
            paxInput.value = calculated;
            if (warningDiv) {
                warningDiv.textContent = '‚úì auto-updated';
                warningDiv.style.color = '#6b8e23';
                setTimeout(() => { if(warningDiv) warningDiv.textContent = ''; }, 2000);
            }
        }
    }

    function onPaxChange(docId) {
        const seatInput = document.getElementById(`edit-seatNo-${docId}`);
        const paxInput = document.getElementById(`edit-pax-${docId}`);
        const warningDiv = document.getElementById(`pax-warning-${docId}`);
        if (seatInput && paxInput) {
            const calculated = calculatePaxFromSeat(seatInput.value);
            const entered = parseInt(paxInput.value) || 0;
            if (entered !== calculated) {
                if (warningDiv) {
                    warningDiv.innerHTML = `‚ö† mismatch (seat->${calculated}) <button onclick="updatePaxFromSeat('${docId}')" style="background:none; border:1px solid #c68b5e; border-radius:12px; padding:2px 6px; font-size:9px; cursor:pointer;">fix</button>`;
                    warningDiv.style.color = '#c68b5e';
                }
            } else {
                if (warningDiv) warningDiv.textContent = '';
            }
        }
    }

    function updatePaxFromSeat(docId) {
        const seatInput = document.getElementById(`edit-seatNo-${docId}`);
        const paxInput = document.getElementById(`edit-pax-${docId}`);
        const warningDiv = document.getElementById(`pax-warning-${docId}`);
        if (seatInput && paxInput) {
            paxInput.value = calculatePaxFromSeat(seatInput.value);
            if (warningDiv) warningDiv.textContent = '';
        }
    }

    // ========== SHIFT ==========
    async function fetchOpenShift() {
        try {
            const shiftBadge = document.getElementById('shiftBadge');
            const ribbonDate = document.getElementById('ribbonDate');
            const ribbon = document.getElementById('shiftRibbon');
            shiftBadge.textContent = 'LOADING...';
            ribbonDate.textContent = '--';
            if (typeof passengerDb === 'undefined') throw new Error('no passengerDb');
            const shiftDoc = await passengerDb.collection('shifts').doc('currentshift').get();
            if (shiftDoc.exists) {
                const data = shiftDoc.data();
                const date = data.date || 'No date';
                const morning = data.morning || 'closed';
                const evening = data.evening || 'closed';
                if (morning === 'open') {
                    shiftBadge.textContent = 'MORNING SHIFT';
                    ribbonDate.textContent = date;
                    ribbon.style.background = 'linear-gradient(135deg, #6b8e23, #8b6913)';
                } else if (evening === 'open') {
                    shiftBadge.textContent = 'EVENING SHIFT';
                    ribbonDate.textContent = date;
                    ribbon.style.background = 'linear-gradient(135deg, #c68b5e, #8b6913)';
                } else {
                    shiftBadge.textContent = 'NO OPEN SHIFT';
                    ribbonDate.textContent = date;
                    ribbon.style.background = 'linear-gradient(135deg, #7f8c8d, #5e4a1a)';
                }
            } else throw new Error('shift missing');
        } catch (error) {
            document.getElementById('shiftBadge').textContent = 'ERROR';
            document.getElementById('ribbonDate').textContent = '--';
        }
    }

    // ========== OPTIMIZED LOAD DATES ==========
    async function loadDates(forceReload = false) {
        // Try cache first
        if (!forceReload && loadFromCache()) {
            return;
        }
        
        if (isLoadingDates) return;
        
        const dateSelect = document.getElementById('dateSelect');
        isLoadingDates = true;
        showLoading('Scanning databases for available dates...');
        
        dateSelect.innerHTML = '<option value="">üîç Scanning databases...</option>';
        dateSelect.disabled = true;
        
        if (forceReload) {
            flightsByDate = {};
            databaseStats = {};
            allDates = [];
        }
        
        try {
            const databases = getAllDatabases();
            console.log(`üîç Loading dates from ${databases.length} databases...`);
            
            let totalFlights = 0;
            
            // Query each database in parallel for faster loading
            const promises = databases.map(async (dbInfo) => {
                try {
                    console.log(`üìÇ Querying ${dbInfo.name}...`);
                    
                    // OPTIMIZATION: Get only the fields we need with a reasonable limit
                    const snapshot = await dbInfo.ref.collection('KoveliPass')
                        .select('date', 'flightNo', 'shift')
                        .limit(5000) // Prevent overwhelming queries
                        .get();
                    
                    if (snapshot.size > 0) {
                        const dateSet = new Set();
                        const flightMap = new Map();
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const date = data.date;
                            const flightNo = data.flightNo;
                            const shift = data.shift || 'UNKNOWN';
                            
                            if (date && flightNo) {
                                dateSet.add(date);
                                
                                // Store minimal flight info
                                const key = `${date}_${flightNo}_${shift}`;
                                if (!flightMap.has(key)) {
                                    flightMap.set(key, {
                                        date,
                                        flightNo,
                                        shift,
                                        count: 1
                                    });
                                } else {
                                    flightMap.get(key).count++;
                                }
                            }
                        });
                        
                        const dates = Array.from(dateSet);
                        databaseStats[dbInfo.name] = {
                            dates: dates.length,
                            flights: flightMap.size,
                            records: snapshot.size
                        };
                        
                        return {
                            dbName: dbInfo.name,
                            dbRef: dbInfo.ref,
                            dates,
                            flights: Array.from(flightMap.values())
                        };
                    }
                    return null;
                } catch (dbError) {
                    console.error(`‚ùå Error querying ${dbInfo.name}:`, dbError);
                    return null;
                }
            });
            
            // Wait for all database queries to complete
            const results = await Promise.all(promises);
            
            // Process results
            results.forEach(result => {
                if (result) {
                    const { dbName, dbRef, dates, flights } = result;
                    
                    dates.forEach(date => {
                        if (!flightsByDate[date]) {
                            flightsByDate[date] = [];
                        }
                        
                        // Add flights for this date from this database
                        const flightsForDate = flights.filter(f => f.date === date);
                        
                        flightsForDate.forEach(f => {
                            // Check if flight already exists
                            const exists = flightsByDate[date].some(existing => 
                                existing.flightNo === f.flightNo && 
                                existing.shift === f.shift &&
                                existing.database === dbName
                            );
                            
                            if (!exists) {
                                flightsByDate[date].push({
                                    flightNo: f.flightNo,
                                    shift: f.shift,
                                    passengerCount: f.count,
                                    database: dbName,
                                    dbRef: dbRef
                                });
                                totalFlights++;
                            }
                        });
                    });
                    
                    console.log(`‚úÖ ${dbName}: ${dates.length} dates, ${flights.length} flights`);
                }
            });
            
            // Get unique sorted dates
            allDates = Object.keys(flightsByDate).sort().reverse();
            datesLoaded = true;
            
            // Save to cache
            saveToCache();
            
            // Update dropdown
            updateDateDropdown();
            
            console.log(`üìä Found ${allDates.length} dates with ${totalFlights} total flights`);
            
        } catch (error) {
            console.error('Error loading dates:', error);
            dateSelect.innerHTML = '<option value="">‚ùå Error loading dates</option>';
            dateSelect.disabled = false;
        } finally { 
            isLoadingDates = false;
            hideLoading();
        }
    }

    function onDateSelected() {
        const dateSelect = document.getElementById('dateSelect');
        const flightSelect = document.getElementById('flightSelect');
        const selectedDate = dateSelect.value;
        
        // Reset flight select
        flightSelect.innerHTML = '<option value="">‚è≥ Loading flights...</option>';
        flightSelect.disabled = true;
        
        // Hide panels
        document.getElementById('flightPanel').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('quickShiftText').innerText = 'Select flight';
        document.getElementById('databaseBadge').style.display = 'none';
        
        // Reset current data
        editingRowId = null;
        currentFlightData = null;
        
        if (!selectedDate) {
            flightSelect.innerHTML = '<option value="">-- Select date first --</option>';
            return;
        }
        
        // Get flights for selected date
        const flights = flightsByDate[selectedDate];
        if (!flights || flights.length === 0) {
            flightSelect.innerHTML = '<option value="">‚ùå No flights for this date</option>';
            return;
        }
        
        // Sort flights
        const sortedFlights = [...flights].sort((a,b) => a.flightNo.localeCompare(b.flightNo));
        
        // Build options
        let options = '<option value="">‚úàÔ∏è Select a flight</option>';
        sortedFlights.forEach(f => { 
            options += `<option value="${f.flightNo}|${f.shift}|${f.database}">${f.flightNo} [${f.database}] - ${f.passengerCount} pax</option>`; 
        });
        
        flightSelect.innerHTML = options;
        flightSelect.disabled = false;
    }

    // ========== OPTIMIZED FLIGHT SELECTION ==========
    async function onFlightSelected() {
        const dateSelect = document.getElementById('dateSelect');
        const flightSelect = document.getElementById('flightSelect');
        const selectedDate = dateSelect.value;
        const selectedValue = flightSelect.value;
        
        if (!selectedDate || !selectedValue) {
            document.getElementById('flightPanel').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            return;
        }
        
        const [flightNo, shift, dbName] = selectedValue.split('|');
        
        showLoading(`Loading passengers for ${flightNo}...`);
        
        try {
            // Find the database reference
            let targetDb = null;
            let databaseName = dbName;
            
            // Try to get from flightsByDate first (faster)
            const flights = flightsByDate[selectedDate];
            if (flights) {
                const flightInfo = flights.find(f => 
                    f.flightNo === flightNo && 
                    f.shift === shift && 
                    f.database === dbName
                );
                if (flightInfo && flightInfo.dbRef) {
                    targetDb = flightInfo.dbRef;
                }
            }
            
            // If not found, use prefix-based lookup
            if (!targetDb) {
                targetDb = getFirestoreForFlight(flightNo);
                databaseName = getFirestoreNameForFlight(flightNo);
            }
            
            if (!targetDb) {
                throw new Error('Could not determine database for flight');
            }
            
            // OPTIMIZATION: Query with both filters for maximum efficiency
            console.log(`üìä Loading passengers for ${flightNo} on ${selectedDate}...`);
            
            const snapshot = await targetDb.collection('KoveliPass')
                .where('flightNo', '==', flightNo)
                .where('date', '==', selectedDate)
                .get();
            
            const passengers = [];
            let firstPax = null;
            let lastPax = null;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const passenger = {
                    docId: doc.id,
                    pName: data.pName || '',
                    seatNo: data.seatNo || '',
                    pax: data.pax || '1',
                    FQTV: data.FQTV || '',
                    entryTime: data.entryTime || '',
                    remarks: data.remarks || '',
                    serialNo: data.serialNo || ''
                };
                
                passengers.push(passenger);
                
                // Track first/last times
                if (data.entryTime) {
                    if (!firstPax || data.entryTime < firstPax) firstPax = data.entryTime;
                    if (!lastPax || data.entryTime > lastPax) lastPax = data.entryTime;
                }
            });
            
            // Sort by entry time
            passengers.sort((a,b) => (a.entryTime||'').localeCompare(b.entryTime||''));
            
            // Create flight data object
            currentFlightData = {
                flightNo,
                shift,
                passengers,
                firstPax,
                lastPax: lastPax, // Will be overwritten by report if exists
                airline: flightNo.substring(0, 2),
                database: databaseName,
                dbRef: targetDb,
                isClosed: false,
                std: ''
            };
            
            // Load flight status
            await loadFlightStatus(selectedDate, flightNo, targetDb);
            
            // Update UI
            updateFlightUI(selectedDate, flightNo, shift);
            
            hideLoading();
            
        } catch (error) {
            console.error('Error loading flight:', error);
            alert('Error loading flight data: ' + error.message);
            hideLoading();
        }
    }

    // Load flight status from FlightReports
    async function loadFlightStatus(date, flightNo, db) {
        try {
            // Format date for document ID (YYYY-MM-DD)
            let formattedDate = date;
            if (date.includes('/')) {
                const parts = date.split('/');
                if (parts.length === 3) {
                    // Try to detect format
                    if (parts[0].length === 4) {
                        // Already YYYY/MM/DD
                        formattedDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    } else {
                        // Assume DD/MM/YYYY or MM/DD/YYYY - convert to YYYY-MM-DD
                        // This is a simplification - adjust based on your actual date format
                        formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
            }
            
            const reportId = `${flightNo}_${formattedDate}`;
            console.log(`üîç Loading flight status: ${reportId}`);
            
            const reportDoc = await db.collection('FlightReports').doc(reportId).get();
            
            if (reportDoc.exists) {
                const reportData = reportDoc.data();
                currentFlightData.isClosed = reportData.isClosed || false;
                currentFlightData.std = reportData.std || '';
                currentFlightData.lastPax = reportData.lastPax || currentFlightData.lastPax;
                console.log('Flight status loaded:', { 
                    isClosed: currentFlightData.isClosed, 
                    std: currentFlightData.std,
                    lastPax: currentFlightData.lastPax
                });
            }
        } catch (error) {
            console.error('Error loading flight status:', error);
        }
    }

    // Update UI with flight data
    function updateFlightUI(date, flightNo, shift) {
        document.getElementById('airlineDisplay').textContent = currentFlightData.airline || '-';
        document.getElementById('flightNoDisplay').textContent = flightNo;
        document.getElementById('dateDisplay').textContent = date;
        document.getElementById('shiftDisplay').textContent = shift;
        document.getElementById('firstPaxDisplay').textContent = currentFlightData.firstPax || '-';
        document.getElementById('stdInput').value = currentFlightData.std || '';
        document.getElementById('lastPaxInput').value = currentFlightData.lastPax || '';
        document.getElementById('totalPaxStat').textContent = currentFlightData.passengers.length;
        document.getElementById('firstPaxStat').textContent = currentFlightData.firstPax || '--:--';
        document.getElementById('lastPaxStat').textContent = currentFlightData.lastPax || '--:--';
        document.getElementById('passengerCount').textContent = currentFlightData.passengers.length + ' PAX';
        document.getElementById('databaseDisplay').textContent = currentFlightData.database;
        document.getElementById('databaseBadge').textContent = currentFlightData.database;
        document.getElementById('databaseBadge').style.display = 'inline-block';
        document.getElementById('quickShiftText').innerHTML = `${flightNo} | ${shift} <span style="font-size:10px; opacity:0.8;">(${currentFlightData.database})</span>`;
        
        // Set status
        if (currentFlightData.isClosed) {
            document.getElementById('flightStatus').textContent = 'CLOSED';
            document.getElementById('flightStatus').className = 'flight-status status-closed';
            document.getElementById('closeFlightBtn').style.display = 'none';
            document.getElementById('reopenFlightBtn').style.display = 'block';
            document.getElementById('printReportBtn').disabled = false;
        } else {
            document.getElementById('flightStatus').textContent = 'OPEN';
            document.getElementById('flightStatus').className = 'flight-status status-open';
            document.getElementById('closeFlightBtn').style.display = 'block';
            document.getElementById('reopenFlightBtn').style.display = 'none';
            document.getElementById('printReportBtn').disabled = true;
            validateCloseButton();
        }
        
        // Display passengers
        displayPassengerTable(currentFlightData.passengers);
        
        // Show panels
        document.getElementById('flightPanel').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'block';
    }

    // Enable/disable close button
    function validateCloseButton() {
        if (!currentFlightData || currentFlightData.isClosed) return;
        const std = document.getElementById('stdInput').value;
        const lastPax = document.getElementById('lastPaxInput').value;
        const closeBtn = document.getElementById('closeFlightBtn');
        closeBtn.disabled = !(std && lastPax);
    }

    function displayPassengerTable(passengers) {
        const tbody = document.getElementById('passengerTableBody');
        
        if (!passengers || passengers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="no-data">No passengers found for this flight</td></tr>';
            return;
        }
        
        // Sort passengers by entry time
        const sorted = [...passengers].sort((a,b) => (a.entryTime||'').localeCompare(b.entryTime||''));
        let html = '';
        
        sorted.forEach((p, idx) => {
            const serial = String(idx+1).padStart(3,'0');
            
            if (editingRowId === p.docId) {
                // Edit mode
                html += `<tr id="edit-row-${p.docId}">
                    <td class="serial-no">${serial}</td>
                    <td><input type="text" id="edit-pName-${p.docId}" value="${escapeHtml(p.pName||'')}" class="edit-mode-input"></td>
                    <td>
                        <input type="text" id="edit-seatNo-${p.docId}" value="${escapeHtml(p.seatNo||'')}" class="edit-mode-input" oninput="onSeatChange('${p.docId}')" onchange="onPaxChange('${p.docId}')">
                        <div id="pax-warning-${p.docId}" class="pax-warning"></div>
                    </td>
                    <td><input type="number" id="edit-pax-${p.docId}" value="${p.pax||1}" class="edit-mode-input" style="width:60px;" min="1" onchange="onPaxChange('${p.docId}')"></td>
                    <td><input type="text" id="edit-FQTV-${p.docId}" value="${escapeHtml(p.FQTV||'')}" class="edit-mode-input"></td>
                    <td><input type="text" id="edit-serialNo-${p.docId}" value="${escapeHtml(p.serialNo||'')}" class="edit-mode-input"></td>
                    <td><input type="time" id="edit-entryTime-${p.docId}" value="${p.entryTime||''}" class="time-edit-input"></td>
                    <td><input type="text" id="edit-remarks-${p.docId}" value="${escapeHtml(p.remarks||'')}" class="edit-mode-input"></td>
                    <td class="action-cell">
                        <button class="table-action-btn save-table-btn" onclick="savePassenger('${p.docId}')">Save</button>
                        <button class="table-action-btn cancel-table-btn" onclick="cancelEdit()">Cancel</button>
                    </td>
                </tr>`;
            } else {
                // View mode
                html += `<tr>
                    <td class="serial-no">${serial}</td>
                    <td>${escapeHtml(p.pName) || '-'}</td>
                    <td>${escapeHtml(p.seatNo) || '-'}</td>
                    <td style="text-align:center;">${p.pax || '1'}</td>
                    <td>${escapeHtml(p.FQTV) || '-'}</td>
                    <td class="${p.serialNo ? 'serial-no' : ''}">${escapeHtml(p.serialNo) || '‚Äî'}</td>
                    <td>${p.entryTime || '-'}</td>
                    <td>${escapeHtml(p.remarks) || '-'}</td>
                    <td class="action-cell">
                        <button class="table-action-btn edit-table-btn" onclick="startEdit('${p.docId}')">Edit</button>
                        <button class="table-action-btn delete-table-btn" onclick="confirmDelete('${p.docId}','${escapeHtml(p.pName)}')">Del</button>
                    </td>
                </tr>`;
            }
        });
        
        tbody.innerHTML = html;
    }

    // Helper to escape HTML
    function escapeHtml(text) {
        if (!text) return text;
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function startEdit(docId) { 
        editingRowId = docId; 
        displayPassengerTable(currentFlightData.passengers); 
    }
    
    function cancelEdit() { 
        editingRowId = null; 
        displayPassengerTable(currentFlightData.passengers); 
    }

    async function savePassenger(docId) {
        try {
            const pName = document.getElementById(`edit-pName-${docId}`).value;
            const seatNo = document.getElementById(`edit-seatNo-${docId}`).value;
            const pax = document.getElementById(`edit-pax-${docId}`).value;
            const FQTV = document.getElementById(`edit-FQTV-${docId}`).value;
            const serialNo = document.getElementById(`edit-serialNo-${docId}`).value;
            const entryTime = document.getElementById(`edit-entryTime-${docId}`).value;
            const remarks = document.getElementById(`edit-remarks-${docId}`).value;
            
            const calculated = calculatePaxFromSeat(seatNo);
            if (parseInt(pax) !== calculated && !confirm(`PAX mismatch (seat->${calculated}). Save anyway?`)) return;
            
            showLoading('Saving changes...');
            
            // Use the correct database
            const targetDb = currentFlightData.dbRef || getFirestoreForFlight(currentFlightData.flightNo);
            
            await targetDb.collection('KoveliPass').doc(docId).update({ 
                pName, 
                seatNo, 
                pax: parseInt(pax), 
                FQTV, 
                serialNo, 
                entryTime,
                remarks, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            });
            
            // Update local data
            const passenger = currentFlightData.passengers.find(p => p.docId === docId);
            if (passenger) { 
                passenger.pName = pName; 
                passenger.seatNo = seatNo; 
                passenger.pax = pax; 
                passenger.FQTV = FQTV; 
                passenger.serialNo = serialNo; 
                passenger.entryTime = entryTime;
                passenger.remarks = remarks; 
            }
            
            // Update first and last pax times
            const times = currentFlightData.passengers.map(p => p.entryTime).filter(t => t);
            if (times.length > 0) {
                currentFlightData.firstPax = times.reduce((a, b) => a < b ? a : b);
                currentFlightData.lastPax = times.reduce((a, b) => a > b ? a : b);
                document.getElementById('firstPaxDisplay').textContent = currentFlightData.firstPax || '-';
                document.getElementById('firstPaxStat').textContent = currentFlightData.firstPax || '--:--';
                document.getElementById('lastPaxStat').textContent = currentFlightData.lastPax || '--:--';
            }
            
            editingRowId = null;
            displayPassengerTable(currentFlightData.passengers);
            
            hideLoading();
            alert(`‚úÖ Updated in ${currentFlightData.database}`);
        } catch (error) { 
            hideLoading();
            alert('‚ùå Error: '+error.message); 
            console.error(error);
        }
    }

    function confirmDelete(docId, name) { 
        if (confirm(`Delete ${name}?`)) deletePassenger(docId); 
    }
    
    async function deletePassenger(docId) {
        try {
            showLoading('Deleting passenger...');
            
            const targetDb = currentFlightData.dbRef || getFirestoreForFlight(currentFlightData.flightNo);
            
            await targetDb.collection('KoveliPass').doc(docId).delete();
            
            const idx = currentFlightData.passengers.findIndex(p => p.docId === docId);
            if (idx !== -1) currentFlightData.passengers.splice(idx, 1);
            
            document.getElementById('totalPaxStat').textContent = currentFlightData.passengers.length;
            document.getElementById('passengerCount').textContent = currentFlightData.passengers.length + ' PAX';
            
            displayPassengerTable(currentFlightData.passengers);
            
            hideLoading();
            alert(`‚úÖ Deleted from ${currentFlightData.database}`);
        } catch (error) { 
            hideLoading();
            alert('‚ùå Error: '+error.message);
            console.error(error);
        }
    }

    async function updateSTD() { 
        const v = document.getElementById('stdInput').value; 
        if(v && currentFlightData) { 
            currentFlightData.std = v; 
            validateCloseButton();
            await saveFlightDataToFirebase();
        } 
    }
    
    async function updateLastPax() { 
        const v = document.getElementById('lastPaxInput').value; 
        if(v && currentFlightData) { 
            currentFlightData.lastPax = v; 
            document.getElementById('lastPaxStat').textContent = v; 
            document.getElementById('lastPaxDisplay').textContent = v;
            validateCloseButton();
            await saveFlightDataToFirebase();
        } 
    }

    async function saveFlightDataToFirebase() {
        if (!currentFlightData) return;
        
        try {
            const date = document.getElementById('dateDisplay').textContent;
            const flightNo = document.getElementById('flightNoDisplay').textContent;
            const shift = document.getElementById('shiftDisplay').textContent;
            const airline = document.getElementById('airlineDisplay').textContent;
            const std = document.getElementById('stdInput').value || currentFlightData.std || '';
            const lastPax = document.getElementById('lastPaxInput').value || currentFlightData.lastPax || '';
            const firstPax = currentFlightData.firstPax || '';
            const totalPax = currentFlightData.passengers.length;
            const isClosed = currentFlightData.isClosed || false;
            
            // Format date for document ID
            let formattedDate = date;
            if (date.includes('/')) {
                const parts = date.split('/');
                if (parts.length === 3) {
                    if (parts[0].length === 4) {
                        formattedDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    } else {
                        formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
            }
            
            const reportId = `${flightNo}_${formattedDate}`;
            const targetDb = currentFlightData.dbRef || getFirestoreForFlight(flightNo);
            
            console.log(`üíæ Saving to ${currentFlightData.database}:`, { reportId });
            
            await targetDb.collection('FlightReports').doc(reportId).set({
                flightNo: flightNo,
                date: formattedDate,
                shift: shift,
                airline: airline,
                std: std,
                firstPax: firstPax,
                lastPax: lastPax,
                totalPax: totalPax,
                isClosed: isClosed,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            console.log(`‚úÖ Flight data saved successfully`);
        } catch (error) { 
            console.error('Error saving flight data:', error);
        }
    }

    async function closeFlight() {
        if (!currentFlightData) return;
        
        const std = document.getElementById('stdInput').value;
        const lastPax = document.getElementById('lastPaxInput').value;
        
        if (!std || !lastPax) {
            alert('STD and Last Pax must be entered before closing the flight.');
            return;
        }
        
        showLoading('Closing flight...');
        
        currentFlightData.std = std;
        currentFlightData.lastPax = lastPax;
        currentFlightData.isClosed = true;
        
        try {
            await saveFlightDataToFirebase();
            
            document.getElementById('flightStatus').textContent = 'CLOSED';
            document.getElementById('flightStatus').className = 'flight-status status-closed';
            document.getElementById('closeFlightBtn').style.display = 'none';
            document.getElementById('reopenFlightBtn').style.display = 'block';
            document.getElementById('printReportBtn').disabled = false;
            
            hideLoading();
            alert(`‚úÖ Flight closed and data saved to ${currentFlightData.database}`);
        } catch (error) {
            hideLoading();
            alert('‚ùå Error saving to Firebase: ' + error.message);
            console.error('Close flight error:', error);
        }
    }

    async function reopenFlight() {
        if (!currentFlightData || !confirm('Reopen flight?')) return;
        
        showLoading('Reopening flight...');
        
        try {
            currentFlightData.isClosed = false;
            await saveFlightDataToFirebase();
            
            document.getElementById('flightStatus').textContent = 'OPEN';
            document.getElementById('flightStatus').className = 'flight-status status-open';
            document.getElementById('closeFlightBtn').style.display = 'block';
            document.getElementById('reopenFlightBtn').style.display = 'none';
            document.getElementById('printReportBtn').disabled = true;
            validateCloseButton();
            
            hideLoading();
            alert(`‚úÖ Flight reopened and data saved to ${currentFlightData.database}`);
        } catch (error) {
            hideLoading();
            alert('‚ùå Error saving to Firebase: ' + error.message);
            console.error('Reopen flight error:', error);
        }
    }

    function printReport() {
        if (!currentFlightData || !currentFlightData.isClosed) { 
            alert('Flight must be closed to print report'); 
            return; 
        }

        // Simple print function - you can expand this
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>Flight Report - ${currentFlightData.flightNo}</title>
                <style>
                    body { font-family: Arial; padding: 20px; }
                    h1 { color: #8b6913; }
                    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                    th { background: #e6b800; padding: 8px; text-align: left; }
                    td { padding: 8px; border-bottom: 1px solid #ddd; }
                    .header { margin-bottom: 20px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Flight Report: ${currentFlightData.flightNo}</h1>
                    <p>Date: ${document.getElementById('dateDisplay').textContent}</p>
                    <p>Shift: ${document.getElementById('shiftDisplay').textContent}</p>
                    <p>STD: ${document.getElementById('stdInput').value}</p>
                    <p>Total Passengers: ${currentFlightData.passengers.length}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Name</th>
                            <th>Seat</th>
                            <th>Pax</th>
                            <th>FQTV</th>
                            <th>Serial No</th>
                            <th>Time</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentFlightData.passengers.map((p, i) => `
                            <tr>
                                <td>${String(i+1).padStart(3,'0')}</td>
                                <td>${p.pName || '-'}</td>
                                <td>${p.seatNo || '-'}</td>
                                <td>${p.pax || '1'}</td>
                                <td>${p.FQTV || '-'}</td>
                                <td>${p.serialNo || '-'}</td>
                                <td>${p.entryTime || '-'}</td>
                                <td>${p.remarks || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // Refresh all data
    async function refreshAll() {
        showLoading('Refreshing all data...');
        await fetchOpenShift();
        await loadDates(true); // Force reload
        hideLoading();
    }

    // initialization
    document.addEventListener('DOMContentLoaded', function() {
        fetchOpenShift();
        setInterval(fetchOpenShift, 30000);
        
        // Load dates once when page loads
        setTimeout(() => {
            loadDates();
        }, 500);
    });

    // Make functions global
    window.loadDates = loadDates;
    window.onDateSelected = onDateSelected;
    window.onFlightSelected = onFlightSelected;
    window.updateSTD = updateSTD;
    window.updateLastPax = updateLastPax;
    window.closeFlight = closeFlight;
    window.reopenFlight = reopenFlight;
    window.printReport = printReport;
    window.fetchOpenShift = fetchOpenShift;
    window.refreshAll = refreshAll;
    window.startEdit = startEdit;
    window.cancelEdit = cancelEdit;
    window.savePassenger = savePassenger;
    window.confirmDelete = confirmDelete;
    window.onSeatChange = onSeatChange;
    window.onPaxChange = onPaxChange;
    window.updatePaxFromSeat = updatePaxFromSeat;
    window.validateCloseButton = validateCloseButton;
    </script>
</body>
</html>
