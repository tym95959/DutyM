<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Report ‚Äì Passenger List (Multi-Database)</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your config files -->
    <script src="fireshift.js"></script>
    <script src="Co.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f0e1, #fff5e6);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ===== smaller top ribbon ===== */
        .shift-ribbon {
            background: linear-gradient(135deg, #8b6913, #e6b800);
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(230, 184, 0, 0.25);
            font-size: 0.9rem;
        }
        
        .shift-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .shift-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 14px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .date-value {
            font-weight: 500;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .refresh-shift {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 14px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        /* ===== main card ‚Äì more compact ===== */
        .card {
            background: white;
            border-radius: 20px;
            padding: 18px 22px;
            box-shadow: 0 8px 24px rgba(230, 184, 0, 0.15);
            border: 2px solid #e6b800;
            margin-bottom: 18px;
        }
        
        /* --- REARRANGED: date/flight on left, ops on right --- */
        .selection-flight-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        /* left block: date + flight selects */
        .left-selectors {
            display: flex;
            gap: 16px;
            flex: 2;
            min-width: 360px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }
        
        .form-group label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .form-control {
            padding: 8px 12px;
            border: 2px solid rgba(230, 184, 0, 0.25);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        /* right block: minimal quick info (optional) */
        .quick-shift-box {
            background: #fff9e6;
            border-radius: 30px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: #8b6913;
            border: 1px solid #e6b800;
            white-space: nowrap;
        }
        
        /* Database indicator */
        .database-badge {
            background: #4682b4;
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* flight panel ‚Äî two columns now: left (details + stats) and right (ops + buttons) */
        .flight-panel-revised {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 8px;
        }
        
        .left-details-block {
            background: #fff9e6;
            border-radius: 14px;
            padding: 14px 16px;
            border-left: 4px solid #e6b800;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .info-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 13px;
        }
        
        /* stats inside left block */
        .stats-mini {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: white;
            border-radius: 12px;
            padding: 10px 8px;
            border: 1px solid rgba(230,184,0,0.2);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: #8b6913;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .stat-number {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* right block: ops + buttons (under last pax) */
        .right-ops-block {
            background: white;
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(230, 184, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .ops-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .ops-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .ops-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .edit-field {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .edit-input {
            padding: 4px 8px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 6px;
            font-size: 12px;
            width: 100px;
        }
        
        .edit-btn {
            background: #e6b800;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* action buttons ‚Äì now only CLOSE / REOPEN / PRINT (SAVE ALL removed) */
        .action-buttons-vertical {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
            border-top: 1px dashed rgba(230,184,0,0.3);
            padding-top: 12px;
        }
        
        .close-btn, .reopen-btn, .print-btn {
            padding: 8px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            flex: 1 0 auto;
            min-width: 110px;
            white-space: nowrap;
        }
        
        .close-btn { background: #c68b5e; color: white; }
        .close-btn:disabled { background: #e0c0a8; cursor: not-allowed; opacity: 0.6; }
        .reopen-btn { background: #6b8e23; color: white; }
        .print-btn { background: #4a6fa5; color: white; }
        .print-btn:disabled { background: #a0b8d0; cursor: not-allowed; }
        
        /* passenger table unchanged */
        .table-container {
            background: white;
            border-radius: 16px;
            border: 2px solid #e6b800;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #faf3e0, #fff5e6);
            padding: 12px 18px;
            border-bottom: 2px solid #e6b800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #8b6913;
            font-size: 16px;
            font-weight: 600;
        }
        
        .passenger-count {
            background: #6b8e23;
            color: white;
            padding: 4px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 480px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background: #e6b800;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(230, 184, 0, 0.2);
            color: #2c3e50;
            font-size: 12px;
        }
        
        tr:hover td {
            background: rgba(230, 184, 0, 0.04);
        }
        
        .serial-no {
            font-weight: 600;
            color: #8b6913;
            font-family: monospace;
        }
        
        .action-cell {
            white-space: nowrap;
        }
        
        .table-action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 2px;
        }
        
        .edit-table-btn { background: #e6b800; color: white; }
        .delete-table-btn { background: #c68b5e; color: white; }
        .save-table-btn { background: #6b8e23; color: white; }
        .cancel-table-btn { background: #7f8c8d; color: white; }
        
        .edit-mode-input {
            width: 100%;
            padding: 4px 6px;
            border: 2px solid #e6b800;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .time-edit-input {
            width: 90px;
            padding: 4px 6px;
            border: 2px solid #e6b800;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .pax-warning {
            font-size: 10px;
            color: #c68b5e;
            margin-top: 2px;
        }
        
        .flight-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
        .status-open { background: #6b8e23; color: white; }
        .status-closed { background: #c68b5e; color: white; }
        
        .no-data, .loading { text-align: center; padding: 30px; color: #8b6913; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(230,184,0,0.3); border-radius: 50%; border-top-color: #e6b800; animation: spin 1s infinite; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* print-specific styles - header only on first page */
        @media print {
            body { background: white; padding: 0; margin: 0.5in; }
            .shift-ribbon, .card .selection-flight-row, .action-buttons-vertical, .edit-btn, .table-action-btn, .refresh-shift, .quick-shift-box, .database-badge { display: none; }
            .card { border: none; box-shadow: none; padding: 0; background: transparent; }
            .flight-panel-revised { display: block; }
            .left-details-block, .right-ops-block { background: transparent; border: none; padding: 0; }
            .stats-mini { border: 1px solid #ccc; }
            .table-container { border: 1px solid #000; margin-top: 20px; }
            th { background: #e6b800 !important; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .flight-status { border: 1px solid #000; background: #eee; }
            
            /* Header only on first page */
            .report-header-print {
                display: block !important;
            }
            
            /* Page break handling */
            tr, td, th {
                page-break-inside: avoid;
            }
            
            thead {
                display: table-header-group;
            }
            
            tfoot {
                display: table-footer-group;
            }
        }
        
        /* Print header - hidden normally, shown only in print */
        .report-header-print {
            display: none;
        }
        
        @media print {
            .report-header-print {
                display: block;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- smaller ribbon -->
        <div class="shift-ribbon" id="shiftRibbon">
            <div class="shift-info">
                <span class="shift-badge" id="shiftBadge">LOADING...</span>
                <span class="date-value" id="ribbonDate">--</span>
            </div>
            <button class="refresh-shift" onclick="fetchOpenShift()">‚Üª REFRESH</button>
        </div>

        <!-- main card ‚Äì compact & rearranged -->
        <div class="card">
            <!-- Row: Date and Flight No on left side, extra right box for visual balance (optional) -->
            <div class="selection-flight-row">
                <div class="left-selectors">
                    <div class="form-group">
                        <label>üìÖ DATE</label>
                        <select id="dateSelect" class="form-control" onclick="loadDates()" onchange="onDateSelected()">
                            <option value="">-- Click to load dates --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‚úà FLIGHT NO</label>
                        <select id="flightSelect" class="form-control" onchange="onFlightSelected()" disabled>
                            <option value="">-- Select date first --</option>
                        </select>
                    </div>
                </div>
                <div class="quick-shift-box" id="quickShiftDisplay">
                    <span id="quickShiftText">Select flight</span>
                    <span id="databaseBadge" class="database-badge" style="display: none;"></span>
                </div>
            </div>
            
            <!-- flight panel ‚Äì now two columns: left details+stats, right ops+buttons under last pax -->
            <div id="flightPanel" style="display: none;">
                <div class="flight-panel-revised">
                    <!-- LEFT SIDE: airline, flight, date, status + stats -->
                    <div class="left-details-block">
                        <div class="info-grid">
                            <span class="info-label">Airline:</span><span class="info-value" id="airlineDisplay">-</span>
                            <span class="info-label">Flight No:</span><span class="info-value" id="flightNoDisplay">-</span>
                            <span class="info-label">Date:</span><span class="info-value" id="dateDisplay">-</span>
                            <span class="info-label">Database:</span><span class="info-value" id="databaseDisplay">-</span>
                            <span class="info-label">Status:</span>
                            <span class="info-value"><span id="flightStatus" class="flight-status status-open">OPEN</span></span>
                        </div>
                        <!-- stats moved inside left block (right below basic info) -->
                        <div class="stats-mini">
                            <div class="stat-item"><div class="stat-label">Total Pax</div><div class="stat-number" id="totalPaxStat">0</div></div>
                            <div class="stat-item"><div class="stat-label">First Pax</div><div class="stat-number" id="firstPaxStat">--:--</div></div>
                            <div class="stat-item"><div class="stat-label">Last Pax</div><div class="stat-number" id="lastPaxStat">--:--</div></div>
                        </div>
                    </div>

                    <!-- RIGHT SIDE: Shift, STD, Last Pax (with edit) + buttons under last pax -->
                    <div class="right-ops-block">
                        <div class="ops-grid">
                            <span class="ops-label">Shift:</span><span class="ops-value" id="shiftDisplay">-</span>
                            <span class="ops-label">STD:</span>
                            <div class="edit-field">
                                <input type="time" id="stdInput" class="edit-input" onchange="updateSTD()">
                                <button class="edit-btn" onclick="updateSTD()">Update</button>
                            </div>
                            <span class="ops-label">First Pax:</span><span class="ops-value first-pax" id="firstPaxDisplay">-</span>
                            <span class="ops-label">Last Pax:</span>
                            <div class="edit-field">
                                <input type="time" id="lastPaxInput" class="edit-input" onchange="updateLastPax()">
                                <button class="edit-btn" onclick="updateLastPax()">Update</button>
                            </div>
                        </div>
                        
                        <!-- BUTTONS: only CLOSE / REOPEN / PRINT -->
                        <div class="action-buttons-vertical">
                            <button id="closeFlightBtn" class="close-btn" onclick="closeFlight()" disabled>üîí CLOSE</button>
                            <button id="reopenFlightBtn" class="reopen-btn" onclick="reopenFlight()" style="display: none;">üîì REOPEN</button>
                            <button id="printReportBtn" class="print-btn" onclick="printReport()" disabled>üñ®Ô∏è PRINT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- passenger table ‚Äì unchanged -->
        <div id="tableContainer" class="table-container" style="display: none;">
            <div class="table-header">
                <h3>‚úà PASSENGER LIST</h3>
                <span class="passenger-count" id="passengerCount">0</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>No.</th><th>Name</th><th>Seat</th><th>Pax</th><th>FQTV</th><th>Serial No</th><th>Time</th><th>Remarks</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="passengerTableBody">
                        <tr><td colspan="9" class="no-data">Select a flight to view passengers</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

 <script>
    // ========== GLOBAL VARIABLES ==========
    let flightsByDate = {};
    let allDates = [];
    let currentFlightData = null;
    let flightReports = {};
    let editingRowId = null;
    let currentDatabase = null;
    let isLoadingDates = false;
    let databaseStats = {};
    let datesLoaded = false; // Track if dates have been loaded

    // ========== MULTI-DATABASE HELPER FUNCTIONS ==========
    
    /**
     * Returns the appropriate Firestore database based on flight number
     * @param {string} flightNo - The flight number (e.g., "BA123", "EK456")
     * @returns {Object} - The Firestore database instance
     */
    function getFirestoreForFlight(flightNo) {
        if (!flightNo || typeof flightNo !== 'string') {
            console.log("No valid flight number provided, using default database");
            return window.defaultCardDb || window.db;
        }

        const flightPrefix = flightNo.substring(0, 2).toUpperCase();
        
        switch(flightPrefix) {
            case 'BA':
                return window.baDb;
            case 'EK':
                return window.ekDb;
            case 'QR':
                return window.qrDb;
            case 'SQ':
                return window.sqDb;
            default:
                return window.defaultCardDb;
        }
    }

    /**
     * Gets the friendly name of the database for a flight
     * @param {string} flightNo - The flight number
     * @returns {string} - The database name
     */
    function getFirestoreNameForFlight(flightNo) {
        if (!flightNo || typeof flightNo !== 'string') return "Default Database";
        
        const flightPrefix = flightNo.substring(0, 2).toUpperCase();
        
        switch(flightPrefix) {
            case 'BA': return "BA Database";
            case 'EK': return "EK Database";
            case 'QR': return "QR Database";
            case 'SQ': return "SQ Database";
            default: return "Default Database";
        }
    }

    /**
     * Gets all available databases for loading passenger data
     * @returns {Array} - Array of database objects with name and reference
     */
    function getAllDatabases() {
        const databases = [];
        
        if (window.baDb) {
            databases.push({ 
                name: 'BA Database', 
                ref: window.baDb, 
                prefix: 'BA',
                projectId: 'cardentryba'
            });
        }
        
        if (window.ekDb) {
            databases.push({ 
                name: 'EK Database', 
                ref: window.ekDb, 
                prefix: 'EK',
                projectId: 'cardentryek'
            });
        }
        
        if (window.qrDb) {
            databases.push({ 
                name: 'QR Database', 
                ref: window.qrDb, 
                prefix: 'QR',
                projectId: 'cardentryqr'
            });
        }
        
        if (window.sqDb) {
            databases.push({ 
                name: 'SQ Database', 
                ref: window.sqDb, 
                prefix: 'SQ',
                projectId: 'dcleeli'
            });
        }
        
        if (window.defaultCardDb) {
            databases.push({ 
                name: 'Default Database', 
                ref: window.defaultCardDb, 
                prefix: 'OTHER',
                projectId: 'cardentry-7bad1'
            });
        }
        
        return databases;
    }

    // ========== UTILS ==========
    function calculatePaxFromSeat(seatNo) {
        if (!seatNo) return 1;
        const letters = seatNo.toString().match(/[A-Za-z]/g);
        return letters ? letters.length : 1;
    }

    function onSeatChange(docId) {
        const seatInput = document.getElementById(`edit-seatNo-${docId}`);
        const paxInput = document.getElementById(`edit-pax-${docId}`);
        const warningDiv = document.getElementById(`pax-warning-${docId}`);
        if (seatInput && paxInput) {
            const calculated = calculatePaxFromSeat(seatInput.value);
            paxInput.value = calculated;
            if (warningDiv) {
                warningDiv.textContent = '‚úì auto-updated';
                warningDiv.style.color = '#6b8e23';
                setTimeout(() => { if(warningDiv) warningDiv.textContent = ''; }, 2000);
            }
        }
    }

    function onPaxChange(docId) {
        const seatInput = document.getElementById(`edit-seatNo-${docId}`);
        const paxInput = document.getElementById(`edit-pax-${docId}`);
        const warningDiv = document.getElementById(`pax-warning-${docId}`);
        if (seatInput && paxInput) {
            const calculated = calculatePaxFromSeat(seatInput.value);
            const entered = parseInt(paxInput.value) || 0;
            if (entered !== calculated) {
                if (warningDiv) {
                    warningDiv.innerHTML = `‚ö† mismatch (seat->${calculated}) <button onclick="updatePaxFromSeat('${docId}')" style="background:none; border:1px solid #c68b5e; border-radius:12px; padding:2px 6px; font-size:9px; cursor:pointer;">fix</button>`;
                    warningDiv.style.color = '#c68b5e';
                }
            } else {
                if (warningDiv) warningDiv.textContent = '';
            }
        }
    }

    function updatePaxFromSeat(docId) {
        const seatInput = document.getElementById(`edit-seatNo-${docId}`);
        const paxInput = document.getElementById(`edit-pax-${docId}`);
        const warningDiv = document.getElementById(`pax-warning-${docId}`);
        if (seatInput && paxInput) {
            paxInput.value = calculatePaxFromSeat(seatInput.value);
            if (warningDiv) warningDiv.textContent = '';
        }
    }

    function showNotification(msg, type = 'info') { 
        console.log(msg); 
    }

    // ========== SHIFT ==========
    async function fetchOpenShift() {
        try {
            const shiftBadge = document.getElementById('shiftBadge');
            const ribbonDate = document.getElementById('ribbonDate');
            const ribbon = document.getElementById('shiftRibbon');
            shiftBadge.textContent = 'LOADING...';
            ribbonDate.textContent = '--';
            if (typeof passengerDb === 'undefined') throw new Error('no passengerDb');
            const shiftDoc = await passengerDb.collection('shifts').doc('currentshift').get();
            if (shiftDoc.exists) {
                const data = shiftDoc.data();
                const date = data.date || 'No date';
                const morning = data.morning || 'closed';
                const evening = data.evening || 'closed';
                if (morning === 'open') {
                    shiftBadge.textContent = 'MORNING SHIFT';
                    ribbonDate.textContent = date;
                    ribbon.style.background = 'linear-gradient(135deg, #6b8e23, #8b6913)';
                } else if (evening === 'open') {
                    shiftBadge.textContent = 'EVENING SHIFT';
                    ribbonDate.textContent = date;
                    ribbon.style.background = 'linear-gradient(135deg, #c68b5e, #8b6913)';
                } else {
                    shiftBadge.textContent = 'NO OPEN SHIFT';
                    ribbonDate.textContent = date;
                    ribbon.style.background = 'linear-gradient(135deg, #7f8c8d, #5e4a1a)';
                }
            } else throw new Error('shift missing');
        } catch (error) {
            document.getElementById('shiftBadge').textContent = 'ERROR';
            document.getElementById('ribbonDate').textContent = '--';
        }
    }

    // ========== LOAD DATES FROM ALL DATABASES (only once) ==========
    async function loadDates(forceReload = false) {
        // If dates are already loaded and not forcing reload, just return
        if (datesLoaded && !forceReload) {
            console.log('Dates already loaded, skipping...');
            return;
        }
        
        if (isLoadingDates) return;
        
        const dateSelect = document.getElementById('dateSelect');
        isLoadingDates = true;
        
        // Show loading message
        dateSelect.innerHTML = '<option value="">üîç Scanning all databases...</option>';
        dateSelect.disabled = true;
        
        // Clear previous data only if forcing reload
        if (forceReload) {
            flightsByDate = {};
            databaseStats = {};
            allDates = [];
        }
        
        try {
            const databases = getAllDatabases();
            console.log(`üîç Loading dates from ${databases.length} databases...`);
            
            let totalRecords = 0;
            let databasesWithData = 0;
            
            // Query each database for passenger data
            for (const dbInfo of databases) {
                try {
                    console.log(`üìÇ Querying ${dbInfo.name}...`);
                    
                    const snapshot = await dbInfo.ref.collection('KoveliPass').get();
                    
                    databaseStats[dbInfo.name] = {
                        records: snapshot.size,
                        flights: new Set(),
                        dates: new Set()
                    };
                    
                    if (snapshot.size > 0) {
                        databasesWithData++;
                        totalRecords += snapshot.size;
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const date = data.date;
                            const docId = doc.id;
                            
                            if (date) {
                                databaseStats[dbInfo.name].dates.add(date);
                                
                                if (!flightsByDate[date]) flightsByDate[date] = new Map();
                                
                                // Create a unique key for each flight+shift combination
                                const flightKey = `${data.flightNo}_${data.shift || 'UNKNOWN'}`;
                                databaseStats[dbInfo.name].flights.add(data.flightNo);
                                
                                if (!flightsByDate[date].has(flightKey)) {
                                    flightsByDate[date].set(flightKey, {
                                        flightNo: data.flightNo,
                                        shift: data.shift || 'UNKNOWN',
                                        airline: data.airline || '',
                                        passengers: [],
                                        firstPax: null,
                                        lastPax: null,
                                        std: '',
                                        isClosed: false,
                                        database: dbInfo.name,
                                        dbRef: dbInfo.ref,
                                        databaseProject: dbInfo.projectId,
                                        flightPrefix: data.flightNo ? data.flightNo.substring(0, 2).toUpperCase() : 'UNK'
                                    });
                                }
                                
                                const flightData = flightsByDate[date].get(flightKey);
                                flightData.passengers.push({
                                    docId: docId,
                                    pName: data.pName || '',
                                    seatNo: data.seatNo || '',
                                    pax: data.pax || '1',
                                    FQTV: data.FQTV || '',
                                    entryTime: data.entryTime || '',
                                    remarks: data.remarks || '',
                                    serialNo: data.serialNo || ''
                                });
                                
                                if (data.entryTime) {
                                    if (!flightData.firstPax || data.entryTime < flightData.firstPax) {
                                        flightData.firstPax = data.entryTime;
                                    }
                                    if (!flightData.lastPax || data.entryTime > flightData.lastPax) {
                                        flightData.lastPax = data.entryTime;
                                    }
                                }
                            }
                        });
                        
                        console.log(`‚úÖ ${dbInfo.name}: ${snapshot.size} records found`);
                    } else {
                        console.log(`‚ÑπÔ∏è ${dbInfo.name}: No records found`);
                    }
                    
                } catch (dbError) {
                    console.error(`‚ùå Error querying ${dbInfo.name}:`, dbError);
                    databaseStats[dbInfo.name] = {
                        records: 0,
                        error: dbError.message,
                        flights: new Set(),
                        dates: new Set()
                    };
                }
            }
            
            // Get all unique dates and sort them (newest first)
            allDates = Object.keys(flightsByDate).sort().reverse();
            datesLoaded = true;
            
            // Update the date select dropdown
            if (allDates.length === 0) {
                dateSelect.innerHTML = '<option value="">‚ùå No dates found in any database</option>';
            } else {
                let options = '<option value="">üìÖ Select a date</option>';
                allDates.forEach(d => { 
                    const flightCount = flightsByDate[d]?.size || 0;
                    options += `<option value="${d}">${d} (${flightCount} flight${flightCount !== 1 ? 's' : ''})</option>`; 
                });
                dateSelect.innerHTML = options;
                
                console.log(`üìä Found ${allDates.length} unique dates with ${totalRecords} total records`);
            }
            
            dateSelect.disabled = false;
            
        } catch (error) {
            console.error('Error loading dates:', error);
            dateSelect.innerHTML = '<option value="">‚ùå Error loading dates</option>';
            dateSelect.disabled = false;
        } finally { 
            isLoadingDates = false; 
        }
    }

    function onDateSelected() {
        const dateSelect = document.getElementById('dateSelect');
        const flightSelect = document.getElementById('flightSelect');
        const selectedDate = dateSelect.value;
        
        // Reset flight select
        flightSelect.innerHTML = '<option value="">‚è≥ Loading flights...</option>';
        flightSelect.disabled = true;
        
        // Hide panels
        document.getElementById('flightPanel').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('quickShiftText').innerText = 'Select flight';
        document.getElementById('databaseBadge').style.display = 'none';
        
        // Reset current data
        editingRowId = null;
        currentDatabase = null;
        currentFlightData = null;
        
        if (!selectedDate) {
            flightSelect.innerHTML = '<option value="">-- Select date first --</option>';
            return;
        }
        
        // Get flights for selected date
        const flights = flightsByDate[selectedDate];
        if (!flights || flights.size === 0) {
            flightSelect.innerHTML = '<option value="">‚ùå No flights for this date</option>';
            return;
        }
        
        // Convert Map to array and sort
        const flightsArray = Array.from(flights.values()).sort((a,b) => a.flightNo.localeCompare(b.flightNo));
        
        // Build options
        let options = '<option value="">‚úàÔ∏è Select a flight</option>';
        flightsArray.forEach(f => { 
            const passengerCount = f.passengers.length;
            options += `<option value="${f.flightNo}|${f.shift}|${f.database}">${f.flightNo} [${f.database}] - ${passengerCount} pax</option>`; 
        });
        
        flightSelect.innerHTML = options;
        flightSelect.disabled = false;
    }

    async function onFlightSelected() {
        const dateSelect = document.getElementById('dateSelect');
        const flightSelect = document.getElementById('flightSelect');
        const selectedDate = dateSelect.value;
        const selectedFlight = flightSelect.value;
        
        if (!selectedDate || !selectedFlight) {
            document.getElementById('flightPanel').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            return;
        }
        
        // Show loading state
        document.getElementById('flightPanel').style.display = 'block';
        document.getElementById('airlineDisplay').textContent = 'Loading...';
        document.getElementById('passengerTableBody').innerHTML = '<tr><td colspan="9" class="loading"><span class="spinner"></span> Loading passengers...</td></tr>';
        
        const [flightNo, shift, dbName] = selectedFlight.split('|');
        const flightKey = `${flightNo}_${shift}`;
        const flightData = flightsByDate[selectedDate]?.get(flightKey);
        
        if (!flightData) {
            alert('Flight data not found');
            return;
        }
        
        currentFlightData = flightData;
        currentDatabase = flightData.dbRef;
        editingRowId = null;
        
        // Log the data for debugging
        console.log('Flight Data:', {
            flightNo: flightData.flightNo,
            passengers: flightData.passengers.length,
            firstPax: flightData.firstPax,
            lastPax: flightData.lastPax,
            database: flightData.database
        });
        
        // Update database display
        document.getElementById('databaseDisplay').textContent = `${flightData.database} (${flightData.databaseProject || 'unknown'})`;
        document.getElementById('databaseBadge').textContent = flightData.database;
        document.getElementById('databaseBadge').style.display = 'inline-block';
        
        // Load flight status from FlightReports collection
        try {
            // Format date for document ID
            let formattedDate = selectedDate;
            if (selectedDate.includes('/')) {
                const parts = selectedDate.split('/');
                if (parts.length === 3) {
                    if (parts[0].length === 4) {
                        formattedDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    } else {
                        formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
            } else if (selectedDate.includes('-')) {
                formattedDate = selectedDate;
            } else {
                const cleanDate = selectedDate.replace(/[^0-9]/g, '');
                if (cleanDate.length === 8) {
                    formattedDate = `${cleanDate.substring(0,4)}-${cleanDate.substring(4,6)}-${cleanDate.substring(6,8)}`;
                } else {
                    formattedDate = selectedDate;
                }
            }
            
            const reportId = `${flightNo}_${formattedDate}`;
            console.log(`üîç Looking for flight report: ${reportId} in ${flightData.database}`);
            
            const targetDb = flightData.dbRef || getFirestoreForFlight(flightNo);
            const reportDoc = await targetDb.collection('FlightReports').doc(reportId).get();
            
            if (reportDoc.exists) {
                const reportData = reportDoc.data();
                currentFlightData.isClosed = reportData.isClosed || false;
                currentFlightData.std = reportData.std || '';
                currentFlightData.lastPax = reportData.lastPax || '';
                console.log('Loaded flight status:', { 
                    isClosed: currentFlightData.isClosed, 
                    std: currentFlightData.std, 
                    lastPax: currentFlightData.lastPax
                });
            } else {
                currentFlightData.isClosed = false;
                console.log('No report found, flight is open by default');
            }
        } catch (error) {
            console.error('Error loading flight status:', error);
            currentFlightData.isClosed = false;
        }
        
        // Update UI with loaded data
        document.getElementById('airlineDisplay').textContent = flightData.airline || '-';
        document.getElementById('flightNoDisplay').textContent = flightNo;
        document.getElementById('dateDisplay').textContent = selectedDate;
        document.getElementById('shiftDisplay').textContent = shift;
        document.getElementById('firstPaxDisplay').textContent = flightData.firstPax || '-';
        document.getElementById('stdInput').value = currentFlightData.std || '';
        document.getElementById('lastPaxInput').value = currentFlightData.lastPax || '';
        document.getElementById('totalPaxStat').textContent = flightData.passengers.length;
        document.getElementById('firstPaxStat').textContent = flightData.firstPax || '--:--';
        document.getElementById('lastPaxStat').textContent = currentFlightData.lastPax || flightData.lastPax || '--:--';
        document.getElementById('passengerCount').textContent = flightData.passengers.length + ' PAX';
        document.getElementById('quickShiftText').innerHTML = `${flightNo} | ${shift} <span style="font-size:10px; opacity:0.8;">(${flightData.database})</span>`;
        
        // Set status UI
        if (currentFlightData.isClosed) {
            document.getElementById('flightStatus').textContent = 'CLOSED';
            document.getElementById('flightStatus').className = 'flight-status status-closed';
            document.getElementById('closeFlightBtn').style.display = 'none';
            document.getElementById('reopenFlightBtn').style.display = 'block';
            document.getElementById('printReportBtn').disabled = false;
        } else {
            document.getElementById('flightStatus').textContent = 'OPEN';
            document.getElementById('flightStatus').className = 'flight-status status-open';
            document.getElementById('closeFlightBtn').style.display = 'block';
            document.getElementById('reopenFlightBtn').style.display = 'none';
            document.getElementById('printReportBtn').disabled = true;
            validateCloseButton();
        }
        
        // Display passenger table
        displayPassengerTable(flightData.passengers);
    }

    // Enable/disable close button based on STD and Last Pax values
    function validateCloseButton() {
        if (!currentFlightData || currentFlightData.isClosed) return;
        const std = document.getElementById('stdInput').value;
        const lastPax = document.getElementById('lastPaxInput').value;
        const closeBtn = document.getElementById('closeFlightBtn');
        if (std && lastPax) {
            closeBtn.disabled = false;
        } else {
            closeBtn.disabled = true;
        }
    }

    function displayPassengerTable(passengers) {
        const tbody = document.getElementById('passengerTableBody');
        
        if (!passengers || passengers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="no-data">No passengers found for this flight</td></tr>';
            document.getElementById('tableContainer').style.display = 'block';
            return;
        }
        
        // Sort passengers by entry time
        const sorted = [...passengers].sort((a,b) => (a.entryTime||'').localeCompare(b.entryTime||''));
        let html = '';
        
        sorted.forEach((p, idx) => {
            const serial = String(idx+1).padStart(3,'0');
            
            if (editingRowId === p.docId) {
                // Edit mode
                html += `<tr id="edit-row-${p.docId}">
                    <td class="serial-no">${serial}</td>
                    <td><input type="text" id="edit-pName-${p.docId}" value="${p.pName||''}" class="edit-mode-input"></td>
                    <td>
                        <input type="text" id="edit-seatNo-${p.docId}" value="${p.seatNo||''}" class="edit-mode-input" oninput="onSeatChange('${p.docId}')" onchange="onPaxChange('${p.docId}')">
                        <div id="pax-warning-${p.docId}" class="pax-warning"></div>
                    </td>
                    <td><input type="number" id="edit-pax-${p.docId}" value="${p.pax||1}" class="edit-mode-input" style="width:60px;" min="1" onchange="onPaxChange('${p.docId}')"></td>
                    <td><input type="text" id="edit-FQTV-${p.docId}" value="${p.FQTV||''}" class="edit-mode-input"></td>
                    <td><input type="text" id="edit-serialNo-${p.docId}" value="${p.serialNo||''}" class="edit-mode-input"></td>
                    <td><input type="time" id="edit-entryTime-${p.docId}" value="${p.entryTime||''}" class="time-edit-input"></td>
                    <td><input type="text" id="edit-remarks-${p.docId}" value="${p.remarks||''}" class="edit-mode-input"></td>
                    <td class="action-cell">
                        <button class="table-action-btn save-table-btn" onclick="savePassenger('${p.docId}')">Save</button>
                        <button class="table-action-btn cancel-table-btn" onclick="cancelEdit()">Cancel</button>
                    </td>
                </tr>`;
            } else {
                // View mode
                html += `<tr>
                    <td class="serial-no">${serial}</td>
                    <td>${p.pName || '-'}</td>
                    <td>${p.seatNo || '-'}</td>
                    <td style="text-align:center;">${p.pax || '1'}</td>
                    <td>${p.FQTV || '-'}</td>
                    <td class="${p.serialNo ? 'serial-no' : ''}">${p.serialNo || '‚Äî'}</td>
                    <td>${p.entryTime || '-'}</td>
                    <td>${p.remarks || '-'}</td>
                    <td class="action-cell">
                        <button class="table-action-btn edit-table-btn" onclick="startEdit('${p.docId}')">Edit</button>
                        <button class="table-action-btn delete-table-btn" onclick="confirmDelete('${p.docId}','${p.pName}')">Del</button>
                    </td>
                </tr>`;
            }
        });
        
        tbody.innerHTML = html;
        document.getElementById('tableContainer').style.display = 'block';
    }

    function startEdit(docId) { 
        editingRowId = docId; 
        displayPassengerTable(currentFlightData.passengers); 
    }
    
    function cancelEdit() { 
        editingRowId = null; 
        displayPassengerTable(currentFlightData.passengers); 
    }

    async function savePassenger(docId) {
        try {
            const pName = document.getElementById(`edit-pName-${docId}`).value;
            const seatNo = document.getElementById(`edit-seatNo-${docId}`).value;
            const pax = document.getElementById(`edit-pax-${docId}`).value;
            const FQTV = document.getElementById(`edit-FQTV-${docId}`).value;
            const serialNo = document.getElementById(`edit-serialNo-${docId}`).value;
            const entryTime = document.getElementById(`edit-entryTime-${docId}`).value;
            const remarks = document.getElementById(`edit-remarks-${docId}`).value;
            
            const calculated = calculatePaxFromSeat(seatNo);
            if (parseInt(pax) !== calculated && !confirm(`PAX mismatch (seat->${calculated}). Save anyway?`)) return;
            
            // Use the correct database for this flight
            const targetDb = currentDatabase || getFirestoreForFlight(currentFlightData.flightNo);
            
            await targetDb.collection('KoveliPass').doc(docId).update({ 
                pName, 
                seatNo, 
                pax: parseInt(pax), 
                FQTV, 
                serialNo, 
                entryTime,
                remarks, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            });
            
            // Update local data
            const passenger = currentFlightData.passengers.find(p => p.docId === docId);
            if (passenger) { 
                passenger.pName = pName; 
                passenger.seatNo = seatNo; 
                passenger.pax = pax; 
                passenger.FQTV = FQTV; 
                passenger.serialNo = serialNo; 
                passenger.entryTime = entryTime;
                passenger.remarks = remarks; 
            }
            
            // Update first and last pax times
            const times = currentFlightData.passengers.map(p => p.entryTime).filter(t => t);
            if (times.length > 0) {
                currentFlightData.firstPax = times.reduce((a, b) => a < b ? a : b);
                currentFlightData.lastPax = times.reduce((a, b) => a > b ? a : b);
                document.getElementById('firstPaxDisplay').textContent = currentFlightData.firstPax || '-';
                document.getElementById('firstPaxStat').textContent = currentFlightData.firstPax || '--:--';
                document.getElementById('lastPaxStat').textContent = currentFlightData.lastPax || '--:--';
            }
            
            editingRowId = null;
            displayPassengerTable(currentFlightData.passengers);
            alert(`‚úÖ Updated in ${currentFlightData.database || 'database'}`);
        } catch (error) { 
            alert('‚ùå Error: '+error.message); 
            console.error(error);
        }
    }

    function confirmDelete(docId, name) { 
        if (confirm(`Delete ${name}?`)) deletePassenger(docId); 
    }
    
    async function deletePassenger(docId) {
        try {
            const targetDb = currentDatabase || getFirestoreForFlight(currentFlightData.flightNo);
            
            await targetDb.collection('KoveliPass').doc(docId).delete();
            
            const idx = currentFlightData.passengers.findIndex(p => p.docId === docId);
            if (idx !== -1) currentFlightData.passengers.splice(idx, 1);
            
            document.getElementById('totalPaxStat').textContent = currentFlightData.passengers.length;
            document.getElementById('passengerCount').textContent = currentFlightData.passengers.length + ' PAX';
            
            displayPassengerTable(currentFlightData.passengers);
            alert(`‚úÖ Deleted from ${currentFlightData.database || 'database'}`);
        } catch (error) { 
            alert('‚ùå Error: '+error.message);
            console.error(error);
        }
    }

    async function updateSTD() { 
        const v = document.getElementById('stdInput').value; 
        if(v && currentFlightData) { 
            currentFlightData.std = v; 
            validateCloseButton();
            try {
                await saveFlightDataToFirebase();
                console.log('STD auto-saved');
            } catch (error) {
                console.error('Error saving STD:', error);
            }
        } 
    }
    
    async function updateLastPax() { 
        const v = document.getElementById('lastPaxInput').value; 
        if(v && currentFlightData) { 
            currentFlightData.lastPax = v; 
            document.getElementById('lastPaxStat').textContent = v; 
            document.getElementById('lastPaxDisplay').textContent = v;
            validateCloseButton();
            try {
                await saveFlightDataToFirebase();
                console.log('Last Pax auto-saved');
            } catch (error) {
                console.error('Error saving Last Pax:', error);
            }
        } 
    }

    async function saveFlightDataToFirebase() {
        if (!currentFlightData) return;
        
        try {
            const date = document.getElementById('dateDisplay').textContent;
            const flightNo = document.getElementById('flightNoDisplay').textContent;
            const shift = document.getElementById('shiftDisplay').textContent;
            const airline = document.getElementById('airlineDisplay').textContent;
            const std = document.getElementById('stdInput').value || currentFlightData.std || '';
            const lastPax = document.getElementById('lastPaxInput').value || currentFlightData.lastPax || '';
            const firstPax = currentFlightData.firstPax || '';
            const totalPax = currentFlightData.passengers.length;
            const isClosed = currentFlightData.isClosed || false;
            
            // Format date for document ID
            let formattedDate = date;
            if (date.includes('/')) {
                const parts = date.split('/');
                if (parts.length === 3) {
                    if (parts[0].length === 4) {
                        formattedDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    } else {
                        formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
            } else if (date.includes('-')) {
                formattedDate = date;
            } else {
                const cleanDate = date.replace(/[^0-9]/g, '');
                if (cleanDate.length === 8) {
                    formattedDate = `${cleanDate.substring(0,4)}-${cleanDate.substring(4,6)}-${cleanDate.substring(6,8)}`;
                } else {
                    formattedDate = date;
                }
            }
            
            const reportId = `${flightNo}_${formattedDate}`;
            const targetDb = currentDatabase || getFirestoreForFlight(flightNo);
            
            console.log(`üíæ Saving to ${currentFlightData.database}:`, { 
                reportId, flightNo, date: formattedDate, shift, airline, std, lastPax, firstPax, totalPax, isClosed 
            });
            
            await targetDb.collection('FlightReports').doc(reportId).set({
                flightNo: flightNo,
                date: formattedDate,
                shift: shift,
                airline: airline,
                std: std,
                firstPax: firstPax,
                lastPax: lastPax,
                totalPax: totalPax,
                isClosed: isClosed,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            console.log(`‚úÖ Flight data saved successfully`);
            return true;
        } catch (error) { 
            console.error('Error saving flight data:', error);
            throw error;
        }
    }

    async function closeFlight() {
        if (!currentFlightData) return;
        
        const std = document.getElementById('stdInput').value;
        const lastPax = document.getElementById('lastPaxInput').value;
        
        if (!std || !lastPax) {
            alert('STD and Last Pax must be entered before closing the flight.');
            return;
        }
        
        currentFlightData.std = std;
        currentFlightData.lastPax = lastPax;
        currentFlightData.isClosed = true;
        
        try {
            await saveFlightDataToFirebase();
            
            document.getElementById('flightStatus').textContent = 'CLOSED';
            document.getElementById('flightStatus').className = 'flight-status status-closed';
            document.getElementById('closeFlightBtn').style.display = 'none';
            document.getElementById('reopenFlightBtn').style.display = 'block';
            document.getElementById('printReportBtn').disabled = false;
            
            alert(`‚úÖ Flight closed and data saved to ${currentFlightData.database}`);
        } catch (error) {
            alert('‚ùå Error saving to Firebase: ' + error.message);
            console.error('Close flight error:', error);
        }
    }

    async function reopenFlight() {
        if (!currentFlightData || !confirm('Reopen flight?')) return;
        
        try {
            currentFlightData.isClosed = false;
            await saveFlightDataToFirebase();
            
            document.getElementById('flightStatus').textContent = 'OPEN';
            document.getElementById('flightStatus').className = 'flight-status status-open';
            document.getElementById('closeFlightBtn').style.display = 'block';
            document.getElementById('reopenFlightBtn').style.display = 'none';
            document.getElementById('printReportBtn').disabled = true;
            validateCloseButton();
            
            alert(`‚úÖ Flight reopened and data saved to ${currentFlightData.database}`);
        } catch (error) {
            alert('‚ùå Error saving to Firebase: ' + error.message);
            console.error('Reopen flight error:', error);
        }
    }

    function printReport() {
    if (!currentFlightData || !currentFlightData.isClosed) { 
        alert('Flight must be closed'); 
        return; 
    }

    const company = window.companyInfo || { 
        name: 'Airline Name', 
        address: '123 Aviation Road', 
        phone: '+123 456 7890',
        logo: '' // You can add a logo URL here if available
    };
    
    const dateStr = document.getElementById('dateDisplay').textContent; 
    const dateParts = dateStr.split('-');
    const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : dateStr;

    const airline = currentFlightData.airline || '‚Äî';
    const flightNo = currentFlightData.flightNo || '‚Äî';
    const std = currentFlightData.std || document.getElementById('stdInput').value || '‚Äî';
    const firstPax = currentFlightData.firstPax || '‚Äî';
    const lastPax = currentFlightData.lastPax || document.getElementById('lastPaxInput').value || '‚Äî';
    const shift = currentFlightData.shift || '‚Äî';
    
    const sortedPassengers = [...currentFlightData.passengers].sort((a,b) => (a.entryTime||'').localeCompare(b.entryTime||''));
    const totalPaxSum = sortedPassengers.reduce((sum, p) => sum + (parseInt(p.pax) || 1), 0);

    // Create print window
    const printWindow = window.open('', '_blank');
    
    // Generate HTML for print
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Flight Report - ${flightNo} - ${formattedDate}</title>
            <style>
                body {
                    font-family: 'Segoe UI', Arial, sans-serif;
                    margin: 0.5in;
                    color: #333;
                }
                .header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid #e6b800;
                }
                .left-header {
                    display: flex;
                    gap: 15px;
                    align-items: center;
                }
                .logo {
                    width: 60px;
                    height: 60px;
                    background: #e6b800;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 24px;
                }
                .company-details {
                    line-height: 1.4;
                }
                .company-name {
                    font-size: 20px;
                    font-weight: bold;
                    color: #8b6913;
                }
                .company-address {
                    font-size: 11px;
                    color: #666;
                }
                .right-header {
                    text-align: right;
                }
                .info-item {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 8px;
                    justify-content: flex-end;
                }
                .label {
                    font-weight: 600;
                    color: #8b6913;
                    min-width: 70px;
                    text-align: right;
                }
                .value {
                    color: #333;
                    min-width: 60px;
                    text-align: left;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    font-size: 12px;
                }
                th {
                    background: #e6b800;
                    color: white;
                    padding: 10px;
                    text-align: left;
                    font-size: 12px;
                }
                td {
                    padding: 8px 10px;
                    border-bottom: 1px solid #ddd;
                }
                tr:nth-child(even) {
                    background: #f9f9f9;
                }
                .summary {
                    margin-top: 30px;
                    padding: 15px;
                    background: #f9f9f9;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                }
                .footer {
                    margin-top: 40px;
                    text-align: center;
                    font-size: 11px;
                    color: #666;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 0.25in; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="left-header">
                    <div class="logo">‚úà</div>
                    <div class="company-details">
                        <div class="company-name">${company.name}</div>
                        <div class="company-address">${company.address}</div>
                        <div class="company-address">${company.phone}</div>
                    </div>
                </div>
                <div class="right-header">
                    <div class="info-item">
                        <span class="label">STD:</span>
                        <span class="value">${std}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">First Pax:</span>
                        <span class="value">${firstPax}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Last Pax:</span>
                        <span class="value">${lastPax}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Shift:</span>
                        <span class="value">${shift}</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px; font-size: 14px;">
                <strong>Flight:</strong> ${airline} ${flightNo} | <strong>Date:</strong> ${formattedDate}
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Name</th>
                        <th>Seat</th>
                        <th>Pax</th>
                        <th>FQTV</th>
                        <th>Serial No</th>
                        <th>Time</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
    `);
    
    // Add passenger rows
    sortedPassengers.forEach((p, idx) => {
        const serial = String(idx+1).padStart(3,'0');
        printWindow.document.write(`
            <tr>
                <td>${serial}</td>
                <td>${p.pName || '-'}</td>
                <td>${p.seatNo || '-'}</td>
                <td style="text-align:center;">${p.pax || '1'}</td>
                <td>${p.FQTV || '-'}</td>
                <td>${p.serialNo || '-'}</td>
                <td>${p.entryTime || '-'}</td>
                <td>${p.remarks || '-'}</td>
            </tr>
        `);
    });
    
    printWindow.document.write(`
                </tbody>
            </table>
            
            <div class="summary">
                <div><span class="label">Total Passengers:</span> ${sortedPassengers.length}</div>
                <div><span class="label">Total PAX Count:</span> ${totalPaxSum}</div>
                <div><span class="label">Generated:</span> ${new Date().toLocaleString()}</div>
            </div>
            
            <div class="footer">
                <p>This is a computer generated report. Valid without signature.</p>
                <p>¬© ${new Date().getFullYear()} ${company.name}. All rights reserved.</p>
            </div>
            
            <script>
                window.onload = function() { window.print(); window.onafterprint = function() { window.close(); } }
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

    // initialization
    document.addEventListener('DOMContentLoaded', function() {
        fetchOpenShift();
        setInterval(fetchOpenShift, 30000);
        
        // Load dates once when page loads
        setTimeout(() => {
            loadDates();
        }, 1000);
    });

    // global functions
    window.loadDates = loadDates; 
    window.onDateSelected = onDateSelected; 
    window.onFlightSelected = onFlightSelected;
    window.updateSTD = updateSTD; 
    window.updateLastPax = updateLastPax; 
    window.closeFlight = closeFlight;
    window.reopenFlight = reopenFlight; 
    window.printReport = printReport;
    window.fetchOpenShift = fetchOpenShift; 
    window.startEdit = startEdit; 
    window.cancelEdit = cancelEdit;
    window.savePassenger = savePassenger; 
    window.confirmDelete = confirmDelete; 
    window.onSeatChange = onSeatChange;
    window.onPaxChange = onPaxChange; 
    window.updatePaxFromSeat = updatePaxFromSeat; 
    window.validateCloseButton = validateCloseButton;
    </script>
</body>
</html>
