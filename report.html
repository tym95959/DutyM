<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Report - Passenger List</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your config files -->
    <script src="fireshift.js"></script>
    <script src="Co.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f0e1, #fff5e6);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Top Ribbon - Smaller */
        .shift-ribbon {
            background: linear-gradient(135deg, #8b6913, #e6b800);
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(230, 184, 0, 0.3);
            font-size: 13px;
        }
        
        .shift-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .shift-badge {
            background: rgba(255,255,255,0.2);
            padding: 3px 15px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .date-value {
            font-weight: 600;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .refresh-shift {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 3px 12px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .refresh-shift:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Main Card */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(230, 184, 0, 0.15);
            border: 2px solid #e6b800;
            margin-bottom: 20px;
        }
        
        /* Compact Selection Bar */
        .selection-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #fff9e6;
            padding: 12px 15px;
            border-radius: 40px;
            border: 1px solid rgba(230, 184, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .compact-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 5px 12px;
            border-radius: 30px;
            border: 1px solid rgba(230, 184, 0, 0.2);
        }
        
        .compact-group label {
            color: #8b6913;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .compact-control {
            padding: 5px 10px;
            border: none;
            font-size: 13px;
            background: transparent;
            min-width: 140px;
            cursor: pointer;
        }
        
        .compact-control:focus {
            outline: none;
        }
        
        .compact-control:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .fetch-btn-small {
            background: #e6b800;
            color: white;
            border: none;
            padding: 6px 20px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            margin-left: auto;
        }
        
        .fetch-btn-small:hover {
            background: #d4a900;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(230, 184, 0, 0.3);
        }
        
        /* Flight Details Panel - Smaller */
        .flight-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        /* Left Side - Basic Info */
        .basic-info {
            background: #fff9e6;
            border-radius: 12px;
            padding: 15px;
            border-left: 3px solid #e6b800;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            align-items: center;
            font-size: 13px;
        }
        
        .info-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* Right Side - Flight Operations */
        .flight-ops {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(230, 184, 0, 0.3);
        }
        
        .ops-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            align-items: center;
            font-size: 13px;
        }
        
        .ops-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .ops-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .edit-field {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .edit-input {
            padding: 4px 8px;
            border: 1px solid rgba(230, 184, 0, 0.3);
            border-radius: 6px;
            font-size: 12px;
            width: 100px;
        }
        
        .edit-input:focus {
            outline: none;
            border-color: #e6b800;
        }
        
        .edit-btn {
            background: #e6b800;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-btn:hover {
            background: #d4a900;
        }
        
        .first-pax {
            color: #6b8e23;
            font-weight: 600;
        }
        
        /* Statistics Section - Smaller */
        .stats-section {
            margin-top: 15px;
            padding: 12px 15px;
            background: #f5f0e1;
            border-radius: 12px;
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: #8b6913;
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        
        .stat-number {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Action Buttons - Smaller */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .close-btn {
            background: #c68b5e;
            color: white;
        }
        
        .close-btn:hover:not(:disabled) {
            background: #a67244;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(198, 139, 94, 0.3);
        }
        
        .close-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .reopen-btn {
            background: #6b8e23;
            color: white;
        }
        
        .reopen-btn:hover {
            background: #556b2f;
        }
        
        .save-btn {
            background: #e6b800;
            color: white;
        }
        
        .save-btn:hover {
            background: #d4a900;
        }
        
        .print-btn {
            background: #4a6fa5;
            color: white;
        }
        
        .print-btn:hover:not(:disabled) {
            background: #3a5a84;
        }
        
        .print-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        /* Status Badge */
        .flight-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-open {
            background: #6b8e23;
            color: white;
        }
        
        .status-closed {
            background: #c68b5e;
            color: white;
        }
        
        /* Table Styles - Keep same size */
        .table-container {
            background: white;
            border-radius: 16px;
            border: 2px solid #e6b800;
            overflow: hidden;
        }
        
        .table-header {
            background: linear-gradient(135deg, #faf3e0, #fff5e6);
            padding: 15px 20px;
            border-bottom: 2px solid #e6b800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #8b6913;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .passenger-count {
            background: #6b8e23;
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        
        th {
            background: #e6b800;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(230, 184, 0, 0.2);
            color: #2c3e50;
            font-size: 13px;
        }
        
        tr:hover td {
            background: rgba(230, 184, 0, 0.05);
        }
        
        .serial-no {
            font-weight: 600;
            color: #8b6913;
            font-family: monospace;
        }
        
        .serial-blank {
            color: #c68b5e;
            font-style: italic;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #c68b5e;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #e6b800;
            font-style: italic;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 50%;
            border-top-color: #e6b800;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Table Action Buttons */
        .table-action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 2px;
            transition: all 0.2s;
        }
        
        .edit-table-btn {
            background: #e6b800;
            color: white;
        }
        
        .edit-table-btn:hover {
            background: #d4a900;
        }
        
        .delete-table-btn {
            background: #c68b5e;
            color: white;
        }
        
        .delete-table-btn:hover {
            background: #a67244;
        }
        
        .save-table-btn {
            background: #6b8e23;
            color: white;
        }
        
        .save-table-btn:hover {
            background: #556b2f;
        }
        
        .cancel-table-btn {
            background: #7f8c8d;
            color: white;
        }
        
        .cancel-table-btn:hover {
            background: #5e6a6b;
        }
        
        .action-cell {
            white-space: nowrap;
        }
        
        /* Edit Mode Inputs */
        .edit-mode-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #e6b800;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        
        .edit-mode-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(230, 184, 0, 0.2);
        }
        
        /* Warning Message */
        .pax-warning {
            color: #c68b5e;
            font-size: 10px;
            margin-top: 2px;
            font-style: italic;
        }
        
        .pax-warning button {
            background: none;
            border: 1px solid #c68b5e;
            color: #c68b5e;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .pax-warning button:hover {
            background: #c68b5e;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Ribbon - Smaller -->
        <div class="shift-ribbon" id="shiftRibbon">
            <div class="shift-info">
                <span class="shift-badge" id="shiftBadge">LOADING...</span>
                <span class="date-value" id="ribbonDate">--</span>
            </div>
            <button class="refresh-shift" onclick="fetchOpenShift()">‚Üª REFRESH</button>
        </div>

        <!-- Main Card -->
        <div class="card">
            <!-- Compact Selection Bar -->
            <div class="selection-bar">
                <div class="compact-group">
                    <label>üìÖ DATE</label>
                    <select id="dateSelect" class="compact-control" onclick="loadDates()" onchange="onDateSelected()">
                        <option value="">-- Click to load --</option>
                    </select>
                </div>
                
                <div class="compact-group">
                    <label>‚úà FLIGHT</label>
                    <select id="flightSelect" class="compact-control" onchange="onFlightSelected()" disabled>
                        <option value="">-- Select date --</option>
                    </select>
                </div>
                
                <button class="fetch-btn-small" onclick="loadDates()">‚Üª LOAD DATES</button>
            </div>
            
            <!-- Flight Details Panel -->
            <div id="flightPanel" style="display: none;">
                <div class="flight-panel">
                    <!-- Left Side - Basic Info -->
                    <div class="basic-info">
                        <div class="info-grid">
                            <span class="info-label">Airline:</span>
                            <span class="info-value" id="airlineDisplay">-</span>
                            
                            <span class="info-label">Flight No:</span>
                            <span class="info-value" id="flightNoDisplay">-</span>
                            
                            <span class="info-label">Date:</span>
                            <span class="info-value" id="dateDisplay">-</span>
                            
                            <span class="info-label">Status:</span>
                            <span class="info-value">
                                <span id="flightStatus" class="flight-status status-open">OPEN</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Right Side - Flight Operations -->
                    <div class="flight-ops">
                        <div class="ops-grid">
                            <span class="ops-label">Shift:</span>
                            <span class="ops-value" id="shiftDisplay">-</span>
                            
                            <span class="ops-label">STD:</span>
                            <div class="edit-field">
                                <input type="time" id="stdInput" class="edit-input">
                                <button class="edit-btn" onclick="updateSTD()">Update</button>
                            </div>
                            
                            <span class="ops-label">First Pax:</span>
                            <span class="ops-value first-pax" id="firstPaxDisplay">-</span>
                            
                            <span class="ops-label">Last Pax Left:</span>
                            <div class="edit-field">
                                <input type="time" id="lastPaxInput" class="edit-input">
                                <button class="edit-btn" onclick="updateLastPax()">Update</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Section - Compact -->
                <div class="stats-section">
                    <div class="stat-item">
                        <div class="stat-label">Total Pax</div>
                        <div class="stat-number" id="totalPaxStat">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">First Pax</div>
                        <div class="stat-number" id="firstPaxStat">--:--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Last Pax</div>
                        <div class="stat-number" id="lastPaxStat">--:--</div>
                    </div>
                </div>
                
                <!-- Action Buttons - Compact -->
                <div class="action-buttons">
                    <button id="closeFlightBtn" class="action-btn close-btn" onclick="closeFlight()">
                        üîí CLOSE
                    </button>
                    <button id="reopenFlightBtn" class="action-btn reopen-btn" onclick="reopenFlight()" style="display: none;">
                        üîì REOPEN
                    </button>
                    <button id="printReportBtn" class="action-btn print-btn" onclick="printReport()" disabled>
                        üñ®Ô∏è PRINT
                    </button>
                    <button class="action-btn save-btn" onclick="saveFlightData()">
                        üíæ SAVE
                    </button>
                </div>
            </div>
        </div>

        <!-- Passenger Table - Full Size -->
        <div id="tableContainer" class="table-container" style="display: none;">
            <div class="table-header">
                <h3>‚úà PASSENGER LIST</h3>
                <span class="passenger-count" id="passengerCount">0</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Name</th>
                            <th>Seat No</th>
                            <th>Pax</th>
                            <th>FQTV</th>
                            <th>Serial No</th>
                            <th>Time Added</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="passengerTableBody">
                        <tr>
                            <td colspan="9" class="no-data">Select a flight to view passengers</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let flightsByDate = {};
        let allDates = [];
        let currentFlightData = null;
        let flightReports = {};
        let editingRowId = null; // Track which row is being edited

        // ========== FUNCTION DECLARATIONS ==========
        
        // Calculate PAX from seat number (count alphabetical letters)
        function calculatePaxFromSeat(seatNo) {
            if (!seatNo) return 1;
            
            // Convert to string and count only letters (A-Z)
            const letters = seatNo.toString().match(/[A-Za-z]/g);
            return letters ? letters.length : 1;
        }

        // Handle seat number change in edit mode
        function onSeatChange(docId) {
            const seatInput = document.getElementById(`edit-seatNo-${docId}`);
            const paxInput = document.getElementById(`edit-pax-${docId}`);
            const warningDiv = document.getElementById(`pax-warning-${docId}`);
            
            if (seatInput && paxInput) {
                const calculatedPax = calculatePaxFromSeat(seatInput.value);
                paxInput.value = calculatedPax;
                
                // Show warning that PAX was auto-updated
                if (warningDiv) {
                    warningDiv.textContent = '‚úì PAX auto-updated from seat number';
                    warningDiv.style.color = '#6b8e23';
                    setTimeout(() => {
                        if (warningDiv) warningDiv.textContent = '';
                    }, 3000);
                }
            }
        }

        // Handle PAX change in edit mode
        function onPaxChange(docId) {
            const seatInput = document.getElementById(`edit-seatNo-${docId}`);
            const paxInput = document.getElementById(`edit-pax-${docId}`);
            const warningDiv = document.getElementById(`pax-warning-${docId}`);
            
            if (seatInput && paxInput) {
                const calculatedPax = calculatePaxFromSeat(seatInput.value);
                const enteredPax = parseInt(paxInput.value) || 0;
                
                if (enteredPax !== calculatedPax) {
                    // Show warning
                    if (warningDiv) {
                        warningDiv.innerHTML = `‚ö† PAX mismatch (${enteredPax} vs ${calculatedPax}) <button onclick="updatePaxFromSeat('${docId}')">Fix</button>`;
                        warningDiv.style.color = '#c68b5e';
                    }
                } else {
                    if (warningDiv) warningDiv.textContent = '';
                }
            }
        }

        // Update PAX from seat number when user clicks the button
        function updatePaxFromSeat(docId) {
            const seatInput = document.getElementById(`edit-seatNo-${docId}`);
            const paxInput = document.getElementById(`edit-pax-${docId}`);
            const warningDiv = document.getElementById(`pax-warning-${docId}`);
            
            if (seatInput && paxInput) {
                const calculatedPax = calculatePaxFromSeat(seatInput.value);
                paxInput.value = calculatedPax;
                if (warningDiv) warningDiv.textContent = '';
            }
        }

        // Show notification function
        function showNotification(message, type) {
            console.log(message);
        }

        // Fetch open shift from passengerDb
        async function fetchOpenShift() {
            try {
                const shiftBadge = document.getElementById('shiftBadge');
                const ribbonDate = document.getElementById('ribbonDate');
                const ribbon = document.getElementById('shiftRibbon');
                
                shiftBadge.textContent = 'LOADING...';
                ribbonDate.textContent = '--';
                
                if (typeof passengerDb === 'undefined') {
                    throw new Error('Database not initialized');
                }
                
                const shiftDoc = await passengerDb.collection('shifts').doc('currentshift').get();
                
                if (shiftDoc.exists) {
                    const data = shiftDoc.data();
                    const date = data.date || 'No date';
                    const morning = data.morning || 'closed';
                    const evening = data.evening || 'closed';
                    
                    if (morning === 'open') {
                        shiftBadge.textContent = 'MORNING SHIFT';
                        ribbonDate.textContent = date;
                        ribbon.style.background = 'linear-gradient(135deg, #6b8e23, #8b6913)';
                    } 
                    else if (evening === 'open') {
                        shiftBadge.textContent = 'EVENING SHIFT';
                        ribbonDate.textContent = date;
                        ribbon.style.background = 'linear-gradient(135deg, #c68b5e, #8b6913)';
                    } 
                    else {
                        shiftBadge.textContent = 'NO OPEN SHIFT';
                        ribbonDate.textContent = date;
                        ribbon.style.background = 'linear-gradient(135deg, #7f8c8d, #5e4a1a)';
                    }
                } else {
                    throw new Error('Shift document not found');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('shiftBadge').textContent = 'ERROR';
                document.getElementById('ribbonDate').textContent = '--';
            }
        }

        // Load dates from KoveliPass
        let isLoadingDates = false;
        
        async function loadDates() {
            if (isLoadingDates) return;
            
            const dateSelect = document.getElementById('dateSelect');
            
            // Always reload dates when button is clicked
            isLoadingDates = true;
            
            dateSelect.innerHTML = '<option value="">Loading...</option>';
            dateSelect.disabled = true;
            
            try {
                if (typeof db === 'undefined') {
                    throw new Error('Database psysko-8d035 not initialized');
                }
                
                const snapshot = await db.collection('KoveliPass').get();
                
                if (snapshot.empty) {
                    dateSelect.innerHTML = '<option value="">No dates found</option>';
                    dateSelect.disabled = false;
                    isLoadingDates = false;
                    return;
                }
                
                const dates = new Set();
                flightsByDate = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.date;
                    const docId = doc.id;
                    
                    if (date) {
                        dates.add(date);
                        
                        if (!flightsByDate[date]) {
                            flightsByDate[date] = new Map();
                        }
                        
                        const flightKey = `${data.flightNo}_${data.shift || 'UNKNOWN'}`;
                        
                        if (!flightsByDate[date].has(flightKey)) {
                            flightsByDate[date].set(flightKey, {
                                flightNo: data.flightNo,
                                shift: data.shift || 'UNKNOWN',
                                airline: data.airline || '',
                                passengers: [],
                                firstPax: null,
                                lastPax: null,
                                std: '',
                                isClosed: false
                            });
                        }
                        
                        const flightData = flightsByDate[date].get(flightKey);
                        flightData.passengers.push({
                            docId: docId,
                            pName: data.pName || '',
                            seatNo: data.seatNo || '',
                            pax: data.pax || '1',
                            FQTV: data.FQTV || '',
                            entryTime: data.entryTime || '',
                            remarks: data.remarks || '',
                            serialNo: data.serialNo || ''
                        });
                        
                        if (data.entryTime) {
                            if (!flightData.firstPax || data.entryTime < flightData.firstPax) {
                                flightData.firstPax = data.entryTime;
                            }
                            if (!flightData.lastPax || data.entryTime > flightData.lastPax) {
                                flightData.lastPax = data.entryTime;
                            }
                        }
                    }
                });
                
                allDates = Array.from(dates).sort().reverse();
                
                let options = '<option value="">-- Select date --</option>';
                allDates.forEach(date => {
                    options += `<option value="${date}">${date}</option>`;
                });
                
                dateSelect.innerHTML = options;
                dateSelect.disabled = false;
                
            } catch (error) {
                console.error('Error fetching dates:', error);
                dateSelect.innerHTML = '<option value="">Error loading</option>';
                dateSelect.disabled = false;
            } finally {
                isLoadingDates = false;
            }
        }

        // When date is selected
        function onDateSelected() {
            const dateSelect = document.getElementById('dateSelect');
            const flightSelect = document.getElementById('flightSelect');
            const selectedDate = dateSelect.value;
            
            flightSelect.innerHTML = '<option value="">-- Select flight --</option>';
            flightSelect.disabled = true;
            
            document.getElementById('flightPanel').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            editingRowId = null;
            
            if (!selectedDate) {
                return;
            }
            
            const flights = flightsByDate[selectedDate];
            if (!flights) return;
            
            const flightsArray = Array.from(flights.values()).sort((a, b) => 
                a.flightNo.localeCompare(b.flightNo)
            );
            
            let options = '<option value="">-- Select flight --</option>';
            flightsArray.forEach((flight) => {
                options += `<option value="${flight.flightNo}|${flight.shift}">${flight.flightNo}</option>`;
            });
            
            flightSelect.innerHTML = options;
            flightSelect.disabled = false;
        }

        // When flight is selected
        function onFlightSelected() {
            const dateSelect = document.getElementById('dateSelect');
            const flightSelect = document.getElementById('flightSelect');
            
            const selectedDate = dateSelect.value;
            const selectedFlight = flightSelect.value;
            
            if (!selectedDate || !selectedFlight) {
                document.getElementById('flightPanel').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'none';
                return;
            }
            
            const [flightNo, shift] = selectedFlight.split('|');
            const flightKey = `${flightNo}_${shift}`;
            const flightData = flightsByDate[selectedDate]?.get(flightKey);
            
            if (!flightData) return;
            
            currentFlightData = flightData;
            editingRowId = null;
            
            document.getElementById('airlineDisplay').textContent = flightData.airline || '-';
            document.getElementById('flightNoDisplay').textContent = flightNo;
            document.getElementById('dateDisplay').textContent = selectedDate;
            document.getElementById('shiftDisplay').textContent = shift;
            document.getElementById('firstPaxDisplay').textContent = flightData.firstPax || '-';
            document.getElementById('stdInput').value = flightData.std || '';
            document.getElementById('lastPaxInput').value = flightData.lastPax || '';
            document.getElementById('totalPaxStat').textContent = flightData.passengers.length;
            document.getElementById('firstPaxStat').textContent = flightData.firstPax || '--:--';
            document.getElementById('lastPaxStat').textContent = flightData.lastPax || '--:--';
            document.getElementById('passengerCount').textContent = flightData.passengers.length + ' PAX';
            
            document.getElementById('flightPanel').style.display = 'block';
            
            displayPassengerTable(flightData.passengers);
        }
        
        function displayPassengerTable(passengers) {
            const tbody = document.getElementById('passengerTableBody');
            
            if (!passengers || passengers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No passengers found for this flight</td></tr>';
                document.getElementById('tableContainer').style.display = 'block';
                return;
            }
            
            const sortedPassengers = [...passengers].sort((a, b) => {
                if (a.entryTime && b.entryTime) {
                    return a.entryTime.localeCompare(b.entryTime);
                }
                return 0;
            });
            
            let html = '';
            sortedPassengers.forEach((p, index) => {
                const serialNo = String(index + 1).padStart(3, '0');
                const fbSerialNo = p.serialNo || '';
                
                if (editingRowId === p.docId) {
                    // Edit Mode
                    html += `<tr id="edit-row-${p.docId}">
                        <td class="serial-no">${serialNo}</td>
                        <td><input type="text" id="edit-pName-${p.docId}" value="${p.pName || ''}" class="edit-mode-input"></td>
                        <td>
                            <input type="text" id="edit-seatNo-${p.docId}" value="${p.seatNo || ''}" class="edit-mode-input" 
                                oninput="onSeatChange('${p.docId}')" onchange="onPaxChange('${p.docId}')">
                            <div id="pax-warning-${p.docId}" class="pax-warning"></div>
                        </td>
                        <td>
                            <input type="number" id="edit-pax-${p.docId}" value="${p.pax || '1'}" class="edit-mode-input" 
                                style="width:60px; text-align:center;" min="1" onchange="onPaxChange('${p.docId}')">
                        </td>
                        <td><input type="text" id="edit-FQTV-${p.docId}" value="${p.FQTV || ''}" class="edit-mode-input"></td>
                        <td><input type="text" id="edit-serialNo-${p.docId}" value="${p.serialNo || ''}" class="edit-mode-input"></td>
                        <td>${p.entryTime || '-'}</td>
                        <td><input type="text" id="edit-remarks-${p.docId}" value="${p.remarks || ''}" class="edit-mode-input"></td>
                        <td class="action-cell">
                            <button class="table-action-btn save-table-btn" onclick="savePassenger('${p.docId}')">Save</button>
                            <button class="table-action-btn cancel-table-btn" onclick="cancelEdit()">Cancel</button>
                        </td>
                    </tr>`;
                } else {
                    // View Mode
                    html += `<tr>
                        <td class="serial-no">${serialNo}</td>
                        <td>${p.pName || '-'}</td>
                        <td>${p.seatNo || '-'}</td>
                        <td style="text-align: center;">${p.pax || '1'}</td>
                        <td>${p.FQTV || '-'}</td>
                        <td class="${fbSerialNo ? 'serial-no' : 'serial-blank'}">${fbSerialNo || '‚Äî'}</td>
                        <td>${p.entryTime || '-'}</td>
                        <td>${p.remarks || '-'}</td>
                        <td class="action-cell">
                            <button class="table-action-btn edit-table-btn" onclick="startEdit('${p.docId}')">Edit</button>
                            <button class="table-action-btn delete-table-btn" onclick="confirmDelete('${p.docId}', '${p.pName}')">Delete</button>
                        </td>
                    </tr>`;
                }
            });
            
            tbody.innerHTML = html;
            document.getElementById('tableContainer').style.display = 'block';
        }

        // Start editing a row
        function startEdit(docId) {
            editingRowId = docId;
            displayPassengerTable(currentFlightData.passengers);
        }

        // Cancel editing
        function cancelEdit() {
            editingRowId = null;
            displayPassengerTable(currentFlightData.passengers);
        }

        // Save passenger edits
        async function savePassenger(docId) {
            try {
                const pName = document.getElementById(`edit-pName-${docId}`).value;
                const seatNo = document.getElementById(`edit-seatNo-${docId}`).value;
                const pax = document.getElementById(`edit-pax-${docId}`).value;
                const FQTV = document.getElementById(`edit-FQTV-${docId}`).value;
                const serialNo = document.getElementById(`edit-serialNo-${docId}`).value;
                const remarks = document.getElementById(`edit-remarks-${docId}`).value;

                const calculatedPax = calculatePaxFromSeat(seatNo);
                if (parseInt(pax) !== calculatedPax) {
                    if (!confirm(`WARNING: PAX (${pax}) doesn't match seat (${seatNo}) which indicates ${calculatedPax} PAX. Save anyway?`)) {
                        return;
                    }
                }

                await db.collection('KoveliPass').doc(docId).update({
                    pName: pName,
                    seatNo: seatNo,
                    pax: pax,
                    FQTV: FQTV,
                    serialNo: serialNo,
                    remarks: remarks,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                const passenger = currentFlightData.passengers.find(p => p.docId === docId);
                if (passenger) {
                    passenger.pName = pName;
                    passenger.seatNo = seatNo;
                    passenger.pax = pax;
                    passenger.FQTV = FQTV;
                    passenger.serialNo = serialNo;
                    passenger.remarks = remarks;
                }

                editingRowId = null;
                displayPassengerTable(currentFlightData.passengers);
                alert('Passenger updated successfully');
                
            } catch (error) {
                console.error('Error updating passenger:', error);
                alert('Error updating passenger: ' + error.message);
            }
        }

        // Confirm and delete passenger
        function confirmDelete(docId, passengerName) {
            if (confirm(`Delete passenger "${passengerName}"? This cannot be undone.`)) {
                deletePassenger(docId);
            }
        }

        // Delete passenger from Firebase
        async function deletePassenger(docId) {
            try {
                await db.collection('KoveliPass').doc(docId).delete();

                const passengerIndex = currentFlightData.passengers.findIndex(p => p.docId === docId);
                if (passengerIndex !== -1) {
                    currentFlightData.passengers.splice(passengerIndex, 1);
                }

                document.getElementById('totalPaxStat').textContent = currentFlightData.passengers.length;
                document.getElementById('passengerCount').textContent = currentFlightData.passengers.length + ' PAX';

                displayPassengerTable(currentFlightData.passengers);
                alert('Passenger deleted successfully');
                
            } catch (error) {
                console.error('Error deleting passenger:', error);
                alert('Error deleting passenger: ' + error.message);
            }
        }

        function updateSTD() {
            const stdValue = document.getElementById('stdInput').value;
            if (stdValue && currentFlightData) {
                currentFlightData.std = stdValue;
                showNotification('STD updated', 'success');
            }
        }
        
        function updateLastPax() {
            const lastPaxValue = document.getElementById('lastPaxInput').value;
            if (lastPaxValue && currentFlightData) {
                currentFlightData.lastPax = lastPaxValue;
                document.getElementById('lastPaxStat').textContent = lastPaxValue;
                showNotification('Last Pax updated', 'success');
            }
        }
        
        async function closeFlight() {
            if (!currentFlightData) return;
            
            if (!confirm('Close this flight?')) {
                return;
            }
            
            currentFlightData.isClosed = true;
            
            document.getElementById('flightStatus').textContent = 'CLOSED';
            document.getElementById('flightStatus').className = 'flight-status status-closed';
            document.getElementById('closeFlightBtn').style.display = 'none';
            document.getElementById('reopenFlightBtn').style.display = 'block';
            document.getElementById('printReportBtn').disabled = false;
            
            await saveFlightData();
            alert('Flight closed successfully!');
        }
        
        async function reopenFlight() {
            if (!currentFlightData) return;
            
            if (!confirm('Reopen this flight?')) {
                return;
            }
            
            currentFlightData.isClosed = false;
            
            document.getElementById('flightStatus').textContent = 'OPEN';
            document.getElementById('flightStatus').className = 'flight-status status-open';
            document.getElementById('closeFlightBtn').style.display = 'block';
            document.getElementById('reopenFlightBtn').style.display = 'none';
            document.getElementById('printReportBtn').disabled = true;
            
            await saveFlightData();
            alert('Flight reopened successfully!');
        }
        
        async function saveFlightData() {
            if (!currentFlightData) return;
            
            try {
                const selectedDate = document.getElementById('dateDisplay').textContent;
                const reportId = `${currentFlightData.flightNo}_${selectedDate}`;
                
                const reportData = {
                    flightNo: currentFlightData.flightNo,
                    date: selectedDate,
                    shift: currentFlightData.shift,
                    airline: currentFlightData.airline,
                    std: currentFlightData.std || '',
                    firstPax: currentFlightData.firstPax || '',
                    lastPax: currentFlightData.lastPax || '',
                    totalPax: currentFlightData.passengers.length,
                    isClosed: currentFlightData.isClosed || false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('FlightReports').doc(reportId).set(reportData, { merge: true });
                alert('Flight data saved successfully!');
                
            } catch (error) {
                console.error('Error saving flight data:', error);
                alert('Error saving flight data: ' + error.message);
            }
        }

        function printReport() {
            if (!currentFlightData || !currentFlightData.isClosed) {
                alert('Flight must be closed to print report');
                return;
            }
            
            const companyName = window.companyInfo?.name || "Company Name";
            const companyAddress = window.companyInfo?.address || "Company Address";
            const companyPhone = window.companyInfo?.phone || "Company Phone";
            
            const selectedDate = document.getElementById('dateDisplay').textContent;
            const flightNo = currentFlightData.flightNo;
            const airline = currentFlightData.airline;
            const shift = currentFlightData.shift;
            const std = currentFlightData.std || '--:--';
            const firstPax = currentFlightData.firstPax || '--:--';
            const lastPax = currentFlightData.lastPax || '--:--';
            
            const dateParts = selectedDate.split('-');
            const formattedDate = dateParts[2] + '/' + dateParts[1] + '/' + dateParts[0];
            
            const sortedPassengers = [...currentFlightData.passengers].sort((a, b) => {
                if (a.entryTime && b.entryTime) return a.entryTime.localeCompare(b.entryTime);
                return 0;
            });
            
            const totalPax = sortedPassengers.reduce((sum, p) => sum + (parseInt(p.pax) || 1), 0);
            
            const printWindow = window.open('', '_blank');
            
            let html = `<!DOCTYPE html>
<html>
<head>
    <title>Flight ${flightNo} Report</title>
    <style>
        @media print {
            @page { size: A4; margin: 1.5cm 1cm; }
            body { font-family: Arial; font-size: 11px; }
            .header { display: flex; justify-content: space-between; border-bottom: 3px solid #e6b800; margin-bottom: 20px; padding-bottom: 20px; }
            .company-name { font-size: 24px; font-weight: bold; color: #8b6913; }
            table { width: 100%; border-collapse: collapse; }
            th { background: #e6b800; color: white; padding: 8px; text-align: left; }
            td { padding: 6px; border-bottom: 1px solid #e6d8a5; }
            .footer { margin-top: 30px; border-top: 2px solid #e6b800; padding-top: 20px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="company-name">${companyName}</div>
            <div>${companyAddress}<br>${companyPhone}</div>
        </div>
        <div>
            <h2>FLIGHT REPORT</h2>
            <div>${flightNo} - ${formattedDate}</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-bottom: 20px;">
        <div><strong>Airline:</strong> ${airline}</div>
        <div><strong>Flight No:</strong> ${flightNo}</div>
        <div><strong>Date:</strong> ${formattedDate}</div>
        <div><strong>Shift:</strong> ${shift}</div>
        <div><strong>STD:</strong> ${std}</div>
        <div><strong>First Pax:</strong> ${firstPax}</div>
        <div><strong>Last Pax:</strong> ${lastPax}</div>
        <div><strong>Total Pax:</strong> ${totalPax}</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>No.</th>
                <th>Name</th>
                <th>Seat</th>
                <th>Pax</th>
                <th>FQTV</th>
                <th>Serial</th>
                <th>Time</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody>`;
        
        sortedPassengers.forEach((p, index) => {
            html += `<tr>
                <td>${String(index + 1).padStart(3, '0')}</td>
                <td>${p.pName || '-'}</td>
                <td>${p.seatNo || '-'}</td>
                <td>${p.pax || '1'}</td>
                <td>${p.FQTV || '-'}</td>
                <td>${p.serialNo || '-'}</td>
                <td>${p.entryTime || '-'}</td>
                <td>${p.remarks || '-'}</td>
            </tr>`;
        });
        
        html += `</tbody>
    </table>
    
    <div class="footer">
        <div style="display: flex; justify-content: space-between;">
            <div>Prepared By: __________________</div>
            <div>Checked By: __________________</div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            Printed: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
        </div>
    </div>
</body>
</html>`;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 500);
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            fetchOpenShift();
            setInterval(fetchOpenShift, 30000);
        });

        // Make functions globally available
        window.loadDates = loadDates;
        window.onDateSelected = onDateSelected;
        window.onFlightSelected = onFlightSelected;
        window.updateSTD = updateSTD;
        window.updateLastPax = updateLastPax;
        window.closeFlight = closeFlight;
        window.reopenFlight = reopenFlight;
        window.saveFlightData = saveFlightData;
        window.printReport = printReport;
        window.fetchOpenShift = fetchOpenShift;
        window.startEdit = startEdit;
        window.cancelEdit = cancelEdit;
        window.savePassenger = savePassenger;
        window.confirmDelete = confirmDelete;
        window.onSeatChange = onSeatChange;
        window.onPaxChange = onPaxChange;
        window.updatePaxFromSeat = updatePaxFromSeat;
    </script>
</body>
</html>
