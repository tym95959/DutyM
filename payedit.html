<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koveli Lounge - Edit Receipts</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your combined firebase config file -->
    <script src="fireshift.js"></script>
    
    <!-- External rate.js file with pricing data -->
    <script src="rate.js"></script>
    
    <!-- External Co.js file with company header -->
    <script src="Co.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(120deg, #faf3e0, #fff5e6);
            min-height: 100vh;
            padding: 30px;
        }
        
        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(230, 184, 0, 0.15);
            border: 1px solid rgba(230, 184, 0, 0.2);
            overflow: hidden;
            backdrop-filter: blur(5px);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(90deg, #fff9e6, #ffffff);
            border-bottom: 2px solid rgba(230, 184, 0, 0.3);
        }
        
        .header h2 {
            color: #8b6913;
            font-size: 26px;
            font-weight: 600;
        }
        
        .nav-menu {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #e6b800, #d4a900);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(230, 184, 0, 0.3);
        }
        
        .nav-btn.primary {
            background: linear-gradient(135deg, #6b8e23, #556b2f);
        }
        
        .main-content {
            padding: 30px;
        }
        
        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 50px;
            font-size: 16px;
            background: white;
            transition: all 0.3s;
            padding-left: 45px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8b6913;
            font-size: 20px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #e6b800;
            box-shadow: 0 5px 15px rgba(230, 184, 0, 0.1);
        }
        
        .filter-select {
            padding: 15px 25px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 50px;
            font-size: 14px;
            background: white;
            min-width: 150px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #e6b800;
        }
        
        .refresh-btn {
            background: #f0f0f0;
            border: 1px solid #e6b800;
            color: #8b6913;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: #e6b800;
            color: white;
            transform: rotate(180deg);
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(145deg, #fff9e6, #fff2d7);
            border: 2px solid #e6b800;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card .label {
            color: #8b6913;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            color: #6b8e23;
            font-size: 32px;
            font-weight: 700;
        }
        
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 2px 10px rgba(230, 184, 0, 0.1);
            border: 1px solid rgba(230, 184, 0, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background: linear-gradient(135deg, #faf3e0, #fff5e6);
            color: #8b6913;
            padding: 15px 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 2px solid #e6b800;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid rgba(230, 184, 0, 0.1);
            color: #5e4a1a;
            font-size: 13px;
        }
        
        tr:hover td {
            background: rgba(230, 184, 0, 0.05);
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
        }
        
        .edit-btn {
            background: #e6b800;
            color: white;
        }
        
        .edit-btn:hover {
            background: #d4a900;
            transform: translateY(-2px);
        }
        
        .view-btn {
            background: #8b6913;
            color: white;
        }
        
        .view-btn:hover {
            background: #6b4f0f;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background: #c68b5e;
            color: white;
        }
        
        .status-completed {
            background: #6b8e23;
            color: white;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #fff9e6, #fff2d7);
            margin: 30px auto;
            padding: 30px;
            border: 3px solid #e6b800;
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-modal {
            position: absolute;
            right: 25px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #8b6913;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close-modal:hover {
            color: #c68b5e;
            transform: scale(1.2);
        }
        
        .modal h3 {
            color: #8b6913;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(230, 184, 0, 0.3);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: #8b6913;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 12px;
            font-size: 14px;
            background: white;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #e6b800;
            box-shadow: 0 0 0 3px rgba(230, 184, 0, 0.1);
        }
        
        .form-group input[readonly] {
            background-color: #f5f5f5;
            color: #8b6913;
        }
        
        .calculation-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            padding: 20px 0;
            border-top: 2px solid rgba(230, 184, 0, 0.3);
            border-bottom: 2px solid rgba(230, 184, 0, 0.3);
        }
        
        .amount-display {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid #e6b800;
        }
        
        .amount-display .label {
            color: #8b6913;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .amount-display .value {
            color: #6b8e23;
            font-size: 24px;
            font-weight: 700;
        }
        
        .amount-display .currency {
            color: #8b6913;
            font-size: 16px;
            margin-left: 5px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .save-btn {
            background: #6b8e23;
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .save-btn:hover {
            background: #556b2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(107, 142, 35, 0.3);
        }
        
        .print-btn {
            background: #8b6913;
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .print-btn:hover {
            background: #6b4f0f;
            transform: translateY(-2px);
        }
        
        .cancel-btn {
            background: #c68b5e;
            color: white;
            border: none;
            padding: 12px 35px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: #a67244;
        }
        
        .warning-note {
            background: rgba(198, 139, 94, 0.1);
            border: 1px dashed #c68b5e;
            border-radius: 12px;
            padding: 10px;
            margin: 15px 0;
            text-align: center;
            color: #c68b5e;
            font-weight: 600;
        }
        
        .loading {
            color: #e6b800;
            font-style: italic;
            text-align: center;
            padding: 50px;
        }
        
        .footer-note {
            text-align: center;
            margin-top: 20px;
            color: #8b6913;
            font-size: 14px;
            opacity: 0.7;
        }
        
        .receipt-print {
            display: none;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .receipt-print, .receipt-print * {
                visibility: visible;
            }
            .receipt-print {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                padding: 10px;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                background: white;
                color: black;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h2>KOVELI LOUNGE - EDIT RECEIPTS</h2>
            <div class="nav-menu">
                <a href="koveli-parser.html" class="nav-btn primary">‚Üê BACK TO PARSER</a>
                <a href="koveli-approval.html" class="nav-btn">‚è≥ PENDING APPROVALS</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Search Section -->
            <div class="search-section">
                <div class="search-box">
                    <i>üîç</i>
                    <input type="text" id="searchInput" placeholder="Search by Receipt No, Passenger Name, Flight No...">
                </div>
                <select class="filter-select" id="paymentFilter">
                    <option value="ALL">All Payments</option>
                    <option value="CASH">Cash</option>
                    <option value="CARD">Card</option>
                    <option value="BANK TRANSFER">Bank Transfer</option>
                    <option value="MOBILE PAYMENT">Mobile Payment</option>
                </select>
                <select class="filter-select" id="statusFilter">
                    <option value="ALL">All Status</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="PENDING_APPROVAL">Pending Approval</option>
                </select>
                <button class="refresh-btn" id="refreshBtn">‚Üª</button>
            </div>

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="label">TOTAL RECEIPTS</div>
                    <div class="value" id="totalReceipts">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">CASH</div>
                    <div class="value" id="totalCash">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">CARD</div>
                    <div class="value" id="totalCard">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">BANK TRANSFER</div>
                    <div class="value" id="totalBank">0</div>
                </div>
            </div>

            <!-- Receipts Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Receipt No</th>
                            <th>Date/Time</th>
                            <th>Passenger</th>
                            <th>Flight</th>
                            <th>Seat</th>
                            <th>Payment</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="9" class="loading">Loading receipts...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="footer-note">
                Click Edit to modify any receipt - all calculations will update automatically
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h3>EDIT RECEIPT - <span id="modalReceiptNo"></span></h3>
            
            <input type="hidden" id="editReceiptNo">
            <input type="hidden" id="editOriginalPaymentMethod">
            
            <!-- Boarding Pass Details - NOW EDITABLE -->
            <div class="grid-3">
                <div class="form-group">
                    <label>PASSENGER NAME *</label>
                    <input type="text" id="editPName" placeholder="Enter passenger name" required>
                </div>
                <div class="form-group">
                    <label>FLIGHT NUMBER *</label>
                    <input type="text" id="editFlightNo" placeholder="Enter flight number" required>
                </div>
                <div class="form-group">
                    <label>SEAT NUMBER *</label>
                    <input type="text" id="editSeatNo" placeholder="Enter seat number" required>
                </div>
            </div>

            <!-- Editable Fields -->
            <div class="grid-4">
                <div class="form-group">
                    <label>ADULT</label>
                    <input type="number" id="editAdult" min="0" value="1" onchange="calculateEditPrices()">
                </div>
                <div class="form-group">
                    <label>CHILDREN</label>
                    <input type="number" id="editChildren" min="0" value="0" onchange="calculateEditPrices()">
                </div>
                <div class="form-group">
                    <label>CURRENCY</label>
                    <select id="editCurrency" onchange="calculateEditPrices()">
                        <option value="USD">USD</option>
                        <option value="MVR">MVR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>RATE TYPE</label>
                    <select id="editRateType" onchange="calculateEditPrices()">
                        <option value="A">RATE A</option>
                        <option value="B">RATE B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>PAYMENT METHOD</label>
                    <select id="editPaymentMethod" onchange="handleEditPaymentMethodChange()">
                        <option value="CASH">CASH</option>
                        <option value="CARD">CARD</option>
                        <option value="BANK TRANSFER">BANK TRANSFER</option>
                        <option value="MOBILE PAYMENT">MOBILE PAYMENT</option>
                        <option value="VOUCHER">VOUCHER</option>
                        <option value="OTHER">OTHER</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>APPROVAL CODE</label>
                    <input type="text" id="editApprovalCode" placeholder="For non-cash payments">
                </div>
                <div class="form-group">
                    <label>BATCH NO</label>
                    <input type="text" id="editBatchNo" placeholder="For non-cash payments">
                </div>
                <div class="form-group">
                    <label>EXPIRY TIME</label>
                    <input type="text" id="editExpiryTime" readonly style="background:#f5f5f5;">
                </div>
            </div>

            <!-- Price Breakdown -->
            <div class="grid-2" style="background: rgba(230, 184, 0, 0.05); padding: 15px; border-radius: 12px; margin: 15px 0;">
                <div>
                    <div><strong>Adult Price:</strong> <span id="editAdultPrice">0.00</span> <span id="editAdultCurrency">USD</span></div>
                    <div><strong>Children Price:</strong> <span id="editChildrenPrice">0.00</span> <span id="editChildrenCurrency">USD</span></div>
                </div>
                <div>
                    <div><strong>Adult Subtotal:</strong> <span id="editAdultSubtotal">0.00</span> <span id="editAdultSubtotalCurrency">USD</span></div>
                    <div><strong>Children Subtotal:</strong> <span id="editChildrenSubtotal">0.00</span> <span id="editChildrenSubtotalCurrency">USD</span></div>
                </div>
            </div>

            <!-- Calculation Results -->
            <div class="calculation-row">
                <div class="amount-display">
                    <div class="label">SUBTOTAL</div>
                    <div class="value" id="editSubtotal">0.00</div>
                    <div class="currency" id="editSubtotalCurrency">USD</div>
                </div>
                <div class="amount-display">
                    <div class="label">GST (8%)</div>
                    <div class="value" id="editGst">0.00</div>
                    <div class="currency" id="editGstCurrency">USD</div>
                </div>
                <div class="amount-display" style="background: #e6b800; color: white;">
                    <div class="label" style="color: white;">TOTAL</div>
                    <div class="value" id="editTotal" style="color: white;">0.00</div>
                    <div class="currency" id="editTotalCurrency" style="color: white;">USD</div>
                </div>
            </div>

            <!-- Warning for payment method change -->
            <div class="warning-note" id="editPaymentWarning" style="display: none;">
                ‚ö†Ô∏è Changing payment method will reset approval status. Please review approval codes if needed.
            </div>

            <!-- Modal Actions -->
            <div class="modal-actions">
                <button class="save-btn" onclick="saveEdit()">üíæ SAVE CHANGES</button>
                <button class="print-btn" onclick="printEditedReceipt()">üñ®Ô∏è PRINT RECEIPT</button>
                <button class="cancel-btn" onclick="closeEditModal()">‚úñÔ∏è CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Hidden Receipt Template -->
    <div class="receipt-print" id="receiptTemplate">
        <div id="receiptContent"></div>
    </div>

<script>
let allReceipts = [];
let filteredReceipts = [];
let currentEditReceipt = null;

// ========== LOAD RECEIPTS ==========

async function loadReceipts() {
    try {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading receipts...</td></tr>';
        
        if (typeof passengerDb === 'undefined') {
            throw new Error('passengerDb not initialized');
        }
        
        const kovelipayRef = passengerDb.collection('Kovelipay');
        const snapshot = await kovelipayRef.orderBy('submissionDateTime', 'desc').get();
        
        allReceipts = [];
        snapshot.forEach(doc => {
            allReceipts.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        applyFilters();
        updateStats();
        
    } catch (error) {
        console.error('Error loading receipts:', error);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = `<tr><td colspan="9" class="loading" style="color:#c68b5e;">Error: ${error.message}</td></tr>`;
    }
}

// ========== UPDATE STATISTICS ==========

function updateStats() {
    document.getElementById('totalReceipts').textContent = allReceipts.length;
    document.getElementById('totalCash').textContent = allReceipts.filter(r => r.paymentMethod === 'CASH').length;
    document.getElementById('totalCard').textContent = allReceipts.filter(r => r.paymentMethod === 'CARD').length;
    document.getElementById('totalBank').textContent = allReceipts.filter(r => r.paymentMethod === 'BANK TRANSFER').length;
}

// ========== FILTER FUNCTIONS ==========

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const paymentFilter = document.getElementById('paymentFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredReceipts = allReceipts.filter(receipt => {
        const matchesSearch = searchTerm === '' || 
            receipt.receiptNo?.toLowerCase().includes(searchTerm) ||
            receipt.passengerName?.toLowerCase().includes(searchTerm) ||
            receipt.flightNo?.toLowerCase().includes(searchTerm);
        
        const matchesPayment = paymentFilter === 'ALL' || receipt.paymentMethod === paymentFilter;
        const matchesStatus = statusFilter === 'ALL' || receipt.paymentStatus === statusFilter;
        
        return matchesSearch && matchesPayment && matchesStatus;
    });
    
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    
    if (filteredReceipts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="loading">No receipts found</td></tr>';
        return;
    }
    
    let html = '';
    filteredReceipts.forEach(receipt => {
        const statusClass = receipt.paymentStatus === 'PENDING_APPROVAL' ? 'status-pending' : 'status-completed';
        const statusText = receipt.paymentStatus === 'PENDING_APPROVAL' ? 'PENDING' : 'COMPLETED';
        
        html += `
            <tr>
                <td><strong>${receipt.receiptNo || 'N/A'}</strong></td>
                <td>${receipt.submissionDateTime || 'N/A'}</td>
                <td>${receipt.passengerName || 'N/A'}</td>
                <td>${receipt.flightNo || 'N/A'}</td>
                <td>${receipt.seatNo || 'N/A'}</td>
                <td>${receipt.paymentMethod || 'N/A'}</td>
                <td>${receipt.currency || ''} ${receipt.totalAmount?.toFixed(2) || '0.00'}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn edit-btn" onclick="openEditModal('${receipt.receiptNo}')">‚úèÔ∏è EDIT</button>
                    <button class="action-btn view-btn" onclick="printReceipt('${receipt.receiptNo}')">üñ®Ô∏è PRINT</button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// ========== EDIT MODAL FUNCTIONS ==========

function openEditModal(receiptNo) {
    const receipt = allReceipts.find(r => r.receiptNo === receiptNo);
    if (!receipt) return;
    
    currentEditReceipt = receipt;
    
    // Populate modal fields
    document.getElementById('modalReceiptNo').textContent = receiptNo;
    document.getElementById('editReceiptNo').value = receiptNo;
    document.getElementById('editOriginalPaymentMethod').value = receipt.paymentMethod;
    
    // Now these are editable fields - remove readonly attribute
    document.getElementById('editPName').value = receipt.passengerName || '';
    document.getElementById('editFlightNo').value = receipt.flightNo || '';
    document.getElementById('editSeatNo').value = receipt.seatNo || '';
    
    document.getElementById('editAdult').value = receipt.adult || 1;
    document.getElementById('editChildren').value = receipt.children || 0;
    document.getElementById('editCurrency').value = receipt.currency || 'USD';
    document.getElementById('editRateType').value = receipt.rateType || 'B';
    document.getElementById('editPaymentMethod').value = receipt.paymentMethod || 'CASH';
    document.getElementById('editApprovalCode').value = receipt.approvalCode || '';
    document.getElementById('editBatchNo').value = receipt.batchNo || '';
    document.getElementById('editExpiryTime').value = receipt.expiryDateTime || '';
    
    // Calculate prices
    calculateEditPrices();
    
    // Show/hide warning based on payment method
    handleEditPaymentMethodChange();
    
    // Show modal
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditReceipt = null;
}

function handleEditPaymentMethodChange() {
    const paymentMethod = document.getElementById('editPaymentMethod').value;
    const originalMethod = document.getElementById('editOriginalPaymentMethod').value;
    const warning = document.getElementById('editPaymentWarning');
    
    // Show warning if payment method changed
    if (paymentMethod !== originalMethod) {
        warning.style.display = 'block';
    } else {
        warning.style.display = 'none';
    }
    
    // Enable/disable approval fields based on payment method
    const approvalCode = document.getElementById('editApprovalCode');
    const batchNo = document.getElementById('editBatchNo');
    
    if (paymentMethod === 'CASH') {
        approvalCode.disabled = true;
        batchNo.disabled = true;
        approvalCode.placeholder = 'Not required for cash';
        batchNo.placeholder = 'Not required for cash';
    } else {
        approvalCode.disabled = false;
        batchNo.disabled = false;
        approvalCode.placeholder = 'Enter approval code';
        batchNo.placeholder = 'Enter batch no';
    }
}

function calculateEditPrices() {
    if (typeof rates === 'undefined') {
        console.error('rates not loaded');
        return;
    }
    
    const adult = parseInt(document.getElementById('editAdult').value) || 0;
    const children = parseInt(document.getElementById('editChildren').value) || 0;
    const currency = document.getElementById('editCurrency').value;
    const rateType = document.getElementById('editRateType').value;
    
    const adultRateKey = `Adult${rateType}${currency}`;
    const childrenRateKey = `Kids${rateType}${currency}`;
    
    const adultRate = rates[adultRateKey] || { price: 0, GST: 8 };
    const childrenRate = rates[childrenRateKey] || { price: 0, GST: 8 };
    
    const adultSubtotal = adult * adultRate.price;
    const childrenSubtotal = children * childrenRate.price;
    const subtotal = adultSubtotal + childrenSubtotal;
    
    const gstRate = adultRate.GST || 8;
    const gstAmount = subtotal * (gstRate / 100);
    const totalAmount = subtotal + gstAmount;
    
    // Update display
    document.getElementById('editAdultPrice').textContent = adultRate.price.toFixed(2);
    document.getElementById('editChildrenPrice').textContent = childrenRate.price.toFixed(2);
    document.getElementById('editAdultCurrency').textContent = currency;
    document.getElementById('editChildrenCurrency').textContent = currency;
    
    document.getElementById('editAdultSubtotal').textContent = adultSubtotal.toFixed(2);
    document.getElementById('editChildrenSubtotal').textContent = childrenSubtotal.toFixed(2);
    document.getElementById('editAdultSubtotalCurrency').textContent = currency;
    document.getElementById('editChildrenSubtotalCurrency').textContent = currency;
    
    document.getElementById('editSubtotal').textContent = subtotal.toFixed(2);
    document.getElementById('editGst').textContent = gstAmount.toFixed(2);
    document.getElementById('editTotal').textContent = totalAmount.toFixed(2);
    
    document.getElementById('editSubtotalCurrency').textContent = currency;
    document.getElementById('editGstCurrency').textContent = currency;
    document.getElementById('editTotalCurrency').textContent = currency;
}

// ========== SAVE EDIT ==========

async function saveEdit() {
    // Validate required fields
    const passengerName = document.getElementById('editPName').value.trim();
    const flightNo = document.getElementById('editFlightNo').value.trim();
    const seatNo = document.getElementById('editSeatNo').value.trim();
    
    if (!passengerName || !flightNo || !seatNo) {
        alert('Please fill in Passenger Name, Flight Number, and Seat Number');
        return;
    }
    
    const receiptNo = document.getElementById('editReceiptNo').value;
    const paymentMethod = document.getElementById('editPaymentMethod').value;
    const isCash = paymentMethod === 'CASH';
    
    // Validate approval fields for non-cash
    if (!isCash) {
        const approvalCode = document.getElementById('editApprovalCode').value.trim();
        const batchNo = document.getElementById('editBatchNo').value.trim();
        
        if (!approvalCode || !batchNo) {
            alert('Please enter both Approval Code and Batch No for non-cash payments');
            return;
        }
    }
    
    if (!confirm(`Update receipt ${receiptNo} with new values?`)) {
        return;
    }
    
    try {
        const saveBtn = document.querySelector('.save-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'SAVING...';
        
        const adult = parseInt(document.getElementById('editAdult').value) || 0;
        const children = parseInt(document.getElementById('editChildren').value) || 0;
        const currency = document.getElementById('editCurrency').value;
        const rateType = document.getElementById('editRateType').value;
        
        const adultRateKey = `Adult${rateType}${currency}`;
        const childrenRateKey = `Kids${rateType}${currency}`;
        
        const adultRate = rates[adultRateKey] || { price: 0, GST: 8 };
        const childrenRate = rates[childrenRateKey] || { price: 0, GST: 8 };
        
        const adultSubtotal = adult * adultRate.price;
        const childrenSubtotal = children * childrenRate.price;
        const subtotal = adultSubtotal + childrenSubtotal;
        const gstAmount = subtotal * (adultRate.GST / 100);
        const totalAmount = subtotal + gstAmount;
        
        // Determine payment status
        let paymentStatus = 'COMPLETED';
        if (!isCash) {
            // If it's non-cash and no approval codes yet, keep pending
            const approvalCode = document.getElementById('editApprovalCode').value.trim();
            const batchNo = document.getElementById('editBatchNo').value.trim();
            paymentStatus = (approvalCode && batchNo) ? 'COMPLETED' : 'PENDING_APPROVAL';
        }
        
        const updateData = {
            // Add the newly editable fields
            passengerName: passengerName,
            flightNo: flightNo,
            seatNo: seatNo,
            
            adult: adult,
            children: children,
            currency: currency,
            rateType: rateType,
            paymentMethod: paymentMethod,
            adultPrice: adultRate.price,
            childrenPrice: childrenRate.price,
            adultSubtotal: adultSubtotal,
            childrenSubtotal: childrenSubtotal,
            subtotal: subtotal,
            gstAmount: gstAmount,
            gstRate: adultRate.GST,
            totalAmount: totalAmount,
            approvalCode: document.getElementById('editApprovalCode').value.trim() || '',
            batchNo: document.getElementById('editBatchNo').value.trim() || '',
            paymentStatus: paymentStatus,
            editedAt: new Date().toISOString(),
            editedBy: 'user' // You can add user info here
        };
        
        const kovelipayRef = passengerDb.collection('Kovelipay').doc(receiptNo);
        await kovelipayRef.update(updateData);
        
        alert(`Receipt ${receiptNo} updated successfully!`);
        
        // Reload data
        await loadReceipts();
        closeEditModal();
        
    } catch (error) {
        console.error('Error saving edit:', error);
        alert('Error saving: ' + error.message);
    } finally {
        const saveBtn = document.querySelector('.save-btn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ SAVE CHANGES';
    }
}

// ========== PRINT FUNCTIONS ==========

function printReceipt(receiptNo) {
    const receipt = allReceipts.find(r => r.receiptNo === receiptNo);
    if (!receipt) return;
    
    printReceiptContent(receipt);
}

function printEditedReceipt() {
    if (!currentEditReceipt) return;
    
    // Create updated receipt object with current form values
    const updatedReceipt = {
        ...currentEditReceipt,
        // Get the editable field values from the form
        passengerName: document.getElementById('editPName').value,
        flightNo: document.getElementById('editFlightNo').value,
        seatNo: document.getElementById('editSeatNo').value,
        
        adult: parseInt(document.getElementById('editAdult').value) || 0,
        children: parseInt(document.getElementById('editChildren').value) || 0,
        currency: document.getElementById('editCurrency').value,
        rateType: document.getElementById('editRateType').value,
        paymentMethod: document.getElementById('editPaymentMethod').value,
        adultPrice: parseFloat(document.getElementById('editAdultPrice').textContent),
        childrenPrice: parseFloat(document.getElementById('editChildrenPrice').textContent),
        adultSubtotal: parseFloat(document.getElementById('editAdultSubtotal').textContent),
        childrenSubtotal: parseFloat(document.getElementById('editChildrenSubtotal').textContent),
        subtotal: parseFloat(document.getElementById('editSubtotal').textContent),
        gstAmount: parseFloat(document.getElementById('editGst').textContent),
        totalAmount: parseFloat(document.getElementById('editTotal').textContent),
        approvalCode: document.getElementById('editApprovalCode').value,
        batchNo: document.getElementById('editBatchNo').value,
        expiryDateTime: document.getElementById('editExpiryTime').value,
        editedAt: new Date().toISOString()
    };
    
    printReceiptContent(updatedReceipt);
}

function printReceiptContent(receipt) {
    // Get company header
    let companyHeader = '';
    if (typeof companyInfo !== 'undefined') {
        companyHeader = `
            <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <h1 style="margin: 0; font-size: 18px; font-weight: bold;">${companyInfo.name || 'Koveli Lounge'}</h1>
                <p style="margin: 3px 0; font-size: 11px;">${companyInfo.address || 'Velana International Airport'}</p>
                <p style="margin: 3px 0; font-size: 11px;">Tel: ${companyInfo.phone || '+960 304 6677'}</p>
                <p style="margin: 5px 0 0 0; font-size: 10px;">GST Registered</p>
            </div>
        `;
    }
    
    // Check if edited
    const editedNote = receipt.editedAt ? 
        `<p style="font-size: 9px; color: #c68b5e;">*Edited: ${new Date(receipt.editedAt).toLocaleString()}</p>` : '';
    
    const receiptHTML = `
        <div style="width: 80mm; font-family: 'Courier New', monospace; font-size: 11px; padding: 10px;">
            ${companyHeader}
            
            <div style="margin-bottom: 10px;">
                <p><strong>Receipt #:</strong> ${receipt.receiptNo}</p>
                <p><strong>Date/Time:</strong> ${receipt.submissionDateTime}</p>
                <p><strong>Shift:</strong> ${receipt.shift} - ${receipt.date}</p>
                ${editedNote}
            </div>
            
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 8px 0;">
                <p><strong>Passenger:</strong> ${receipt.passengerName}</p>
                <p><strong>Flight:</strong> ${receipt.flightNo} | Seat: ${receipt.seatNo}</p>
            </div>
            
            <div style="margin: 10px 0;">
                <table style="width: 100%; font-size: 10px;">
                    <tr>
                        <td>Adult x${receipt.adult}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.adultPrice?.toFixed(2)}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.adultSubtotal?.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Children x${receipt.children}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.childrenPrice?.toFixed(2)}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.childrenSubtotal?.toFixed(2)}</td>
                    </tr>
                </table>
            </div>
            
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 8px 0;">
                <table style="width: 100%;">
                    <tr>
                        <td><strong>Subtotal:</strong></td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.subtotal?.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>GST (${receipt.gstRate}%):</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.gstAmount?.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td><strong>TOTAL:</strong></td>
                        <td style="text-align: right;"><strong>${receipt.currency} ${receipt.totalAmount?.toFixed(2)}</strong></td>
                    </tr>
                </table>
            </div>
            
            <div style="margin: 10px 0;">
                <p><strong>Payment:</strong> ${receipt.paymentMethod}</p>
                ${receipt.approvalCode ? `<p><strong>Approval:</strong> ${receipt.approvalCode}</p>` : ''}
                ${receipt.batchNo ? `<p><strong>Batch:</strong> ${receipt.batchNo}</p>` : ''}
                <p><strong>Valid Until:</strong> ${receipt.expiryDateTime}</p>
            </div>
            
            <div style="border-top: 1px dashed #000; padding-top: 10px; text-align: center;">
                <p>Thank you for choosing Koveli Lounge!</p>
                <p>${new Date().toLocaleDateString()}</p>
            </div>
        </div>
    `;
    
    // Open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Receipt ${receipt.receiptNo}</title>
                <style>
                    @media print {
                        body { margin: 0; padding: 10px; }
                    }
                </style>
            </head>
            <body>${receiptHTML}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// ========== INITIALIZATION ==========

document.addEventListener('DOMContentLoaded', function() {
    loadReceipts();
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('paymentFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('refreshBtn').addEventListener('click', loadReceipts);
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    };
    
    // Refresh every 30 seconds
    setInterval(loadReceipts, 30000);
});
</script>
</body>
</html>
