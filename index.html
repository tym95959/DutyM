<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Duty Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    <meta name="description" content="Duty and Leave Management System for staff">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3498db">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="512x512" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    
    <!-- Replace the existing manifest link with this simple one -->
    <link rel="manifest" href="manifest.json">
    
    <title>Duty Management System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Configuration Files -->
    <script src="users.js"></script>
    <script src="dcfire.js"></script>
    
    <!-- Rest of the CSS and HTML remains the same -->
     <style>
        /* Mobile-First CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        #loadingOverlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* Toast Container */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: calc(100% - 40px);
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid #3498db;
        }

        /* Login Page */
        .login-container {
            background: white;
            width: 100%;
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-block {
            width: 100%;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #f5f7fa;
        }

        /* Mobile Header */
        .mobile-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
        }

        .mobile-title {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .mobile-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* Mobile Navigation */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .mobile-nav-overlay.active {
            display: block;
        }

        .mobile-nav {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: white;
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .mobile-nav.active {
            transform: translateX(0);
        }

        .nav-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .nav-user-details {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-items {
            flex: 1;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            color: #2c3e50;
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
        }

        .nav-item.active {
            background: #e8f4fc;
            color: #3498db;
            border-left: 4px solid #3498db;
        }

        .nav-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-item-badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        .nav-footer {
            padding: 20px;
            border-top: 1px solid #f0f0f0;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e6ed;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 99;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #7f8c8d;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }

        .bottom-nav-btn.active {
            color: #3498db;
        }

        .bottom-nav-icon {
            font-size: 20px;
        }

        /* Content Area */
        .dashboard-content {
            padding: 20px;
            padding-bottom: 80px; /* Space for bottom nav */
            min-height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            font-weight: 600;
        }

        /* Balance Display */
        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .balance-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e6ed;
        }

        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .balance-label {
            font-size: 13px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 500;
        }

        /* Form Rows */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
            line-height: 1.4;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Announcement Banner */
        .announcement-banner {
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .announcement-banner.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .announcement-banner.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .announcement-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Duty Time Colors */
        .duty-0730-1530 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }

        .duty-0830-1630 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }

        .duty-1030-1830 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }

        .duty-1530-2330 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }

        .duty-1630-0030 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }

        .duty-leave {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
            color: #e8590c !important;
            border: 1px dashed #fd7e14 !important;
        }

        .off-day-cell {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
            font-weight: 500;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Mobile Optimized Form Elements */
        select.form-control {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237f8c8d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            line-height: 1.4;
        }

        /* Touch-friendly Date Inputs */
        input[type="date"] {
            min-height: 48px;
        }

        /* Responsive Grids */
        @media (min-width: 768px) {
            .balance-display {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1;
                min-width: 200px;
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Mobile Specific */
        @media (max-width: 767px) {
            .dashboard-content {
                padding: 15px;
                padding-bottom: 70px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
            
            th, td {
                padding: 10px;
                font-size: 13px;
            }
            
            .action-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
        
        /* Install App Button */
        #installBtnContainer {
            position: fixed;
            bottom: 90px;
            right: 15px;
            z-index: 1000;
        }
        
        #installBtn {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            animation: pulse 2s infinite;
        }
        
        #installBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        /* Push Notification Permission Prompt */
        .notification-permission {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            animation: slideInUp 0.3s ease;
        }
        
        .notification-permission h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        /* PWA App Styles */
        .standalone-app .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        
        .standalone-app .dashboard-content {
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Animation for new notifications */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
        
        /* Service Worker Status */
        .service-worker-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Install App Button -->
    <div id="installBtnContainer" style="display: none;">
        <button id="installBtn">
            <span>üì±</span> Install App
        </button>
    </div>

    <!-- Service Worker Status -->
    <div id="serviceWorkerStatus" class="service-worker-status" style="display: none;"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <div id="notificationPermissionPrompt" class="notification-permission" style="display: none;">
            <h4>üîî Enable Push Notifications</h4>
            <p>Get instant alerts for duty changes, leave approvals, and messages!</p>
            <button onclick="requestNotificationPermission()" class="btn btn-success" style="margin-top: 10px;">
                <span>üîî</span> Enable Notifications
            </button>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <span>üîê</span> Login
            </button>
            
            <div class="error-message" id="errorMessage" style="color: #e74c3c; margin-top: 10px; display: none;">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header with Notification Badge -->
        <div class="mobile-header">
            <button class="menu-toggle" id="menuToggle">
                ‚ò∞
            </button>
            <div class="mobile-title" id="mobileTitle">Dashboard</div>
            <div class="mobile-user">
                <div class="mobile-avatar" id="mobileAvatar">U</div>
                <div id="headerNotificationBadge" class="notification-badge" style="display: none;">0</div>
            </div>
        </div>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
        <div class="mobile-nav" id="mobileNav">
            <div class="nav-header">
                <div class="nav-user-name" id="navUserName">User Name</div>
                <div class="nav-user-details">
                    <span>RC: <span id="navUserRC">000</span></span>
                    <span>Level: <span id="navUserLevel">User</span></span>
                </div>
            </div>
            
            <div class="nav-items">
                <a href="#" class="nav-item active" data-section="home">
                    <span class="nav-item-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="dutyChange">
                    <span class="nav-item-icon">üîÑ</span>
                    <span>Duty Change</span>
                </a>
                <a href="#" class="nav-item" data-section="leaveApplication">
                    <span class="nav-item-icon">üìÖ</span>
                    <span>Apply Leave</span>
                </a>
                <a href="#" class="nav-item" data-section="myRequests">
                    <span class="nav-item-icon">üìã</span>
                    <span>My Requests</span>
                    <span class="nav-item-badge" id="myRequestsBadge" style="display: none;">0</span>
                </a>
                <a href="#" class="nav-item" data-section="viewMyRoster">
                    <span class="nav-item-icon">üìä</span>
                    <span>My Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="viewAllRoster">
                    <span class="nav-item-icon">üë•</span>
                    <span>All Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="pendingRequests" id="pendingRequestsNav" style="display: none;">
                    <span class="nav-item-icon">‚è≥</span>
                    <span>Pending</span>
                    <span class="nav-item-badge" id="pendingRequestsBadge">0</span>
                </a>
                
                <!-- Admin Sections -->
                <a href="#" class="nav-item admin-nav" data-section="adminAnnouncements" style="display: none;">
                    <span class="nav-item-icon">üì¢</span>
                    <span>Announcements</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminDutyRoster" style="display: none;">
                    <span class="nav-item-icon">üìù</span>
                    <span>Duty Roster</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminLeaveBalance" style="display: none;">
                    <span class="nav-item-icon">üí∞</span>
                    <span>Leave Balance</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminApprovals" style="display: none;">
                    <span class="nav-item-icon">‚úÖ</span>
                    <span>Approvals</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminRequestHistory" style="display: none;">
                    <span class="nav-item-icon">üìú</span>
                    <span>History</span>
                    <span class="nav-item-badge" id="historyNotificationBadge" style="display: none;">!</span>
                </a>
            </div>
            
            <div class="nav-footer">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <span>üö™</span> Logout
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <!-- Notification Settings -->
                    <div id="notificationSettings" class="form-row" style="margin-bottom: 15px;">
                        <button onclick="requestNotificationPermission()" class="btn btn-warning">
                            <span>üîî</span> Notifications: <span id="notificationStatus">Off</span>
                        </button>
                        <button onclick="testPushNotification()" class="btn btn-info">
                            <span>üì±</span> Test Push
                        </button>
                    </div>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;"></div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <span>üîÑ</span> Refresh
                        </button>
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">
                            <span>üîÑ</span> Change Duty
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <span>üìÖ</span> Apply Leave
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToRcNo">Staff RC No</label>
                            <input type="text" id="requestToRcNo" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">
                                <span>üì§</span> Submit Request
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <span>‚ùå</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>‚Ä¢ Sick Leave: Minimum 2 hours before duty time</p>
                        <p>‚Ä¢ FRL: Minimum 1 hour before duty time</p>
                        <p><strong>Note:</strong> Leave balance will be deducted immediately upon submission</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div id="leaveRulesAlert" class="alert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">
                                <span>üì§</span> Submit Application
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <span>‚ùå</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests For You</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View All Roster -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3>Complete Duty Roster</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterStartDate">From Date</label>
                            <input type="date" id="allRosterStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="allRosterEndDate">To Date</label>
                            <input type="date" id="allRosterEndDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="loadAllRoster()">
                            <span>üìä</span> Load Roster
                        </button>
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Admin Announcements -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card">
                    <h3>Create Announcement</h3>
                    <form id="announcementForm">
                        <div class="form-group">
                            <label for="announcementTitle">Title *</label>
                            <input type="text" id="announcementTitle" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementContent">Content *</label>
                            <textarea id="announcementContent" class="form-control" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementPriority">Priority</label>
                            <select id="announcementPriority" class="form-control">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            <span>üì¢</span> Create Announcement
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Active Announcements</h3>
                    <div id="activeAnnouncementsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="bottom-nav-btn active" onclick="showSection('home')">
                <span class="bottom-nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('dutyChange')">
                <span class="bottom-nav-icon">üîÑ</span>
                <span>Change</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('leaveApplication')">
                <span class="bottom-nav-icon">üìÖ</span>
                <span>Leave</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('myRequests')">
                <span class="bottom-nav-icon">üìã</span>
                <span>Requests</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('viewAllRoster')">
                <span class="bottom-nav-icon">üë•</span>
                <span>Roster</span>
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // APPLICATION VARIABLES
        // ============================================
        let currentUser = null;
        let allUsers = []; // Will be populated from users.js
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let announcements = [];
        let isMobile = false;
        let currentToastId = 0;
        let deferredPrompt = null;
        let messaging = null;
        let notificationPermission = 'default';
        let unreadNotifications = 0;
        let db = null;
        let firebaseInitialized = false;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            detectMobile();
            initApp();
            initializeServiceWorker();
            initializeFirebase();
            setupPWAInstall();
            checkNotificationPermission();
        });

        // ... REST OF THE SCRIPT.JS CODE REMAINS THE SAME ...
        // (The functions that reference users will now use the global `users` variable from users.js)
        // (The functions that reference firebaseConfig will now use the global `firebaseConfig` from dcfire.js)

        // ============================================
        // FIREBASE
        // ============================================
        function initializeFirebase() {
            try {
                // firebaseConfig is now defined in dcfire.js
                if (!firebaseConfig) {
                    console.error('Firebase configuration not found in dcfire.js');
                    showToast('Firebase configuration missing', 'error');
                    firebaseInitialized = false;
                    return;
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('Firebase initialized successfully');
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                firebaseInitialized = false;
            }
        }

        // ============================================
        // CORE APPLICATION FUNCTIONS
        // ============================================
        async function handleLogin() {
            showLoading(true, 'Authenticating...');
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showToast('Please enter both username and password', 'warning');
                showLoading(false);
                return;
            }
            
            // users is now defined in users.js
            const user = users.find(u => u.username === username);
            
            if (!user) {
                showToast('Invalid username or password', 'error');
                document.getElementById('errorMessage').style.display = 'block';
                showLoading(false);
                return;
            }
            
            const hashedPassword = sha256(password);
            
            if (hashedPassword === user.passwordHash) {
                const sessionData = {
                    username: user.username,
                    name: user.name,
                    rcNo: user.RCNo,
                    level: user.Level,
                    expiry: Date.now() + (8 * 60 * 60 * 1000)
                };
                
                localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
                await loginUser(sessionData);
                showLoading(false);
            } else {
                showToast('Invalid username or password', 'error');
                document.getElementById('errorMessage').style.display = 'block';
                showLoading(false);
            }
        }

      async function loginUser(userData) {
            currentUser = userData;
            allUsers = users || [];
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            
            document.getElementById('mobileTitle').textContent = 'Dashboard';
            document.getElementById('mobileAvatar').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('navUserName').textContent = userData.name;
            document.getElementById('navUserRC').textContent = userData.rcNo;
            document.getElementById('navUserLevel').textContent = userData.level;
            document.getElementById('welcomeName').textContent = userData.name;
            
            const isAdmin = userData.level === 'Supervisor';
            document.querySelectorAll('.admin-nav').forEach(el => {
                el.style.display = isAdmin ? 'flex' : 'none';
            });
            
            if (Notification.permission === 'granted') {
                await initializeFirebaseMessaging();
            }
            
            setupNotificationListener();
            await initializeData();
            setupEventListeners();
            
            showToast(`Welcome back, ${userData.name}!`, 'success');
            
            setTimeout(() => {
                sendPushNotification(
                    userData.username,
                    'Welcome to Duty Manager!',
                    'You have successfully logged in.',
                    { type: 'welcome' }
                );
            }, 2000);
        }

        async function initializeData() {
            showLoading(true, 'Loading data...');
            
            try {
                await Promise.all([
                    loadDutyRoster(),
                    loadLeaveBalances(),
                    loadAllRequests(),
                    loadAnnouncements()
                ]);
                
                updateUserBalance();
                updateRequestCounts();
                loadHomeAnnouncements();
                
                showLoading(false);
            } catch (error) {
                console.error('Error initializing data:', error);
                showToast('Failed to load data', 'error');
                showLoading(false);
            }
        }

        function updateUserBalance() {
            if (!currentUser) return;
            
            const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
            document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
        }

        function updateRequestCounts() {
            if (!currentUser) return;
            
            const pendingForUser = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            ).length;
            
            const pendingNav = document.getElementById('pendingRequestsNav');
            const pendingBadge = document.getElementById('pendingRequestsBadge');
            
            if (pendingForUser > 0) {
                if (pendingNav) {
                    pendingNav.style.display = 'flex';
                    pendingBadge.textContent = pendingForUser;
                    pendingBadge.style.display = 'inline-block';
                }
            } else {
                if (pendingNav) {
                    pendingNav.style.display = 'none';
                    pendingBadge.style.display = 'none';
                }
            }
            
            const myPending = allRequests.filter(req => 
                req.fromUsername === currentUser.username && 
                req.status === 'pending'
            ).length;
            
            const myBadge = document.getElementById('myRequestsBadge');
            if (myBadge) {
                if (myPending > 0) {
                    myBadge.textContent = myPending;
                    myBadge.style.display = 'inline-block';
                } else {
                    myBadge.style.display = 'none';
                }
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function showSection(sectionId) {
            const titles = {
                home: 'Dashboard',
                dutyChange: 'Duty Change',
                leaveApplication: 'Apply Leave',
                myRequests: 'My Requests',
                pendingRequests: 'Pending Requests',
                viewMyRoster: 'My Roster',
                viewAllRoster: 'All Roster',
                adminAnnouncements: 'Announcements',
                adminDutyRoster: 'Duty Roster',
                adminLeaveBalance: 'Leave Balance',
                adminApprovals: 'Approvals',
                adminRequestHistory: 'History'
            };
            
            document.getElementById('mobileTitle').textContent = titles[sectionId] || sectionId;
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const sectionElement = document.getElementById(sectionId + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.querySelector('span:last-child').textContent.toLowerCase();
                if (sectionId === 'home' && btnText === 'home') btn.classList.add('active');
                if (sectionId === 'dutyChange' && btnText === 'change') btn.classList.add('active');
                if (sectionId === 'leaveApplication' && btnText === 'leave') btn.classList.add('active');
                if (sectionId === 'myRequests' && btnText === 'requests') btn.classList.add('active');
                if (sectionId === 'viewAllRoster' && btnText === 'roster') btn.classList.add('active');
            });
            
            loadSectionData(sectionId);
            
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                dashboardContent.scrollTop = 0;
            }
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'home':
                    updateDashboard();
                    break;
                case 'dutyChange':
                    loadDutyChangeForm();
                    break;
                case 'leaveApplication':
                    loadLeaveForm();
                    break;
                case 'myRequests':
                    loadMyRequests();
                    break;
                case 'pendingRequests':
                    loadPendingRequests();
                    break;
                case 'viewAllRoster':
                    loadAllRoster();
                    break;
                case 'adminAnnouncements':
                    loadAnnouncementsAdmin();
                    break;
            }
        }

        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                    if (textEl) textEl.textContent = text;
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toastId = 'toast-' + (++currentToastId);
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">
                    ${type === 'success' ? '‚úÖ' : 
                      type === 'error' ? '‚ùå' : 
                      type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                const toastElem = document.getElementById(toastId);
                if (toastElem) {
                    toastElem.style.opacity = '0';
                    toastElem.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toastElem.parentNode) {
                            toastElem.parentNode.removeChild(toastElem);
                        }
                    }, 300);
                }
            }, duration);
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        function updateDashboard() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayDutyTime = document.getElementById('todayDutyTime');
            const nextDutyTime = document.getElementById('nextDutyTime');
            
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                const duty = dutyRoster[today][currentUser.username];
                todayDutyTime.textContent = duty === 'Off' ? 'Off Duty' : duty;
            } else {
                todayDutyTime.textContent = 'Not Scheduled';
            }
            
            const tomorrow = new Date();
            let foundNext = false;
            
            for (let i = 1; i <= 7; i++) {
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                    const duty = dutyRoster[dateStr][currentUser.username];
                    if (duty !== 'Off') {
                        const date = new Date(dateStr);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        nextDutyTime.textContent = `${dayName}: ${duty}`;
                        foundNext = true;
                        break;
                    }
                }
            }
            
            if (!foundNext) {
                nextDutyTime.textContent = 'No upcoming duty';
            }
            
            updateUserBalance();
            loadHomeAnnouncements();
        }

        function loadHomeAnnouncements() {
            const container = document.getElementById('homeAnnouncements');
            if (!container) return;
            
            container.innerHTML = '';
            
            const now = new Date();
            const activeAnnouncements = announcements.filter(ann => {
                if (ann.status === 'expired' || ann.status === 'archived') return false;
                if (ann.expiry && new Date(ann.expiry) < now) return false;
                return ann.target === 'all' || 
                       (ann.target === 'specific' && ann.targetUsers && 
                        ann.targetUsers.includes(currentUser.username));
            });
            
            if (activeAnnouncements.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">üì¢</div>
                    <div class="empty-state-title">No Announcements</div>
                `;
                container.appendChild(emptyState);
                return;
            }
            
            const displayAnnouncements = isMobile ? 
                activeAnnouncements.slice(0, 2) : activeAnnouncements;
            
            displayAnnouncements.forEach(ann => {
                const announcementDiv = document.createElement('div');
                announcementDiv.className = `announcement-banner priority-${ann.priority}`;
                
                announcementDiv.innerHTML = `
                    <div class="announcement-title">
                        <span>üì¢</span> ${ann.title}
                    </div>
                    <div style="margin-bottom: 10px; font-size: 14px;">${ann.content}</div>
                    <div style="font-size: 12px; opacity: 0.9;">
                        By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
                    </div>
                `;
                
                container.appendChild(announcementDiv);
            });
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return past.toLocaleDateString();
        }

        // ============================================
        // DUTY CHANGE FUNCTIONS
        // ============================================
        function loadDutyChangeForm() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const changeDateEl = document.getElementById('changeDate');
            if (changeDateEl) changeDateEl.value = tomorrow.toISOString().split('T')[0];
            
            const staffSelect = document.getElementById('requestToStaff');
            if (staffSelect) {
                staffSelect.innerHTML = '<option value="">Select staff member</option>';
                allUsers.forEach(user => {
                    if (user.username !== currentUser.username && user.Level === 'User') {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.name} (RC: ${user.RCNo})`;
                        staffSelect.appendChild(option);
                    }
                });
            }
            
            loadUserDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0]);
        }

        function loadUserDutyTimes(selectId, date) {
            const select = document.getElementById(selectId);
            if (!select || !date || !currentUser) return;
            
            select.innerHTML = '<option value="">Select duty time</option>';
            const dutyTime = dutyRoster[date] && dutyRoster[date][currentUser.username];
            
            if (dutyTime) {
                const option = document.createElement('option');
                option.value = dutyTime;
                option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                select.appendChild(option);
            }
        }

        async function submitDutyChange() {
            if (!currentUser) return;
            
            const date = document.getElementById('changeDate').value;
            const dutyTime = document.getElementById('changeDutyTime').value;
            const toStaff = document.getElementById('requestToStaff').value;
            const toDutyTime = document.getElementById('requestToDutyTime').value;
            const reason = document.getElementById('changeReason').value;
            
            if (!date || !dutyTime || !toStaff || !toDutyTime) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            if (dutyTime === 'Off' || toDutyTime === 'Off') {
                showToast('Cannot request duty change on off days', 'warning');
                return;
            }
            
            const requestDate = new Date(date);
            const now = new Date();
            const hoursDiff = (requestDate - now) / (1000 * 60 * 60);
            
            if (hoursDiff < 24) {
                showToast('Duty changes must be requested at least 24 hours in advance', 'warning');
                return;
            }
            
            const toUser = allUsers.find(u => u.username === toStaff);
            if (!toUser) {
                showToast('Selected staff not found', 'error');
                return;
            }
            
            const request = {
                id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                type: 'dutyChange',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                toUsername: toStaff,
                toName: toUser.name,
                toRcNo: toUser.RCNo,
                toDutyTime: toDutyTime,
                reason: reason,
                status: 'pending',
                timestamp: new Date().toISOString(),
                history: [{
                    action: 'created',
                    by: currentUser.name,
                    timestamp: new Date().toISOString()
                }]
            };
            
            allRequests.push(request);
            
            const success = await saveAllRequests();
            if (success) {
                await sendPushNotification(
                    toStaff,
                    'New Duty Change Request',
                    `${currentUser.name} wants to swap duty on ${date}`,
                    {
                        type: 'dutyChange',
                        requestId: request.id,
                        fromUser: currentUser.username,
                        date: date
                    }
                );
                
                updateRequestCounts();
                showToast('Duty change request submitted! Notification sent.', 'success');
                showSection('home');
                document.getElementById('dutyChangeForm').reset();
            }
        }

        // ============================================
        // LEAVE APPLICATION FUNCTIONS
        // ============================================
        function loadLeaveForm() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const leaveDateEl = document.getElementById('leaveDate');
            if (leaveDateEl) leaveDateEl.value = tomorrow.toISOString().split('T')[0];
            loadUserDutyTimes('leaveDutyTime', tomorrow.toISOString().split('T')[0]);
            updateLeaveRules();
        }

        function updateLeaveRules() {
            const leaveType = document.getElementById('leaveType').value;
            const leaveDate = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const alertDiv = document.getElementById('leaveRulesAlert');
            const submitBtn = document.getElementById('submitLeaveBtn');
            
            if (!leaveType || !leaveDate || !dutyTime) {
                alertDiv.className = 'alert alert-warning';
                alertDiv.textContent = 'Please select leave type, date and duty time';
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            
            if (dutyTime === 'Off' || dutyTime === '') {
                alertDiv.className = 'alert alert-warning';
                alertDiv.textContent = 'You are off duty on this date. No leave needed.';
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            
            const dutyStart = dutyTime.split('-')[0];
            const dutyDateTime = new Date(leaveDate + 'T' + dutyStart + ':00');
            const now = new Date();
            const hoursBeforeDuty = (dutyDateTime - now) / (1000 * 60 * 60);
            
            let canApply = false;
            let message = '';
            
            if (leaveType === 'Sick Leave') {
                canApply = hoursBeforeDuty >= 2;
                message = canApply 
                    ? '‚úÖ You can apply for Sick Leave (2+ hours before duty)'
                    : `‚ùå Need ${Math.ceil(2 - hoursBeforeDuty)} more hours before duty`;
            } else if (leaveType === 'FRL') {
                canApply = hoursBeforeDuty >= 1;
                message = canApply
                    ? '‚úÖ You can apply for FRL (1+ hour before duty)'
                    : `‚ùå Need ${Math.ceil(1 - hoursBeforeDuty)} more hours before duty`;
            }
            
            if (canApply) {
                const duration = parseFloat(document.getElementById('leaveDuration').value) || 1;
                const userBalance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
                
                if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
                    canApply = false;
                    message = `‚ùå Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days`;
                } else if (leaveType === 'FRL' && userBalance.FRL < duration) {
                    canApply = false;
                    message = `‚ùå Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days`;
                }
            }
            
            alertDiv.className = canApply ? 'alert alert-success' : 'alert alert-danger';
            alertDiv.innerHTML = `<strong>${leaveType} Rules:</strong><br>${message}`;
            if (submitBtn) submitBtn.disabled = !canApply;
        }

        async function submitLeaveApplication() {
            if (!currentUser) return;
            
            const leaveType = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const duration = parseFloat(document.getElementById('leaveDuration').value);
            const reason = document.getElementById('leaveReason').value;
            
            if (!leaveType || !date || !dutyTime || !reason) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            if (dutyTime === 'Off' || dutyTime === '') {
                showToast('You are off duty on this date', 'warning');
                return;
            }
            
            const userBalance = leaveBalances[currentUser.username];
            if (!userBalance) {
                showToast('Error: User balance not found', 'error');
                return;
            }
            
            if (leaveType === 'Sick Leave') {
                if (userBalance.SL < duration) {
                    showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days`, 'warning');
                    return;
                }
                userBalance.SL -= duration;
                userBalance.SL = Math.max(0, userBalance.SL);
            } else if (leaveType === 'FRL') {
                if (userBalance.FRL < duration) {
                    showToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days`, 'warning');
                    return;
                }
                userBalance.FRL -= duration;
                userBalance.FRL = Math.max(0, userBalance.FRL);
            }
            
            await saveLeaveBalances();
            
            const request = {
                id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                type: 'leave',
                leaveType: leaveType,
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                duration: duration,
                reason: reason,
                status: 'approved',
                timestamp: new Date().toISOString(),
                approvedBy: 'System (Auto-approved)',
                approvedAt: new Date().toISOString(),
                history: [{
                    action: 'created_and_approved',
                    by: currentUser.name,
                    timestamp: new Date().toISOString(),
                    note: 'Leave balance deducted immediately upon application'
                }]
            };
            
            allRequests.push(request);
            
            const success = await saveAllRequests();
            if (success) {
                updateUserBalance();
                updateRequestCounts();
                
                const supervisor = allUsers.find(u => u.Level === 'Supervisor');
                if (supervisor) {
                    await sendPushNotification(
                        supervisor.username,
                        'New Leave Application',
                        `${currentUser.name} applied for ${leaveType} on ${date}`,
                        {
                            type: 'leaveApplication',
                            requestId: request.id,
                            username: currentUser.username,
                            leaveType: leaveType,
                            date: date
                        }
                    );
                }
                
                showToast(`${leaveType} application submitted successfully! ${duration} day(s) deducted from your balance.`, 'success');
                showSection('home');
                document.getElementById('leaveApplicationForm').reset();
                
                showToast(`New ${leaveType} balance: ${leaveType === 'Sick Leave' ? userBalance.SL.toFixed(1) : userBalance.FRL.toFixed(1)} days`, 'info', 2000);
            }
        }

        // ============================================
        // MY REQUESTS FUNCTIONS
        // ============================================
        function loadMyRequests() {
            const tbody = document.getElementById('myRequestsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
            
            if (myReqs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div style="color: #7f8c8d; font-size: 16px;">
                                No requests found
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            myReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            myReqs.forEach(req => {
                const tr = document.createElement('tr');
                
                let details = '';
                if (req.type === 'dutyChange') {
                    details = `Swap with ${req.toName} (${req.toDutyTime})`;
                } else {
                    details = `${req.leaveType} - ${req.duration} day(s)`;
                }
                
                let statusClass = 'status-' + req.status;
                let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
                
                tr.innerHTML = `
                    <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                    <td>${req.date}</td>
                    <td>${details}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        ${req.status === 'pending' ? 
                            `<button class="action-btn reject" onclick="cancelRequest('${req.id}')">Cancel</button>` : ''}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        async function cancelRequest(requestId) {
            if (!confirm('Are you sure you want to cancel this request?')) return;
            
            const request = allRequests.find(req => req.id === requestId);
            if (!request) {
                showToast('Request not found', 'error');
                return;
            }
            
            if (request.status !== 'pending') {
                showToast('Only pending requests can be cancelled', 'warning');
                return;
            }
            
            if (request.type === 'leave' && request.status === 'approved') {
                const userBalance = leaveBalances[request.fromUsername];
                if (userBalance) {
                    if (request.leaveType === 'Sick Leave') {
                        userBalance.SL += request.duration;
                    } else if (request.leaveType === 'FRL') {
                        userBalance.FRL += request.duration;
                    }
                    await saveLeaveBalances();
                    updateUserBalance();
                    showToast(`${request.duration} day(s) refunded to ${request.leaveType} balance`, 'info');
                }
            }
            
            request.status = 'cancelled';
            request.history.push({
                action: 'cancelled',
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            const success = await saveAllRequests();
            if (success) {
                loadMyRequests();
                updateRequestCounts();
                showToast('Request cancelled', 'success');
            }
        }

        // ============================================
        // PENDING REQUESTS FUNCTIONS
        // ============================================
        function loadPendingRequests() {
            const tbody = document.getElementById('pendingRequestsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const pendingReqs = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            );
            
            if (pendingReqs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">
                            <div style="color: #7f8c8d; font-size: 16px;">
                                No pending requests
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            pendingReqs.forEach(req => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${req.fromName}</td>
                    <td>${req.date}</td>
                    <td>Swap ${req.dutyTime} with ${req.toDutyTime}</td>
                    <td class="action-buttons">
                        <button class="action-btn approve" onclick="respondToRequest('${req.id}', 'approved')">Accept</button>
                        <button class="action-btn reject" onclick="respondToRequest('${req.id}', 'rejected')">Reject</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        async function respondToRequest(requestId, response) {
            const request = allRequests.find(req => req.id === requestId);
            if (!request) {
                showToast('Request not found', 'error');
                return;
            }
            
            if (response === 'approved') {
                const date = request.date;
                if (dutyRoster[date]) {
                    const fromDuty = dutyRoster[date][request.fromUsername];
                    const toDuty = dutyRoster[date][request.toUsername];
                    
                    dutyRoster[date][request.fromUsername] = toDuty;
                    dutyRoster[date][request.toUsername] = fromDuty;
                    
                    await saveDutyRoster();
                }
            }
            
            request.status = response;
            request.respondedAt = new Date().toISOString();
            request.history.push({
                action: response,
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            const success = await saveAllRequests();
            if (success) {
                await sendPushNotification(
                    request.fromUsername,
                    `Duty Change Request ${response === 'approved' ? 'Approved' : 'Rejected'}`,
                    `${currentUser.name} has ${response} your duty change request for ${request.date}`,
                    {
                        type: 'dutyChangeResponse',
                        requestId: requestId,
                        response: response,
                        date: request.date
                    }
                );
                
                showToast(`Request ${response} successfully! Notification sent.`, 'success');
                showSection('home');
                updateRequestCounts();
            }
        }

        // ============================================
        // ROSTER FUNCTIONS
        // ============================================
        function loadAllRoster() {
            const container = document.getElementById('allRosterContainer');
            if (!container) return;
            
            const startDate = document.getElementById('allRosterStartDate').value;
            const endDate = document.getElementById('allRosterEndDate').value;
            
            if (!startDate || !endDate) {
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                document.getElementById('allRosterStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('allRosterEndDate').value = nextWeek.toISOString().split('T')[0];
                
                loadAllRoster();
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showToast('Start date must be before end date', 'warning');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            let html = '<div class="table-container"><table>';
            
            html += '<thead><tr><th>Date</th><th>Day</th>';
            allUsers.forEach(user => {
                if (user.Level === 'User') {
                    html += `<th>${user.name}<br><small>${user.RCNo}</small></th>`;
                }
            });
            html += '</tr></thead><tbody>';
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const isToday = dateStr === today;
                
                html += `<tr ${isToday ? 'style="background-color: rgba(52, 152, 219, 0.1);"' : ''}>`;
                html += `<td>${dateStr}${isToday ? ' <strong>(Today)</strong>' : ''}</td>`;
                html += `<td>${dayName}</td>`;
                
                allUsers.forEach(user => {
                    if (user.Level === 'User') {
                        let dutyTime = 'Off';
                        let cellClass = 'off-day-cell';
                        
                        if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                            dutyTime = dutyRoster[dateStr][user.username];
                            if (dutyTime !== 'Off') {
                                cellClass = getDutyTimeClass(dutyTime);
                            }
                        }
                        
                        html += `<td class="${cellClass}">${dutyTime}</td>`;
                    }
                });
                
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function getDutyTimeClass(dutyTime) {
            if (!dutyTime || dutyTime === 'Off') return 'off-day-cell';
            if (dutyTime.includes('Leave')) return 'duty-leave';
            
            const normalizedTime = dutyTime.replace(/\s/g, '').toUpperCase();
            
            if (normalizedTime.includes('0730-1530') || normalizedTime.includes('0700-1500')) 
                return 'duty-0730-1530';
            if (normalizedTime.includes('0830-1630') || normalizedTime.includes('0800-1600')) 
                return 'duty-0830-1630';
            if (normalizedTime.includes('1030-1830') || normalizedTime.includes('1000-1800')) 
                return 'duty-1030-1830';
            if (normalizedTime.includes('1530-2330') || normalizedTime.includes('1500-2300')) 
                return 'duty-1530-2330';
            if (normalizedTime.includes('1630-0030') || normalizedTime.includes('1600-0000')) 
                return 'duty-1630-0030';
            
            return 'duty-other';
        }

        // ============================================
        // ANNOUNCEMENTS FUNCTIONS
        // ============================================
        function loadAnnouncementsAdmin() {
            const container = document.getElementById('activeAnnouncementsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            const activeAnnouncements = announcements.filter(ann => 
                ann.status !== 'expired' && ann.status !== 'archived'
            );
            
            if (activeAnnouncements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <div class="empty-state-title">No Active Announcements</div>
                    </div>
                `;
                return;
            }
            
            activeAnnouncements.forEach(ann => {
                const announcementDiv = document.createElement('div');
                announcementDiv.className = `announcement-banner priority-${ann.priority}`;
                announcementDiv.style.marginBottom = '15px';
                
                announcementDiv.innerHTML = `
                    <div class="announcement-title">
                        <span>üì¢</span> ${ann.title}
                    </div>
                    <div style="margin-bottom: 10px;">${ann.content}</div>
                    <div style="font-size: 12px; opacity: 0.9;">
                        By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
                        <button class="action-btn reject" onclick="deleteAnnouncement('${ann.id}')" 
                                style="float: right; margin-left: 5px;">Delete</button>
                    </div>
                `;
                
                container.appendChild(announcementDiv);
            });
        }

        async function createAnnouncement() {
            if (!currentUser) return;
            
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const priority = document.getElementById('announcementPriority').value;
            
            if (!title || !content) {
                showToast('Please fill title and content', 'warning');
                return;
            }
            
            const announcement = {
                id: 'ann_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                title: title,
                content: content,
                priority: priority,
                target: 'all',
                createdBy: currentUser.name,
                createdByUsername: currentUser.username,
                createdAt: new Date().toISOString(),
                status: 'active'
            };
            
            announcements.push(announcement);
            
            const success = await saveAnnouncements();
            if (success) {
                allUsers.forEach(async (user) => {
                    if (user.username !== currentUser.username) {
                        await sendPushNotification(
                            user.username,
                            'New Announcement',
                            `${currentUser.name}: ${title}`,
                            {
                                type: 'announcement',
                                announcementId: announcement.id,
                                priority: priority
                            }
                        );
                    }
                });
                
                showToast('Announcement created! Notifications sent to all users.', 'success');
                document.getElementById('announcementForm').reset();
                loadAnnouncementsAdmin();
                loadHomeAnnouncements();
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (!confirm('Delete this announcement?')) return;
            
            const index = announcements.findIndex(ann => ann.id === announcementId);
            if (index !== -1) {
                announcements.splice(index, 1);
                const success = await saveAnnouncements();
                if (success) {
                    showToast('Announcement deleted', 'success');
                    loadAnnouncementsAdmin();
                    loadHomeAnnouncements();
                }
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            const dutyChangeForm = document.getElementById('dutyChangeForm');
            if (dutyChangeForm) {
                dutyChangeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitDutyChange();
                });
            }
            
            const leaveApplicationForm = document.getElementById('leaveApplicationForm');
            if (leaveApplicationForm) {
                leaveApplicationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitLeaveApplication();
                });
            }
            
            const announcementForm = document.getElementById('announcementForm');
            if (announcementForm) {
                announcementForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createAnnouncement();
                });
            }
            
            document.getElementById('changeDate')?.addEventListener('change', function() {
                loadUserDutyTimes('changeDutyTime', this.value);
            });
            
            document.getElementById('requestToStaff')?.addEventListener('change', function() {
                const user = allUsers.find(u => u.username === this.value);
                if (user) {
                    document.getElementById('requestToRcNo').value = user.RCNo;
                    const date = document.getElementById('changeDate').value;
                    if (date) {
                        const select = document.getElementById('requestToDutyTime');
                        select.innerHTML = '<option value="">Select duty time</option>';
                        const dutyTime = dutyRoster[date] && dutyRoster[date][user.username];
                        if (dutyTime) {
                            const option = document.createElement('option');
                            option.value = dutyTime;
                            option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                            select.appendChild(option);
                        }
                    }
                }
            });
            
            document.getElementById('leaveDate')?.addEventListener('change', function() {
                loadUserDutyTimes('leaveDutyTime', this.value);
                updateLeaveRules();
            });
            
            document.getElementById('leaveType')?.addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDutyTime')?.addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDuration')?.addEventListener('change', updateLeaveRules);
            
            document.getElementById('logoutBtn')?.addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('dutySystemSession');
                    localStorage.removeItem('fcmToken');
                    location.reload();
                }
            });
            
            document.getElementById('installBtn')?.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('User accepted install');
                        const installBtnContainer = document.getElementById('installBtnContainer');
                        if (installBtnContainer) {
                            installBtnContainer.style.display = 'none';
                        }
                        localStorage.setItem('appInstalled', 'true');
                    }
                    deferredPrompt = null;
                }
            });
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        window.showSection = showSection;
        window.updateDashboard = updateDashboard;
        window.requestNotificationPermission = requestNotificationPermission;
        window.testPushNotification = testPushNotification;
        window.respondToRequest = respondToRequest;
        window.cancelRequest = cancelRequest;
        window.deleteAnnouncement = deleteAnnouncement;
        window.loadAllRoster = loadAllRoster;
        window.clearNotifications = clearNotifications;

        // ============================================
        // ANIMATIONS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                    100% { transform: scale(1); }
                }
                @keyframes slideInUp {
                    from { transform: translateY(100%); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes slideOutDown {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
