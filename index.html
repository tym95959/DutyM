<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification PWA | Online Setup</title>
    <meta name="description" content="Web Push Notifications using Firebase & Vercel">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#4A90E2">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        :root {
            --primary: #4A90E2;
            --secondary: #7B68EE;
            --success: #2ECC71;
            --danger: #E74C3C;
            --dark: #2C3E50;
            --light: #F5F7FA;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .status-bar {
            background: #F8F9FA;
            padding: 15px 30px;
            border-bottom: 2px solid #E9ECEF;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .status-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-icon {
            width: 24px;
            text-align: center;
        }
        
        .controls {
            padding: 30px;
            display: grid;
            gap: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-secondary {
            background: #E9ECEF;
            color: var(--dark);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .notification-form {
            background: #F8F9FA;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #DEE2E6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .token-display {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        .instructions {
            background: #E3F2FD;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .instructions h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .flex {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 600px) {
            .container {
                border-radius: 10px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .controls {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîî Push Notification PWA</h1>
            <p class="subtitle">Online Setup - No Local Installation Required</p>
        </header>
        
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <span class="status-icon">üîÑ</span>
                <span id="statusText">Initializing application...</span>
            </div>
            <div class="status-item">
                <span class="status-icon">üåê</span>
                <span id="permissionStatus">Checking notification permission...</span>
            </div>
            <div class="status-item">
                <span class="status-icon">‚öôÔ∏è</span>
                <span id="serviceWorkerStatus">Checking service worker...</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" id="requestPermissionBtn">
                <span>üîî</span> Enable Push Notifications
            </button>
            
            <button class="btn btn-success hidden" id="sendTestBtn">
                <span>üöÄ</span> Send Test Notification
            </button>
            
            <button class="btn btn-secondary" id="installBtn" style="display: none;">
                <span>üì±</span> Install App
            </button>
            
            <div class="notification-form hidden" id="notificationForm">
                <h3>Send Custom Notification</h3>
                <div class="form-group">
                    <label for="titleInput">Title:</label>
                    <input type="text" id="titleInput" placeholder="Enter notification title" value="Hello! üëã">
                </div>
                <div class="form-group">
                    <label for="bodyInput">Message:</label>
                    <textarea id="bodyInput" placeholder="Enter notification message">This is a test notification sent from our PWA!</textarea>
                </div>
                <div class="form-group">
                    <label for="dataInput">Additional Data (JSON):</label>
                    <textarea id="dataInput">{"url": "/", "icon": "/icon-192x192.png", "timestamp": ""}</textarea>
                </div>
                <button class="btn btn-primary" id="sendCustomBtn">
                    <span>üì®</span> Send Custom Notification
                </button>
            </div>
            
            <div class="token-display hidden" id="tokenDisplay">
                <strong>FCM Token:</strong>
                <div id="tokenText"></div>
            </div>
            
            <div class="instructions">
                <h3>üìã Setup Instructions</h3>
                <ol>
                    <li>Click "Enable Push Notifications" to request permission</li>
                    <li>Grant notification permission when browser asks</li>
                    <li>Click "Install App" to install as PWA (optional)</li>
                    <li>Send test notifications using the buttons above</li>
                    <li>Notifications will work even when browser is closed!</li>
                </ol>
                <p><strong>Note:</strong> For production, replace Firebase config and add VAPID key.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (loaded from CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>
    
    <script>
        // ==================== CONFIGURATION ====================
        // REPLACE THESE WITH YOUR FIREBASE CONFIG
        // Get from: Firebase Console > Project Settings > General > Your apps > Web app
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
              authDomain: "leelidc-1f753.firebaseapp.com",
              projectId: "leelidc-1f753",
              storageBucket: "leelidc-1f753.firebasestorage.app",
              messagingSenderId: "43622932335",
              appId: "1:43622932335:web:a7529bce1f19714687129a",
              measurementId: "G-3KD6ZYS599"
        };
        
        // VAPID Key (optional but recommended)
        // Get from: Firebase Console > Cloud Messaging > Web configuration
        const vapidKey = "BCMEhQHZvwuii0Pul11PRfM68N_C4iox9c6jUwWoj21lvKZ2hhAfRe-5KwG_A1xMsQ04aelb8XM7x-mXNYzak1o";
        
        // ==================== APPLICATION CODE ====================
        let messaging = null;
        let currentToken = null;
        let deferredPrompt = null;
        
        // DOM Elements
        const statusText = document.getElementById('statusText');
        const permissionStatus = document.getElementById('permissionStatus');
        const serviceWorkerStatus = document.getElementById('serviceWorkerStatus');
        const requestPermissionBtn = document.getElementById('requestPermissionBtn');
        const sendTestBtn = document.getElementById('sendTestBtn');
        const sendCustomBtn = document.getElementById('sendCustomBtn');
        const installBtn = document.getElementById('installBtn');
        const notificationForm = document.getElementById('notificationForm');
        const tokenDisplay = document.getElementById('tokenDisplay');
        const tokenText = document.getElementById('tokenText');
        
        // Update status
        function updateStatus(message) {
            console.log(message);
            statusText.textContent = message;
        }
        
        function updatePermissionStatus(message) {
            permissionStatus.textContent = message;
        }
        
        function updateServiceWorkerStatus(message) {
            serviceWorkerStatus.textContent = message;
        }
        
        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    messaging = firebase.messaging();
                    updateStatus('‚úÖ Firebase initialized');
                }
                return true;
            } catch (error) {
                updateStatus('‚ùå Firebase initialization failed: ' + error.message);
                return false;
            }
        }
        
        // Request notification permission
        async function requestNotificationPermission() {
            try {
                updatePermissionStatus('üîÑ Requesting permission...');
                
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    updatePermissionStatus('‚úÖ Permission granted');
                    await setupPushNotifications();
                } else if (permission === 'denied') {
                    updatePermissionStatus('‚ùå Permission denied. Enable in browser settings.');
                    showPermissionInstructions();
                } else {
                    updatePermissionStatus('‚ö†Ô∏è Permission dismissed');
                }
            } catch (error) {
                updatePermissionStatus('‚ùå Error: ' + error.message);
            }
        }
        
        // Setup push notifications
        async function setupPushNotifications() {
            try {
                updateStatus('üîÑ Setting up push notifications...');
                
                // Register service worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.register('/service-worker.js', {
                        scope: '/'
                    });
                    updateServiceWorkerStatus('‚úÖ Service Worker registered');
                    
                    // Get FCM token
                    currentToken = await messaging.getToken({
                        vapidKey: vapidKey,
                        serviceWorkerRegistration: registration
                    });
                    
                    if (currentToken) {
                        updateStatus('‚úÖ FCM Token obtained');
                        displayToken(currentToken);
                        
                        // Save token to server
                        await saveTokenToServer(currentToken);
                        
                        // Show notification controls
                        sendTestBtn.classList.remove('hidden');
                        notificationForm.classList.remove('hidden');
                        
                        // Listen for messages
                        setupMessageListener();
                    } else {
                        updateStatus('‚ùå No token available');
                    }
                } else {
                    updateServiceWorkerStatus('‚ùå Service Worker not supported');
                }
            } catch (error) {
                updateStatus('‚ùå Setup failed: ' + error.message);
            }
        }
        
        // Display token
        function displayToken(token) {
            tokenDisplay.classList.remove('hidden');
            tokenText.textContent = token.substring(0, 80) + '...';
        }
        
        // Save token to server
        async function saveTokenToServer(token) {
            try {
                const response = await fetch('/api/save-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        userId: 'user_' + Date.now(),
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    updateStatus('‚úÖ Token saved to server');
                }
            } catch (error) {
                console.warn('Could not save token:', error);
            }
        }
        
        // Send test notification
        async function sendTestNotification() {
            if (!currentToken) {
                alert('Please enable notifications first');
                return;
            }
            
            try {
                updateStatus('üîÑ Sending test notification...');
                
                const response = await fetch('/api/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: currentToken,
                        title: 'Test Notification üéâ',
                        body: 'This is a test notification from your PWA!',
                        data: {
                            url: window.location.href,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('‚úÖ Test notification sent successfully');
                } else {
                    updateStatus('‚ùå Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                updateStatus('‚ùå Error: ' + error.message);
            }
        }
        
        // Send custom notification
        async function sendCustomNotification() {
            if (!currentToken) {
                alert('Please enable notifications first');
                return;
            }
            
            const title = document.getElementById('titleInput').value;
            const body = document.getElementById('bodyInput').value;
            let data = {};
            
            try {
                data = JSON.parse(document.getElementById('dataInput').value);
            } catch (e) {
                data = { raw: document.getElementById('dataInput').value };
            }
            
            data.timestamp = new Date().toISOString();
            
            try {
                updateStatus('üîÑ Sending custom notification...');
                
                const response = await fetch('/api/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: currentToken,
                        title: title,
                        body: body,
                        data: data
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('‚úÖ Custom notification sent');
                } else {
                    updateStatus('‚ùå Failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                updateStatus('‚ùå Error: ' + error.message);
            }
        }
        
        // Setup message listener
        function setupMessageListener() {
            messaging.onMessage((payload) => {
                updateStatus('üì® Message received: ' + payload.notification.title);
                
                // Show notification even if app is in foreground
                if (Notification.permission === 'granted') {
                    new Notification(payload.notification.title, {
                        body: payload.notification.body,
                        icon: '/icon-192x192.png'
                    });
                }
            });
        }
        
        // Show permission instructions
        function showPermissionInstructions() {
            alert('To enable notifications:\n\n' +
                  '1. Click the lock icon in your browser address bar\n' +
                  '2. Change "Notifications" to "Allow"\n' +
                  '3. Refresh this page');
        }
        
        // PWA Installation
        function setupPWAInstall() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'block';
            });
            
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    updateStatus('‚úÖ PWA installed successfully');
                    installBtn.style.display = 'none';
                }
                
                deferredPrompt = null;
            });
        }
        
        // Check initial state
        function checkInitialState() {
            // Check notification permission
            if (Notification.permission === 'granted') {
                updatePermissionStatus('‚úÖ Permission already granted');
                initializeFirebase() && setupPushNotifications();
            } else if (Notification.permission === 'denied') {
                updatePermissionStatus('‚ùå Permission denied');
                showPermissionInstructions();
            } else {
                updatePermissionStatus('‚ö†Ô∏è Click to request permission');
            }
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                updateServiceWorkerStatus('‚úÖ Supported');
            } else {
                updateServiceWorkerStatus('‚ùå Not supported');
            }
            
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                updateStatus('üì± Running as installed PWA');
            }
        }
        
        // Event Listeners
        requestPermissionBtn.addEventListener('click', requestNotificationPermission);
        sendTestBtn.addEventListener('click', sendTestNotification);
        sendCustomBtn.addEventListener('click', sendCustomNotification);
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('üöÄ Starting application...');
            initializeFirebase();
            setupPWAInstall();
            checkInitialState();
        });
        
        // Handle visibility change (for debugging)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Page hidden');
            } else {
                console.log('Page visible');
            }
        });
    </script>
</body>
</html>
