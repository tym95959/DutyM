<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Duty Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    <meta name="description" content="Duty and Leave Management System for staff">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3498db">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="512x512" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    
    <!-- Manifest for PWA -->
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"Duty Manager\",
        \"short_name\": \"DutyMgr\",
        \"description\": \"Duty and Leave Management System\",
        \"start_url\": \"./\",
        \"display\": \"standalone\",
        \"background_color\": \"#3498db\",
        \"theme_color\": \"#3498db\",
        \"orientation\": \"portrait\",
        \"scope\": \"./\",
        \"categories\": [\"productivity\", \"business\"],
        \"icons\": [
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"72x72\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"96x96\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"128x128\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"144x144\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"152x152\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"192x192\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any maskable\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"384x384\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any maskable\"
            },
            {
                \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E\",
                \"sizes\": \"512x512\",
                \"type\": \"image/svg+xml\",
                \"purpose\": \"any maskable\"
            }
        ]
    }">
    <title>Duty Management System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <style>
        /* All previous styles remain the same, but add these new styles */
        
        /* Install App Button */
        #installBtnContainer {
            position: fixed;
            bottom: 90px;
            right: 15px;
            z-index: 1000;
        }
        
        #installBtn {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            animation: pulse 2s infinite;
        }
        
        #installBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        /* Push Notification Permission Prompt */
        .notification-permission {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            animation: slideInUp 0.3s ease;
        }
        
        .notification-permission h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        /* PWA App Styles */
        .standalone-app .bottom-nav {
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        
        .standalone-app .dashboard-content {
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Animation for new notifications */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
        
        /* Service Worker Status */
        .service-worker-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Install App Button -->
    <div id="installBtnContainer" style="display: none;">
        <button id="installBtn">
            <span>üì±</span> Install App
        </button>
    </div>

    <!-- Service Worker Status -->
    <div id="serviceWorkerStatus" class="service-worker-status" style="display: none;"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <div id="notificationPermissionPrompt" class="notification-permission" style="display: none;">
            <h4>üîî Enable Push Notifications</h4>
            <p>Get instant alerts for duty changes, leave approvals, and messages!</p>
            <button onclick="requestNotificationPermission()" class="btn btn-success" style="margin-top: 10px;">
                <span>üîî</span> Enable Notifications
            </button>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <span>üîê</span> Login
            </button>
            
            <div class="error-message" id="errorMessage" style="color: #e74c3c; margin-top: 10px; display: none;">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header with Notification Badge -->
        <div class="mobile-header">
            <button class="menu-toggle" id="menuToggle">
                ‚ò∞
            </button>
            <div class="mobile-title" id="mobileTitle">Dashboard</div>
            <div class="mobile-user">
                <div class="mobile-avatar" id="mobileAvatar">U</div>
                <div id="headerNotificationBadge" class="notification-badge" style="display: none;">0</div>
            </div>
        </div>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
        <div class="mobile-nav" id="mobileNav">
            <div class="nav-header">
                <div class="nav-user-name" id="navUserName">User Name</div>
                <div class="nav-user-details">
                    <span>RC: <span id="navUserRC">000</span></span>
                    <span>Level: <span id="navUserLevel">User</span></span>
                </div>
            </div>
            
            <div class="nav-items">
                <!-- ... (same navigation items) ... -->
            </div>
            
            <div class="nav-footer">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <span>üö™</span> Logout
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <!-- Notification Settings -->
                    <div id="notificationSettings" class="form-row" style="margin-bottom: 15px;">
                        <button onclick="requestNotificationPermission()" class="btn btn-warning">
                            <span>üîî</span> Notifications: <span id="notificationStatus">Off</span>
                        </button>
                        <button onclick="testPushNotification()" class="btn btn-info">
                            <span>üì±</span> Test Push
                        </button>
                    </div>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <!-- ... (rest of the dashboard content) ... -->
                </div>
            </div>
            
            <!-- ... (other sections remain the same) ... -->
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <!-- ... (same bottom navigation) ... -->
        </div>
    </div>

    <script>
       // Mobile Duty Management System with PWA and Push Notifications
let currentUser = null;
let allUsers = [];
let dutyRoster = {};
let leaveBalances = {};
let allRequests = [];
let announcements = [];
let isMobile = false;
let currentToastId = 0;
let deferredPrompt = null;
let messaging = null;
let notificationPermission = 'default';
let unreadNotifications = 0;
let db = null;
let firebaseInitialized = false;

// User database (replace with your actual users)
const users = [
    { username: "koveli", passwordHash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", name: "Koveli", RCNo: "001", Level: "Supervisor" },
    { username: "john", passwordHash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", name: "John Doe", RCNo: "002", Level: "User" },
    { username: "jane", passwordHash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", name: "Jane Smith", RCNo: "003", Level: "User" }
    // Add more users as needed
];

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
    detectMobile();
    initApp();
    initializeServiceWorker();
    initializeFirebase();
    setupPWAInstall();
    checkNotificationPermission();
});

function detectMobile() {
    isMobile = window.innerWidth <= 768;
    if (isMobile) {
        document.body.classList.add('mobile');
    }
}

// Service Worker for PWA
async function initializeServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker registered:', registration);
            
            // Update status display
            const statusEl = document.getElementById('serviceWorkerStatus');
            if (statusEl) {
                statusEl.textContent = '‚úÖ PWA Ready';
                statusEl.style.display = 'block';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showToast('New version available! Reload to update.', 'info');
                    }
                });
            });
            
        } catch (error) {
            console.error('Service Worker registration failed:', error);
        }
    }
}

// Firebase Initialization
function initializeFirebase() {
    try {
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
            authDomain: "leelidc-1f753.firebaseapp.com",
            projectId: "leelidc-1f753",
            storageBucket: "leelidc-1f753.firebasestorage.app",
            messagingSenderId: "43622932335",
            appId: "1:43622932335:web:a7529bce1f19714687129a",
            measurementId: "G-3KD6ZYS599"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firebaseInitialized = true;
        
        console.log('Firebase initialized successfully');
        
    } catch (error) {
        console.error('Firebase initialization failed:', error);
        firebaseInitialized = false;
    }
}

// Firebase Messaging for Push Notifications
async function initializeFirebaseMessaging() {
    if (!firebaseInitialized) return;
    
    try {
        // Check if messaging is supported
        if (!firebase.messaging.isSupported()) {
            console.log('Firebase Messaging not supported in this browser');
            return;
        }
        
        messaging = firebase.messaging();
        
        // Use default VAPID key (you should replace this with your own)
        messaging.usePublicVapidKey("BCMEhQHZvwuii0Pul11PRfM68N_C4iox9c6jUwWoj21lvKZ2hhAfRe-5KwG_A1xMsQ04aelb8XM7x-mXNYzak1o");
        
        // Get current token
        const token = await messaging.getToken();
        console.log('FCM Token:', token);
        
        // Save token to localStorage for now
        if (token) {
            localStorage.setItem('fcmToken', token);
        }
        
        // Handle incoming messages when app is in foreground
        messaging.onMessage((payload) => {
            console.log('Foreground message received:', payload);
            showPushNotification(payload);
            updateNotificationBadge(1);
            playNotificationSound();
        });
        
        // Handle token refresh
        messaging.onTokenRefresh(async () => {
            try {
                const refreshedToken = await messaging.getToken();
                console.log('Token refreshed:', refreshedToken);
                localStorage.setItem('fcmToken', refreshedToken);
            } catch (error) {
                console.error('Unable to refresh token:', error);
            }
        });
        
    } catch (error) {
        console.error('Firebase Messaging initialization failed:', error);
    }
}

// Show push notification
function showPushNotification(payload) {
    const notification = payload.notification || {
        title: payload.title || 'Duty Manager',
        body: payload.body || 'New notification'
    };
    
    // Show in-app toast
    showToast(`${notification.title}: ${notification.body}`, 'info', 5000);
    
    // Show system notification if permission granted and app is in background
    if (Notification.permission === 'granted') {
        const options = {
            body: notification.body,
            icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%233498db"/%3E%3C/svg%3E',
            badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%233498db"/%3E%3C/svg%3E',
            vibrate: [200, 100, 200],
            tag: 'duty-notification',
            data: payload.data || {}
        };
        
        if (navigator.serviceWorker) {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification(notification.title, options);
            });
        } else {
            // Fallback to regular Notification API
            new Notification(notification.title, options);
        }
    }
}

// Play notification sound
function playNotificationSound() {
    try {
        // Create a simple beep sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        console.log('Audio play failed:', e);
    }
}

// Update notification badge
function updateNotificationBadge(count) {
    unreadNotifications += count;
    const badge = document.getElementById('headerNotificationBadge');
    if (badge) {
        if (unreadNotifications > 0) {
            badge.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
            badge.style.display = 'flex';
            badge.style.animation = 'pulse 1s infinite';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Clear notifications
function clearNotifications() {
    unreadNotifications = 0;
    updateNotificationBadge(0);
}

// Request notification permission
async function requestNotificationPermission() {
    try {
        const permission = await Notification.requestPermission();
        notificationPermission = permission;
        
        if (permission === 'granted') {
            showToast('Notifications enabled!', 'success');
            if (document.getElementById('notificationStatus')) {
                document.getElementById('notificationStatus').textContent = 'On';
            }
            
            // Initialize FCM
            await initializeFirebaseMessaging();
            
            // Hide permission prompt
            const prompt = document.getElementById('notificationPermissionPrompt');
            if (prompt) prompt.style.display = 'none';
        } else {
            showToast('Notifications blocked. You can enable them in browser settings.', 'warning');
            if (document.getElementById('notificationStatus')) {
                document.getElementById('notificationStatus').textContent = 'Off';
            }
        }
    } catch (error) {
        console.error('Error requesting notification permission:', error);
    }
}

// Check notification permission
function checkNotificationPermission() {
    if ('Notification' in window) {
        notificationPermission = Notification.permission;
        if (document.getElementById('notificationStatus')) {
            document.getElementById('notificationStatus').textContent = 
                notificationPermission === 'granted' ? 'On' : 'Off';
        }
        
        // Show permission prompt if not granted
        if (notificationPermission === 'default') {
            const prompt = document.getElementById('notificationPermissionPrompt');
            if (prompt) prompt.style.display = 'block';
        }
    }
}

// Test push notification
async function testPushNotification() {
    if (!currentUser) {
        showToast('Please login first', 'warning');
        return;
    }
    
    // Create a test notification
    const notificationData = {
        notification: {
            title: 'Test Notification',
            body: 'This is a test push notification from Duty Manager!',
            icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%233498db"/%3E%3C/svg%3E'
        },
        data: {
            type: 'test',
            username: currentUser.username,
            timestamp: new Date().toISOString()
        }
    };
    
    showPushNotification(notificationData);
    showToast('Test notification sent!', 'success');
    
    // Also simulate receiving a message from Koveli
    setTimeout(() => {
        const koveliMessage = {
            notification: {
                title: 'Message from Koveli',
                body: 'You have a new message from Koveli',
                icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%2327ae60"/%3E%3C/svg%3E'
            },
            data: {
                type: 'message',
                from: 'koveli',
                message: 'Please check your duty schedule for tomorrow.',
                timestamp: new Date().toISOString()
            }
        };
        
        showPushNotification(koveliMessage);
    }, 2000);
}

// PWA Install Prompt
function setupPWAInstall() {
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install button
        const installBtnContainer = document.getElementById('installBtnContainer');
        if (installBtnContainer) {
            installBtnContainer.style.display = 'block';
        }
        
        // Auto-show install prompt after delay
        setTimeout(() => {
            if (deferredPrompt && !localStorage.getItem('installPromptShown')) {
                showInstallPrompt();
            }
        }, 3000);
    });
    
    // Hide install button if already installed
    window.addEventListener('appinstalled', () => {
        console.log('PWA was installed');
        const installBtnContainer = document.getElementById('installBtnContainer');
        if (installBtnContainer) {
            installBtnContainer.style.display = 'none';
        }
        localStorage.setItem('appInstalled', 'true');
    });
    
    // Check if already installed
    if (localStorage.getItem('appInstalled') === 'true') {
        const installBtnContainer = document.getElementById('installBtnContainer');
        if (installBtnContainer) {
            installBtnContainer.style.display = 'none';
        }
    }
}

// Show custom install prompt
function showInstallPrompt() {
    const installContainer = document.createElement('div');
    installContainer.style.cssText = `
        position: fixed;
        bottom: 90px;
        right: 15px;
        z-index: 1000;
        background: white;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        max-width: 300px;
        animation: slideInUp 0.3s ease;
    `;
    
    installContainer.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                üë§
            </div>
            <div>
                <div style="font-weight: bold; font-size: 14px;">Install Duty Manager</div>
                <div style="font-size: 12px; color: #666;">Quick access on home screen</div>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="installNowBtn" style="flex: 1; background: #3498db; color: white; border: none; padding: 8px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                Install
            </button>
            <button id="installLaterBtn" style="background: #f0f0f0; color: #666; border: none; padding: 8px; border-radius: 8px; cursor: pointer;">
                Later
            </button>
        </div>
    `;
    
    document.body.appendChild(installContainer);
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    document.getElementById('installNowBtn').addEventListener('click', async () => {
        installContainer.style.animation = 'slideOutDown 0.3s ease';
        setTimeout(() => {
            if (installContainer.parentNode) {
                document.body.removeChild(installContainer);
            }
        }, 300);
        
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response: ${outcome}`);
            deferredPrompt = null;
        }
        localStorage.setItem('installPromptShown', 'true');
    });
    
    document.getElementById('installLaterBtn').addEventListener('click', () => {
        installContainer.style.animation = 'slideOutDown 0.3s ease';
        setTimeout(() => {
            if (installContainer.parentNode) {
                document.body.removeChild(installContainer);
            }
        }, 300);
        localStorage.setItem('installPromptShown', 'true');
    });
    
    // Auto-remove after 15 seconds
    setTimeout(() => {
        if (installContainer.parentNode) {
            installContainer.style.animation = 'slideOutDown 0.3s ease';
            setTimeout(() => {
                if (installContainer.parentNode) {
                    document.body.removeChild(installContainer);
                }
            }, 300);
        }
    }, 15000);
}

// Check if running as installed app
function isRunningStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone ||
           document.referrer.includes('android-app://');
}

// Send push notification (simulated for demo)
async function sendPushNotification(username, title, body, data = {}) {
    try {
        // In a real app, you would send this to your server or use Firebase Cloud Functions
        // For demo, we'll simulate it
        
        const notificationData = {
            notification: {
                title: title,
                body: body,
                icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%233498db"/%3E%3C/svg%3E'
            },
            data: {
                ...data,
                username: username,
                timestamp: new Date().toISOString()
            }
        };
        
        // Simulate delay for network request
        setTimeout(() => {
            if (currentUser && currentUser.username === username) {
                showPushNotification(notificationData);
            }
        }, 1000);
        
        return true;
        
    } catch (error) {
        console.error('Error sending push notification:', error);
        return false;
    }
}

// Listen for notifications
function setupNotificationListener() {
    if (!currentUser || !firebaseInitialized) return;
    
    try {
        // Listen for announcements
        db.collection('announcements').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().announcements) {
                    announcements = doc.data().announcements;
                    if (document.getElementById('homeSection')?.classList.contains('active')) {
                        loadHomeAnnouncements();
                    }
                }
            });
        
        // Listen for requests
        db.collection('requests').doc('all')
            .onSnapshot((doc) => {
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                    updateRequestCounts();
                    
                    const activeSection = document.querySelector('.section.active')?.id;
                    if (activeSection === 'myRequestsSection') loadMyRequests();
                    if (activeSection === 'pendingRequestsSection') loadPendingRequests();
                }
            });
            
    } catch (error) {
        console.error('Error setting up notification listener:', error);
    }
}

// Initialize app
function initApp() {
    // Setup login form
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleLogin();
        });
    }
    
    // Setup mobile navigation
    setupMobileNavigation();
    
    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    const dateInputs = ['changeDate', 'leaveDate', 'allRosterStartDate', 'allRosterEndDate'];
    dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.min = today;
    });
    
    // Set default dates
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const changeDateEl = document.getElementById('changeDate');
    const leaveDateEl = document.getElementById('leaveDate');
    const allRosterStartEl = document.getElementById('allRosterStartDate');
    const allRosterEndEl = document.getElementById('allRosterEndDate');
    
    if (changeDateEl) changeDateEl.value = tomorrow.toISOString().split('T')[0];
    if (leaveDateEl) leaveDateEl.value = tomorrow.toISOString().split('T')[0];
    if (allRosterStartEl) allRosterStartEl.value = today;
    if (allRosterEndEl) {
        const nextWeek = new Date(today);
        nextWeek.setDate(nextWeek.getDate() + 7);
        allRosterEndEl.value = nextWeek.toISOString().split('T')[0];
    }
    
    // Check session
    checkSession();
}

function setupMobileNavigation() {
    const menuToggle = document.getElementById('menuToggle');
    const mobileNav = document.getElementById('mobileNav');
    const mobileNavOverlay = document.getElementById('mobileNavOverlay');
    
    if (menuToggle && mobileNav && mobileNavOverlay) {
        menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            mobileNav.classList.add('active');
            mobileNavOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        
        mobileNavOverlay.addEventListener('click', function() {
            mobileNav.classList.remove('active');
            mobileNavOverlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // Close menu when clicking a nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                mobileNav.classList.remove('active');
                mobileNavOverlay.classList.remove('active');
                document.body.style.overflow = '';
                
                const sectionId = this.getAttribute('data-section');
                showSection(sectionId);
            });
        });
    }
}

function checkSession() {
    const session = localStorage.getItem('dutySystemSession');
    if (session) {
        try {
            const user = JSON.parse(session);
            if (user.expiry > Date.now()) {
                loginUser(user);
            } else {
                localStorage.removeItem('dutySystemSession');
            }
        } catch (e) {
            localStorage.removeItem('dutySystemSession');
        }
    }
}

async function handleLogin() {
    showLoading(true, 'Authenticating...');
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    if (!username || !password) {
        showToast('Please enter both username and password', 'warning');
        showLoading(false);
        return;
    }
    
    const user = users.find(u => u.username === username);
    
    if (!user) {
        showToast('Invalid username or password', 'error');
        document.getElementById('errorMessage').style.display = 'block';
        showLoading(false);
        return;
    }
    
    // Hash and check password
    const hashedPassword = sha256(password);
    
    if (hashedPassword === user.passwordHash) {
        const sessionData = {
            username: user.username,
            name: user.name,
            rcNo: user.RCNo,
            level: user.Level,
            expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
        };
        
        localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
        await loginUser(sessionData);
        showLoading(false);
    } else {
        showToast('Invalid username or password', 'error');
        document.getElementById('errorMessage').style.display = 'block';
        showLoading(false);
    }
}

async function loginUser(userData) {
    currentUser = userData;
    allUsers = users || [];
    
    // Update UI
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('dashboardContainer').style.display = 'block';
    
    // Update user info
    document.getElementById('mobileTitle').textContent = 'Dashboard';
    document.getElementById('mobileAvatar').textContent = userData.name.charAt(0).toUpperCase();
    document.getElementById('navUserName').textContent = userData.name;
    document.getElementById('navUserRC').textContent = userData.rcNo;
    document.getElementById('navUserLevel').textContent = userData.level;
    document.getElementById('welcomeName').textContent = userData.name;
    
    // Show/hide admin sections
    const isAdmin = userData.level === 'Supervisor';
    document.querySelectorAll('.admin-nav').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
    });
    
    // Initialize Firebase messaging for logged in user
    if (Notification.permission === 'granted') {
        await initializeFirebaseMessaging();
    }
    
    // Setup notification listener
    setupNotificationListener();
    
    // Load data
    await initializeData();
    
    // Setup event listeners
    setupEventListeners();
    
    // Show welcome
    showToast(`Welcome back, ${userData.name}!`, 'success');
    
    // Send welcome notification
    setTimeout(() => {
        sendPushNotification(
            userData.username,
            'Welcome to Duty Manager!',
            'You have successfully logged in. You will receive notifications for duty changes and leave approvals.',
            { type: 'welcome' }
        );
    }, 2000);
}

async function initializeData() {
    showLoading(true, 'Loading data...');
    
    try {
        // Load all data
        await Promise.all([
            loadDutyRoster(),
            loadLeaveBalances(),
            loadAllRequests(),
            loadAnnouncements()
        ]);
        
        // Update UI
        updateUserBalance();
        updateRequestCounts();
        loadHomeAnnouncements();
        
        showLoading(false);
    } catch (error) {
        console.error('Error initializing data:', error);
        showToast('Failed to load data', 'error');
        showLoading(false);
    }
}

// Firebase Functions
async function loadDutyRoster() {
    try {
        if (!firebaseInitialized) {
            dutyRoster = {};
            return dutyRoster;
        }
        
        const doc = await db.collection('dutyRoster').doc('current').get();
        dutyRoster = doc.exists ? doc.data() || {} : {};
        return dutyRoster;
    } catch (error) {
        console.error('Error loading duty roster:', error);
        dutyRoster = {};
        return dutyRoster;
    }
}

async function saveDutyRoster() {
    try {
        if (!firebaseInitialized) {
            showToast('Firebase not initialized', 'error');
            return false;
        }
        
        await db.collection('dutyRoster').doc('current').set(dutyRoster);
        return true;
    } catch (error) {
        console.error('Error saving duty roster:', error);
        showToast('Failed to save roster', 'error');
        return false;
    }
}

async function loadLeaveBalances() {
    try {
        if (!firebaseInitialized) {
            // Initialize default balances
            leaveBalances = {};
            allUsers.forEach(user => {
                leaveBalances[user.username] = {
                    SL: 12,
                    FRL: 6
                };
            });
            return leaveBalances;
        }
        
        const doc = await db.collection('leaveBalances').doc('current').get();
        if (doc.exists) {
            leaveBalances = doc.data() || {};
        } else {
            // Initialize default balances
            leaveBalances = {};
            allUsers.forEach(user => {
                leaveBalances[user.username] = {
                    SL: 12,
                    FRL: 6
                };
            });
            await saveLeaveBalances();
        }
        return leaveBalances;
    } catch (error) {
        console.error('Error loading leave balances:', error);
        leaveBalances = {};
        return leaveBalances;
    }
}

async function saveLeaveBalances() {
    try {
        if (!firebaseInitialized) return false;
        await db.collection('leaveBalances').doc('current').set(leaveBalances);
        return true;
    } catch (error) {
        console.error('Error saving leave balances:', error);
        showToast('Failed to save leave balances', 'error');
        return false;
    }
}

async function loadAllRequests() {
    try {
        if (!firebaseInitialized) {
            allRequests = [];
            return allRequests;
        }
        
        const doc = await db.collection('requests').doc('all').get();
        if (doc.exists && doc.data().requests) {
            allRequests = doc.data().requests;
        } else {
            allRequests = [];
        }
        return allRequests;
    } catch (error) {
        console.error('Error loading requests:', error);
        allRequests = [];
        return allRequests;
    }
}

async function saveAllRequests() {
    try {
        if (!firebaseInitialized) return false;
        await db.collection('requests').doc('all').set({ requests: allRequests });
        return true;
    } catch (error) {
        console.error('Error saving requests:', error);
        showToast('Failed to save requests', 'error');
        return false;
    }
}

async function loadAnnouncements() {
    try {
        if (!firebaseInitialized) {
            announcements = [];
            return announcements;
        }
        
        const doc = await db.collection('announcements').doc('all').get();
        if (doc.exists && doc.data().announcements) {
            announcements = doc.data().announcements;
        } else {
            announcements = [];
            await saveAnnouncements();
        }
        return announcements;
    } catch (error) {
        console.error('Error loading announcements:', error);
        announcements = [];
        return announcements;
    }
}

async function saveAnnouncements() {
    try {
        if (!firebaseInitialized) return false;
        await db.collection('announcements').doc('all').set({ announcements: announcements });
        return true;
    } catch (error) {
        console.error('Error saving announcements:', error);
        showToast('Failed to save announcements', 'error');
        return false;
    }
}

function updateUserBalance() {
    if (!currentUser) return;
    
    const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
    document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
    document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
}

function updateRequestCounts() {
    if (!currentUser) return;
    
    // Pending requests for user
    const pendingForUser = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    ).length;
    
    const pendingNav = document.getElementById('pendingRequestsNav');
    const pendingBadge = document.getElementById('pendingRequestsBadge');
    
    if (pendingForUser > 0) {
        if (pendingNav) {
            pendingNav.style.display = 'flex';
            pendingBadge.textContent = pendingForUser;
            pendingBadge.style.display = 'inline-block';
        }
    } else {
        if (pendingNav) {
            pendingNav.style.display = 'none';
            pendingBadge.style.display = 'none';
        }
    }
    
    // My pending requests
    const myPending = allRequests.filter(req => 
        req.fromUsername === currentUser.username && 
        req.status === 'pending'
    ).length;
    
    const myBadge = document.getElementById('myRequestsBadge');
    if (myBadge) {
        if (myPending > 0) {
            myBadge.textContent = myPending;
            myBadge.style.display = 'inline-block';
        } else {
            myBadge.style.display = 'none';
        }
    }
}

// Navigation Functions
function showSection(sectionId) {
    // Update mobile title
    const titles = {
        home: 'Dashboard',
        dutyChange: 'Duty Change',
        leaveApplication: 'Apply Leave',
        myRequests: 'My Requests',
        pendingRequests: 'Pending Requests',
        viewMyRoster: 'My Roster',
        viewAllRoster: 'All Roster',
        adminAnnouncements: 'Announcements',
        adminDutyRoster: 'Duty Roster',
        adminLeaveBalance: 'Leave Balance',
        adminApprovals: 'Approvals',
        adminRequestHistory: 'History'
    };
    
    document.getElementById('mobileTitle').textContent = titles[sectionId] || sectionId;
    
    // Update sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    const sectionElement = document.getElementById(sectionId + 'Section');
    if (sectionElement) {
        sectionElement.classList.add('active');
    }
    
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-section') === sectionId) {
            item.classList.add('active');
        }
    });
    
    // Update bottom nav
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        const btnText = btn.querySelector('span:last-child').textContent.toLowerCase();
        if (sectionId === 'home' && btnText === 'home') btn.classList.add('active');
        if (sectionId === 'dutyChange' && btnText === 'change') btn.classList.add('active');
        if (sectionId === 'leaveApplication' && btnText === 'leave') btn.classList.add('active');
        if (sectionId === 'myRequests' && btnText === 'requests') btn.classList.add('active');
        if (sectionId === 'viewAllRoster' && btnText === 'roster') btn.classList.add('active');
    });
    
    // Load section data
    loadSectionData(sectionId);
    
    // Scroll to top
    const dashboardContent = document.getElementById('dashboardContent');
    if (dashboardContent) {
        dashboardContent.scrollTop = 0;
    }
}

function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'home':
            updateDashboard();
            break;
        case 'dutyChange':
            loadDutyChangeForm();
            break;
        case 'leaveApplication':
            loadLeaveForm();
            break;
        case 'myRequests':
            loadMyRequests();
            break;
        case 'pendingRequests':
            loadPendingRequests();
            break;
        case 'viewAllRoster':
            loadAllRoster();
            break;
        case 'adminAnnouncements':
            loadAnnouncementsAdmin();
            break;
    }
}

// UI Helper Functions
function showLoading(show, text = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const textEl = document.getElementById('loadingText');
    if (overlay) {
        if (show) {
            overlay.classList.add('active');
            if (textEl) textEl.textContent = text;
        } else {
            overlay.classList.remove('active');
        }
    }
}

function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toastId = 'toast-' + (++currentToastId);
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span class="toast-icon">
            ${type === 'success' ? '‚úÖ' : 
              type === 'error' ? '‚ùå' : 
              type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
        </span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    // Remove after duration
    setTimeout(() => {
        const toastElem = document.getElementById(toastId);
        if (toastElem) {
            toastElem.style.opacity = '0';
            toastElem.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toastElem.parentNode) {
                    toastElem.parentNode.removeChild(toastElem);
                }
            }, 300);
        }
    }, duration);
}

// Dashboard Functions
function updateDashboard() {
    if (!currentUser) return;
    
    const today = new Date().toISOString().split('T')[0];
    const todayDutyTime = document.getElementById('todayDutyTime');
    const nextDutyTime = document.getElementById('nextDutyTime');
    
    // Today's duty
    if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
        const duty = dutyRoster[today][currentUser.username];
        todayDutyTime.textContent = duty === 'Off' ? 'Off Duty' : duty;
        todayDutyTime.className = duty === 'Off' ? 'status-off' : '';
    } else {
        todayDutyTime.textContent = 'Not Scheduled';
    }
    
    // Next duty
    const tomorrow = new Date();
    let foundNext = false;
    
    for (let i = 1; i <= 7; i++) {
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dateStr = tomorrow.toISOString().split('T')[0];
        if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
            const duty = dutyRoster[dateStr][currentUser.username];
            if (duty !== 'Off') {
                const date = new Date(dateStr);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                nextDutyTime.textContent = `${dayName}: ${duty}`;
                foundNext = true;
                break;
            }
        }
    }
    
    if (!foundNext) {
        nextDutyTime.textContent = 'No upcoming duty';
    }
    
    // Update balance
    updateUserBalance();
    
    // Load announcements
    loadHomeAnnouncements();
}

function loadHomeAnnouncements() {
    const container = document.getElementById('homeAnnouncements');
    if (!container) return;
    
    container.innerHTML = '';
    
    const now = new Date();
    const activeAnnouncements = announcements.filter(ann => {
        if (ann.status === 'expired' || ann.status === 'archived') return false;
        if (ann.expiry && new Date(ann.expiry) < now) return false;
        return ann.target === 'all' || 
               (ann.target === 'specific' && ann.targetUsers && 
                ann.targetUsers.includes(currentUser.username));
    });
    
    if (activeAnnouncements.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
            <div class="empty-state-icon">üì¢</div>
            <div class="empty-state-title">No Announcements</div>
        `;
        container.appendChild(emptyState);
        return;
    }
    
    // Show only 2 announcements on mobile
    const displayAnnouncements = isMobile ? 
        activeAnnouncements.slice(0, 2) : activeAnnouncements;
    
    displayAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <span>üì¢</span> ${ann.title}
            </div>
            <div style="margin-bottom: 10px; font-size: 14px;">${ann.content}</div>
            <div style="font-size: 12px; opacity: 0.9;">
                By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return past.toLocaleDateString();
}

// Duty Change Functions
function loadDutyChangeForm() {
    // Set tomorrow as default
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const changeDateEl = document.getElementById('changeDate');
    if (changeDateEl) changeDateEl.value = tomorrow.toISOString().split('T')[0];
    
    // Populate staff dropdown
    const staffSelect = document.getElementById('requestToStaff');
    if (staffSelect) {
        staffSelect.innerHTML = '<option value="">Select staff member</option>';
        allUsers.forEach(user => {
            if (user.username !== currentUser.username && user.Level === 'User') {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name} (RC: ${user.RCNo})`;
                staffSelect.appendChild(option);
            }
        });
    }
    
    // Load duty times
    loadUserDutyTimes('changeDutyTime', tomorrow.toISOString().split('T')[0]);
}

function loadUserDutyTimes(selectId, date) {
    const select = document.getElementById(selectId);
    if (!select || !date || !currentUser) return;
    
    select.innerHTML = '<option value="">Select duty time</option>';
    const dutyTime = dutyRoster[date] && dutyRoster[date][currentUser.username];
    
    if (dutyTime) {
        const option = document.createElement('option');
        option.value = dutyTime;
        option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
        select.appendChild(option);
    }
}

async function submitDutyChange() {
    if (!currentUser) return;
    
    const date = document.getElementById('changeDate').value;
    const dutyTime = document.getElementById('changeDutyTime').value;
    const toStaff = document.getElementById('requestToStaff').value;
    const toDutyTime = document.getElementById('requestToDutyTime').value;
    const reason = document.getElementById('changeReason').value;
    
    if (!date || !dutyTime || !toStaff || !toDutyTime) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    if (dutyTime === 'Off' || toDutyTime === 'Off') {
        showToast('Cannot request duty change on off days', 'warning');
        return;
    }
    
    // Check if date is at least 24 hours from now
    const requestDate = new Date(date);
    const now = new Date();
    const hoursDiff = (requestDate - now) / (1000 * 60 * 60);
    
    if (hoursDiff < 24) {
        showToast('Duty changes must be requested at least 24 hours in advance', 'warning');
        return;
    }
    
    const toUser = allUsers.find(u => u.username === toStaff);
    if (!toUser) {
        showToast('Selected staff not found', 'error');
        return;
    }
    
    const request = {
        id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        type: 'dutyChange',
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        toUsername: toStaff,
        toName: toUser.name,
        toRcNo: toUser.RCNo,
        toDutyTime: toDutyTime,
        reason: reason,
        status: 'pending',
        timestamp: new Date().toISOString(),
        history: [{
            action: 'created',
            by: currentUser.name,
            timestamp: new Date().toISOString()
        }]
    };
    
    allRequests.push(request);
    
    const success = await saveAllRequests();
    if (success) {
        // Send push notification to requested user
        await sendPushNotification(
            toStaff,
            'New Duty Change Request',
            `${currentUser.name} wants to swap duty on ${date}`,
            {
                type: 'dutyChange',
                requestId: request.id,
                fromUser: currentUser.username,
                date: date
            }
        );
        
        updateRequestCounts();
        showToast('Duty change request submitted! Notification sent.', 'success');
        showSection('home');
        document.getElementById('dutyChangeForm').reset();
    }
}

// Leave Application Functions
function loadLeaveForm() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const leaveDateEl = document.getElementById('leaveDate');
    if (leaveDateEl) leaveDateEl.value = tomorrow.toISOString().split('T')[0];
    loadUserDutyTimes('leaveDutyTime', tomorrow.toISOString().split('T')[0]);
    updateLeaveRules();
}

function updateLeaveRules() {
    const leaveType = document.getElementById('leaveType').value;
    const leaveDate = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const alertDiv = document.getElementById('leaveRulesAlert');
    const submitBtn = document.getElementById('submitLeaveBtn');
    
    if (!leaveType || !leaveDate || !dutyTime) {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'Please select leave type, date and duty time';
        if (submitBtn) submitBtn.disabled = true;
        return;
    }
    
    // Check if user is off duty
    if (dutyTime === 'Off' || dutyTime === '') {
        alertDiv.className = 'alert alert-warning';
        alertDiv.textContent = 'You are off duty on this date. No leave needed.';
        if (submitBtn) submitBtn.disabled = true;
        return;
    }
    
    const dutyStart = dutyTime.split('-')[0];
    const dutyDateTime = new Date(leaveDate + 'T' + dutyStart + ':00');
    const now = new Date();
    const hoursBeforeDuty = (dutyDateTime - now) / (1000 * 60 * 60);
    
    let canApply = false;
    let message = '';
    
    if (leaveType === 'Sick Leave') {
        canApply = hoursBeforeDuty >= 2;
        message = canApply 
            ? '‚úÖ You can apply for Sick Leave (2+ hours before duty)'
            : `‚ùå Need ${Math.ceil(2 - hoursBeforeDuty)} more hours before duty`;
    } else if (leaveType === 'FRL') {
        canApply = hoursBeforeDuty >= 1;
        message = canApply
            ? '‚úÖ You can apply for FRL (1+ hour before duty)'
            : `‚ùå Need ${Math.ceil(1 - hoursBeforeDuty)} more hours before duty`;
    }
    
    // Check balance if user can apply
    if (canApply) {
        const duration = parseFloat(document.getElementById('leaveDuration').value) || 1;
        const userBalance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
        
        if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
            canApply = false;
            message = `‚ùå Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days`;
        } else if (leaveType === 'FRL' && userBalance.FRL < duration) {
            canApply = false;
            message = `‚ùå Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days`;
        }
    }
    
    alertDiv.className = canApply ? 'alert alert-success' : 'alert alert-danger';
    alertDiv.innerHTML = `<strong>${leaveType} Rules:</strong><br>${message}`;
    if (submitBtn) submitBtn.disabled = !canApply;
}

async function submitLeaveApplication() {
    if (!currentUser) return;
    
    const leaveType = document.getElementById('leaveType').value;
    const date = document.getElementById('leaveDate').value;
    const dutyTime = document.getElementById('leaveDutyTime').value;
    const duration = parseFloat(document.getElementById('leaveDuration').value);
    const reason = document.getElementById('leaveReason').value;
    
    if (!leaveType || !date || !dutyTime || !reason) {
        showToast('Please fill all required fields', 'warning');
        return;
    }
    
    if (dutyTime === 'Off' || dutyTime === '') {
        showToast('You are off duty on this date', 'warning');
        return;
    }
    
    // Check balance
    const userBalance = leaveBalances[currentUser.username];
    if (!userBalance) {
        showToast('Error: User balance not found', 'error');
        return;
    }
    
    // IMMEDIATELY DEDUCT FROM BALANCE
    if (leaveType === 'Sick Leave') {
        if (userBalance.SL < duration) {
            showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days`, 'warning');
            return;
        }
        userBalance.SL -= duration;
        userBalance.SL = Math.max(0, userBalance.SL); // Ensure non-negative
    } else if (leaveType === 'FRL') {
        if (userBalance.FRL < duration) {
            showToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days`, 'warning');
            return;
        }
        userBalance.FRL -= duration;
        userBalance.FRL = Math.max(0, userBalance.FRL);
    }
    
    // Save updated balance immediately
    await saveLeaveBalances();
    
    // Create leave request (auto-approved since balance already deducted)
    const request = {
        id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        type: 'leave',
        leaveType: leaveType,
        fromUsername: currentUser.username,
        fromName: currentUser.name,
        fromRcNo: currentUser.rcNo,
        date: date,
        dutyTime: dutyTime,
        duration: duration,
        reason: reason,
        status: 'approved', // Auto-approved since balance deducted
        timestamp: new Date().toISOString(),
        approvedBy: 'System (Auto-approved)',
        approvedAt: new Date().toISOString(),
        history: [{
            action: 'created_and_approved',
            by: currentUser.name,
            timestamp: new Date().toISOString(),
            note: 'Leave balance deducted immediately upon application'
        }]
    };
    
    allRequests.push(request);
    
    // Save request
    const success = await saveAllRequests();
    if (success) {
        // Update UI immediately
        updateUserBalance();
        updateRequestCounts();
        
        // Send notification to supervisor
        const supervisor = allUsers.find(u => u.Level === 'Supervisor');
        if (supervisor) {
            await sendPushNotification(
                supervisor.username,
                'New Leave Application',
                `${currentUser.name} applied for ${leaveType} on ${date}`,
                {
                    type: 'leaveApplication',
                    requestId: request.id,
                    username: currentUser.username,
                    leaveType: leaveType,
                    date: date
                }
            );
        }
        
        // Show success message with balance deduction info
        showToast(`${leaveType} application submitted successfully! ${duration} day(s) deducted from your balance.`, 'success');
        
        // Reset form and go to dashboard
        showSection('home');
        document.getElementById('leaveApplicationForm').reset();
        
        // Show updated balance
        showToast(`New ${leaveType} balance: ${leaveType === 'Sick Leave' ? userBalance.SL.toFixed(1) : userBalance.FRL.toFixed(1)} days`, 'info', 2000);
    }
}

// My Requests Functions
function loadMyRequests() {
    const tbody = document.getElementById('myRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
    
    if (myReqs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                    <div style="color: #7f8c8d; font-size: 16px;">
                        No requests found
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Sort by timestamp
    myReqs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    myReqs.forEach(req => {
        const tr = document.createElement('tr');
        
        let details = '';
        if (req.type === 'dutyChange') {
            details = `Swap with ${req.toName} (${req.toDutyTime})`;
        } else {
            details = `${req.leaveType} - ${req.duration} day(s)`;
        }
        
        let statusClass = 'status-' + req.status;
        let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
        
        tr.innerHTML = `
            <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
            <td>${req.date}</td>
            <td>${details}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>
                ${req.status === 'pending' ? 
                    `<button class="action-btn reject" onclick="cancelRequest('${req.id}')">Cancel</button>` : ''}
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

async function cancelRequest(requestId) {
    if (!confirm('Are you sure you want to cancel this request?')) return;
    
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    if (request.status !== 'pending') {
        showToast('Only pending requests can be cancelled', 'warning');
        return;
    }
    
    // If it's a leave request that was auto-approved, refund the balance
    if (request.type === 'leave' && request.status === 'approved') {
        const userBalance = leaveBalances[request.fromUsername];
        if (userBalance) {
            if (request.leaveType === 'Sick Leave') {
                userBalance.SL += request.duration;
            } else if (request.leaveType === 'FRL') {
                userBalance.FRL += request.duration;
            }
            await saveLeaveBalances();
            updateUserBalance();
            showToast(`${request.duration} day(s) refunded to ${request.leaveType} balance`, 'info');
        }
    }
    
    request.status = 'cancelled';
    request.history.push({
        action: 'cancelled',
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        loadMyRequests();
        updateRequestCounts();
        showToast('Request cancelled', 'success');
    }
}

// Pending Requests Functions
function loadPendingRequests() {
    const tbody = document.getElementById('pendingRequestsTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const pendingReqs = allRequests.filter(req => 
        req.status === 'pending' && 
        req.type === 'dutyChange' && 
        req.toUsername === currentUser.username
    );
    
    if (pendingReqs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 40px;">
                    <div style="color: #7f8c8d; font-size: 16px;">
                        No pending requests
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    pendingReqs.forEach(req => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td>${req.fromName}</td>
            <td>${req.date}</td>
            <td>Swap ${req.dutyTime} with ${req.toDutyTime}</td>
            <td class="action-buttons">
                <button class="action-btn approve" onclick="respondToRequest('${req.id}', 'approved')">Accept</button>
                <button class="action-btn reject" onclick="respondToRequest('${req.id}', 'rejected')">Reject</button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

async function respondToRequest(requestId, response) {
    const request = allRequests.find(req => req.id === requestId);
    if (!request) {
        showToast('Request not found', 'error');
        return;
    }
    
    if (response === 'approved') {
        // Swap duty times
        const date = request.date;
        if (dutyRoster[date]) {
            const fromDuty = dutyRoster[date][request.fromUsername];
            const toDuty = dutyRoster[date][request.toUsername];
            
            dutyRoster[date][request.fromUsername] = toDuty;
            dutyRoster[date][request.toUsername] = fromDuty;
            
            await saveDutyRoster();
        }
    }
    
    request.status = response;
    request.respondedAt = new Date().toISOString();
    request.history.push({
        action: response,
        by: currentUser.name,
        timestamp: new Date().toISOString()
    });
    
    const success = await saveAllRequests();
    if (success) {
        // Send notification to requester
        await sendPushNotification(
            request.fromUsername,
            `Duty Change Request ${response === 'approved' ? 'Approved' : 'Rejected'}`,
            `${currentUser.name} has ${response} your duty change request for ${request.date}`,
            {
                type: 'dutyChangeResponse',
                requestId: requestId,
                response: response,
                date: request.date
            }
        );
        
        showToast(`Request ${response} successfully! Notification sent.`, 'success');
        showSection('home');
        updateRequestCounts();
    }
}

// All Roster Functions
function loadAllRoster() {
    const container = document.getElementById('allRosterContainer');
    if (!container) return;
    
    const startDate = document.getElementById('allRosterStartDate').value;
    const endDate = document.getElementById('allRosterEndDate').value;
    
    if (!startDate || !endDate) {
        // Default to next 7 days
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(nextWeek.getDate() + 7);
        
        document.getElementById('allRosterStartDate').value = today.toISOString().split('T')[0];
        document.getElementById('allRosterEndDate').value = nextWeek.toISOString().split('T')[0];
        
        loadAllRoster();
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        showToast('Start date must be before end date', 'warning');
        return;
    }
    
    // Generate roster table
    const today = new Date().toISOString().split('T')[0];
    let html = '<div class="table-container"><table>';
    
    // Header
    html += '<thead><tr><th>Date</th><th>Day</th>';
    allUsers.forEach(user => {
        if (user.Level === 'User') {
            html += `<th>${user.name}<br><small>${user.RCNo}</small></th>`;
        }
    });
    html += '</tr></thead><tbody>';
    
    // Rows
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const isToday = dateStr === today;
        
        html += `<tr ${isToday ? 'style="background-color: rgba(52, 152, 219, 0.1);"' : ''}>`;
        html += `<td>${dateStr}${isToday ? ' <strong>(Today)</strong>' : ''}</td>`;
        html += `<td>${dayName}</td>`;
        
        // Staff duties
        allUsers.forEach(user => {
            if (user.Level === 'User') {
                let dutyTime = 'Off';
                let cellClass = 'off-day-cell';
                
                if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                    dutyTime = dutyRoster[dateStr][user.username];
                    if (dutyTime !== 'Off') {
                        cellClass = getDutyTimeClass(dutyTime);
                    }
                }
                
                html += `<td class="${cellClass}">${dutyTime}</td>`;
            }
        });
        
        html += '</tr>';
    }
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getDutyTimeClass(dutyTime) {
    if (!dutyTime || dutyTime === 'Off') return 'off-day-cell';
    if (dutyTime.includes('Leave')) return 'duty-leave';
    
    const normalizedTime = dutyTime.replace(/\s/g, '').toUpperCase();
    
    if (normalizedTime.includes('0730-1530') || normalizedTime.includes('0700-1500')) 
        return 'duty-0730-1530';
    if (normalizedTime.includes('0830-1630') || normalizedTime.includes('0800-1600')) 
        return 'duty-0830-1630';
    if (normalizedTime.includes('1030-1830') || normalizedTime.includes('1000-1800')) 
        return 'duty-1030-1830';
    if (normalizedTime.includes('1530-2330') || normalizedTime.includes('1500-2300')) 
        return 'duty-1530-2330';
    if (normalizedTime.includes('1630-0030') || normalizedTime.includes('1600-0000')) 
        return 'duty-1630-0030';
    
    return 'duty-other';
}

// Admin Announcements Functions
function loadAnnouncementsAdmin() {
    const container = document.getElementById('activeAnnouncementsList');
    if (!container) return;
    
    container.innerHTML = '';
    
    const activeAnnouncements = announcements.filter(ann => 
        ann.status !== 'expired' && ann.status !== 'archived'
    );
    
    if (activeAnnouncements.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üì¢</div>
                <div class="empty-state-title">No Active Announcements</div>
            </div>
        `;
        return;
    }
    
    activeAnnouncements.forEach(ann => {
        const announcementDiv = document.createElement('div');
        announcementDiv.className = `announcement-banner priority-${ann.priority}`;
        announcementDiv.style.marginBottom = '15px';
        
        announcementDiv.innerHTML = `
            <div class="announcement-title">
                <span>üì¢</span> ${ann.title}
            </div>
            <div style="margin-bottom: 10px;">${ann.content}</div>
            <div style="font-size: 12px; opacity: 0.9;">
                By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
                <button class="action-btn reject" onclick="deleteAnnouncement('${ann.id}')" 
                        style="float: right; margin-left: 5px;">Delete</button>
            </div>
        `;
        
        container.appendChild(announcementDiv);
    });
}

async function createAnnouncement() {
    if (!currentUser) return;
    
    const title = document.getElementById('announcementTitle').value.trim();
    const content = document.getElementById('announcementContent').value.trim();
    const priority = document.getElementById('announcementPriority').value;
    
    if (!title || !content) {
        showToast('Please fill title and content', 'warning');
        return;
    }
    
    const announcement = {
        id: 'ann_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        title: title,
        content: content,
        priority: priority,
        target: 'all',
        createdBy: currentUser.name,
        createdByUsername: currentUser.username,
        createdAt: new Date().toISOString(),
        status: 'active'
    };
    
    announcements.push(announcement);
    
    const success = await saveAnnouncements();
    if (success) {
        // Send push notification to all users
        allUsers.forEach(async (user) => {
            if (user.username !== currentUser.username) {
                await sendPushNotification(
                    user.username,
                    'New Announcement',
                    `${currentUser.name}: ${title}`,
                    {
                        type: 'announcement',
                        announcementId: announcement.id,
                        priority: priority
                    }
                );
            }
        });
        
        showToast('Announcement created! Notifications sent to all users.', 'success');
        document.getElementById('announcementForm').reset();
        loadAnnouncementsAdmin();
        loadHomeAnnouncements();
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Delete this announcement?')) return;
    
    const index = announcements.findIndex(ann => ann.id === announcementId);
    if (index !== -1) {
        announcements.splice(index, 1);
        const success = await saveAnnouncements();
        if (success) {
            showToast('Announcement deleted', 'success');
            loadAnnouncementsAdmin();
            loadHomeAnnouncements();
        }
    }
}

// Setup Event Listeners
function setupEventListeners() {
    // Duty Change Form
    const dutyChangeForm = document.getElementById('dutyChangeForm');
    if (dutyChangeForm) {
        dutyChangeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitDutyChange();
        });
    }
    
    // Leave Application Form
    const leaveApplicationForm = document.getElementById('leaveApplicationForm');
    if (leaveApplicationForm) {
        leaveApplicationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitLeaveApplication();
        });
    }
    
    // Announcement Form
    const announcementForm = document.getElementById('announcementForm');
    if (announcementForm) {
        announcementForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createAnnouncement();
        });
    }
    
    // Date change handlers
    document.getElementById('changeDate')?.addEventListener('change', function() {
        loadUserDutyTimes('changeDutyTime', this.value);
    });
    
    document.getElementById('requestToStaff')?.addEventListener('change', function() {
        const user = allUsers.find(u => u.username === this.value);
        if (user) {
            document.getElementById('requestToRcNo').value = user.RCNo;
            const date = document.getElementById('changeDate').value;
            if (date) {
                // Load staff's duty time
                const select = document.getElementById('requestToDutyTime');
                select.innerHTML = '<option value="">Select duty time</option>';
                const dutyTime = dutyRoster[date] && dutyRoster[date][user.username];
                if (dutyTime) {
                    const option = document.createElement('option');
                    option.value = dutyTime;
                    option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                    select.appendChild(option);
                }
            }
        }
    });
    
    // Leave form handlers
    document.getElementById('leaveDate')?.addEventListener('change', function() {
        loadUserDutyTimes('leaveDutyTime', this.value);
        updateLeaveRules();
    });
    
    document.getElementById('leaveType')?.addEventListener('change', updateLeaveRules);
    document.getElementById('leaveDutyTime')?.addEventListener('change', updateLeaveRules);
    document.getElementById('leaveDuration')?.addEventListener('change', updateLeaveRules);
    
    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('dutySystemSession');
            localStorage.removeItem('fcmToken');
            location.reload();
        }
    });
    
    // Install app button
    document.getElementById('installBtn')?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
                const installBtnContainer = document.getElementById('installBtnContainer');
                if (installBtnContainer) {
                    installBtnContainer.style.display = 'none';
                }
                localStorage.setItem('appInstalled', 'true');
            }
            deferredPrompt = null;
        }
    });
}

// Export functions for use in HTML onclick attributes
window.showSection = showSection;
window.updateDashboard = updateDashboard;
window.requestNotificationPermission = requestNotificationPermission;
window.testPushNotification = testPushNotification;
window.respondToRequest = respondToRequest;
window.cancelRequest = cancelRequest;
window.deleteAnnouncement = deleteAnnouncement;
window.loadAllRoster = loadAllRoster;
window.clearNotifications = clearNotifications;

// Add CSS animations
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
});
</script>
</body>
</html>
