<!DOCTYPE html>
<html>
<head>
    <title>PWA Push App</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 600px; margin: 0 auto; }
        button { background: #4285f4; color: white; border: none; padding: 12px 24px; 
                 border-radius: 5px; font-size: 16px; cursor: pointer; margin: 10px; }
        .card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üì± My PWA App</h1>
    
    <div class="card">
        <h3>Step 1: Enable Notifications</h3>
        <button onclick="enableNotifications()">üîî Enable Push Notifications</button>
        <div id="status1"></div>
    </div>
    
    <div class="card">
        <h3>Step 2: Subscribe to All Users Topic</h3>
        <button onclick="subscribeToTopic()">üì¢ Subscribe to All Users</button>
        <div id="status2"></div>
    </div>
    
    <div class="card">
        <h3>Step 3: Install as PWA</h3>
        <p>Click "Add to Home Screen" in browser menu</p>
        <div id="installBtn"></div>
    </div>
    
    <div id="tokenDisplay" style="display:none;">
        <h3>Your FCM Token:</h3>
        <textarea id="tokenArea" style="width:100%; height:60px;"></textarea>
    </div>

    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
            authDomain: "leelidc-1f753.firebaseapp.com",
            projectId: "leelidc-1f753",
            storageBucket: "leelidc-1f753.firebasestorage.app",
            messagingSenderId: "43622932335",
            appId: "1:43622932335:web:a7529bce1f19714687129a"
        };
        
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();
        
        let currentToken = null;
        
        async function enableNotifications() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    document.getElementById('status1').innerHTML = 
                        '<p class="success">‚úÖ Notifications enabled</p>';
                    
                    // Get FCM token
                    currentToken = await messaging.getToken({
                        vapidKey: "BCS5MgDiA9DOzT_CI12agRMwNRtU6wehijEVEkjY77LMRnv6Fh9mlGocJ87k_5w862iwomMSx1xRGJFRH9W3s_8"
                    });
                    
                    if (currentToken) {
                        document.getElementById('tokenArea').value = currentToken;
                        document.getElementById('tokenDisplay').style.display = 'block';
                        console.log('Token:', currentToken);
                        
                        // Automatically subscribe to topic after getting token
                        await subscribeToTopic();
                    }
                } else {
                    document.getElementById('status1').innerHTML = 
                        '<p class="error">‚ùå Notifications blocked</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status1').innerHTML = 
                    `<p class="error">‚ùå ${error.message}</p>`;
            }
        }
        
        async function subscribeToTopic() {
            if (!currentToken) {
                alert('Please enable notifications first');
                return;
            }
            
            try {
                document.getElementById('status2').innerHTML = 
                    '<p>‚è≥ Subscribing to "all_users" topic...</p>';
                
                // Subscribe to topic using Firebase Functions
                const response = await fetch('https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/subscribeToTopic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: currentToken,
                        topic: 'all_users'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('status2').innerHTML = 
                        '<p class="success">‚úÖ Subscribed to "all_users" topic!</p>' +
                        '<p><small>You will now receive broadcasts to all users</small></p>';
                } else {
                    document.getElementById('status2').innerHTML = 
                        `<p class="error">‚ùå ${result.error || 'Subscription failed'}</p>`;
                }
            } catch (error) {
                console.error('Subscription error:', error);
                
                // Fallback: Use REST API directly
                await subscribeViaRestAPI();
            }
        }
        
        async function subscribeViaRestAPI() {
            // Direct REST API call (no server needed)
            const projectId = firebaseConfig.projectId;
            const url = `https://iid.googleapis.com/iid/v1/${currentToken}/rel/topics/all_users`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `key=YOUR_SERVER_KEY`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                document.getElementById('status2').innerHTML = 
                    '<p class="success">‚úÖ Subscribed via REST API!</p>';
            } else {
                document.getElementById('status2').innerHTML = 
                    '<p class="error">‚ùå REST subscription failed</p>';
            }
        }
        
        // Handle incoming messages
        messaging.onMessage((payload) => {
            console.log('Message received:', payload);
            
            // Show notification
            if (Notification.permission === 'granted') {
                const notification = new Notification(payload.notification.title, {
                    body: payload.notification.body,
                    icon: payload.notification.icon || '/icon.png',
                    data: payload.data
                });
                
                notification.onclick = function() {
                    if (payload.data && payload.data.url) {
                        window.open(payload.data.url, '_blank');
                    }
                };
            }
        });
        
        // Check if app is installed as PWA
        window.addEventListener('appinstalled', (event) => {
            console.log('App installed as PWA');
            document.getElementById('installBtn').innerHTML = 
                '<p class="success">‚úÖ Installed as PWA!</p>';
        });
        
        // Show install button for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            document.getElementById('installBtn').innerHTML = 
                '<button onclick="installPWA()">üì± Install as PWA</button>';
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // Check on load
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('firebase-messaging-sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('SW error:', err));
        }
    </script>
</body>
</html>
