import { 
    messaging, 
    functions, 
    getToken, 
    onMessage, 
    httpsCallable 
} from './firebase-config.js';

// DOM Elements
const statusEl = document.getElementById('status');
const requestPermissionBtn = document.getElementById('requestPermission');
const subscribeButton = document.getElementById('subscribeButton');
const sendTestButton = document.getElementById('sendTestButton');
const notificationEl = document.getElementById('notification');

// Your VAPID key (Replace with your own from Firebase Console)
// Get it from: Firebase Console â†’ Project Settings â†’ Cloud Messaging â†’ Web configuration
const VAPID_KEY = "BCMEhQHZvwuii0Pul11PRfM68N_C4iox9c6jUwWoj21lvKZ2hhAfRe-5KwG_A1xMsQ04aelb8XM7x-mXNYzak1o";

let currentToken = null;

// Initialize app
async function initApp() {
    statusEl.textContent = 'Checking browser support...';
    
    if (!('serviceWorker' in navigator)) {
        statusEl.textContent = 'Service Workers not supported';
        return;
    }
    
    if (!('PushManager' in window)) {
        statusEl.textContent = 'Push Notifications not supported';
        return;
    }
    
    if (!messaging) {
        statusEl.textContent = 'Firebase Messaging not available';
        return;
    }
    
    // Request notification permission
    requestPermissionBtn.disabled = false;
    requestPermissionBtn.addEventListener('click', requestPermission);
    
    statusEl.textContent = 'Ready to request permission';
}

// Request notification permission
async function requestPermission() {
    try {
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
            statusEl.textContent = 'Permission granted! Setting up push notifications...';
            requestPermissionBtn.disabled = true;
            subscribeButton.disabled = false;
            
            // Register service worker
            await registerServiceWorker();
        } else {
            statusEl.textContent = 'Permission denied';
        }
    } catch (error) {
        console.error('Error requesting permission:', error);
        statusEl.textContent = 'Error: ' + error.message;
    }
}

// Register Service Worker
async function registerServiceWorker() {
    try {
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('Service Worker registered:', registration);
        
        // Enable subscribe button
        subscribeButton.disabled = false;
        subscribeButton.addEventListener('click', subscribeToPush);
        
        statusEl.textContent = 'Service Worker registered. Click "Enable Push Notifications"';
    } catch (error) {
        console.error('Service Worker registration failed:', error);
        statusEl.textContent = 'Failed to register Service Worker';
    }
}

// Subscribe to push notifications
async function subscribeToPush() {
    try {
        statusEl.textContent = 'Getting FCM token...';
        
        // Get FCM token
        currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
        
        if (currentToken) {
            statusEl.innerHTML = `
                <strong>Token obtained successfully!</strong><br>
                <small style="word-break: break-all;">${currentToken}</small>
            `;
            
            // Save token to Firebase Functions
            await saveTokenToFirestore(currentToken);
            
            // Enable test button
            sendTestButton.disabled = false;
            sendTestButton.addEventListener('click', sendTestNotification);
            subscribeButton.disabled = true;
            
            // Listen for foreground messages
            setupMessageListener();
        } else {
            statusEl.textContent = 'No registration token available. Request permission to generate one.';
        }
    } catch (error) {
        console.error('Error getting token:', error);
        statusEl.textContent = 'Error getting token: ' + error.message;
    }
}

// Save token to Firebase Functions
async function saveTokenToFirestore(token) {
    try {
        const saveTokenFunction = httpsCallable(functions, 'saveToken');
        await saveTokenFunction({ token: token });
        console.log('Token saved successfully');
    } catch (error) {
        console.error('Error saving token:', error);
    }
}

// Send test notification
async function sendTestNotification() {
    try {
        if (!currentToken) {
            alert('No token available. Please enable notifications first.');
            return;
        }
        
        statusEl.textContent = 'Sending test notification...';
        sendTestButton.disabled = true;
        
        const sendTestFunction = httpsCallable(functions, 'sendTestNotification');
        const result = await sendTestFunction({
            token: currentToken,
            title: 'Test Notification',
            body: 'This is a test from your PWA! ðŸŽ‰'
        });
        
        statusEl.innerHTML = `
            <strong>Test notification sent!</strong><br>
            <small>Message ID: ${result.data.messageId}</small>
        `;
        
        sendTestButton.disabled = false;
    } catch (error) {
        console.error('Error sending notification:', error);
        statusEl.textContent = 'Error: ' + error.message;
        sendTestButton.disabled = false;
    }
}

// Setup message listener for foreground messages
function setupMessageListener() {
    onMessage(messaging, (payload) => {
        console.log('Message received in foreground:', payload);
        
        // Show notification
        showNotification(payload.notification);
    });
}

// Show notification in UI
function showNotification(notification) {
    notificationEl.textContent = `${notification.title}: ${notification.body}`;
    notificationEl.style.display = 'block';
    
    setTimeout(() => {
        notificationEl.style.display = 'none';
    }, 5000);
}

// Service Worker file for background notifications
if ('serviceWorker' in navigator) {
    // Create the service worker file dynamically
    const swContent = `
// Firebase Service Worker for background messages
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js');

firebase.initializeApp({
    apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
    authDomain: "leelidc-1f753.firebaseapp.com",
    projectId: "leelidc-1f753",
    storageBucket: "leelidc-1f753.firebasestorage.app",
    messagingSenderId: "43622932335",
    appId: "1:43622932335:web:a7529bce1f19714687129a",
    measurementId: "G-3KD6ZYS599"
});

const messaging = firebase.messaging();

// Background message handler
messaging.onBackgroundMessage((payload) => {
    console.log('[firebase-messaging-sw.js] Received background message:', payload);
    
    const notificationTitle = payload.notification.title;
    const notificationOptions = {
        body: payload.notification.body,
        icon: 'https://leelidc-1f753.firebaseapp.com/icon-192x192.png',
        badge: 'https://leelidc-1f753.firebasestorage.app/badge-72x72.png',
        data: payload.data || {}
    };
    
    self.registration.showNotification(notificationTitle, notificationOptions);
});

// Handle notification click
self.addEventListener('notificationclick', (event) => {
    console.log('Notification clicked:', event.notification);
    event.notification.close();
    
    // Open the app
    event.waitUntil(
        clients.matchAll({type: 'window', includeUncontrolled: true})
        .then((clientList) => {
            for (const client of clientList) {
                if (client.url === '/' && 'focus' in client) {
                    return client.focus();
                }
            }
            if (clients.openWindow) {
                return clients.openWindow('/');
            }
        })
    );
});
    `;
    
    // Create blob URL for service worker
    const blob = new Blob([swContent], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    
    // Store URL for later use
    window.serviceWorkerUrl = swUrl;
}

// Start the app
document.addEventListener('DOMContentLoaded', initApp);
