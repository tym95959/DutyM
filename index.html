<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leeli DC Announcements</title>
<link rel="manifest" href="manifest.json">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="dcfire.js"></script>
<style>
body { font-family: Arial; padding: 20px; }
#messages { margin-top: 20px; }
.message { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
</style>
</head>
<body>
<h1>Announcements</h1>
<button id="enablePush">Enable Notifications</button>
<div id="messages"></div>

<script>
// Initialize messaging here
const messaging = firebase.messaging();

// Request notification permission and get FCM token
document.getElementById('enablePush').onclick = async () => {
    try {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") throw new Error("Permission not granted");
        
        const token = await messaging.getToken({ vapidKey: 'BCMEhQHZvwuii0Pul11PRfM68N_C4iox9c6jUwWoj21lvKZ2hhAfRe-5KwG_A1xMsQ04aelb8XM7x-mXNYzak1o' });
        console.log('FCM Token:', token);
        alert('Notifications enabled!');
        
        // Optionally, save token to Firestore for targeted messaging
        await db.collection('users').doc(token).set({ token, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    } catch (err) {
        console.error(err);
        alert('Notification permission denied.');
    }
};

// Listen for messages when app is in foreground
messaging.onMessage(payload => {
    console.log('Message received: ', payload);
    const div = document.createElement('div');
    div.className = 'message';
    div.innerText = payload.notification.title + "\n" + payload.notification.body;
    document.getElementById('messages').prepend(div);
});

// Fetch latest announcements from Firestore
db.collection('announcements').orderBy('timestamp', 'desc').limit(10)
.onSnapshot(snapshot => {
    const container = document.getElementById('messages');
    container.innerHTML = '';
    snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<strong>${data.title}</strong><br>${data.message}`;
        container.appendChild(div);
    });
});
</script>
</body>
</html>
