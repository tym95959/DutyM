<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Duty Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    <meta name="description" content="Duty and Leave Management System">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3498db">
    
    <!-- Web App Manifest -->
    <link rel="manifest" id="app-manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icons/icon-96.png">
    
    <title>Duty Management System</title>
    
    <!-- Firebase SDKs - Use local fallback -->
    <script>
        // Firebase SDKs with fallback
        function loadFirebase() {
            const firebaseScripts = [
                'https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js',
                'https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js',
                'https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js'
            ];
            
            let loaded = 0;
            firebaseScripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loaded++;
                    if (loaded === firebaseScripts.length) {
                        initializeFirebase();
                    }
                };
                script.onerror = () => {
                    console.warn('Failed to load Firebase from CDN, using local fallback');
                    loadLocalFirebase();
                };
                document.head.appendChild(script);
            });
        }
        
        function loadLocalFirebase() {
            const scripts = [
                'firebase-app.js',
                'firebase-firestore.js',
                'firebase-messaging.js'
            ];
            
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                document.head.appendChild(script);
            });
            
            // Wait a bit then initialize
            setTimeout(initializeFirebase, 1000);
        }
        
        function initializeFirebase() {
            if (typeof firebase === 'undefined') {
                console.error('Firebase not loaded');
                return;
            }
            
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCHPVt3vO1oPHW1kPFnZtof5nIwaXU9_oQ",
                    authDomain: "duty-management-414610.firebaseapp.com",
                    projectId: "duty-management-414610",
                    storageBucket: "duty-management-414610.appspot.com",
                    messagingSenderId: "449919731322",
                    appId: "1:449919731322:web:2d305bb69dee30fafc5ff7"
                };
                
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }
        }
        
        // Load Firebase when DOM is ready
        document.addEventListener('DOMContentLoaded', loadFirebase);
    </script>
    
    <!-- SHA256 Library - Self-hosted version -->
    <script src="sha256.min.js"></script>
    
    <style>
        /* Mobile-First CSS - Keep all the CSS from previous version */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* PWA Safe Areas */
        @supports (padding: max(0px)) {
            body {
                padding-left: min(0vmin, env(safe-area-inset-left));
                padding-right: min(0vmin, env(safe-area-inset-right));
                padding-top: min(0vmin, env(safe-area-inset-top));
                padding-bottom: min(0vmin, env(safe-area-inset-bottom));
            }
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
            backdrop-filter: blur(5px);
        }

        #loadingOverlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* Install Prompt */
        #installPrompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            animation: slideUp 0.3s ease;
            border: 2px solid #3498db;
        }

        #installPrompt.show {
            display: block;
        }

        .install-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .install-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .install-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .install-subtitle {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .install-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .install-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .install-btn.primary {
            background: #3498db;
            color: white;
        }

        .install-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }

        /* Toast Container */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: calc(100% - 40px);
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid #3498db;
        }

        /* Login Page */
        .login-container {
            background: white;
            width: 100%;
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-block {
            width: 100%;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #f5f7fa;
        }

        /* Mobile Header */
        .mobile-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px;
            padding-top: max(15px, env(safe-area-inset-top));
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 60px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
        }

        .mobile-title {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .mobile-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* Mobile Navigation */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            backdrop-filter: blur(5px);
        }

        .mobile-nav-overlay.active {
            display: block;
        }

        .mobile-nav {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: white;
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .mobile-nav.active {
            transform: translateX(0);
        }

        .nav-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .nav-user-details {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-items {
            flex: 1;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            color: #2c3e50;
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
            cursor: pointer;
        }

        .nav-item.active {
            background: #e8f4fc;
            color: #3498db;
            border-left: 4px solid #3498db;
        }

        .nav-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-item-badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        .nav-footer {
            padding: 20px;
            border-top: 1px solid #f0f0f0;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e6ed;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 99;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #7f8c8d;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }

        .bottom-nav-btn.active {
            color: #3498db;
        }

        .bottom-nav-icon {
            font-size: 20px;
        }

        /* Content Area */
        .dashboard-content {
            padding: 20px;
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            min-height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            font-weight: 600;
        }

        /* Balance Display */
        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .balance-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e6ed;
        }

        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .balance-label {
            font-size: 13px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 500;
        }

        /* Form Rows */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
            line-height: 1.4;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Announcement Banner */
        .announcement-banner {
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .announcement-banner.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .announcement-banner.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .announcement-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Mobile Optimized Form Elements */
        select.form-control {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237f8c8d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            line-height: 1.4;
        }

        /* Responsive Grids */
        @media (min-width: 768px) {
            .balance-display {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1;
                min-width: 200px;
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Mobile Specific */
        @media (max-width: 767px) {
            .dashboard-content {
                padding: 15px;
                padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
            
            th, td {
                padding: 10px;
                font-size: 13px;
            }
            
            .action-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
            
            #installPrompt {
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading...</div>
    </div>

    <!-- Install Prompt -->
    <div id="installPrompt">
        <div class="install-header">
            <div class="install-icon">DM</div>
            <div>
                <div class="install-title">Install Duty Manager</div>
                <div class="install-subtitle">Get quick access and offline support</div>
            </div>
        </div>
        <div class="install-buttons">
            <button class="install-btn secondary" id="installLaterBtn">Later</button>
            <button class="install-btn primary" id="installNowBtn">Install</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <span>üîê</span> Login
            </button>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="menu-toggle" id="menuToggle">
                ‚ò∞
            </button>
            <div class="mobile-title" id="mobileTitle">Dashboard</div>
            <div class="mobile-user">
                <div class="mobile-avatar" id="mobileAvatar">U</div>
            </div>
        </div>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
        <div class="mobile-nav" id="mobileNav">
            <div class="nav-header">
                <div class="nav-user-name" id="navUserName">User Name</div>
                <div class="nav-user-details">
                    <span>RC: <span id="navUserRC">000</span></span>
                    <span>Level: <span id="navUserLevel">User</span></span>
                </div>
            </div>
            
            <div class="nav-items">
                <div class="nav-item active" data-section="home">
                    <span class="nav-item-icon">üè†</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-section="dutyChange">
                    <span class="nav-item-icon">üîÑ</span>
                    <span>Duty Change</span>
                </div>
                <div class="nav-item" data-section="leaveApplication">
                    <span class="nav-item-icon">üìÖ</span>
                    <span>Apply Leave</span>
                </div>
                <div class="nav-item" data-section="myRequests">
                    <span class="nav-item-icon">üìã</span>
                    <span>My Requests</span>
                    <span class="nav-item-badge" id="myRequestsBadge" style="display: none;">0</span>
                </div>
                <div class="nav-item" data-section="pendingRequests" id="pendingRequestsNav" style="display: none;">
                    <span class="nav-item-icon">‚è≥</span>
                    <span>Pending</span>
                    <span class="nav-item-badge" id="pendingRequestsBadge">0</span>
                </div>
                <div class="nav-item" data-section="viewAllRoster">
                    <span class="nav-item-icon">üë•</span>
                    <span>All Roster</span>
                </div>
            </div>
            
            <div class="nav-footer">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <span>üö™</span> Logout
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements"></div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;"></div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <span>üîÑ</span> Refresh
                        </button>
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">
                            <span>üîÑ</span> Change Duty
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <span>üìÖ</span> Apply Leave
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    
                    <div class="alert alert-info">
                        <strong>Note:</strong> Duty changes can be requested for future dates only (not today or past dates).
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">
                                <span>üì§</span> Submit Request
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <span>‚ùå</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div id="leaveBalanceCheck" class="alert alert-info">
                            Check your leave balance after selecting type
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">
                                <span>üì§</span> Submit Application
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <span>‚ùå</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests For You</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRequestsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View All Roster -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3>Complete Duty Roster</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterStartDate">From Date</label>
                            <input type="date" id="allRosterStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="allRosterEndDate">To Date</label>
                            <input type="date" id="allRosterEndDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="loadAllRoster()">
                            <span>üìä</span> Load Roster
                        </button>
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="bottom-nav-btn active" onclick="showSection('home')">
                <span class="bottom-nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('dutyChange')">
                <span class="bottom-nav-icon">üîÑ</span>
                <span>Change</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('leaveApplication')">
                <span class="bottom-nav-icon">üìÖ</span>
                <span>Leave</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('myRequests')">
                <span class="bottom-nav-icon">üìã</span>
                <span>Requests</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('viewAllRoster')">
                <span class="bottom-nav-icon">üë•</span>
                <span>Roster</span>
            </button>
        </div>
    </div>

    <script>
        // Mobile Duty Management System
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let announcements = [];
        let deferredPrompt = null;
        let messaging = null;
        let swRegistration = null;
        let currentToastId = 0;
        let db = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to load
            const checkFirebase = setInterval(() => {
                if (typeof firebase !== 'undefined') {
                    clearInterval(checkFirebase);
                    db = firebase.firestore();
                    initApp();
                    setupPWAInstall();
                    setupServiceWorker();
                }
            }, 100);
        });

        // Service Worker Registration
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Only register once
                if (!navigator.serviceWorker.controller) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('Service Worker registered successfully');
                            swRegistration = registration;
                            
                            // Initialize Firebase messaging after SW registration
                            if (firebase.messaging.isSupported()) {
                                messaging = firebase.messaging();
                                messaging.useServiceWorker(registration);
                                setupMessaging();
                            }
                        })
                        .catch(error => {
                            console.error('Service Worker registration failed:', error);
                        });
                }
            }
        }

        // PWA Installation
        function setupPWAInstall() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Check if already installed
                if (!isRunningStandalone()) {
                    setTimeout(() => {
                        showInstallPrompt();
                    }, 3000);
                }
            });
            
            // Install button click
            document.getElementById('installNowBtn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                    localStorage.setItem('installPromptShown', 'true');
                }
            });
            
            // Later button click
            document.getElementById('installLaterBtn').addEventListener('click', () => {
                document.getElementById('installPrompt').classList.remove('show');
                localStorage.setItem('installPromptShown', 'true');
            });
        }

        function showInstallPrompt() {
            if (deferredPrompt && !localStorage.getItem('installPromptShown')) {
                document.getElementById('installPrompt').classList.add('show');
                
                // Auto-hide after 30 seconds
                setTimeout(() => {
                    document.getElementById('installPrompt').classList.remove('show');
                }, 30000);
            }
        }

        function isRunningStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // Firebase Messaging Setup
        function setupMessaging() {
            if (!messaging) return;
            
            // Handle foreground messages
            messaging.onMessage((payload) => {
                console.log('Message received in foreground:', payload);
                showPushNotification(payload.notification);
            });
            
            // Request permission with better UX
            requestNotificationPermissionWithDelay();
        }

        function requestNotificationPermissionWithDelay() {
            // Wait until user is logged in and engaged
            setTimeout(() => {
                if (currentUser && Notification.permission === 'default') {
                    showNotificationPermissionRequest();
                }
            }, 10000); // Wait 10 seconds after page load
        }

        function showNotificationPermissionRequest() {
            const permissionDiv = document.createElement('div');
            permissionDiv.id = 'notificationPermissionRequest';
            permissionDiv.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 20px;
                right: 20px;
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideUp 0.3s ease;
                border: 2px solid #3498db;
            `;
            
            permissionDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #27ae60, #219653); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                        üîî
                    </div>
                    <div>
                        <div style="font-size: 18px; font-weight: 600; color: #2c3e50;">Enable Notifications</div>
                        <div style="font-size: 14px; color: #7f8c8d; margin-top: 5px;">Get instant updates about duty changes and approvals</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="notificationLaterBtn" style="flex: 1; background: #f0f0f0; color: #666; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        Later
                    </button>
                    <button id="notificationAllowBtn" style="flex: 1; background: #27ae60; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        Allow
                    </button>
                </div>
            `;
            
            document.body.appendChild(permissionDiv);
            
            document.getElementById('notificationAllowBtn').addEventListener('click', async () => {
                permissionDiv.remove();
                await requestNotificationPermission();
            });
            
            document.getElementById('notificationLaterBtn').addEventListener('click', () => {
                permissionDiv.remove();
                localStorage.setItem('notificationPromptShown', 'true');
            });
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (document.getElementById('notificationPermissionRequest')) {
                    document.getElementById('notificationPermissionRequest').remove();
                }
            }, 30000);
        }

        async function requestNotificationPermission() {
            if (!messaging || !('Notification' in window)) return;
            
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    await getFCMToken();
                    showToast('Notifications enabled successfully!', 'success');
                } else if (permission === 'denied') {
                    console.log('Notification permission denied.');
                    showToast('Notifications blocked. You can enable them in browser settings.', 'warning');
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
            }
        }

        async function getFCMToken() {
            try {
                const token = await messaging.getToken({
                    vapidKey: 'BCMEhQHZvwuii0Pul11PRfM68N_C4iox9c6jUwWoj21lvKZ2hhAfRe-5KwG_A1xMsQ04aelb8XM7x-mXNYzak1o',
                    serviceWorkerRegistration: swRegistration
                });
                if (token) {
                    console.log('FCM Token obtained');
                    if (currentUser) {
                        await saveUserFCMToken(token);
                    }
                } else {
                    console.log('No registration token available.');
                }
            } catch (error) {
                console.error('Error getting FCM token:', error);
            }
        }

        async function saveUserFCMToken(token) {
            if (!db || !currentUser) return;
            
            try {
                await db.collection('fcmTokens').doc(currentUser.username).set({
                    token: token,
                    username: currentUser.username,
                    name: currentUser.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error saving FCM token:', error);
            }
        }

        function showPushNotification(notification) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const options = {
                    body: notification.body,
                    icon: 'icons/icon-96.png',
                    badge: 'icons/badge-96.png',
                    vibrate: [100, 50, 100],
                    tag: 'duty-manager-notification',
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'view',
                            title: 'View'
                        }
                    ]
                };
                
                const pushNotification = new Notification(notification.title || 'Duty Manager', options);
                
                pushNotification.onclick = function() {
                    window.focus();
                    this.close();
                    // Navigate to appropriate section
                    if (notification.data && notification.data.type === 'request') {
                        showSection('pendingRequests');
                    }
                };
                
                // Also show in-app toast
                showToast(notification.body || 'New notification', 'info');
            }
        }

        // App Functions
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                    if (textEl) textEl.textContent = text;
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toastId = 'toast-' + (++currentToastId);
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">
                    ${type === 'success' ? '‚úÖ' : 
                      type === 'error' ? '‚ùå' : 
                      type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Remove after duration
            setTimeout(() => {
                const toastElem = document.getElementById(toastId);
                if (toastElem) {
                    toastElem.style.opacity = '0';
                    toastElem.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toastElem.parentNode) {
                            toastElem.parentNode.removeChild(toastElem);
                        }
                    }, 300);
                }
            }, duration);
        }

        function initApp() {
            // Setup login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }
            
            // Setup mobile navigation
            setupMobileNavigation();
            
            // Set minimum dates (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('changeDate').min = tomorrowStr;
            document.getElementById('leaveDate').min = tomorrowStr;
            
            // Set default dates to tomorrow
            document.getElementById('changeDate').value = tomorrowStr;
            document.getElementById('leaveDate').value = tomorrowStr;
            
            // Check session
            checkSession();
        }

        function setupMobileNavigation() {
            const menuToggle = document.getElementById('menuToggle');
            const mobileNav = document.getElementById('mobileNav');
            const mobileNavOverlay = document.getElementById('mobileNavOverlay');
            
            if (menuToggle && mobileNav && mobileNavOverlay) {
                menuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mobileNav.classList.add('active');
                    mobileNavOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
                
                mobileNavOverlay.addEventListener('click', function() {
                    mobileNav.classList.remove('active');
                    mobileNavOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                // Close menu when clicking a nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', function() {
                        mobileNav.classList.remove('active');
                        mobileNavOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                        
                        const sectionId = this.getAttribute('data-section');
                        showSection(sectionId);
                    });
                });
            }
        }

        function checkSession() {
            const session = localStorage.getItem('dutySystemSession');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    if (user.expiry > Date.now()) {
                        loginUser(user);
                    } else {
                        localStorage.removeItem('dutySystemSession');
                    }
                } catch (e) {
                    localStorage.removeItem('dutySystemSession');
                }
            }
        }

        async function handleLogin() {
            showLoading(true, 'Authenticating...');
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showToast('Please enter both username and password', 'warning');
                showLoading(false);
                return;
            }
            
            // In production, this would come from your server/Firebase
            // For demo, using hardcoded users from user.js
            if (!window.users || !Array.isArray(window.users)) {
                showToast('System error. Please try again.', 'error');
                showLoading(false);
                return;
            }
            
            const user = window.users.find(u => u.username === username);
            
            if (!user) {
                showToast('Invalid username or password', 'error');
                showLoading(false);
                return;
            }
            
            // Hash and check password
            const hashedPassword = sha256(password);
            
            if (hashedPassword === user.passwordHash) {
                const sessionData = {
                    username: user.username,
                    name: user.name,
                    rcNo: user.RCNo,
                    level: user.Level,
                    expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
                };
                
                localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
                await loginUser(sessionData);
                showLoading(false);
            } else {
                showToast('Invalid username or password', 'error');
                showLoading(false);
            }
        }

        async function loginUser(userData) {
            currentUser = userData;
            
            // Get FCM token for this user if notifications are enabled
            if (messaging && Notification.permission === 'granted') {
                await getFCMToken();
            }
            
            // Update UI
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            
            // Update user info
            document.getElementById('mobileTitle').textContent = 'Dashboard';
            document.getElementById('mobileAvatar').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('navUserName').textContent = userData.name;
            document.getElementById('navUserRC').textContent = userData.rcNo;
            document.getElementById('navUserLevel').textContent = userData.level;
            document.getElementById('welcomeName').textContent = userData.name;
            
            // Load users
            allUsers = window.users || [];
            
            // Load all data
            await initializeData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup real-time listeners
            setupRealtimeListeners();
            
            // Show welcome
            showToast(`Welcome back, ${userData.name}!`, 'success');
        }

        async function initializeData() {
            showLoading(true, 'Loading data...');
            
            try {
                // Load all data from Firestore
                await Promise.all([
                    loadDutyRoster(),
                    loadLeaveBalances(),
                    loadAllRequests(),
                    loadAnnouncements()
                ]);
                
                // Update UI
                updateUserBalance();
                updateRequestCounts();
                loadHomeAnnouncements();
                
                showLoading(false);
            } catch (error) {
                console.error('Error initializing data:', error);
                showToast('Failed to load data', 'error');
                showLoading(false);
            }
        }

        // Firebase Functions
        async function loadDutyRoster() {
            try {
                const doc = await db.collection('dutyRoster').doc('current').get();
                dutyRoster = doc.exists ? doc.data() || {} : {};
                return dutyRoster;
            } catch (error) {
                console.error('Error loading duty roster:', error);
                dutyRoster = {};
                return dutyRoster;
            }
        }

        async function saveDutyRoster() {
            try {
                await db.collection('dutyRoster').doc('current').set(dutyRoster);
                return true;
            } catch (error) {
                console.error('Error saving duty roster:', error);
                showToast('Failed to save roster', 'error');
                return false;
            }
        }

        async function loadLeaveBalances() {
            try {
                const doc = await db.collection('leaveBalances').doc('current').get();
                if (doc.exists) {
                    leaveBalances = doc.data() || {};
                } else {
                    // Initialize default balances
                    leaveBalances = {};
                    allUsers.forEach(user => {
                        leaveBalances[user.username] = {
                            SL: 12,
                            FRL: 6
                        };
                    });
                    await saveLeaveBalances();
                }
                return leaveBalances;
            } catch (error) {
                console.error('Error loading leave balances:', error);
                leaveBalances = {};
                return leaveBalances;
            }
        }

        async function saveLeaveBalances() {
            try {
                await db.collection('leaveBalances').doc('current').set(leaveBalances);
                return true;
            } catch (error) {
                console.error('Error saving leave balances:', error);
                showToast('Failed to save leave balances', 'error');
                return false;
            }
        }

        async function loadAllRequests() {
            try {
                const snapshot = await db.collection('requests').orderBy('timestamp', 'desc').limit(50).get();
                allRequests = [];
                snapshot.forEach(doc => {
                    allRequests.push({ id: doc.id, ...doc.data() });
                });
                return allRequests;
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = [];
                return allRequests;
            }
        }

        async function saveRequest(request) {
            try {
                if (request.id) {
                    await db.collection('requests').doc(request.id).set(request);
                } else {
                    const docRef = await db.collection('requests').add(request);
                    request.id = docRef.id;
                }
                return true;
            } catch (error) {
                console.error('Error saving request:', error);
                showToast('Failed to save request', 'error');
                return false;
            }
        }

        async function deleteRequest(requestId) {
            try {
                await db.collection('requests').doc(requestId).delete();
                return true;
            } catch (error) {
                console.error('Error deleting request:', error);
                return false;
            }
        }

        async function loadAnnouncements() {
            try {
                const snapshot = await db.collection('announcements')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                announcements = [];
                snapshot.forEach(doc => {
                    announcements.push({ id: doc.id, ...doc.data() });
                });
                return announcements;
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcements = [];
                return announcements;
            }
        }

        async function sendPushNotification(toUsername, title, body, data = {}) {
            try {
                // Get FCM token for the user
                const tokenDoc = await db.collection('fcmTokens').doc(toUsername).get();
                if (!tokenDoc.exists) return;
                
                const token = tokenDoc.data().token;
                
                // Send push notification via Firebase Cloud Functions or your server
                // This would be implemented on your server
                console.log(`Would send push notification to ${toUsername}: ${title} - ${body}`);
                
                // For demo, we'll just show a local notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    showPushNotification({ title, body, data });
                }
            } catch (error) {
                console.error('Error sending push notification:', error);
            }
        }

        function updateUserBalance() {
            if (!currentUser) return;
            
            const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
            document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
        }

        function updateRequestCounts() {
            if (!currentUser) return;
            
            // Pending requests for user (duty changes)
            const pendingForUser = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            ).length;
            
            const pendingNav = document.getElementById('pendingRequestsNav');
            const pendingBadge = document.getElementById('pendingRequestsBadge');
            
            if (pendingForUser > 0) {
                pendingNav.style.display = 'flex';
                pendingBadge.textContent = pendingForUser;
                pendingBadge.style.display = 'inline-block';
            } else {
                pendingNav.style.display = 'none';
                pendingBadge.style.display = 'none';
            }
            
            // My pending requests
            const myPending = allRequests.filter(req => 
                req.fromUsername === currentUser.username && 
                req.status === 'pending'
            ).length;
            
            const myBadge = document.getElementById('myRequestsBadge');
            if (myPending > 0) {
                myBadge.textContent = myPending;
                myBadge.style.display = 'inline-block';
            } else {
                myBadge.style.display = 'none';
            }
        }

        // Navigation Functions
        function showSection(sectionId) {
            // Update mobile title
            const titles = {
                home: 'Dashboard',
                dutyChange: 'Duty Change',
                leaveApplication: 'Apply Leave',
                myRequests: 'My Requests',
                pendingRequests: 'Pending Requests',
                viewAllRoster: 'All Roster'
            };
            
            document.getElementById('mobileTitle').textContent = titles[sectionId] || sectionId;
            
            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const sectionElement = document.getElementById(sectionId + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Update bottom nav
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.querySelector('span:last-child').textContent.toLowerCase();
                if (sectionId === 'home' && btnText === 'home') btn.classList.add('active');
                if (sectionId === 'dutyChange' && btnText === 'change') btn.classList.add('active');
                if (sectionId === 'leaveApplication' && btnText === 'leave') btn.classList.add('active');
                if (sectionId === 'myRequests' && btnText === 'requests') btn.classList.add('active');
                if (sectionId === 'viewAllRoster' && btnText === 'roster') btn.classList.add('active');
            });
            
            // Load section data
            loadSectionData(sectionId);
            
            // Scroll to top
            document.getElementById('dashboardContent').scrollTop = 0;
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'home':
                    updateDashboard();
                    break;
                case 'dutyChange':
                    loadDutyChangeForm();
                    break;
                case 'leaveApplication':
                    loadLeaveForm();
                    break;
                case 'myRequests':
                    loadMyRequests();
                    break;
                case 'pendingRequests':
                    loadPendingRequests();
                    break;
                case 'viewAllRoster':
                    loadAllRoster();
                    break;
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayDutyTime = document.getElementById('todayDutyTime');
            const nextDutyTime = document.getElementById('nextDutyTime');
            
            // Today's duty
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                const duty = dutyRoster[today][currentUser.username];
                todayDutyTime.textContent = duty === 'Off' ? 'Off Duty' : duty;
            } else {
                todayDutyTime.textContent = 'Not Scheduled';
            }
            
            // Next duty (next 7 days)
            const tomorrow = new Date();
            let foundNext = false;
            
            for (let i = 1; i <= 7; i++) {
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                    const duty = dutyRoster[dateStr][currentUser.username];
                    if (duty !== 'Off') {
                        const date = new Date(dateStr);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        nextDutyTime.textContent = `${dayName}: ${duty}`;
                        foundNext = true;
                        break;
                    }
                }
            }
            
            if (!foundNext) {
                nextDutyTime.textContent = 'No upcoming duty';
            }
            
            // Update balance
            updateUserBalance();
            
            // Load announcements
            loadHomeAnnouncements();
        }

        function loadHomeAnnouncements() {
            const container = document.getElementById('homeAnnouncements');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (announcements.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">üì¢</div>
                    <div class="empty-state-title">No Announcements</div>
                `;
                container.appendChild(emptyState);
                return;
            }
            
            // Show only 2 announcements on mobile
            const displayAnnouncements = window.innerWidth <= 768 ? 
                announcements.slice(0, 2) : announcements;
            
            displayAnnouncements.forEach(ann => {
                const announcementDiv = document.createElement('div');
                announcementDiv.className = `announcement-banner priority-${ann.priority || 'medium'}`;
                
                announcementDiv.innerHTML = `
                    <div class="announcement-title">
                        <span>üì¢</span> ${ann.title}
                    </div>
                    <div style="margin-bottom: 10px; font-size: 14px;">${ann.content}</div>
                    <div style="font-size: 12px; opacity: 0.9;">
                        By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
                    </div>
                `;
                
                container.appendChild(announcementDiv);
            });
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const past = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return past.toLocaleDateString();
        }

        // Duty Change Functions
        function loadDutyChangeForm() {
            // Set tomorrow as default
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Ensure we're not setting today or past dates
            document.getElementById('changeDate').min = tomorrowStr;
            document.getElementById('changeDate').value = tomorrowStr;
            
            // Populate staff dropdown (exclude current user)
            const staffSelect = document.getElementById('requestToStaff');
            if (staffSelect) {
                staffSelect.innerHTML = '<option value="">Select staff member</option>';
                allUsers.forEach(user => {
                    if (user.username !== currentUser.username) {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.name} (RC: ${user.RCNo})`;
                        staffSelect.appendChild(option);
                    }
                });
            }
            
            // Load user's duty time for tomorrow
            loadUserDutyTimes('changeDutyTime', tomorrowStr);
        }

        function loadUserDutyTimes(selectId, date) {
            const select = document.getElementById(selectId);
            if (!select || !date || !currentUser) return;
            
            select.innerHTML = '<option value="">Select duty time</option>';
            const dutyTime = dutyRoster[date] && dutyRoster[date][currentUser.username];
            
            if (dutyTime) {
                const option = document.createElement('option');
                option.value = dutyTime;
                option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                select.appendChild(option);
            }
        }

        async function submitDutyChange() {
            const date = document.getElementById('changeDate').value;
            const dutyTime = document.getElementById('changeDutyTime').value;
            const toStaff = document.getElementById('requestToStaff').value;
            const toDutyTime = document.getElementById('requestToDutyTime').value;
            const reason = document.getElementById('changeReason').value;
            
            if (!date || !dutyTime || !toStaff || !toDutyTime) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            // Check if date is today or in the past
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = new Date(date).toISOString().split('T')[0];
            
            if (selectedDate <= today) {
                showToast('Duty changes can only be requested for future dates', 'warning');
                return;
            }
            
            if (dutyTime === 'Off' || toDutyTime === 'Off') {
                showToast('Cannot request duty change on off days', 'warning');
                return;
            }
            
            const toUser = allUsers.find(u => u.username === toStaff);
            if (!toUser) {
                showToast('Selected staff not found', 'error');
                return;
            }
            
            const request = {
                type: 'dutyChange',
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                toUsername: toStaff,
                toName: toUser.name,
                toRcNo: toUser.RCNo,
                toDutyTime: toDutyTime,
                reason: reason || '',
                status: 'pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                history: [{
                    action: 'created',
                    by: currentUser.name,
                    timestamp: new Date().toISOString()
                }]
            };
            
            const success = await saveRequest(request);
            if (success) {
                // Send push notification to the requested staff
                await sendPushNotification(
                    toStaff,
                    'New Duty Change Request',
                    `${currentUser.name} wants to swap duty with you on ${date}`,
                    { type: 'dutyChange', requestId: request.id }
                );
                
                showToast('Duty change request submitted!', 'success');
                showSection('home');
                document.getElementById('dutyChangeForm').reset();
                loadDutyChangeForm(); // Reset form
            }
        }

        // Leave Application Functions
        function loadLeaveForm() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('leaveDate').min = tomorrowStr;
            document.getElementById('leaveDate').value = tomorrowStr;
            
            loadUserDutyTimes('leaveDutyTime', tomorrowStr);
            updateLeaveBalanceCheck();
        }

        function updateLeaveBalanceCheck() {
            const leaveType = document.getElementById('leaveType').value;
            const alertDiv = document.getElementById('leaveBalanceCheck');
            const submitBtn = document.getElementById('submitLeaveBtn');
            
            if (!leaveType) {
                alertDiv.className = 'alert alert-info';
                alertDiv.textContent = 'Select a leave type to check your balance';
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            
            const userBalance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            const available = leaveType === 'Sick Leave' ? userBalance.SL : userBalance.FRL;
            
            if (available <= 0) {
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = `No ${leaveType} balance available`;
                if (submitBtn) submitBtn.disabled = true;
            } else {
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = `${leaveType} balance: ${available.toFixed(1)} days available`;
                if (submitBtn) submitBtn.disabled = false;
            }
        }

        async function submitLeaveApplication() {
            const leaveType = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const dutyTime = document.getElementById('leaveDutyTime').value;
            const duration = parseFloat(document.getElementById('leaveDuration').value);
            const reason = document.getElementById('leaveReason').value;
            
            if (!leaveType || !date || !dutyTime || !reason) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            // Check if date is today or in the past
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = new Date(date).toISOString().split('T')[0];
            
            if (selectedDate <= today) {
                showToast('Leave can only be applied for future dates', 'warning');
                return;
            }
            
            if (dutyTime === 'Off' || dutyTime === '') {
                showToast('You are off duty on this date', 'warning');
                return;
            }
            
            // Check balance
            const userBalance = leaveBalances[currentUser.username];
            if (!userBalance) {
                showToast('Error: User balance not found', 'error');
                return;
            }
            
            // Check balance
            if (leaveType === 'Sick Leave' && userBalance.SL < duration) {
                showToast(`Insufficient Sick Leave balance. Available: ${userBalance.SL.toFixed(1)} days`, 'warning');
                return;
            } else if (leaveType === 'FRL' && userBalance.FRL < duration) {
                showToast(`Insufficient FRL balance. Available: ${userBalance.FRL.toFixed(1)} days`, 'warning');
                return;
            }
            
            // Deduct balance
            if (leaveType === 'Sick Leave') {
                userBalance.SL -= duration;
            } else {
                userBalance.FRL -= duration;
            }
            
            // Save updated balance
            await saveLeaveBalances();
            
            // Create leave request
            const request = {
                type: 'leave',
                leaveType: leaveType,
                fromUsername: currentUser.username,
                fromName: currentUser.name,
                fromRcNo: currentUser.rcNo,
                date: date,
                dutyTime: dutyTime,
                duration: duration,
                reason: reason,
                status: 'approved', // Auto-approved
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                approvedBy: 'System (Auto-approved)',
                approvedAt: new Date().toISOString(),
                history: [{
                    action: 'created_and_approved',
                    by: currentUser.name,
                    timestamp: new Date().toISOString(),
                    note: 'Leave balance deducted immediately'
                }]
            };
            
            const success = await saveRequest(request);
            if (success) {
                // Update UI immediately
                updateUserBalance();
                updateRequestCounts();
                
                // Show success message
                showToast(`${leaveType} application submitted successfully! ${duration} day(s) deducted.`, 'success');
                
                // Reset form and go to dashboard
                showSection('home');
                document.getElementById('leaveApplicationForm').reset();
                loadLeaveForm();
            }
        }

        // My Requests Functions
        function loadMyRequests() {
            const tbody = document.getElementById('myRequestsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const myReqs = allRequests.filter(req => req.fromUsername === currentUser.username);
            
            if (myReqs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div style="color: #7f8c8d; font-size: 16px;">
                                No requests found
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            myReqs.forEach(req => {
                const tr = document.createElement('tr');
                
                let details = '';
                if (req.type === 'dutyChange') {
                    details = `Swap with ${req.toName} (${req.toDutyTime})`;
                } else {
                    details = `${req.leaveType} - ${req.duration} day(s)`;
                }
                
                let statusClass = 'status-' + req.status;
                let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
                
                tr.innerHTML = `
                    <td>${req.type === 'dutyChange' ? 'Duty Change' : 'Leave'}</td>
                    <td>${req.date}</td>
                    <td>${details}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        ${req.status === 'pending' ? 
                            `<button class="action-btn reject" onclick="cancelRequest('${req.id}')">Cancel</button>` : ''}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        async function cancelRequest(requestId) {
            if (!confirm('Are you sure you want to cancel this request?')) return;
            
            const request = allRequests.find(req => req.id === requestId);
            if (!request) {
                showToast('Request not found', 'error');
                return;
            }
            
            if (request.status !== 'pending') {
                showToast('Only pending requests can be cancelled', 'warning');
                return;
            }
            
            // If it's a leave request that was approved, refund the balance
            if (request.type === 'leave' && request.status === 'approved') {
                const userBalance = leaveBalances[request.fromUsername];
                if (userBalance) {
                    if (request.leaveType === 'Sick Leave') {
                        userBalance.SL += request.duration;
                    } else if (request.leaveType === 'FRL') {
                        userBalance.FRL += request.duration;
                    }
                    await saveLeaveBalances();
                    updateUserBalance();
                }
            }
            
            // Update request status
            request.status = 'cancelled';
            request.history.push({
                action: 'cancelled',
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            const success = await saveRequest(request);
            if (success) {
                loadMyRequests();
                updateRequestCounts();
                showToast('Request cancelled', 'success');
            }
        }

        // Pending Requests Functions
        function loadPendingRequests() {
            const tbody = document.getElementById('pendingRequestsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const pendingReqs = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            );
            
            if (pendingReqs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px;">
                            <div style="color: #7f8c8d; font-size: 16px;">
                                No pending requests
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            pendingReqs.forEach(req => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${req.fromName}</td>
                    <td>${req.date}</td>
                    <td>Swap ${req.dutyTime} with ${req.toDutyTime}</td>
                    <td class="action-buttons">
                        <button class="action-btn approve" onclick="respondToRequest('${req.id}', 'approved')">Accept</button>
                        <button class="action-btn reject" onclick="respondToRequest('${req.id}', 'rejected')">Reject</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        async function respondToRequest(requestId, response) {
            const request = allRequests.find(req => req.id === requestId);
            if (!request) {
                showToast('Request not found', 'error');
                return;
            }
            
            if (response === 'approved') {
                // Swap duty times
                const date = request.date;
                if (dutyRoster[date]) {
                    const fromDuty = dutyRoster[date][request.fromUsername];
                    const toDuty = dutyRoster[date][request.toUsername];
                    
                    dutyRoster[date][request.fromUsername] = toDuty;
                    dutyRoster[date][request.toUsername] = fromDuty;
                    
                    await saveDutyRoster();
                }
            }
            
            request.status = response;
            request.respondedAt = new Date().toISOString();
            request.history.push({
                action: response,
                by: currentUser.name,
                timestamp: new Date().toISOString()
            });
            
            const success = await saveRequest(request);
            if (success) {
                // Send push notification to the requester
                await sendPushNotification(
                    request.fromUsername,
                    'Duty Change Request ' + (response === 'approved' ? 'Approved' : 'Rejected'),
                    `${currentUser.name} has ${response} your duty change request for ${request.date}`,
                    { type: 'dutyChangeResponse', requestId: request.id }
                );
                
                showToast(`Request ${response} successfully!`, 'success');
                showSection('home');
                updateRequestCounts();
            }
        }

        // All Roster Functions
        function loadAllRoster() {
            const container = document.getElementById('allRosterContainer');
            if (!container) return;
            
            const startDate = document.getElementById('allRosterStartDate').value;
            const endDate = document.getElementById('allRosterEndDate').value;
            
            if (!startDate || !endDate) {
                // Default to next 7 days
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                document.getElementById('allRosterStartDate').value = today.toISOString().split('T')[0];
                document.getElementById('allRosterEndDate').value = nextWeek.toISOString().split('T')[0];
                
                loadAllRoster();
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showToast('Start date must be before end date', 'warning');
                return;
            }
            
            // Generate roster table
            const today = new Date().toISOString().split('T')[0];
            let html = '<div class="table-container"><table>';
            
            // Header
            html += '<thead><tr><th>Date</th><th>Day</th>';
            allUsers.forEach(user => {
                html += `<th>${user.name}<br><small>${user.RCNo}</small></th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Rows
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const isToday = dateStr === today;
                
                html += `<tr ${isToday ? 'style="background-color: rgba(52, 152, 219, 0.1);"' : ''}>`;
                html += `<td>${dateStr}${isToday ? ' <strong>(Today)</strong>' : ''}</td>`;
                html += `<td>${dayName}</td>`;
                
                // Staff duties
                allUsers.forEach(user => {
                    let dutyTime = 'Off';
                    if (dutyRoster[dateStr] && dutyRoster[dateStr][user.username]) {
                        dutyTime = dutyRoster[dateStr][user.username];
                    }
                    html += `<td>${dutyTime}</td>`;
                });
                
                html += '</tr>';
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Duty Change Form
            const dutyChangeForm = document.getElementById('dutyChangeForm');
            if (dutyChangeForm) {
                dutyChangeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitDutyChange();
                });
            }
            
            // Leave Application Form
            const leaveApplicationForm = document.getElementById('leaveApplicationForm');
            if (leaveApplicationForm) {
                leaveApplicationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitLeaveApplication();
                });
            }
            
            // Date change handlers
            document.getElementById('changeDate').addEventListener('change', function() {
                loadUserDutyTimes('changeDutyTime', this.value);
            });
            
            document.getElementById('requestToStaff').addEventListener('change', function() {
                const user = allUsers.find(u => u.username === this.value);
                if (user) {
                    const date = document.getElementById('changeDate').value;
                    if (date) {
                        // Load staff's duty time
                        const select = document.getElementById('requestToDutyTime');
                        select.innerHTML = '<option value="">Select duty time</option>';
                        const dutyTime = dutyRoster[date] && dutyRoster[date][user.username];
                        if (dutyTime) {
                            const option = document.createElement('option');
                            option.value = dutyTime;
                            option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                            select.appendChild(option);
                        }
                    }
                }
            });
            
            // Leave form handlers
            document.getElementById('leaveDate').addEventListener('change', function() {
                loadUserDutyTimes('leaveDutyTime', this.value);
            });
            
            document.getElementById('leaveType').addEventListener('change', updateLeaveBalanceCheck);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('dutySystemSession');
                    location.reload();
                }
            });
        }

        // Setup real-time listeners
        function setupRealtimeListeners() {
            if (!db) return;
            
            // Listen for requests (only for current user)
            db.collection('requests')
                .where('toUsername', '==', currentUser.username)
                .where('status', '==', 'pending')
                .onSnapshot((snapshot) => {
                    updateRequestCounts();
                    if (document.getElementById('pendingRequestsSection').classList.contains('active')) {
                        loadPendingRequests();
                    }
                    
                    // Show notification for new requests
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const request = change.doc.data();
                            showPushNotification({
                                title: 'New Duty Change Request',
                                body: `${request.fromName} wants to swap duty with you on ${request.date}`,
                                data: { type: 'request' }
                            });
                        }
                    });
                });
            
            // Listen for user's own requests
            db.collection('requests')
                .where('fromUsername', '==', currentUser.username)
                .onSnapshot((snapshot) => {
                    updateRequestCounts();
                    if (document.getElementById('myRequestsSection').classList.contains('active')) {
                        loadMyRequests();
                    }
                    
                    // Show notification for request updates
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'modified') {
                            const request = change.doc.data();
                            if (request.status === 'approved' || request.status === 'rejected') {
                                showPushNotification({
                                    title: `Request ${request.status}`,
                                    body: `Your duty change request for ${request.date} has been ${request.status}`,
                                    data: { type: 'requestUpdate' }
                                });
                            }
                        }
                    });
                });
            
            // Listen for announcements
            db.collection('announcements')
                .where('status', '==', 'active')
                .orderBy('createdAt', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    announcements = [];
                    snapshot.forEach(doc => {
                        announcements.push({ id: doc.id, ...doc.data() });
                    });
                    if (document.getElementById('homeSection').classList.contains('active')) {
                        loadHomeAnnouncements();
                    }
                    
                    // Show notification for new announcements
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const announcement = change.doc.data();
                            showPushNotification({
                                title: 'New Announcement',
                                body: announcement.title,
                                data: { type: 'announcement' }
                            });
                        }
                    });
                });
            
            // Listen for duty roster changes
            db.collection('dutyRoster').doc('current')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        dutyRoster = doc.data() || {};
                        if (document.getElementById('homeSection').classList.contains('active')) {
                            updateDashboard();
                        }
                        if (document.getElementById('viewAllRosterSection').classList.contains('active')) {
                            loadAllRoster();
                        }
                    }
                });
        }

        // Handle app visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // App came to foreground
                updateRequestCounts();
                if (currentUser && document.getElementById('homeSection').classList.contains('active')) {
                    updateDashboard();
                }
            }
        });
    </script>
</body>
</html>
