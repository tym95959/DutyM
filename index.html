<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Duty Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Duty Manager">
    <meta name="description" content="Duty and Leave Management System for staff">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3498db">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="512x512" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233498db'/%3E%3Ccircle cx='50' cy='35' r='12' fill='white'/%3E%3Cpath d='M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z' fill='white'/%3E%3Cpath d='M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z' fill='white'/%3E%3Cpath d='M20,20 L20,40 L30,30 Z' fill='%2327ae60'/%3E%3C/svg%3E">
    
    <!-- Manifest for PWA with Push Permissions -->
        <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Duty Manager',
        'short_name': 'DutyMgr',
        'description': 'Duty and Leave Management System',
        'start_url': './',
        'display': 'standalone',
        'background_color': '#3498db',
        'theme_color': '#3498db',
        'orientation': 'portrait',
        'scope': './',
        'categories': ['productivity', 'business'],
        'permissions': ['notifications'],
        'gcm_sender_id': '103953800507',
        'icons': [
            {
                'src': 'data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Ccircle cx=\\'50\\' cy=\\'50\\' r=\\'45\\' fill=\\'%233498db\\'/%3E%3Ccircle cx=\\'50\\' cy=\\'35\\' r=\\'12\\' fill=\\'white\\'/%3E%3Cpath d=\\'M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M20,20 L20,40 L30,30 Z\\' fill=\\'%2327ae60\\'/%3E%3C/svg%3E',
                'sizes': '72x72',
                'type': 'image/svg+xml',
                'purpose': 'any'
            },
            {
                'src': 'data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Ccircle cx=\\'50\\' cy=\\'50\\' r=\\'45\\' fill=\\'%233498db\\'/%3E%3Ccircle cx=\\'50\\' cy=\\'35\\' r=\\'12\\' fill=\\'white\\'/%3E%3Cpath d=\\'M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M20,20 L20,40 L30,30 Z\\' fill=\\'%2327ae60\\'/%3E%3C/svg%3E',
                'sizes': '96x96',
                'type': 'image/svg+xml',
                'purpose': 'any'
            },
            {
                'src': 'data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Ccircle cx=\\'50\\' cy=\\'50\\' r=\\'45\\' fill=\\'%233498db\\'/%3E%3Ccircle cx=\\'50\\' cy=\\'35\\' r=\\'12\\' fill=\\'white\\'/%3E%3Cpath d=\\'M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M20,20 L20,40 L30,30 Z\\' fill=\\'%2327ae60\\'/%3E%3C/svg%3E',
                'sizes': '128x128',
                'type': 'image/svg+xml',
                'purpose': 'any'
            },
            {
                'src': 'data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Ccircle cx=\\'50\\' cy=\\'50\\' r=\\'45\\' fill=\\'%233498db\\'/%3E%3Ccircle cx=\\'50\\' cy=\\'35\\' r=\\'12\\' fill=\\'white\\'/%3E%3Cpath d=\\'M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M20,20 L20,40 L30,30 Z\\' fill=\\'%2327ae60\\'/%3E%3C/svg%3E',
                'sizes': '144x144',
                'type': 'image/svg+xml',
                'purpose': 'any'
            },
            {
                'src': 'data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 100 100\\'%3E%3Ccircle cx=\\'50\\' cy=\\'50\\' r=\\'45\\' fill=\\'%233498db\\'/%3E%3Ccircle cx=\\'50\\' cy=\\'35\\' r=\\'12\\' fill=\\'white\\'/%3E%3Cpath d=\\'M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z\\' fill=\\'white\\'/%3E%3Cpath d=\\'M20,20 L20,40 L30,30 Z\\' fill=\\'%2327ae60\\'/%3E%3C/svg%3E',
                'sizes': '192x192',
                'type': 'image/svg+xml',
                'purpose': 'any maskable'
            }
        ]
    }">
    
    <title>Duty Management System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase Messaging SDK (for push notifications) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    
    <!-- SHA-256 Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    
    <!-- External Firebase and User files -->
    
    <script src="dcfire.js"></script>
    <script src="user.js"></script>
    
    <style>
        /* Mobile-First CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        #loadingOverlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* Toast Container */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: calc(100% - 40px);
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.warning {
            border-left: 4px solid #f39c12;
        }

        .toast.info {
            border-left: 4px solid #3498db;
        }

        /* Login Page */
        .login-container {
            background: white;
            width: 100%;
            min-height: 100vh;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .logo p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2c3e50;
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-block {
            width: 100%;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #f5f7fa;
        }

        /* Mobile Header */
        .mobile-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
        }

        .mobile-title {
            font-size: 18px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .mobile-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* Mobile Navigation */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .mobile-nav-overlay.active {
            display: block;
        }

        .mobile-nav {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: white;
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .mobile-nav.active {
            transform: translateX(0);
        }

        .nav-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .nav-user-details {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-items {
            flex: 1;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            color: #2c3e50;
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px;
        }

        .nav-item.active {
            background: #e8f4fc;
            color: #3498db;
            border-left: 4px solid #3498db;
        }

        .nav-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .nav-item-badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }

        .nav-footer {
            padding: 20px;
            border-top: 1px solid #f0f0f0;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e6ed;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 99;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #7f8c8d;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }

        .bottom-nav-btn.active {
            color: #3498db;
        }

        .bottom-nav-icon {
            font-size: 20px;
        }

        /* Content Area */
        .dashboard-content {
            padding: 20px;
            padding-bottom: 80px; /* Space for bottom nav */
            min-height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            font-weight: 600;
        }

        /* Balance Display */
        .balance-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .balance-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e6ed;
        }

        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }

        .balance-label {
            font-size: 13px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 500;
        }

        /* Form Rows */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 14px;
            line-height: 1.4;
        }

        .alert-info {
            background: #e8f4fc;
            border-color: #3498db;
            color: #2c3e50;
        }

        .alert-success {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            font-size: 14px;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.approve {
            background: #d4edda;
            color: #155724;
        }

        .action-btn.reject {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn.view {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Announcement Banner */
        .announcement-banner {
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .announcement-banner.priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .announcement-banner.priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .announcement-banner.priority-low {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .announcement-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Duty Time Colors */
        .duty-0730-1530 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404 !important;
        }

        .duty-0830-1630 {
            background: linear-gradient(135deg, #e2d9f3 0%, #d6c6f7 100%) !important;
            color: #563d7c !important;
        }

        .duty-1030-1830 {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
            color: #827717 !important;
        }

        .duty-1530-2330 {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            color: #0d47a1 !important;
        }

        .duty-1630-0030 {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            color: #424242 !important;
        }

        .duty-leave {
            background: linear-gradient(135deg, #ffd8a6 0%, #ffc078 100%) !important;
            color: #e8590c !important;
            border: 1px dashed #fd7e14 !important;
        }

        .off-day-cell {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
            color: #155724 !important;
            font-weight: 500;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Mobile Optimized Form Elements */
        select.form-control {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237f8c8d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            line-height: 1.4;
        }

        /* Touch-friendly Date Inputs */
        input[type="date"] {
            min-height: 48px;
        }

        /* Responsive Grids */
        @media (min-width: 768px) {
            .balance-display {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1;
                min-width: 200px;
            }
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Mobile Specific */
        @media (max-width: 767px) {
            .dashboard-content {
                padding: 15px;
                padding-bottom: 70px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 15px;
            }
            
            th, td {
                padding: 10px;
                font-size: 13px;
            }
            
            .action-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading...</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>Duty Management</h1>
            <p>Secure Login System</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <span>üîê</span> Login
            </button>
            
            <div class="error-message" id="errorMessage">
                Invalid username or password
            </div>
        </form>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="menu-toggle" id="menuToggle">
                ‚ò∞
            </button>
            <div class="mobile-title" id="mobileTitle">Dashboard</div>
            <div class="mobile-user">
                <div class="mobile-avatar" id="mobileAvatar">U</div>
            </div>
        </div>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav-overlay" id="mobileNavOverlay"></div>
        <div class="mobile-nav" id="mobileNav">
            <div class="nav-header">
                <div class="nav-user-name" id="navUserName">User Name</div>
                <div class="nav-user-details">
                    <span>RC: <span id="navUserRC">000</span></span>
                    <span>Level: <span id="navUserLevel">User</span></span>
                </div>
            </div>
            
            <div class="nav-items">
                <a href="#" class="nav-item active" data-section="home">
                    <span class="nav-item-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-section="dutyChange">
                    <span class="nav-item-icon">üîÑ</span>
                    <span>Duty Change</span>
                </a>
                <a href="#" class="nav-item" data-section="leaveApplication">
                    <span class="nav-item-icon">üìÖ</span>
                    <span>Apply Leave</span>
                </a>
                <a href="#" class="nav-item" data-section="myRequests">
                    <span class="nav-item-icon">üìã</span>
                    <span>My Requests</span>
                    <span class="nav-item-badge" id="myRequestsBadge" style="display: none;">0</span>
                </a>
                <a href="#" class="nav-item" data-section="viewMyRoster">
                    <span class="nav-item-icon">üìä</span>
                    <span>My Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="viewAllRoster">
                    <span class="nav-item-icon">üë•</span>
                    <span>All Roster</span>
                </a>
                <a href="#" class="nav-item" data-section="notificationSettings" id="notificationSettingsNav">
                    <span class="nav-item-icon">üîî</span>
                    <span>Notifications</span>
                </a>
                <a href="#" class="nav-item" data-section="pendingRequests" id="pendingRequestsNav" style="display: none;">
                    <span class="nav-item-icon">‚è≥</span>
                    <span>Pending</span>
                    <span class="nav-item-badge" id="pendingRequestsBadge">0</span>
                </a>
                
                <!-- Admin Sections -->
                <a href="#" class="nav-item admin-nav" data-section="adminAnnouncements" style="display: none;">
                    <span class="nav-item-icon">üì¢</span>
                    <span>Announcements</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminDutyRoster" style="display: none;">
                    <span class="nav-item-icon">üìù</span>
                    <span>Duty Roster</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminLeaveBalance" style="display: none;">
                    <span class="nav-item-icon">üí∞</span>
                    <span>Leave Balance</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminApprovals" style="display: none;">
                    <span class="nav-item-icon">‚úÖ</span>
                    <span>Approvals</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminPushConfig" style="display: none;">
                    <span class="nav-item-icon">üì±</span>
                    <span>Push Config</span>
                </a>
                <a href="#" class="nav-item admin-nav" data-section="adminRequestHistory" style="display: none;">
                    <span class="nav-item-icon">üìú</span>
                    <span>History</span>
                    <span class="nav-item-badge" id="historyNotificationBadge" style="display: none;">!</span>
                </a>
            </div>
            
            <div class="nav-footer">
                <button class="btn btn-danger btn-block" id="logoutBtn">
                    <span>üö™</span> Logout
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Dashboard -->
            <div class="section active" id="homeSection">
                <div id="homeAnnouncements">
                    <!-- Announcements will be loaded here -->
                </div>
                
                <div class="card">
                    <h3>Welcome, <span id="welcomeName">User</span>!</h3>
                    
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Sick Leave</div>
                            <div class="balance-value" id="slBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">FRL</div>
                            <div class="balance-value" id="frlBalance">0</div>
                            <div class="balance-label">Days</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <p><strong>Today's Duty:</strong> <span id="todayDutyTime">Not Scheduled</span></p>
                        <p><strong>Next Duty:</strong> <span id="nextDutyTime">No upcoming duty</span></p>
                        <div id="homeNotifications" style="margin-top: 10px; display: none;"></div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <span>üîÑ</span> Refresh
                        </button>
                        <button class="btn btn-warning" onclick="showSection('dutyChange')">
                            <span>üîÑ</span> Change Duty
                        </button>
                        <button class="btn btn-success" onclick="showSection('leaveApplication')">
                            <span>üìÖ</span> Apply Leave
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Duty Change Request -->
            <div class="section" id="dutyChangeSection">
                <div class="card">
                    <h3>Duty Change Request</h3>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Requests must be made at least 24 hours in advance.
                    </div>
                    
                    <form id="dutyChangeForm">
                        <div class="form-group">
                            <label for="changeDate">Change Date *</label>
                            <input type="date" id="changeDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="changeDutyTime">Your Duty Time *</label>
                            <select id="changeDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToStaff">Request To Staff *</label>
                            <select id="requestToStaff" class="form-control" required>
                                <option value="">Select staff member</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToRcNo">Staff RC No</label>
                            <input type="text" id="requestToRcNo" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="requestToDutyTime">Staff's Duty Time *</label>
                            <select id="requestToDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="changeReason">Reason (Optional)</label>
                            <textarea id="changeReason" class="form-control" rows="2" placeholder="Brief reason for duty change"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">
                                <span>üì§</span> Submit Request
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <span>‚ùå</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Leave Application -->
            <div class="section" id="leaveApplicationSection">
                <div class="card">
                    <h3>Leave Application</h3>
                    
                    <div class="alert alert-info">
                        <p><strong>Application Rules:</strong></p>
                        <p>‚Ä¢ Sick Leave: Minimum 2 hours before duty time</p>
                        <p>‚Ä¢ FRL: Minimum 1 hour before duty time</p>
                        <p><strong>Note:</strong> Leave balance will be deducted immediately upon submission</p>
                    </div>
                    
                    <form id="leaveApplicationForm">
                        <div class="form-group">
                            <label for="leaveType">Leave Type *</label>
                            <select id="leaveType" class="form-control" required>
                                <option value="">Select leave type</option>
                                <option value="Sick Leave">Sick Leave</option>
                                <option value="FRL">FRL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDate">Leave Date *</label>
                            <input type="date" id="leaveDate" class="form-control" required min="">
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDutyTime">Duty Time *</label>
                            <select id="leaveDutyTime" class="form-control" required>
                                <option value="">Select duty time</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveDuration">Duration *</label>
                            <select id="leaveDuration" class="form-control" required>
                                <option value="1">1 Day</option>
                                <option value="0.5">Half Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="leaveReason">Reason *</label>
                            <textarea id="leaveReason" class="form-control" rows="3" placeholder="Please provide reason for leave" required></textarea>
                        </div>
                        
                        <div id="leaveRulesAlert" class="alert">
                            Select leave type, date and duty time to see rules
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="submitLeaveBtn">
                                <span>üì§</span> Submit Application
                            </button>
                            <button type="button" class="btn btn-danger" onclick="showSection('home')">
                                <span>‚ùå</span> Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- My Requests -->
            <div class="section" id="myRequestsSection">
                <div class="card">
                    <h3>My Requests</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pending Requests -->
            <div class="section" id="pendingRequestsSection">
                <div class="card">
                    <h3>Pending Requests For You</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRequestsTable">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- View All Roster -->
            <div class="section" id="viewAllRosterSection">
                <div class="card">
                    <h3>Complete Duty Roster</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="allRosterStartDate">From Date</label>
                            <input type="date" id="allRosterStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="allRosterEndDate">To Date</label>
                            <input type="date" id="allRosterEndDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="loadAllRoster()">
                            <span>üìä</span> Load Roster
                        </button>
                    </div>
                    
                    <div id="allRosterContainer" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Notification Settings -->
            <div class="section" id="notificationSettingsSection">
                <div class="card">
                    <h3>Notification Settings</h3>
                    <div class="alert alert-info">
                        <p>Control what types of notifications you receive</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label" style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" id="notifyDutyChanges" checked style="margin-right: 10px;">
                            <div>
                                <strong>Duty Change Notifications</strong>
                                <div style="font-size: 13px; color: #666;">When someone requests a duty change with you</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label" style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" id="notifyLeaveApprovals" checked style="margin-right: 10px;">
                            <div>
                                <strong>Leave Application Notifications</strong>
                                <div style="font-size: 13px; color: #666;">When your leave is approved/rejected</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label" style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" id="notifyAnnouncements" checked style="margin-right: 10px;">
                            <div>
                                <strong>Announcements</strong>
                                <div style="font-size: 13px; color: #666;">Important announcements from management</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label" style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" id="notifySystemAlerts" checked style="margin-right: 10px;">
                            <div>
                                <strong>System Alerts</strong>
                                <div style="font-size: 13px; color: #666;">System maintenance and important alerts</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveNotificationSettings()">
                            <span>üíæ</span> Save Settings
                        </button>
                        <button class="btn btn-primary" onclick="testUserNotification()">
                            <span>üîî</span> Test Notification
                        </button>
                        <button class="btn btn-info" onclick="checkNotificationPermission()">
                            <span>üîÑ</span> Check Permission
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Notification Status</h3>
                    <div id="notificationStatus">
                        <div class="alert alert-info">Loading notification status...</div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-warning" onclick="resetPushToken()">
                            <span>üîÑ</span> Reset Push Token
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Admin Announcements -->
            <div class="section" id="adminAnnouncementsSection">
                <div class="card">
                    <h3>Create Announcement</h3>
                    <form id="announcementForm">
                        <div class="form-group">
                            <label for="announcementTitle">Title *</label>
                            <input type="text" id="announcementTitle" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementContent">Content *</label>
                            <textarea id="announcementContent" class="form-control" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="announcementPriority">Priority</label>
                            <select id="announcementPriority" class="form-control">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            <span>üì¢</span> Create Announcement
                        </button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Active Announcements</h3>
                    <div id="activeAnnouncementsList"></div>
                </div>
            </div>
            
            <!-- Admin Push Configuration -->
            <div class="section" id="adminPushConfigSection">
                <div class="card">
                    <h3>Push Notification Configuration</h3>
                    <div class="alert alert-info">
                        <strong>Instructions:</strong> Get these values from your Firebase Console ‚Üí Project Settings ‚Üí General
                    </div>
                    
                    <form id="firebaseConfigForm">
                        <div class="form-group">
                            <label for="firebaseApiKey">API Key *</label>
                            <input type="text" id="firebaseApiKey" class="form-control" required 
                                   placeholder="AIzaSyD...">
                        </div>
                        
                        <div class="form-group">
                            <label for="firebaseAuthDomain">Auth Domain *</label>
                            <input type="text" id="firebaseAuthDomain" class="form-control" required 
                                   placeholder="your-app.firebaseapp.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="firebaseProjectId">Project ID *</label>
                            <input type="text" id="firebaseProjectId" class="form-control" required 
                                   placeholder="your-project-id">
                        </div>
                        
                        <div class="form-group">
                            <label for="firebaseStorageBucket">Storage Bucket *</label>
                            <input type="text" id="firebaseStorageBucket" class="form-control" required 
                                   placeholder="your-app.appspot.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="firebaseMessagingSenderId">Messaging Sender ID *</label>
                            <input type="text" id="firebaseMessagingSenderId" class="form-control" required 
                                   placeholder="1234567890">
                        </div>
                        
                        <div class="form-group">
                            <label for="firebaseAppId">App ID *</label>
                            <input type="text" id="firebaseAppId" class="form-control" required 
                                   placeholder="1:1234567890:web:abc123def456">
                        </div>
                        
                        <div class="form-group">
                            <label for="firebaseVapidKey">VAPID Key *</label>
                            <input type="text" id="firebaseVapidKey" class="form-control" required 
                                   placeholder="BLH3...">
                            <small class="form-text text-muted">
                                Get from Firebase Console ‚Üí Cloud Messaging ‚Üí Web Configuration ‚Üí Generate Key Pair
                            </small>
                        </div>
                        
                        <div class="form-row">
                            <button type="submit" class="btn btn-success">
                                <span>üíæ</span> Save Configuration
                            </button>
                            <button type="button" class="btn btn-primary" onclick="testFirebaseConfig()">
                                <span>üß™</span> Test Configuration
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Push Notification Statistics</h3>
                    <div id="pushStatsContainer">
                        <div class="alert alert-info">Loading statistics...</div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-info" onclick="loadPushStats()">
                            <span>üîÑ</span> Refresh Statistics
                        </button>
                        <button class="btn btn-warning" onclick="cleanupOldTokens()">
                            <span>üßπ</span> Cleanup Old Tokens
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Send Test Notification</h3>
                    <div class="form-group">
                        <label for="testNotificationTitle">Title</label>
                        <input type="text" id="testNotificationTitle" class="form-control" 
                               value="Test Notification">
                    </div>
                    
                    <div class="form-group">
                        <label for="testNotificationBody">Body</label>
                        <input type="text" id="testNotificationBody" class="form-control" 
                               value="This is a test notification from the admin panel">
                    </div>
                    
                    <div class="form-group">
                        <label for="testNotificationTarget">Target</label>
                        <select id="testNotificationTarget" class="form-control">
                            <option value="current">Current User</option>
                            <option value="all">All Users</option>
                            <option value="specific">Specific User</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="specificUserContainer" style="display: none;">
                        <label for="testNotificationUser">Select User</label>
                        <select id="testNotificationUser" class="form-control">
                            <option value="">Select user</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendTestNotification()">
                        <span>üì§</span> Send Test Notification
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="bottom-nav-btn active" onclick="showSection('home')">
                <span class="bottom-nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('dutyChange')">
                <span class="bottom-nav-icon">üîÑ</span>
                <span>Change</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('leaveApplication')">
                <span class="bottom-nav-icon">üìÖ</span>
                <span>Leave</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('myRequests')">
                <span class="bottom-nav-icon">üìã</span>
                <span>Requests</span>
            </button>
            <button class="bottom-nav-btn" onclick="showSection('viewAllRoster')">
                <span class="bottom-nav-icon">üë•</span>
                <span>Roster</span>
            </button>
        </div>
    </div>

    <!-- Push Notification Manager Script (Embedded) -->
    <script>
        // Push Notification Manager Class
        class PushNotificationManager {
            constructor() {
                this.fcmToken = null;
                this.messaging = null;
                this.isInitialized = false;
                this.isPermissionGranted = false;
                this.config = null;
                this.notificationSettings = {
                    dutyChanges: true,
                    leaveApprovals: true,
                    announcements: true,
                    systemAlerts: true
                };
                this.serviceWorkerRegistration = null;
                this.init();
            }

            async init() {
                this.loadNotificationSettings();
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        this.handleServiceWorkerMessage(event);
                    });
                }
            }

            async loadFirebaseConfig() {
                try {
                    if (typeof db === 'undefined') return false;
                    const doc = await db.collection('systemConfig').doc('firebase').get();
                    if (doc.exists && doc.data().apiKey) {
                        this.config = doc.data();
                        console.log('Firebase config loaded');
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error loading Firebase config:', error);
                    return false;
                }
            }

            async checkNotificationPermission() {
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    this.isPermissionGranted = false;
                    return false;
                }

                if (Notification.permission === 'granted') {
                    this.isPermissionGranted = true;
                    return true;
                } else if (Notification.permission === 'denied') {
                    console.log('Notification permission denied');
                    this.isPermissionGranted = false;
                    return false;
                } else {
                    try {
                        const permission = await Notification.requestPermission();
                        this.isPermissionGranted = permission === 'granted';
                        return this.isPermissionGranted;
                    } catch (error) {
                        console.error('Error requesting notification permission:', error);
                        return false;
                    }
                }
            }

            async registerServiceWorker() {
                if (!('serviceWorker' in navigator)) {
                    console.log('Service workers not supported');
                    return null;
                }

                try {
                    this.serviceWorkerRegistration = await navigator.serviceWorker.register('firebase-messaging-sw.js', {
                        scope: './',
                        updateViaCache: 'none'
                    });
                    console.log('Service Worker registered');
                    return this.serviceWorkerRegistration;
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                    return null;
                }
            }

            async initialize() {
            if (this.isInitialized) return true;

            try {
                // Check permission first
                const hasPermission = await this.checkNotificationPermission();
                if (!hasPermission) {
                    console.log('Notification permission not granted');
                    return false;
                }

                // Load Firebase config
                const hasConfig = await this.loadFirebaseConfig();
                if (!hasConfig || !this.config) {
                    console.log('Firebase config not available');
                    showToast('Push notifications not configured. Please contact administrator.', 'warning');
                    return false;
                }

                // Register service worker first
                const registration = await this.registerServiceWorker();
                if (!registration) {
                    throw new Error('Service Worker registration failed');
                }

                // Get messaging instance - Firebase v8
                if (firebase.messaging.isSupported()) {
                    this.messaging = firebase.messaging();
                    console.log('Firebase Messaging initialized');
                } else {
                    console.log('Firebase Messaging not supported');
                    return false;
                }

                // Get FCM token
                this.fcmToken = await this.getToken();
                
                // Save token to user's profile
                if (this.fcmToken && currentUser) {
                    await this.saveTokenToProfile(this.fcmToken);
                }

                // Set up message listeners
                this.setupMessageListeners();
                
                // Send config to service worker
                await this.sendConfigToServiceWorker();

                this.isInitialized = true;
                console.log('Push notifications initialized successfully');
                
                // Show success message
                showToast('Push notifications enabled ‚úì', 'success');
                
                return true;
            } catch (error) {
                console.error('Error initializing push notifications:', error);
                showToast('Failed to enable push notifications', 'error');
                return false;
            }
        }

        // Update getToken method:
        async getToken() {
            try {
                if (!this.messaging) {
                    throw new Error('Messaging not initialized');
                }

                // Get token for Firebase v8
                const token = await this.messaging.getToken();
                
                if (token) {
                    console.log('FCM Token obtained:', token.substring(0, 20) + '...');
                    return token;
                } else {
                    console.log('No registration token available');
                    return null;
                }
            } catch (error) {
                console.error('Error getting FCM token:', error);
                return null;
            }
        }

            async saveTokenToProfile(token) {
                try {
                    if (!currentUser || !token) return;
                    await db.collection('userTokens').doc(currentUser.username).set({
                        token: token,
                        username: currentUser.username,
                        name: currentUser.name,
                        rcNo: currentUser.rcNo,
                        level: currentUser.level,
                        lastUpdated: new Date().toISOString(),
                        settings: this.notificationSettings
                    }, { merge: true });
                } catch (error) {
                    console.error('Error saving token:', error);
                }
            }

            async sendConfigToServiceWorker() {
                if (!this.serviceWorkerRegistration || !this.config) return;
                try {
                    const serviceWorker = this.serviceWorkerRegistration.active;
                    if (serviceWorker) {
                        serviceWorker.postMessage({
                            type: 'UPDATE_FIREBASE_CONFIG',
                            config: this.config
                        });
                    }
                } catch (error) {
                    console.error('Error sending config to Service Worker:', error);
                }
            }

            setupMessageListeners() {
                if (!this.messaging) return;

                this.messaging.onMessage((payload) => {
                    console.log('Foreground message received:', payload);
                    if (!this.shouldShowNotification(payload.data?.type)) return;
                    this.showInAppNotification(payload);
                    if (this.isPermissionGranted) {
                        this.showBrowserNotification(payload);
                    }
                });

                this.messaging.onTokenRefresh(async () => {
                    const newToken = await this.getToken();
                    if (newToken && currentUser) {
                        this.fcmToken = newToken;
                        await this.saveTokenToProfile(newToken);
                    }
                });
            }

            shouldShowNotification(type) {
                switch(type) {
                    case 'duty_change_request':
                    case 'duty_change_response':
                        return this.notificationSettings.dutyChanges;
                    case 'leave_request':
                    case 'leave_approval':
                        return this.notificationSettings.leaveApprovals;
                    case 'announcement':
                        return this.notificationSettings.announcements;
                    case 'system_alert':
                    case 'test':
                        return this.notificationSettings.systemAlerts;
                    default:
                        return true;
                }
            }

            showInAppNotification(payload) {
                const title = payload.notification?.title || 'New Notification';
                const body = payload.notification?.body || '';
                const type = payload.data?.type || 'info';
                
                let toastType = 'info';
                if (type.includes('success') || type.includes('approved')) toastType = 'success';
                if (type.includes('error') || type.includes('rejected')) toastType = 'error';
                if (type.includes('warning')) toastType = 'warning';
                
                showToast(`${title}: ${body}`, toastType);
            }

            showBrowserNotification(payload) {
                const title = payload.notification?.title || 'Duty Manager';
                const body = payload.notification?.body || 'New notification';
                
                const options = {
                    body: body,
                    icon: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%233498db\'/%3E%3Ccircle cx=\'50\' cy=\'35\' r=\'12\' fill=\'white\'/%3E%3Cpath d=\'M50,55 C65,55 70,70 70,70 L30,70 C30,70 35,55 50,55 Z\' fill=\'white\'/%3E%3Cpath d=\'M35,75 L65,75 L65,85 C65,90 60,95 50,95 C40,95 35,90 35,85 Z\' fill=\'white\'/%3E%3Cpath d=\'M20,20 L20,40 L30,30 Z\' fill=\'%2327ae60\'/%3E%3C/svg%3E',
                    badge: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%233498db\'/%3E%3C/svg%3E',
                    data: payload.data || {}
                };
                
                if (Notification.permission === 'granted') {
                    const notification = new Notification(title, options);
                    notification.onclick = (event) => {
                        event.preventDefault();
                        window.focus();
                        notification.close();
                        if (payload.data?.requestId) showSection('myRequests');
                        else if (payload.data?.type === 'announcement') showSection('home');
                    };
                }
            }

            async sendNotificationToUser(username, title, body, data = {}) {
                try {
                    if (!this.isInitialized) return false;
                    const tokenDoc = await db.collection('userTokens').doc(username).get();
                    if (!tokenDoc.exists) return false;

                    await db.collection('notifications').add({
                        toUsername: username,
                        title: title,
                        body: body,
                        data: data,
                        read: false,
                        createdAt: new Date().toISOString()
                    });

                    if (currentUser && currentUser.username === username) {
                        const payload = { notification: { title, body }, data: data };
                        this.showInAppNotification(payload);
                        if (this.isPermissionGranted) this.showBrowserNotification(payload);
                    }

                    return true;
                } catch (error) {
                    console.error('Error sending notification:', error);
                    return false;
                }
            }

            async sendNotificationToAll(title, body, data = {}) {
                try {
                    const tokensSnapshot = await db.collection('userTokens').get();
                    const usernames = [];
                    tokensSnapshot.forEach(doc => usernames.push(doc.id));

                    const promises = usernames.map(username => 
                        this.sendNotificationToUser(username, title, body, data)
                    );
                    
                    await Promise.all(promises);
                    await db.collection('broadcastNotifications').add({
                        title: title,
                        body: body,
                        data: data,
                        sentBy: currentUser?.username || 'system',
                        sentAt: new Date().toISOString(),
                        userCount: usernames.length
                    });

                    return true;
                } catch (error) {
                    console.error('Error sending notification to all:', error);
                    return false;
                }
            }

            loadNotificationSettings() {
                const saved = localStorage.getItem('notificationSettings');
                if (saved) {
                    try {
                        this.notificationSettings = JSON.parse(saved);
                    } catch (e) {
                        console.error('Error loading notification settings:', e);
                    }
                }
            }

            saveNotificationSettings() {
                localStorage.setItem('notificationSettings', JSON.stringify(this.notificationSettings));
                if (currentUser && this.fcmToken) {
                    this.saveTokenToProfile(this.fcmToken);
                }
            }

            async testNotification() {
                if (!this.isInitialized) {
                    showToast('Push notifications not initialized', 'warning');
                    return;
                }
                await this.sendNotificationToUser(
                    currentUser.username,
                    'Test Notification',
                    'This is a test notification from Duty Manager',
                    { type: 'test', testTime: new Date().toISOString() }
                );
                showToast('Test notification sent!', 'success');
            }

            async getNotificationStats() {
                try {
                    const tokensSnapshot = await db.collection('userTokens').get();
                    const notificationsSnapshot = await db.collection('notifications')
                        .where('createdAt', '>=', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString())
                        .get();
                    
                    return {
                        totalUsers: tokensSnapshot.size,
                        weeklyNotifications: notificationsSnapshot.size,
                        pushEnabled: this.isInitialized,
                        permissionGranted: this.isPermissionGranted
                    };
                } catch (error) {
                    console.error('Error getting notification stats:', error);
                    return null;
                }
            }

            async cleanupOldTokens(days = 30) {
                try {
                    const cutoffDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                    const tokensSnapshot = await db.collection('userTokens')
                        .where('lastUpdated', '<', cutoffDate.toISOString())
                        .get();
                    
                    const batch = db.batch();
                    tokensSnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    return tokensSnapshot.size;
                } catch (error) {
                    console.error('Error cleaning up old tokens:', error);
                    return 0;
                }
            }

            handleServiceWorkerMessage(event) {
                switch(event.data.type) {
                    case 'NOTIFICATION_CLICK':
                        if (event.data.data?.requestId) showSection('myRequests');
                        else if (event.data.data?.type === 'announcement') showSection('home');
                        break;
                    case 'GET_FIREBASE_CONFIG':
                        this.loadFirebaseConfig().then(() => {
                            if (this.config && this.serviceWorkerRegistration?.active) {
                                this.serviceWorkerRegistration.active.postMessage({
                                    type: 'UPDATE_FIREBASE_CONFIG',
                                    config: this.config
                                });
                            }
                        });
                        break;
                }
            }
        }

        // Create global instance
        const pushManager = new PushNotificationManager();
    </script>

    <script>
        // Main Application Script
        let currentUser = null;
        let allUsers = [];
        let dutyRoster = {};
        let leaveBalances = {};
        let allRequests = [];
        let announcements = [];
        let isMobile = false;
        let currentToastId = 0;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            detectMobile();
            initApp();
        });

        function detectMobile() {
            isMobile = window.innerWidth <= 768;
            if (isMobile) document.body.classList.add('mobile');
        }

        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                    if (textEl) textEl.textContent = text;
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toastId = 'toast-' + (++currentToastId);
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">
                    ${type === 'success' ? '‚úÖ' : 
                      type === 'error' ? '‚ùå' : 
                      type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </span>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                const toastElem = document.getElementById(toastId);
                if (toastElem) {
                    toastElem.style.opacity = '0';
                    toastElem.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toastElem.parentNode) {
                            toastElem.parentNode.removeChild(toastElem);
                        }
                    }, 300);
                }
            }, duration);
        }

        function initApp() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
            }
            
            setupMobileNavigation();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('changeDate').min = today;
            document.getElementById('leaveDate').min = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('changeDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('leaveDate').value = tomorrow.toISOString().split('T')[0];
            
            checkSession();
        }

        function setupMobileNavigation() {
            const menuToggle = document.getElementById('menuToggle');
            const mobileNav = document.getElementById('mobileNav');
            const mobileNavOverlay = document.getElementById('mobileNavOverlay');
            
            if (menuToggle && mobileNav && mobileNavOverlay) {
                menuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mobileNav.classList.add('active');
                    mobileNavOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
                
                mobileNavOverlay.addEventListener('click', function() {
                    mobileNav.classList.remove('active');
                    mobileNavOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', function() {
                        mobileNav.classList.remove('active');
                        mobileNavOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                        const sectionId = this.getAttribute('data-section');
                        showSection(sectionId);
                    });
                });
            }
        }

        function checkSession() {
            const session = localStorage.getItem('dutySystemSession');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    if (user.expiry > Date.now()) {
                        loginUser(user);
                    } else {
                        localStorage.removeItem('dutySystemSession');
                    }
                } catch (e) {
                    localStorage.removeItem('dutySystemSession');
                }
            }
        }

        async function handleLogin() {
            showLoading(true, 'Authenticating...');
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showToast('Please enter both username and password', 'warning');
                showLoading(false);
                return;
            }
            
            if (!users || !Array.isArray(users)) {
                showToast('System error. Please try again.', 'error');
                showLoading(false);
                return;
            }
            
            const user = users.find(u => u.username === username);
            
            if (!user) {
                showToast('Invalid username or password', 'error');
                showLoading(false);
                return;
            }
            
            const hashedPassword = sha256(password);
            
            if (hashedPassword === user.passwordHash) {
                const sessionData = {
                    username: user.username,
                    name: user.name,
                    rcNo: user.RCNo,
                    level: user.Level,
                    expiry: Date.now() + (8 * 60 * 60 * 1000)
                };
                
                localStorage.setItem('dutySystemSession', JSON.stringify(sessionData));
                await loginUser(sessionData);
                showLoading(false);
            } else {
                showToast('Invalid username or password', 'error');
                showLoading(false);
            }
        }

        async function loginUser(userData) {
            currentUser = userData;
            allUsers = users || [];
            
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
            
            document.getElementById('mobileTitle').textContent = 'Dashboard';
            document.getElementById('mobileAvatar').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('navUserName').textContent = userData.name;
            document.getElementById('navUserRC').textContent = userData.rcNo;
            document.getElementById('navUserLevel').textContent = userData.level;
            document.getElementById('welcomeName').textContent = userData.name;
            
            const isAdmin = userData.level === 'Supervisor';
            document.querySelectorAll('.admin-nav').forEach(el => {
                el.style.display = isAdmin ? 'flex' : 'none';
            });
            
            setTimeout(async () => {
                try {
                    const initialized = await pushManager.initialize();
                    if (initialized) {
                        setTimeout(() => {
                            pushManager.sendNotificationToUser(
                                userData.username,
                                'Welcome to Duty Manager!',
                                'Push notifications are now enabled.',
                                { type: 'system_alert', welcome: true }
                            );
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error initializing push notifications:', error);
                }
            }, 1000);
            
            await initializeData();
            setupEventListeners();
            showToast(`Welcome back, ${userData.name}!`, 'success');
        }

        async function initializeData() {
            showLoading(true, 'Loading data...');
            try {
                await Promise.all([
                    loadDutyRoster(),
                    loadLeaveBalances(),
                    loadAllRequests(),
                    loadAnnouncements()
                ]);
                updateUserBalance();
                updateRequestCounts();
                loadHomeAnnouncements();
                showLoading(false);
            } catch (error) {
                console.error('Error initializing data:', error);
                showToast('Failed to load data', 'error');
                showLoading(false);
            }
        }

        // Firebase Functions
        async function loadDutyRoster() {
            try {
                const doc = await db.collection('dutyRoster').doc('current').get();
                dutyRoster = doc.exists ? doc.data() || {} : {};
                return dutyRoster;
            } catch (error) {
                console.error('Error loading duty roster:', error);
                dutyRoster = {};
                return dutyRoster;
            }
        }

        async function saveDutyRoster() {
            try {
                await db.collection('dutyRoster').doc('current').set(dutyRoster);
                return true;
            } catch (error) {
                console.error('Error saving duty roster:', error);
                showToast('Failed to save roster', 'error');
                return false;
            }
        }

        async function loadLeaveBalances() {
            try {
                const doc = await db.collection('leaveBalances').doc('current').get();
                if (doc.exists) {
                    leaveBalances = doc.data() || {};
                } else {
                    leaveBalances = {};
                    allUsers.forEach(user => {
                        leaveBalances[user.username] = { SL: 12, FRL: 6 };
                    });
                    await saveLeaveBalances();
                }
                return leaveBalances;
            } catch (error) {
                console.error('Error loading leave balances:', error);
                leaveBalances = {};
                return leaveBalances;
            }
        }

        async function saveLeaveBalances() {
            try {
                await db.collection('leaveBalances').doc('current').set(leaveBalances);
                return true;
            } catch (error) {
                console.error('Error saving leave balances:', error);
                showToast('Failed to save leave balances', 'error');
                return false;
            }
        }

        async function loadAllRequests() {
            try {
                const doc = await db.collection('requests').doc('all').get();
                if (doc.exists && doc.data().requests) {
                    allRequests = doc.data().requests;
                } else {
                    allRequests = [];
                }
                return allRequests;
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = [];
                return allRequests;
            }
        }

        async function saveAllRequests() {
            try {
                await db.collection('requests').doc('all').set({ requests: allRequests });
                return true;
            } catch (error) {
                console.error('Error saving requests:', error);
                showToast('Failed to save requests', 'error');
                return false;
            }
        }

        async function loadAnnouncements() {
            try {
                const doc = await db.collection('announcements').doc('all').get();
                if (doc.exists && doc.data().announcements) {
                    announcements = doc.data().announcements;
                } else {
                    announcements = [];
                    await saveAnnouncements();
                }
                return announcements;
            } catch (error) {
                console.error('Error loading announcements:', error);
                announcements = [];
                return announcements;
            }
        }

        async function saveAnnouncements() {
            try {
                await db.collection('announcements').doc('all').set({ announcements: announcements });
                return true;
            } catch (error) {
                console.error('Error saving announcements:', error);
                showToast('Failed to save announcements', 'error');
                return false;
            }
        }

        function updateUserBalance() {
            if (!currentUser) return;
            const balance = leaveBalances[currentUser.username] || {SL: 0, FRL: 0};
            document.getElementById('slBalance').textContent = balance.SL.toFixed(1);
            document.getElementById('frlBalance').textContent = balance.FRL.toFixed(1);
        }

        function updateRequestCounts() {
            if (!currentUser) return;
            
            const pendingForUser = allRequests.filter(req => 
                req.status === 'pending' && 
                req.type === 'dutyChange' && 
                req.toUsername === currentUser.username
            ).length;
            
            const pendingNav = document.getElementById('pendingRequestsNav');
            const pendingBadge = document.getElementById('pendingRequestsBadge');
            
            if (pendingForUser > 0) {
                pendingNav.style.display = 'flex';
                pendingBadge.textContent = pendingForUser;
                pendingBadge.style.display = 'inline-block';
            } else {
                pendingNav.style.display = 'none';
                pendingBadge.style.display = 'none';
            }
            
            const myPending = allRequests.filter(req => 
                req.fromUsername === currentUser.username && 
                req.status === 'pending'
            ).length;
            
            const myBadge = document.getElementById('myRequestsBadge');
            if (myPending > 0) {
                myBadge.textContent = myPending;
                myBadge.style.display = 'inline-block';
            } else {
                myBadge.style.display = 'none';
            }
        }

        // Navigation Functions
        function showSection(sectionId) {
            const titles = {
                home: 'Dashboard',
                dutyChange: 'Duty Change',
                leaveApplication: 'Apply Leave',
                myRequests: 'My Requests',
                pendingRequests: 'Pending Requests',
                viewMyRoster: 'My Roster',
                viewAllRoster: 'All Roster',
                notificationSettings: 'Notifications',
                adminAnnouncements: 'Announcements',
                adminPushConfig: 'Push Config'
            };
            
            document.getElementById('mobileTitle').textContent = titles[sectionId] || sectionId;
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId + 'Section').classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.querySelector('span:last-child').textContent.toLowerCase();
                if (sectionId === 'home' && btnText === 'home') btn.classList.add('active');
                if (sectionId === 'dutyChange' && btnText === 'change') btn.classList.add('active');
                if (sectionId === 'leaveApplication' && btnText === 'leave') btn.classList.add('active');
                if (sectionId === 'myRequests' && btnText === 'requests') btn.classList.add('active');
                if (sectionId === 'viewAllRoster' && btnText === 'roster') btn.classList.add('active');
            });
            
            loadSectionData(sectionId);
            document.getElementById('dashboardContent').scrollTop = 0;
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'home':
                    updateDashboard();
                    break;
                case 'dutyChange':
                    loadDutyChangeForm();
                    break;
                case 'leaveApplication':
                    loadLeaveForm();
                    break;
                case 'myRequests':
                    loadMyRequests();
                    break;
                case 'pendingRequests':
                    loadPendingRequests();
                    break;
                case 'viewAllRoster':
                    loadAllRoster();
                    break;
                case 'notificationSettings':
                    loadNotificationSettings();
                    break;
                case 'adminAnnouncements':
                    loadAnnouncementsAdmin();
                    break;
                case 'adminPushConfig':
                    loadFirebaseConfigForm();
                    loadPushStats();
                    break;
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayDutyTime = document.getElementById('todayDutyTime');
            const nextDutyTime = document.getElementById('nextDutyTime');
            
            if (dutyRoster[today] && dutyRoster[today][currentUser.username]) {
                const duty = dutyRoster[today][currentUser.username];
                todayDutyTime.textContent = duty === 'Off' ? 'Off Duty' : duty;
            } else {
                todayDutyTime.textContent = 'Not Scheduled';
            }
            
            const tomorrow = new Date();
            let foundNext = false;
            
            for (let i = 1; i <= 7; i++) {
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                if (dutyRoster[dateStr] && dutyRoster[dateStr][currentUser.username]) {
                    const duty = dutyRoster[dateStr][currentUser.username];
                    if (duty !== 'Off') {
                        const date = new Date(dateStr);
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                        nextDutyTime.textContent = `${dayName}: ${duty}`;
                        foundNext = true;
                        break;
                    }
                }
            }
            
            if (!foundNext) {
                nextDutyTime.textContent = 'No upcoming duty';
            }
            
            updateUserBalance();
            loadHomeAnnouncements();
        }

        function loadHomeAnnouncements() {
            const container = document.getElementById('homeAnnouncements');
            if (!container) return;
            container.innerHTML = '';
            
            const now = new Date();
            const activeAnnouncements = announcements.filter(ann => {
                if (ann.status === 'expired' || ann.status === 'archived') return false;
                if (ann.expiry && new Date(ann.expiry) < now) return false;
                return ann.target === 'all' || 
                       (ann.target === 'specific' && ann.targetUsers && 
                        ann.targetUsers.includes(currentUser.username));
            });
            
            if (activeAnnouncements.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">üì¢</div>
                    <div class="empty-state-title">No Announcements</div>
                `;
                container.appendChild(emptyState);
                return;
            }
            
            const displayAnnouncements = isMobile ? 
                activeAnnouncements.slice(0, 2) : activeAnnouncements;
            
            displayAnnouncements.forEach(ann => {
                const announcementDiv = document.createElement('div');
                announcementDiv.className = `announcement-banner priority-${ann.priority}`;
                announcementDiv.innerHTML = `
                    <div class="announcement-title">
                        <span>üì¢</span> ${ann.title}
                    </div>
                    <div style="margin-bottom: 10px; font-size: 14px;">${ann.content}</div>
                    <div style="font-size: 12px; opacity: 0.9;">
                        By: ${ann.createdBy} ‚Ä¢ ${formatTimeAgo(ann.createdAt)}
                    </div>
                `;
                container.appendChild(announcementDiv);
            });
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return past.toLocaleDateString();
        }

        // Notification Settings Functions
        function loadNotificationSettings() {
            const settings = pushManager.notificationSettings;
            document.getElementById('notifyDutyChanges').checked = settings.dutyChanges;
            document.getElementById('notifyLeaveApprovals').checked = settings.leaveApprovals;
            document.getElementById('notifyAnnouncements').checked = settings.announcements;
            document.getElementById('notifySystemAlerts').checked = settings.systemAlerts;
            updateNotificationStatus();
        }

        function saveNotificationSettings() {
            pushManager.notificationSettings = {
                dutyChanges: document.getElementById('notifyDutyChanges').checked,
                leaveApprovals: document.getElementById('notifyLeaveApprovals').checked,
                announcements: document.getElementById('notifyAnnouncements').checked,
                systemAlerts: document.getElementById('notifySystemAlerts').checked
            };
            pushManager.saveNotificationSettings();
            showToast('Notification settings saved!', 'success');
            updateNotificationStatus();
        }

        function testUserNotification() {
            pushManager.testNotification();
        }

        async function checkNotificationPermission() {
            const hasPermission = await pushManager.checkNotificationPermission();
            if (hasPermission) showToast('‚úÖ Notification permission granted', 'success');
            else showToast('‚ùå Notification permission not granted', 'error');
            updateNotificationStatus();
        }

        function updateNotificationStatus() {
            const container = document.getElementById('notificationStatus');
            const status = {
                permission: Notification.permission,
                initialized: pushManager.isInitialized,
                token: pushManager.fcmToken ? '‚úì' : '‚úó',
                settings: pushManager.notificationSettings
            };
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <strong>Permission Status:</strong>
                    <span class="badge ${status.permission === 'granted' ? 'badge-success' : 
                                  status.permission === 'denied' ? 'badge-danger' : 'badge-warning'}" 
                          style="margin-left: 10px; padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                        ${status.permission.toUpperCase()}
                    </span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Push Initialized:</strong>
                    <span class="badge ${status.initialized ? 'badge-success' : 'badge-danger'}" 
                          style="margin-left: 10px; padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                        ${status.initialized ? 'YES' : 'NO'}
                    </span>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>Push Token:</strong>
                    <span class="badge ${status.token === '‚úì' ? 'badge-success' : 'badge-danger'}" 
                          style="margin-left: 10px; padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                        ${status.token}
                    </span>
                </div>
                
                <div style="margin-top: 20px;">
                    <strong>Current Settings:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Duty Changes: ${status.settings.dutyChanges ? '‚úÖ' : '‚ùå'}</li>
                        <li>Leave Approvals: ${status.settings.leaveApprovals ? '‚úÖ' : '‚ùå'}</li>
                        <li>Announcements: ${status.settings.announcements ? '‚úÖ' : '‚ùå'}</li>
                        <li>System Alerts: ${status.settings.systemAlerts ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                </div>
            `;
            
            if (pushManager.fcmToken) {
                const truncatedToken = pushManager.fcmToken.substring(0, 20) + '...';
                html += `
                    <div style="margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <small><strong>Token:</strong> ${truncatedToken}</small>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function resetPushToken() {
            if (!confirm('Reset your push notification token? You will need to re-enable notifications.')) return;
            showLoading(true, 'Resetting push token...');
            try {
                await db.collection('userTokens').doc(currentUser.username).delete();
                pushManager.fcmToken = null;
                pushManager.isInitialized = false;
                await pushManager.initialize();
                showLoading(false);
                showToast('Push token reset successfully', 'success');
                updateNotificationStatus();
            } catch (error) {
                showLoading(false);
                console.error('Error resetting push token:', error);
                showToast('Failed to reset push token', 'error');
            }
        }

        // Admin Push Configuration Functions
        async function loadFirebaseConfigForm() {
            try {
                const doc = await db.collection('systemConfig').doc('firebase').get();
                if (doc.exists) {
                    const config = doc.data();
                    document.getElementById('firebaseApiKey').value = config.apiKey || '';
                    document.getElementById('firebaseAuthDomain').value = config.authDomain || '';
                    document.getElementById('firebaseProjectId').value = config.projectId || '';
                    document.getElementById('firebaseStorageBucket').value = config.storageBucket || '';
                    document.getElementById('firebaseMessagingSenderId').value = config.messagingSenderId || '';
                    document.getElementById('firebaseAppId').value = config.appId || '';
                    document.getElementById('firebaseVapidKey').value = config.vapidKey || '';
                }
            } catch (error) {
                console.error('Error loading Firebase config:', error);
            }
            populateTestUsers();
        }

        async function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('firebaseApiKey').value.trim(),
                authDomain: document.getElementById('firebaseAuthDomain').value.trim(),
                projectId: document.getElementById('firebaseProjectId').value.trim(),
                storageBucket: document.getElementById('firebaseStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('firebaseMessagingSenderId').value.trim(),
                appId: document.getElementById('firebaseAppId').value.trim(),
                vapidKey: document.getElementById('firebaseVapidKey').value.trim()
            };
            
            for (const [key, value] of Object.entries(config)) {
                if (!value) {
                    showToast(`Please fill in ${key}`, 'error');
                    return;
                }
            }
            
            showLoading(true, 'Saving configuration...');
            try {
                await db.collection('systemConfig').doc('firebase').set(config);
                pushManager.config = config;
                if (pushManager.serviceWorkerRegistration?.active) {
                    pushManager.serviceWorkerRegistration.active.postMessage({
                        type: 'UPDATE_FIREBASE_CONFIG',
                        config: config
                    });
                }
                showLoading(false);
                showToast('Firebase configuration saved successfully!', 'success');
                setTimeout(() => {
                    pushManager.initialize().then(initialized => {
                        if (initialized) showToast('Push notifications reinitialized', 'success');
                    });
                }, 1000);
            } catch (error) {
                showLoading(false);
                console.error('Error saving Firebase config:', error);
                showToast('Failed to save configuration', 'error');
            }
        }

        async function testFirebaseConfig() {
        const config = {
            apiKey: document.getElementById('firebaseApiKey').value.trim(),
            authDomain: document.getElementById('firebaseAuthDomain').value.trim(),
            projectId: document.getElementById('firebaseProjectId').value.trim(),
            storageBucket: document.getElementById('firebaseStorageBucket').value.trim(),
            messagingSenderId: document.getElementById('firebaseMessagingSenderId').value.trim(),
            appId: document.getElementById('firebaseAppId').value.trim(),
            vapidKey: document.getElementById('firebaseVapidKey').value.trim()
        };
        
        for (const [key, value] of Object.entries(config)) {
            if (!value) {
                showToast(`Please fill in ${key}`, 'error');
                return;
            }
        }
        
        showLoading(true, 'Testing Firebase configuration...');
        
        try {
            // Test Firebase initialization with a temporary name
            const tempApp = firebase.initializeApp(config, 'testApp');
            console.log('Firebase test initialization successful');
            
            // Test Firestore connection
            const testDb = firebase.firestore(tempApp);
            const testDoc = await testDb.collection('systemConfig').doc('test').get();
            console.log('Firestore test successful');
            
            // Test Messaging support
            if (firebase.messaging.isSupported()) {
                console.log('Messaging test successful');
            } else {
                console.log('Messaging not supported in this environment');
            }
            
            // Cleanup test app
            await tempApp.delete();
            
            showLoading(false);
            showToast('‚úÖ Firebase configuration test passed!', 'success');
        } catch (error) {
            showLoading(false);
            console.error('Firebase configuration test failed:', error);
            showToast(`‚ùå Configuration test failed: ${error.message}`, 'error');
        }
    }

        async function loadPushStats() {
            const container = document.getElementById('pushStatsContainer');
            container.innerHTML = '<div class="alert alert-info">Loading statistics...</div>';
            try {
                const stats = await pushManager.getNotificationStats();
                if (!stats) {
                    container.innerHTML = '<div class="alert alert-warning">Failed to load statistics</div>';
                    return;
                }
                
                let html = `
                    <div class="balance-display">
                        <div class="balance-box">
                            <div class="balance-label">Total Users</div>
                            <div class="balance-value">${stats.totalUsers}</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">Weekly Notifications</div>
                            <div class="balance-value">${stats.weeklyNotifications}</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">Push Enabled</div>
                            <div class="balance-value">${stats.pushEnabled ? '‚úì' : '‚úó'}</div>
                        </div>
                        <div class="balance-box">
                            <div class="balance-label">Permission Granted</div>
                            <div class="balance-value">${stats.permissionGranted ? '‚úì' : '‚úó'}</div>
                        </div>
                    </div>
                `;
                
                const tokensSnapshot = await db.collection('userTokens').get();
                if (tokensSnapshot.size > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <h4>Registered Users (${tokensSnapshot.size})</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>RC No</th>
                                            <th>Last Updated</th>
                                            <th>Device</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    tokensSnapshot.forEach(doc => {
                        const data = doc.data();
                        const timeAgo = formatTimeAgo(data.lastUpdated);
                        html += `
                            <tr>
                                <td>${data.name}</td>
                                <td>${data.rcNo}</td>
                                <td>${timeAgo}</td>
                                <td>${data.platform || 'Unknown'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading push stats:', error);
                container.innerHTML = '<div class="alert alert-error">Error loading statistics</div>';
            }
        }

        async function cleanupOldTokens() {
            if (!confirm('Clean up tokens older than 30 days?')) return;
            showLoading(true, 'Cleaning up old tokens...');
            try {
                const cleanedCount = await pushManager.cleanupOldTokens();
                showLoading(false);
                showToast(`Cleaned up ${cleanedCount} old tokens`, 'success');
                loadPushStats();
            } catch (error) {
                showLoading(false);
                console.error('Error cleaning up tokens:', error);
                showToast('Failed to cleanup tokens', 'error');
            }
        }

        function populateTestUsers() {
            const select = document.getElementById('testNotificationUser');
            select.innerHTML = '<option value="">Select user</option>';
            if (allUsers && allUsers.length > 0) {
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.name} (RC: ${user.RCNo})`;
                    select.appendChild(option);
                });
            }
        }

        document.getElementById('testNotificationTarget')?.addEventListener('change', function() {
            const container = document.getElementById('specificUserContainer');
            container.style.display = this.value === 'specific' ? 'block' : 'none';
        });

        async function sendTestNotification() {
            const title = document.getElementById('testNotificationTitle').value.trim();
            const body = document.getElementById('testNotificationBody').value.trim();
            const target = document.getElementById('testNotificationTarget').value;
            
            if (!title || !body) {
                showToast('Please enter title and body', 'warning');
                return;
            }
            
            showLoading(true, 'Sending test notification...');
            try {
                let success = false;
                switch(target) {
                    case 'current':
                        success = await pushManager.sendNotificationToUser(
                            currentUser.username,
                            title,
                            body,
                            { type: 'test', source: 'admin_panel' }
                        );
                        break;
                    case 'all':
                        success = await pushManager.sendNotificationToAll(
                            title,
                            body,
                            { type: 'test', source: 'admin_panel' }
                        );
                        break;
                    case 'specific':
                        const username = document.getElementById('testNotificationUser').value;
                        if (!username) {
                            showLoading(false);
                            showToast('Please select a user', 'warning');
                            return;
                        }
                        success = await pushManager.sendNotificationToUser(
                            username,
                            title,
                            body,
                            { type: 'test', source: 'admin_panel' }
                        );
                        break;
                }
                showLoading(false);
                if (success) showToast('Test notification sent successfully!', 'success');
                else showToast('Failed to send test notification', 'error');
            } catch (error) {
                showLoading(false);
                console.error('Error sending test notification:', error);
                showToast('Error sending test notification', 'error');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            const dutyChangeForm = document.getElementById('dutyChangeForm');
            if (dutyChangeForm) {
                dutyChangeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitDutyChange();
                });
            }
            
            const leaveApplicationForm = document.getElementById('leaveApplicationForm');
            if (leaveApplicationForm) {
                leaveApplicationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitLeaveApplication();
                });
            }
            
            const announcementForm = document.getElementById('announcementForm');
            if (announcementForm) {
                announcementForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createAnnouncement();
                });
            }
            
            const firebaseConfigForm = document.getElementById('firebaseConfigForm');
            if (firebaseConfigForm) {
                firebaseConfigForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveFirebaseConfig();
                });
            }
            
            document.getElementById('changeDate').addEventListener('change', function() {
                loadUserDutyTimes('changeDutyTime', this.value);
            });
            
            document.getElementById('requestToStaff').addEventListener('change', function() {
                const user = allUsers.find(u => u.username === this.value);
                if (user) {
                    document.getElementById('requestToRcNo').value = user.RCNo;
                    const date = document.getElementById('changeDate').value;
                    if (date) {
                        const select = document.getElementById('requestToDutyTime');
                        select.innerHTML = '<option value="">Select duty time</option>';
                        const dutyTime = dutyRoster[date] && dutyRoster[date][user.username];
                        if (dutyTime) {
                            const option = document.createElement('option');
                            option.value = dutyTime;
                            option.textContent = dutyTime === 'Off' ? 'Off Duty' : dutyTime;
                            select.appendChild(option);
                        }
                    }
                }
            });
            
            document.getElementById('leaveDate').addEventListener('change', function() {
                loadUserDutyTimes('leaveDutyTime', this.value);
                updateLeaveRules();
            });
            
            document.getElementById('leaveType').addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDutyTime').addEventListener('change', updateLeaveRules);
            document.getElementById('leaveDuration').addEventListener('change', updateLeaveRules);
            
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('dutySystemSession');
                    location.reload();
                }
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => showInstallPrompt(), 3000);
        });
        
        function showInstallPrompt() {
            if (deferredPrompt && !localStorage.getItem('installPromptShown')) {
                const installContainer = document.createElement('div');
                installContainer.style.cssText = `
                    position: fixed;
                    bottom: 90px;
                    right: 15px;
                    z-index: 1000;
                    background: white;
                    border-radius: 15px;
                    padding: 15px;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                    max-width: 300px;
                    animation: slideInUp 0.3s ease;
                `;
                installContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="width: 40px; height: 40px; border-radius: 10px; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            üë§
                        </div>
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">Install Duty Manager</div>
                            <div style="font-size: 12px; color: #666;">Quick access on home screen</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="installNowBtn" style="flex: 1; background: #3498db; color: white; border: none; padding: 8px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            Install
                        </button>
                        <button id="installLaterBtn" style="background: #f0f0f0; color: #666; border: none; padding: 8px; border-radius: 8px; cursor: pointer;">
                            Later
                        </button>
                    </div>
                `;
                document.body.appendChild(installContainer);
                
                document.getElementById('installNowBtn').addEventListener('click', async () => {
                    installContainer.style.animation = 'slideOutDown 0.3s ease';
                    setTimeout(() => document.body.removeChild(installContainer), 300);
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    localStorage.setItem('installPromptShown', 'true');
                });
                
                document.getElementById('installLaterBtn').addEventListener('click', () => {
                    installContainer.style.animation = 'slideOutDown 0.3s ease';
                    setTimeout(() => document.body.removeChild(installContainer), 300);
                    localStorage.setItem('installPromptShown', 'true');
                });
                
                setTimeout(() => {
                    if (installContainer.parentNode) {
                        installContainer.style.animation = 'slideOutDown 0.3s ease';
                        setTimeout(() => {
                            if (installContainer.parentNode) document.body.removeChild(installContainer);
                        }, 300);
                    }
                }, 15000);
            }
        }

        // PWA Animation Styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes slideOutDown {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
