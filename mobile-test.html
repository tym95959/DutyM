<!DOCTYPE html>
<html>
<head>
    <title>Push Notification Test - Fixed</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f7fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #3498db; }
        .btn { padding: 12px 24px; margin: 10px 5px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219653; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        textarea { width: 100%; height: 150px; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; }
        .token-box { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; word-break: break-all; border-left: 4px solid #3498db; }
        .log-box { background: #2c3e50; color: white; padding: 15px; border-radius: 5px; margin: 15px 0; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .step { margin: 20px 0; padding: 15px; background: #e8f4fc; border-radius: 5px; }
        .step-number { display: inline-block; background: #3498db; color: white; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Push Notification Test</h1>
        <p>Test FCM push notifications on mobile devices</p>
        
        <div class="step">
            <span class="step-number">1</span>
            <strong>Initialize Firebase</strong>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="initFirebase()">Initialize Firebase</button>
                <button class="btn btn-success" onclick="getToken()">Get FCM Token</button>
            </div>
        </div>
        
        <div class="step">
            <span class="step-number">2</span>
            <strong>Your FCM Token</strong>
            <div class="token-box" id="tokenDisplay">
                No token yet. Click "Get FCM Token" first.
            </div>
            <button class="btn" onclick="copyToken()">üìã Copy Token</button>
        </div>
        
        <div class="step">
            <span class="step-number">3</span>
            <strong>Test Methods</strong>
            <div style="margin-top: 10px;">
                <button class="btn btn-success" onclick="sendViaCurl()">üìú Show cURL Command</button>
                <button class="btn" onclick="sendViaPostman()">üõ†Ô∏è Show Postman Setup</button>
                <button class="btn" onclick="sendViaFirebaseCLI()">üî• Show Firebase CLI Command</button>
            </div>
        </div>
        
        <div class="step">
            <span class="step-number">4</span>
            <strong>Direct Send (Server Required)</strong>
            <div style="margin-top: 10px;">
                <input type="text" id="testTitle" placeholder="Title" value="Test Notification" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                <input type="text" id="testBody" placeholder="Body" value="This is a test notification" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                <button class="btn btn-success" onclick="sendViaNodeServer()">Send via Node.js Server</button>
                <button class="btn" onclick="sendViaCloudFunction()">Send via Cloud Function</button>
            </div>
        </div>
        
        <div id="commandOutput" style="margin: 20px 0;"></div>
        
        <div class="step">
            <span class="step-number">5</span>
            <strong>Debug & Status</strong>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="checkStatus()">üîÑ Check Status</button>
                <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                <button class="btn btn-danger" onclick="resetAll()">üîÑ Reset All</button>
            </div>
        </div>
        
        <div class="log-box" id="logOutput">
            <!-- Logs will appear here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
            authDomain: "leelidc-1f753.firebaseapp.com",
            projectId: "leelidc-1f753",
            storageBucket: "leelidc-1f753.firebasestorage.app",
            messagingSenderId: "43622932335",
            appId: "1:43622932335:web:a7529bce1f19714687129a",
            measurementId: "G-3KD6ZYS599"
        };
        
        // YOUR SERVER KEY
        const SERVER_KEY = "BCS5MgDiA9DOzT_CI12agRMwNRtU6wehijEVEkjY77LMRnv6Fh9mlGocJ87k_5w862iwomMSx1xRGJFRH9W3s_8";
        
        let messaging = null;
        let fcmToken = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db';
            logDiv.innerHTML = `<div style="color: ${color}; margin: 5px 0;">[${time}] ${message}</div>` + logDiv.innerHTML;
            console.log(message);
        }
        
        function showCommand(title, content) {
            const outputDiv = document.getElementById('commandOutput');
            outputDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h3>${title}</h3>
                    <textarea readonly style="width: 100%; height: 200px; font-family: monospace; padding: 10px;">${content}</textarea>
                    <button class="btn" onclick="copyToClipboard(this.previousElementSibling.value)">üìã Copy Command</button>
                </div>
            `;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                log('Command copied to clipboard!', 'success');
            });
        }
        
        async function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    const app = firebase.initializeApp(firebaseConfig);
                    log('‚úÖ Firebase initialized', 'success');
                    
                    if (firebase.messaging.isSupported()) {
                        messaging = firebase.messaging();
                        log('‚úÖ Messaging initialized', 'success');
                        
                        // Listen for messages
                        messaging.onMessage((payload) => {
                            log(`üì± Foreground notification: ${payload.notification?.title}`, 'success');
                            alert(`üì± ${payload.notification?.title}: ${payload.notification?.body}`);
                        });
                        
                        return true;
                    } else {
                        log('‚ùå Messaging not supported', 'error');
                        return false;
                    }
                } else {
                    log('‚ö†Ô∏è Firebase already initialized', 'info');
                    messaging = firebase.messaging();
                    return true;
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function getToken() {
            if (!messaging) {
                log('‚ùå Messaging not initialized. Initialize Firebase first.', 'error');
                return;
            }
            
            try {
                log('Requesting notification permission...', 'info');
                const permission = await Notification.requestPermission();
                log(`Permission: ${permission}`, permission === 'granted' ? 'success' : 'error');
                
                if (permission === 'granted') {
                    // Register service worker for background messages
                    if ('serviceWorker' in navigator) {
                        try {
                            const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                            log('‚úÖ Service Worker registered', 'success');
                            messaging.useServiceWorker(registration);
                        } catch (swError) {
                            log('‚ö†Ô∏è Service Worker registration failed, continuing...', 'info');
                        }
                    }
                    
                    fcmToken = await messaging.getToken();
                    document.getElementById('tokenDisplay').innerHTML = `
                        <strong>Token (${fcmToken.length} chars):</strong><br>
                        <code style="font-size: 12px;">${fcmToken}</code>
                    `;
                    localStorage.setItem('fcmToken', fcmToken);
                    log(`‚úÖ Token obtained successfully`, 'success');
                    
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function copyToken() {
            if (!fcmToken) {
                log('‚ùå No token to copy', 'error');
                return;
            }
            
            navigator.clipboard.writeText(fcmToken).then(() => {
                log('‚úÖ Token copied to clipboard!', 'success');
            });
        }
        
        function sendViaCurl() {
            if (!fcmToken) {
                log('‚ùå No token. Get token first.', 'error');
                return;
            }
            
            const title = document.getElementById('testTitle').value || 'Test Notification';
            const body = document.getElementById('testBody').value || 'This is a test notification';
            
            const curlCommand = `curl -X POST \\
  -H "Authorization: key=${SERVER_KEY}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "to": "${fcmToken}",
    "notification": {
      "title": "${title}",
      "body": "${body}",
      "icon": "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
      "click_action": "https://leelidc-1f753.firebaseapp.com/"
    },
    "data": {
      "type": "test",
      "timestamp": "${new Date().toISOString()}"
    }
  }' \\
  "https://fcm.googleapis.com/fcm/send"`;
            
            showCommand('cURL Command', curlCommand);
            log('cURL command generated. Run this in terminal.', 'success');
        }
        
        function sendViaPostman() {
            if (!fcmToken) {
                log('‚ùå No token. Get token first.', 'error');
                return;
            }
            
            const title = document.getElementById('testTitle').value || 'Test Notification';
            const body = document.getElementById('testBody').value || 'This is a test notification';
            
            const postmanSetup = `
POSTMAN SETUP:
===============
URL: https://fcm.googleapis.com/fcm/send
Method: POST
Headers:
  Authorization: key=${SERVER_KEY}
  Content-Type: application/json

Body (raw JSON):
{
  "to": "${fcmToken}",
  "notification": {
    "title": "${title}",
    "body": "${body}",
    "icon": "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
    "click_action": "https://leelidc-1f753.firebaseapp.com/"
  },
  "data": {
    "type": "test",
    "timestamp": "${new Date().toISOString()}"
  }
}

Click "Send" and check response.`;
            
            showCommand('Postman Setup', postmanSetup);
            log('Postman setup generated.', 'success');
        }
        
        function sendViaFirebaseCLI() {
            if (!fcmToken) {
                log('‚ùå No token. Get token first.', 'error');
                return;
            }
            
            const title = document.getElementById('testTitle').value || 'Test Notification';
            const body = document.getElementById('testBody').value || 'This is a test notification';
            
            const firebaseCLICommand = `# Install Firebase CLI first:
npm install -g firebase-tools

# Login to Firebase:
firebase login

# Send test notification:
firebase messaging:send \\
  --token="${fcmToken}" \\
  --message="{
    \\"notification\\": {
      \\"title\\": \\"${title}\\",
      \\"body\\": \\"${body}\\"
    },
    \\"data\\": {
      \\"type\\": \\"test\\"
    }
  }"`;
            
            showCommand('Firebase CLI Command', firebaseCLICommand);
            log('Firebase CLI command generated.', 'success');
        }
        
        function sendViaNodeServer() {
            if (!fcmToken) {
                log('‚ùå No token. Get token first.', 'error');
                return;
            }
            
            const title = document.getElementById('testTitle').value || 'Test Notification';
            const body = document.getElementById('testBody').value || 'This is a test notification';
            
            const nodeServerCode = `// Save as server.js and run: node server.js
const admin = require('firebase-admin');
const express = require('express');
const app = express();

// Initialize Firebase Admin
const serviceAccount = require('./serviceAccountKey.json');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});

app.use(express.json());

app.post('/send-notification', async (req, res) => {
  try {
    const { token, title, body } = req.body;
    
    const message = {
      token: token,
      notification: {
        title: title || 'Test Notification',
        body: body || 'This is a test'
      },
      data: {
        type: 'test',
        timestamp: new Date().toISOString()
      }
    };
    
    const response = await admin.messaging().send(message);
    res.json({ success: true, messageId: response });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});

// Then send request:
// curl -X POST http://localhost:3000/send-notification \\
//   -H "Content-Type: application/json" \\
//   -d '{
//     "token": "${fcmToken}",
//     "title": "${title}",
//     "body": "${body}"
//   }'`;
            
            showCommand('Node.js Server Code', nodeServerCode);
            log('Node.js server code generated.', 'success');
        }
        
        function sendViaCloudFunction() {
            if (!fcmToken) {
                log('‚ùå No token. Get token first.', 'error');
                return;
            }
            
            const title = document.getElementById('testTitle').value || 'Test Notification';
            const body = document.getElementById('testBody').value || 'This is a test notification';
            
            const cloudFunctionCode = `// Firebase Cloud Function
const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();

exports.sendTestNotification = functions.https.onCall(async (data, context) => {
  try {
    const { token, title, body } = data;
    
    const message = {
      token: token,
      notification: {
        title: title || 'Test Notification',
        body: body || 'This is a test'
      },
      data: {
        type: 'test',
        timestamp: new Date().toISOString()
      }
    };
    
    const response = await admin.messaging().send(message);
    return { success: true, messageId: response };
  } catch (error) {
    throw new functions.https.HttpsError('internal', error.message);
  }
});

// Call from frontend:
// const sendNotification = firebase.functions().httpsCallable('sendTestNotification');
// const result = await sendNotification({
//   token: "${fcmToken}",
//   title: "${title}",
//   body: "${body}"
// });`;
            
            showCommand('Firebase Cloud Function', cloudFunctionCode);
            log('Cloud Function code generated.', 'success');
        }
        
        function checkStatus() {
            log('=== STATUS CHECK ===', 'info');
            log(`Firebase loaded: ${typeof firebase !== 'undefined'}`, 'info');
            log(`Firebase apps: ${firebase ? firebase.apps.length : 0}`, 'info');
            log(`Messaging supported: ${firebase && firebase.messaging ? firebase.messaging.isSupported() : false}`, 'info');
            log(`Service Worker: ${'serviceWorker' in navigator}`, 'info');
            log(`Notification Permission: ${Notification.permission}`, 'info');
            log(`Token available: ${!!fcmToken}`, 'info');
            log(`Token in localStorage: ${!!localStorage.getItem('fcmToken')}`, 'info');
            log(`Platform: ${navigator.platform}`, 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            log(`URL: ${window.location.href}`, 'info');
            log('=== END CHECK ===', 'info');
        }
        
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        function resetAll() {
            localStorage.removeItem('fcmToken');
            fcmToken = null;
            document.getElementById('tokenDisplay').textContent = 'No token yet. Click "Get FCM Token" first.';
            document.getElementById('commandOutput').innerHTML = '';
            clearLogs();
            log('All data reset', 'success');
        }
        
        // Auto-initialize on load
        window.onload = function() {
            log('Push Notification Test Page Loaded', 'info');
            fcmToken = localStorage.getItem('fcmToken');
            if (fcmToken) {
                document.getElementById('tokenDisplay').innerHTML = `
                    <strong>Token (${fcmToken.length} chars):</strong><br>
                    <code style="font-size: 12px;">${fcmToken}</code>
                `;
                log('Loaded saved token from localStorage', 'success');
            }
            
            // Auto-initialize Firebase
            setTimeout(() => {
                initFirebase();
            }, 1000);
        };
    </script>
</body>
</html>
