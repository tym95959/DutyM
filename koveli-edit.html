<script>
let allReceipts = [];
let filteredReceipts = [];
let currentEditReceipt = null;

// ========== LOAD RECEIPTS ==========

async function loadReceipts() {
    try {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading receipts...</td></tr>';
        
        if (typeof passengerDb === 'undefined') {
            throw new Error('passengerDb not initialized');
        }
        
        const kovelipayRef = passengerDb.collection('Kovelipay');
        const snapshot = await kovelipayRef.orderBy('submissionDateTime', 'desc').get();
        
        allReceipts = [];
        snapshot.forEach(doc => {
            allReceipts.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        applyFilters();
        updateStats();
        
    } catch (error) {
        console.error('Error loading receipts:', error);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = `<tr><td colspan="9" class="loading" style="color:#c68b5e;">Error: ${error.message}</td></tr>`;
    }
}

// ========== UPDATE STATISTICS ==========

function updateStats() {
    document.getElementById('totalReceipts').textContent = allReceipts.length;
    document.getElementById('totalCash').textContent = allReceipts.filter(r => r.paymentMethod === 'CASH').length;
    document.getElementById('totalCard').textContent = allReceipts.filter(r => r.paymentMethod === 'CARD').length;
    document.getElementById('totalBank').textContent = allReceipts.filter(r => r.paymentMethod === 'BANK TRANSFER').length;
}

// ========== FILTER FUNCTIONS ==========

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const paymentFilter = document.getElementById('paymentFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredReceipts = allReceipts.filter(receipt => {
        const matchesSearch = searchTerm === '' || 
            receipt.receiptNo?.toLowerCase().includes(searchTerm) ||
            receipt.passengerName?.toLowerCase().includes(searchTerm) ||
            receipt.flightNo?.toLowerCase().includes(searchTerm);
        
        const matchesPayment = paymentFilter === 'ALL' || receipt.paymentMethod === paymentFilter;
        const matchesStatus = statusFilter === 'ALL' || receipt.paymentStatus === statusFilter;
        
        return matchesSearch && matchesPayment && matchesStatus;
    });
    
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    
    if (filteredReceipts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="loading">No receipts found</td></tr>';
        return;
    }
    
    let html = '';
    filteredReceipts.forEach(receipt => {
        const statusClass = receipt.paymentStatus === 'PENDING_APPROVAL' ? 'status-pending' : 'status-completed';
        const statusText = receipt.paymentStatus === 'PENDING_APPROVAL' ? 'PENDING' : 'COMPLETED';
        
        html += `
            <tr>
                <td><strong>${receipt.receiptNo || 'N/A'}</strong></td>
                <td>${receipt.submissionDateTime || 'N/A'}</td>
                <td>${receipt.passengerName || 'N/A'}</td>
                <td>${receipt.flightNo || 'N/A'}</td>
                <td>${receipt.seatNo || 'N/A'}</td>
                <td>${receipt.paymentMethod || 'N/A'}</td>
                <td>${receipt.currency || ''} ${receipt.totalAmount?.toFixed(2) || '0.00'}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn edit-btn" onclick="openEditModal('${receipt.receiptNo}')">‚úèÔ∏è EDIT</button>
                    <button class="action-btn view-btn" onclick="printReceipt('${receipt.receiptNo}')">üñ®Ô∏è PRINT</button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// ========== EDIT MODAL FUNCTIONS ==========

function openEditModal(receiptNo) {
    const receipt = allReceipts.find(r => r.receiptNo === receiptNo);
    if (!receipt) return;
    
    currentEditReceipt = receipt;
    
    // Populate modal fields
    document.getElementById('modalReceiptNo').textContent = receiptNo;
    document.getElementById('editReceiptNo').value = receiptNo;
    document.getElementById('editOriginalPaymentMethod').value = receipt.paymentMethod;
    
    // Editable fields
    document.getElementById('editPName').value = receipt.passengerName || '';
    document.getElementById('editFlightNo').value = receipt.flightNo || '';
    document.getElementById('editSeatNo').value = receipt.seatNo || '';
    
    document.getElementById('editAdult').value = receipt.adult || 1;
    document.getElementById('editChildren').value = receipt.children || 0;
    document.getElementById('editCurrency').value = receipt.currency || 'USD';
    document.getElementById('editRateType').value = receipt.rateType || 'B';
    document.getElementById('editPaymentMethod').value = receipt.paymentMethod || 'CASH';
    document.getElementById('editApprovalCode').value = receipt.approvalCode || '';
    document.getElementById('editBatchNo').value = receipt.batchNo || '';
    document.getElementById('editExpiryTime').value = receipt.expiryDateTime || '';
    
    // Calculate prices
    calculateEditPrices();
    
    // Show/hide warning based on payment method
    handleEditPaymentMethodChange();
    
    // Show modal
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditReceipt = null;
}

function handleEditPaymentMethodChange() {
    const paymentMethod = document.getElementById('editPaymentMethod').value;
    const originalMethod = document.getElementById('editOriginalPaymentMethod').value;
    const warning = document.getElementById('editPaymentWarning');
    
    // Show warning if payment method changed
    if (paymentMethod !== originalMethod) {
        warning.style.display = 'block';
    } else {
        warning.style.display = 'none';
    }
    
    // Enable/disable approval fields based on payment method
    const approvalCode = document.getElementById('editApprovalCode');
    const batchNo = document.getElementById('editBatchNo');
    
    if (paymentMethod === 'CASH') {
        approvalCode.disabled = true;
        batchNo.disabled = true;
        approvalCode.value = '';
        batchNo.value = '';
        approvalCode.placeholder = 'Not required for cash';
        batchNo.placeholder = 'Not required for cash';
    } else {
        approvalCode.disabled = false;
        batchNo.disabled = false;
        approvalCode.placeholder = 'Enter approval code';
        batchNo.placeholder = 'Enter batch no';
    }
}

// ========== CALCULATION FUNCTIONS ==========

function calculateEditPrices() {
    console.log('Calculating prices...'); // Debug log
    
    // Get form values
    const adult = parseInt(document.getElementById('editAdult').value) || 0;
    const children = parseInt(document.getElementById('editChildren').value) || 0;
    const currency = document.getElementById('editCurrency').value;
    const rateType = document.getElementById('editRateType').value;
    
    console.log('Values:', { adult, children, currency, rateType }); // Debug log
    
    // Define default rates in case rates.js is not loaded
    const defaultRates = {
        // Rate A - USD
        AdultAUSD: { price: 45.00, GST: 8 },
        KidsAUSD: { price: 25.00, GST: 8 },
        // Rate A - MVR
        AdultAMVR: { price: 675.00, GST: 8 },
        KidsAMVR: { price: 375.00, GST: 8 },
        // Rate B - USD
        AdultBUSD: { price: 55.00, GST: 8 },
        KidsBUSD: { price: 30.00, GST: 8 },
        // Rate B - MVR
        AdultBMVR: { price: 825.00, GST: 8 },
        KidsBMVR: { price: 450.00, GST: 8 }
    };
    
    // Use rates from rate.js if available, otherwise use defaultRates
    const rateSource = typeof rates !== 'undefined' ? rates : defaultRates;
    
    // Construct rate keys
    const adultRateKey = `Adult${rateType}${currency}`;
    const childrenRateKey = `Kids${rateType}${currency}`;
    
    console.log('Rate keys:', { adultRateKey, childrenRateKey }); // Debug log
    console.log('Rate source:', rateSource); // Debug log
    
    // Get rates with fallback
    const adultRate = rateSource[adultRateKey] || { price: 0, GST: 8 };
    const childrenRate = rateSource[childrenRateKey] || { price: 0, GST: 8 };
    
    console.log('Rates found:', { adultRate, childrenRate }); // Debug log
    
    // Calculate subtotals
    const adultSubtotal = adult * (adultRate.price || 0);
    const childrenSubtotal = children * (childrenRate.price || 0);
    const subtotal = adultSubtotal + childrenSubtotal;
    
    // Calculate GST (use adult rate GST or default 8%)
    const gstRate = adultRate.GST || 8;
    const gstAmount = subtotal * (gstRate / 100);
    const totalAmount = subtotal + gstAmount;
    
    console.log('Calculated:', { adultSubtotal, childrenSubtotal, subtotal, gstAmount, totalAmount }); // Debug log
    
    // Update display with proper formatting
    document.getElementById('editAdultPrice').textContent = (adultRate.price || 0).toFixed(2);
    document.getElementById('editChildrenPrice').textContent = (childrenRate.price || 0).toFixed(2);
    document.getElementById('editAdultCurrency').textContent = currency;
    document.getElementById('editChildrenCurrency').textContent = currency;
    
    document.getElementById('editAdultSubtotal').textContent = adultSubtotal.toFixed(2);
    document.getElementById('editChildrenSubtotal').textContent = childrenSubtotal.toFixed(2);
    document.getElementById('editAdultSubtotalCurrency').textContent = currency;
    document.getElementById('editChildrenSubtotalCurrency').textContent = currency;
    
    document.getElementById('editSubtotal').textContent = subtotal.toFixed(2);
    document.getElementById('editGst').textContent = gstAmount.toFixed(2);
    document.getElementById('editTotal').textContent = totalAmount.toFixed(2);
    
    document.getElementById('editSubtotalCurrency').textContent = currency;
    document.getElementById('editGstCurrency').textContent = currency;
    document.getElementById('editTotalCurrency').textContent = currency;
}

// ========== SAVE EDIT ==========

async function saveEdit() {
    // Validate required fields
    const passengerName = document.getElementById('editPName').value.trim();
    const flightNo = document.getElementById('editFlightNo').value.trim();
    const seatNo = document.getElementById('editSeatNo').value.trim();
    
    if (!passengerName || !flightNo || !seatNo) {
        alert('Please fill in Passenger Name, Flight Number, and Seat Number');
        return;
    }
    
    const receiptNo = document.getElementById('editReceiptNo').value;
    const paymentMethod = document.getElementById('editPaymentMethod').value;
    const isCash = paymentMethod === 'CASH';
    
    // Validate approval fields for non-cash
    if (!isCash) {
        const approvalCode = document.getElementById('editApprovalCode').value.trim();
        const batchNo = document.getElementById('editBatchNo').value.trim();
        
        if (!approvalCode || !batchNo) {
            alert('Please enter both Approval Code and Batch No for non-cash payments');
            return;
        }
    }
    
    if (!confirm(`Update receipt ${receiptNo} with new values?`)) {
        return;
    }
    
    try {
        const saveBtn = document.querySelector('.save-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'SAVING...';
        
        // Get current values for calculation
        const adult = parseInt(document.getElementById('editAdult').value) || 0;
        const children = parseInt(document.getElementById('editChildren').value) || 0;
        const currency = document.getElementById('editCurrency').value;
        const rateType = document.getElementById('editRateType').value;
        
        // Define default rates
        const defaultRates = {
            AdultAUSD: { price: 45.00, GST: 8 },
            KidsAUSD: { price: 25.00, GST: 8 },
            AdultAMVR: { price: 675.00, GST: 8 },
            KidsAMVR: { price: 375.00, GST: 8 },
            AdultBUSD: { price: 55.00, GST: 8 },
            KidsBUSD: { price: 30.00, GST: 8 },
            AdultBMVR: { price: 825.00, GST: 8 },
            KidsBMVR: { price: 450.00, GST: 8 }
        };
        
        const rateSource = typeof rates !== 'undefined' ? rates : defaultRates;
        
        const adultRateKey = `Adult${rateType}${currency}`;
        const childrenRateKey = `Kids${rateType}${currency}`;
        
        const adultRate = rateSource[adultRateKey] || { price: 0, GST: 8 };
        const childrenRate = rateSource[childrenRateKey] || { price: 0, GST: 8 };
        
        const adultSubtotal = adult * adultRate.price;
        const childrenSubtotal = children * childrenRate.price;
        const subtotal = adultSubtotal + childrenSubtotal;
        const gstAmount = subtotal * (adultRate.GST / 100);
        const totalAmount = subtotal + gstAmount;
        
        // Determine payment status
        let paymentStatus = 'COMPLETED';
        if (!isCash) {
            const approvalCode = document.getElementById('editApprovalCode').value.trim();
            const batchNo = document.getElementById('editBatchNo').value.trim();
            paymentStatus = (approvalCode && batchNo) ? 'COMPLETED' : 'PENDING_APPROVAL';
        }
        
        const updateData = {
            passengerName: passengerName,
            flightNo: flightNo,
            seatNo: seatNo,
            
            adult: adult,
            children: children,
            currency: currency,
            rateType: rateType,
            paymentMethod: paymentMethod,
            adultPrice: adultRate.price,
            childrenPrice: childrenRate.price,
            adultSubtotal: adultSubtotal,
            childrenSubtotal: childrenSubtotal,
            subtotal: subtotal,
            gstAmount: gstAmount,
            gstRate: adultRate.GST,
            totalAmount: totalAmount,
            approvalCode: document.getElementById('editApprovalCode').value.trim() || '',
            batchNo: document.getElementById('editBatchNo').value.trim() || '',
            paymentStatus: paymentStatus,
            editedAt: new Date().toISOString(),
            editedBy: 'user'
        };
        
        console.log('Saving data:', updateData); // Debug log
        
        const kovelipayRef = passengerDb.collection('Kovelipay').doc(receiptNo);
        await kovelipayRef.update(updateData);
        
        alert(`Receipt ${receiptNo} updated successfully!`);
        
        // Reload data
        await loadReceipts();
        closeEditModal();
        
    } catch (error) {
        console.error('Error saving edit:', error);
        alert('Error saving: ' + error.message);
    } finally {
        const saveBtn = document.querySelector('.save-btn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ SAVE CHANGES';
    }
}

// ========== PRINT FUNCTIONS ==========

function printReceipt(receiptNo) {
    const receipt = allReceipts.find(r => r.receiptNo === receiptNo);
    if (!receipt) return;
    
    printReceiptContent(receipt);
}

function printEditedReceipt() {
    if (!currentEditReceipt) return;
    
    // Get current form values
    const adult = parseInt(document.getElementById('editAdult').value) || 0;
    const children = parseInt(document.getElementById('editChildren').value) || 0;
    const currency = document.getElementById('editCurrency').value;
    const rateType = document.getElementById('editRateType').value;
    
    // Calculate current values
    const defaultRates = {
        AdultAUSD: { price: 45.00, GST: 8 },
        KidsAUSD: { price: 25.00, GST: 8 },
        AdultAMVR: { price: 675.00, GST: 8 },
        KidsAMVR: { price: 375.00, GST: 8 },
        AdultBUSD: { price: 55.00, GST: 8 },
        KidsBUSD: { price: 30.00, GST: 8 },
        AdultBMVR: { price: 825.00, GST: 8 },
        KidsBMVR: { price: 450.00, GST: 8 }
    };
    
    const rateSource = typeof rates !== 'undefined' ? rates : defaultRates;
    
    const adultRateKey = `Adult${rateType}${currency}`;
    const childrenRateKey = `Kids${rateType}${currency}`;
    
    const adultRate = rateSource[adultRateKey] || { price: 0, GST: 8 };
    const childrenRate = rateSource[childrenRateKey] || { price: 0, GST: 8 };
    
    const adultSubtotal = adult * adultRate.price;
    const childrenSubtotal = children * childrenRate.price;
    const subtotal = adultSubtotal + childrenSubtotal;
    const gstAmount = subtotal * (adultRate.GST / 100);
    const totalAmount = subtotal + gstAmount;
    
    // Create updated receipt object with current form values
    const updatedReceipt = {
        ...currentEditReceipt,
        passengerName: document.getElementById('editPName').value,
        flightNo: document.getElementById('editFlightNo').value,
        seatNo: document.getElementById('editSeatNo').value,
        
        adult: adult,
        children: children,
        currency: currency,
        rateType: rateType,
        paymentMethod: document.getElementById('editPaymentMethod').value,
        adultPrice: adultRate.price,
        childrenPrice: childrenRate.price,
        adultSubtotal: adultSubtotal,
        childrenSubtotal: childrenSubtotal,
        subtotal: subtotal,
        gstAmount: gstAmount,
        gstRate: adultRate.GST,
        totalAmount: totalAmount,
        approvalCode: document.getElementById('editApprovalCode').value,
        batchNo: document.getElementById('editBatchNo').value,
        expiryDateTime: document.getElementById('editExpiryTime').value,
        editedAt: new Date().toISOString()
    };
    
    printReceiptContent(updatedReceipt);
}

function printReceiptContent(receipt) {
    // Get company header
    let companyHeader = '';
    if (typeof companyInfo !== 'undefined') {
        companyHeader = `
            <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <h1 style="margin: 0; font-size: 18px; font-weight: bold;">${companyInfo.name || 'Koveli Lounge'}</h1>
                <p style="margin: 3px 0; font-size: 11px;">${companyInfo.address || 'Velana International Airport'}</p>
                <p style="margin: 3px 0; font-size: 11px;">Tel: ${companyInfo.phone || '+960 304 6677'}</p>
                <p style="margin: 5px 0 0 0; font-size: 10px;">GST Registered</p>
            </div>
        `;
    }
    
    // Check if edited
    const editedNote = receipt.editedAt ? 
        `<p style="font-size: 9px; color: #c68b5e;">*Edited: ${new Date(receipt.editedAt).toLocaleString()}</p>` : '';
    
    const receiptHTML = `
        <div style="width: 80mm; font-family: 'Courier New', monospace; font-size: 11px; padding: 10px;">
            ${companyHeader}
            
            <div style="margin-bottom: 10px;">
                <p><strong>Receipt #:</strong> ${receipt.receiptNo}</p>
                <p><strong>Date/Time:</strong> ${receipt.submissionDateTime}</p>
                <p><strong>Shift:</strong> ${receipt.shift} - ${receipt.date}</p>
                ${editedNote}
            </div>
            
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 8px 0;">
                <p><strong>Passenger:</strong> ${receipt.passengerName}</p>
                <p><strong>Flight:</strong> ${receipt.flightNo} | Seat: ${receipt.seatNo}</p>
            </div>
            
            <div style="margin: 10px 0;">
                <table style="width: 100%; font-size: 10px;">
                    <tr>
                        <td>Adult x${receipt.adult}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.adultPrice?.toFixed(2)}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.adultSubtotal?.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Children x${receipt.children}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.childrenPrice?.toFixed(2)}</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.childrenSubtotal?.toFixed(2)}</td>
                    </tr>
                </table>
            </div>
            
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 8px 0;">
                <table style="width: 100%;">
                    <tr>
                        <td><strong>Subtotal:</strong></td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.subtotal?.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>GST (${receipt.gstRate}%):</td>
                        <td style="text-align: right;">${receipt.currency} ${receipt.gstAmount?.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td><strong>TOTAL:</strong></td>
                        <td style="text-align: right;"><strong>${receipt.currency} ${receipt.totalAmount?.toFixed(2)}</strong></td>
                    </tr>
                </table>
            </div>
            
            <div style="margin: 10px 0;">
                <p><strong>Payment:</strong> ${receipt.paymentMethod}</p>
                ${receipt.approvalCode ? `<p><strong>Approval:</strong> ${receipt.approvalCode}</p>` : ''}
                ${receipt.batchNo ? `<p><strong>Batch:</strong> ${receipt.batchNo}</p>` : ''}
                <p><strong>Valid Until:</strong> ${receipt.expiryDateTime}</p>
            </div>
            
            <div style="border-top: 1px dashed #000; padding-top: 10px; text-align: center;">
                <p>Thank you for choosing Koveli Lounge!</p>
                <p>${new Date().toLocaleDateString()}</p>
            </div>
        </div>
    `;
    
    // Open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Receipt ${receipt.receiptNo}</title>
                <style>
                    @media print {
                        body { margin: 0; padding: 10px; }
                    }
                </style>
            </head>
            <body>${receiptHTML}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// ========== INITIALIZATION ==========

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...'); // Debug log
    console.log('Rates available:', typeof rates !== 'undefined' ? rates : 'Not loaded'); // Debug log
    
    loadReceipts();
    
    // Event listeners for real-time calculation
    document.getElementById('editAdult').addEventListener('input', calculateEditPrices);
    document.getElementById('editChildren').addEventListener('input', calculateEditPrices);
    document.getElementById('editCurrency').addEventListener('change', calculateEditPrices);
    document.getElementById('editRateType').addEventListener('change', calculateEditPrices);
    
    // Search and filter events
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('paymentFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('refreshBtn').addEventListener('click', loadReceipts);
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    };
    
    // Refresh every 30 seconds
    setInterval(loadReceipts, 30000);
});
</script>
