<!DOCTYPE html>
<html>
<head>
  <title>User App</title>
  <link rel="manifest" href="/manifest.json">
</head>
<body>
  <h2>User App</h2>
  <div id="log"></div>

  <script type="module">
    import { messaging, db } from "./dcfire.js";
    import { getToken, onMessage } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";
    import { setDoc, doc, onSnapshot, collection } from
      "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Register service worker
    await navigator.serviceWorker.register("/firebase-messaging-sw.js");

    // --- AUTO INSTALL PROMPT ---
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); // Prevent default prompt
      console.log("PWA install available, triggering automatically...");
      e.prompt(); // Show prompt immediately

      e.userChoice.then(choice => {
        console.log('Install choice:', choice.outcome);
      });
    });

    // --- FCM: ask notification permission + save token ---
    const permission = await Notification.requestPermission();
    if (permission === "granted") {
      const token = await getToken(messaging, {
        vapidKey: "BCMEhQHZvwuii0Pul11PRfM68N_C4iox9c6jUwWoj21lvKZ2hhAfRe-5KwG_A1xMsQ04aelb8XM7x-mXNYzak1o"
      });

      console.log("FCM Token:", token);

      await setDoc(doc(db, "tokens", token), {
        token,
        updatedAt: new Date()
      });
    }

    // --- FOREGROUND NOTIFICATIONS ---
    onMessage(messaging, payload => {
      alert(payload.notification.title + "\n" + payload.notification.body);
    });

    // --- LIVE MESSAGES ---
    onSnapshot(collection(db, "messages"), snap => {
      snap.docChanges().forEach(c => {
        if (c.type === "added") {
          log.innerHTML += "<p>" + c.doc.data().text + "</p>";
        }
      });
    });
  </script>
</body>
</html>
