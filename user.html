<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAW App - Messages</title>
    <link rel="manifest" href="manifest.json">
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <style>
        /* Same CSS as before, but simplified for brevity */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: #f5f5f7; min-height: 100vh; }
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; text-align: center;
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
        }
        .notification-badge {
            position: absolute; top: 15px; right: 20px;
            background: #ff4757; color: white; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold;
        }
        .messages-container { margin-top: 120px; padding: 20px; }
        .message-card {
            background: white; border-radius: 15px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        .message-card.unread { border-left-color: #ff4757; background: #fff5f5; }
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .permission-box {
            background: white; border-radius: 15px; padding: 25px;
            margin: 20px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .enable-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 14px 30px;
            border-radius: 25px; font-size: 16px; font-weight: 600;
            cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>üêæ PAW Messages</h1>
        <p>Stay updated with real-time notifications</p>
        <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
    </div>
    
    <div id="permissionBox" class="permission-box" style="display: none;">
        <h3>üîî Enable Push Notifications</h3>
        <p>Get instant alerts for new messages</p>
        <button class="enable-btn" onclick="requestNotificationPermission()">Enable Notifications</button>
    </div>
    
    <div class="messages-container" id="messagesContainer">
        <div class="empty-state" id="emptyState">
            <div>üì≠</div>
            <h3>No messages yet</h3>
            <p>Messages will appear here when received</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
            authDomain: "leelidc-1f753.firebaseapp.com",
            projectId: "leelidc-1f753",
            storageBucket: "leelidc-1f753.firebasestorage.app",
            messagingSenderId: "43622932335",
            appId: "1:43622932335:web:a7529bce1f19714687129a",
            measurementId: "G-3KD6ZYS599"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const messagesCollection = db.collection('messages');
        
        let messages = [];
        let unreadCount = 0;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkNotificationPermission();
            loadMessages();
        });

        async function checkNotificationPermission() {
            if (!('Notification' in window)) return;
            
            if (Notification.permission === 'granted') {
                initializeFirebaseMessaging();
            } else if (Notification.permission !== 'denied') {
                document.getElementById('permissionBox').style.display = 'block';
            }
        }

        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('permissionBox').style.display = 'none';
                    initializeFirebaseMessaging();
                    alert('Notifications enabled!');
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
            }
        }

        async function initializeFirebaseMessaging() {
            try {
                const messaging = firebase.messaging();
                
                // Get FCM token
                const token = await messaging.getToken();
                if (token) {
                    console.log('FCM Token:', token);
                    localStorage.setItem('fcmToken', token);
                }

                // Handle foreground messages
                messaging.onMessage((payload) => {
                    console.log('Message received:', payload);
                    showLocalNotification(payload);
                    loadMessages(); // Refresh messages
                });
                
            } catch (error) {
                console.error('Error initializing messaging:', error);
            }
        }

        function showLocalNotification(payload) {
            if (Notification.permission === 'granted') {
                const title = payload.notification?.title || 'New Message';
                const options = {
                    body: payload.notification?.body || 'You have a new message',
                    icon: 'https://cdn-icons-png.flaticon.com/512/3014/3014486.png'
                };
                new Notification(title, options);
            }
            
            // Update unread count
            unreadCount++;
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            }
        }

        function loadMessages() {
            messagesCollection
                .orderBy('timestamp', 'desc')
                .onSnapshot((snapshot) => {
                    messages = [];
                    snapshot.forEach(doc => {
                        messages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    renderMessages();
                }, (error) => {
                    console.error('Error loading messages:', error);
                });
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (messages.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let messagesHTML = '';
            messages.forEach(msg => {
                const time = msg.timestamp ? 
                    new Date(msg.timestamp.toDate()).toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }) : 'Just now';
                    
                messagesHTML += `
                    <div class="message-card" onclick="markAsRead('${msg.id}')">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${msg.title || 'Notification'}</strong>
                            <small style="color: #888;">${time}</small>
                        </div>
                        <p style="margin-top: 10px;">${msg.body || msg.message || ''}</p>
                        ${msg.priority ? `<span style="color: #666; font-size: 12px;">Priority: ${msg.priority}</span>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = messagesHTML;
        }

        function markAsRead(messageId) {
            // Mark as read in Firebase (optional)
            // messagesCollection.doc(messageId).update({ read: true });
            
            // Update locally
            const messageIndex = messages.findIndex(m => m.id === messageId);
            if (messageIndex > -1) {
                messages[messageIndex].read = true;
                unreadCount = Math.max(0, unreadCount - 1);
                updateNotificationBadge();
            }
        }

        // Make functions available globally
        window.requestNotificationPermission = requestNotificationPermission;
        window.markAsRead = markAsRead;
    </script>
</body>
</html>
