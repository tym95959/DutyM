<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Report ‚Äì Passenger List (Multi-Database)</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your config files -->
    <script src="fireshift.js"></script>
    <script src="Co.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f0e1, #fff5e6);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ===== smaller top ribbon ===== */
        .shift-ribbon {
            background: linear-gradient(135deg, #8b6913, #e6b800);
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(230, 184, 0, 0.25);
            font-size: 0.9rem;
        }
        
        .shift-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .shift-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 14px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .date-value {
            font-weight: 500;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .refresh-shift {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 14px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        /* ===== main card ‚Äì more compact ===== */
        .card {
            background: white;
            border-radius: 20px;
            padding: 18px 22px;
            box-shadow: 0 8px 24px rgba(230, 184, 0, 0.15);
            border: 2px solid #e6b800;
            margin-bottom: 18px;
        }
        
        /* --- REARRANGED: date/flight on left, ops on right --- */
        .selection-flight-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        /* left block: date + flight selects */
        .left-selectors {
            display: flex;
            gap: 16px;
            flex: 2;
            min-width: 360px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }
        
        .form-group label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .form-control {
            padding: 8px 12px;
            border: 2px solid rgba(230, 184, 0, 0.25);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        /* right block: minimal quick info (optional) */
        .quick-shift-box {
            background: #fff9e6;
            border-radius: 30px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: #8b6913;
            border: 1px solid #e6b800;
            white-space: nowrap;
        }
        
        /* Database indicator */
        .database-badge {
            background: #4682b4;
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* flight panel ‚Äî two columns now: left (details + stats) and right (ops + buttons) */
        .flight-panel-revised {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-top: 8px;
        }
        
        .left-details-block {
            background: #fff9e6;
            border-radius: 14px;
            padding: 14px 16px;
            border-left: 4px solid #e6b800;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .info-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 13px;
        }
        
        /* stats inside left block */
        .stats-mini {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            background: white;
            border-radius: 12px;
            padding: 10px 8px;
            border: 1px solid rgba(230,184,0,0.2);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            color: #8b6913;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .stat-number {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* right block: ops + buttons (under last pax) */
        .right-ops-block {
            background: white;
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(230, 184, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        
        .ops-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 16px;
            align-items: center;
            font-size: 13px;
        }
        
        .ops-label {
            color: #8b6913;
            font-weight: 600;
            font-size: 12px;
        }
        
        .ops-value {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .edit-field {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .edit-input {
            padding: 4px 8px;
            border: 2px solid rgba(230, 184, 0, 0.3);
            border-radius: 6px;
            font-size: 12px;
            width: 100px;
        }
        
        .edit-btn {
            background: #e6b800;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* action buttons ‚Äì now only CLOSE / REOPEN / PRINT (SAVE ALL removed) */
        .action-buttons-vertical {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
            border-top: 1px dashed rgba(230,184,0,0.3);
            padding-top: 12px;
        }
        
        .close-btn, .reopen-btn, .print-btn {
            padding: 8px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            flex: 1 0 auto;
            min-width: 110px;
            white-space: nowrap;
        }
        
        .close-btn { background: #c68b5e; color: white; }
        .close-btn:disabled { background: #e0c0a8; cursor: not-allowed; opacity: 0.6; }
        .reopen-btn { background: #6b8e23; color: white; }
        .print-btn { background: #4a6fa5; color: white; }
        .print-btn:disabled { background: #a0b8d0; cursor: not-allowed; }
        
        /* passenger table unchanged */
        .table-container {
            background: white;
            border-radius: 16px;
            border: 2px solid #e6b800;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #faf3e0, #fff5e6);
            padding: 12px 18px;
            border-bottom: 2px solid #e6b800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #8b6913;
            font-size: 16px;
            font-weight: 600;
        }
        
        .passenger-count {
            background: #6b8e23;
            color: white;
            padding: 4px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 480px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background: #e6b800;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(230, 184, 0, 0.2);
            color: #2c3e50;
            font-size: 12px;
        }
        
        tr:hover td {
            background: rgba(230, 184, 0, 0.04);
        }
        
        .serial-no {
            font-weight: 600;
            color: #8b6913;
            font-family: monospace;
        }
        
        .action-cell {
            white-space: nowrap;
        }
        
        .table-action-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 2px;
        }
        
        .edit-table-btn { background: #e6b800; color: white; }
        .delete-table-btn { background: #c68b5e; color: white; }
        .save-table-btn { background: #6b8e23; color: white; }
        .cancel-table-btn { background: #7f8c8d; color: white; }
        
        .edit-mode-input {
            width: 100%;
            padding: 4px 6px;
            border: 2px solid #e6b800;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .time-edit-input {
            width: 90px;
            padding: 4px 6px;
            border: 2px solid #e6b800;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .pax-warning {
            font-size: 10px;
            color: #c68b5e;
            margin-top: 2px;
        }
        
        .flight-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
        .status-open { background: #6b8e23; color: white; }
        .status-closed { background: #c68b5e; color: white; }
        
        .no-data, .loading { text-align: center; padding: 30px; color: #8b6913; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(230,184,0,0.3); border-radius: 50%; border-top-color: #e6b800; animation: spin 1s infinite; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* print-specific styles - header only on first page */
        @media print {
            body { background: white; padding: 0; margin: 0.5in; }
            .shift-ribbon, .card .selection-flight-row, .action-buttons-vertical, .edit-btn, .table-action-btn, .refresh-shift, .quick-shift-box, .database-badge { display: none; }
            .card { border: none; box-shadow: none; padding: 0; background: transparent; }
            .flight-panel-revised { display: block; }
            .left-details-block, .right-ops-block { background: transparent; border: none; padding: 0; }
            .stats-mini { border: 1px solid #ccc; }
            .table-container { border: 1px solid #000; margin-top: 20px; }
            th { background: #e6b800 !important; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .flight-status { border: 1px solid #000; background: #eee; }
            
            /* Header only on first page */
            .report-header-print {
                display: block !important;
            }
            
            /* Page break handling */
            tr, td, th {
                page-break-inside: avoid;
            }
            
            thead {
                display: table-header-group;
            }
            
            tfoot {
                display: table-footer-group;
            }
        }
        
        /* Print header - hidden normally, shown only in print */
        .report-header-print {
            display: none;
        }
        
        @media print {
            .report-header-print {
                display: block;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- smaller ribbon -->
        <div class="shift-ribbon" id="shiftRibbon">
            <div class="shift-info">
                <span class="shift-badge" id="shiftBadge">LOADING...</span>
                <span class="date-value" id="ribbonDate">--</span>
            </div>
            <button class="refresh-shift" onclick="fetchOpenShift()">‚Üª REFRESH</button>
        </div>

        <!-- main card ‚Äì compact & rearranged -->
        <div class="card">
            <!-- Row: Date and Flight No on left side, extra right box for visual balance (optional) -->
            <div class="selection-flight-row">
                <div class="left-selectors">
                    <div class="form-group">
                        <label>üìÖ DATE</label>
                        <select id="dateSelect" class="form-control" onclick="loadDates()" onchange="onDateSelected()">
                            <option value="">-- Click to load dates --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‚úà FLIGHT NO</label>
                        <select id="flightSelect" class="form-control" onchange="onFlightSelected()" disabled>
                            <option value="">-- Select date first --</option>
                        </select>
                    </div>
                </div>
                <div class="quick-shift-box" id="quickShiftDisplay">
                    <span id="quickShiftText">Select flight</span>
                    <span id="databaseBadge" class="database-badge" style="display: none;"></span>
                </div>
            </div>
            
            <!-- flight panel ‚Äì now two columns: left details+stats, right ops+buttons under last pax -->
            <div id="flightPanel" style="display: none;">
                <div class="flight-panel-revised">
                    <!-- LEFT SIDE: airline, flight, date, status + stats -->
                    <div class="left-details-block">
                        <div class="info-grid">
                            <span class="info-label">Airline:</span><span class="info-value" id="airlineDisplay">-</span>
                            <span class="info-label">Flight No:</span><span class="info-value" id="flightNoDisplay">-</span>
                            <span class="info-label">Date:</span><span class="info-value" id="dateDisplay">-</span>
                            <span class="info-label">Database:</span><span class="info-value" id="databaseDisplay">-</span>
                            <span class="info-label">Status:</span>
                            <span class="info-value"><span id="flightStatus" class="flight-status status-open">OPEN</span></span>
                        </div>
                        <!-- stats moved inside left block (right below basic info) -->
                        <div class="stats-mini">
                            <div class="stat-item"><div class="stat-label">Total Pax</div><div class="stat-number" id="totalPaxStat">0</div></div>
                            <div class="stat-item"><div class="stat-label">First Pax</div><div class="stat-number" id="firstPaxStat">--:--</div></div>
                            <div class="stat-item"><div class="stat-label">Last Pax</div><div class="stat-number" id="lastPaxStat">--:--</div></div>
                        </div>
                    </div>

                    <!-- RIGHT SIDE: Shift, STD, Last Pax (with edit) + buttons under last pax -->
                    <div class="right-ops-block">
                        <div class="ops-grid">
                            <span class="ops-label">Shift:</span><span class="ops-value" id="shiftDisplay">-</span>
                            <span class="ops-label">STD:</span>
                            <div class="edit-field">
                                <input type="time" id="stdInput" class="edit-input" onchange="updateSTD()">
                                <button class="edit-btn" onclick="updateSTD()">Update</button>
                            </div>
                            <span class="ops-label">First Pax:</span><span class="ops-value first-pax" id="firstPaxDisplay">-</span>
                            <span class="ops-label">Last Pax:</span>
                            <div class="edit-field">
                                <input type="time" id="lastPaxInput" class="edit-input" onchange="updateLastPax()">
                                <button class="edit-btn" onclick="updateLastPax()">Update</button>
                            </div>
                        </div>
                        
                        <!-- BUTTONS: only CLOSE / REOPEN / PRINT -->
                        <div class="action-buttons-vertical">
                            <button id="closeFlightBtn" class="close-btn" onclick="closeFlight()" disabled>üîí CLOSE</button>
                            <button id="reopenFlightBtn" class="reopen-btn" onclick="reopenFlight()" style="display: none;">üîì REOPEN</button>
                            <button id="printReportBtn" class="print-btn" onclick="printReport()" disabled>üñ®Ô∏è PRINT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- passenger table ‚Äì unchanged -->
        <div id="tableContainer" class="table-container" style="display: none;">
            <div class="table-header">
                <h3>‚úà PASSENGER LIST</h3>
                <span class="passenger-count" id="passengerCount">0</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>No.</th><th>Name</th><th>Seat</th><th>Pax</th><th>FQTV</th><th>Serial No</th><th>Time</th><th>Remarks</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="passengerTableBody">
                        <tr><td colspan="9" class="no-data">Select a flight to view passengers</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<script>
// ========== REPORT.JS - FIXED VERSION ==========

// Global variables
let allPassengers = [];
let filteredPassengers = [];
let currentUser = {
    name: '',
    rcno: '',
    level: '',
    username: ''
};
let currentShiftData = {
    date: '',
    shift: '',
    status: '',
    openTime: ''
};
let selectedDb = 'all'; // 'all', 'ba', 'ek', 'qr', 'sq', 'default'
let isLoading = false;

// ========== CHECK LOGIN AND INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    const isLoggedIn = checkLoginStatus();
    if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
    }
    
    loadUserData();
    
    // Set up event listeners
    document.getElementById('searchBtn').addEventListener('click', function() {
        searchPassengers();
    });
    
    document.getElementById('clearBtn').addEventListener('click', function() {
        clearSearch();
    });
    
    document.getElementById('exportBtn').addEventListener('click', function() {
        exportToCSV();
    });
    
    document.getElementById('printBtn').addEventListener('click', function() {
        printReport();
    });
    
    document.getElementById('databaseSelect').addEventListener('change', function(e) {
        selectedDb = e.target.value;
        if (selectedDb === 'all') {
            document.getElementById('dateSelect').style.display = 'inline-block';
            document.getElementById('flightInput').style.display = 'inline-block';
        } else {
            document.getElementById('dateSelect').style.display = 'inline-block';
            document.getElementById('flightInput').style.display = 'inline-block';
        }
    });
    
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadDates();
    });
    
    // Load available dates
    loadDates();
});

// ========== LOGIN CHECK FUNCTION ==========
function checkLoginStatus() {
    try {
        const username = localStorage.getItem('username');
        const level = localStorage.getItem('level');
        const rcno = localStorage.getItem('rcno');
        const loggedInUser = localStorage.getItem('loggedInUser');
        
        if (username && (level || rcno)) {
            return true;
        }
        
        if (loggedInUser) {
            try {
                const userData = JSON.parse(loggedInUser);
                if (userData && userData.username) {
                    return true;
                }
            } catch (e) {
                console.error('Error parsing loggedInUser:', e);
            }
        }
        
        return false;
    } catch (error) {
        console.error('Error checking login status:', error);
        return false;
    }
}

// ========== USER DATA FUNCTIONS ==========
function loadUserData() {
    try {
        console.log('Loading user data from localStorage...');
        
        const storedUsername = localStorage.getItem('username');
        const storedLevel = localStorage.getItem('level');
        const storedRcno = localStorage.getItem('rcno');
        const loggedInUser = localStorage.getItem('loggedInUser');
        
        if (loggedInUser) {
            try {
                const parsedUser = JSON.parse(loggedInUser);
                currentUser.username = parsedUser.username || storedUsername || '';
                currentUser.name = parsedUser.name || parsedUser.username || storedUsername || '';
                currentUser.rcno = parsedUser.rcno || storedRcno || '';
                currentUser.level = parsedUser.level || storedLevel || '';
            } catch (e) {
                console.error('Error parsing loggedInUser:', e);
            }
        }
        
        if (storedUsername) currentUser.username = storedUsername;
        if (!currentUser.name && storedUsername) currentUser.name = storedUsername;
        if (storedRcno) currentUser.rcno = storedRcno;
        if (storedLevel) currentUser.level = storedLevel;
        
        if (!currentUser.username) {
            console.warn('No user data found in localStorage');
            currentUser.username = 'UNKNOWN';
            currentUser.name = 'UNKNOWN';
            currentUser.rcno = 'N/A';
            currentUser.level = 'OPERATOR';
        }
        
        if (!currentUser.name) {
            currentUser.name = currentUser.username;
        }
        
        console.log('Final currentUser object:', currentUser);
        updateUserDisplay();
        
    } catch (error) {
        console.error('Error loading user data:', error);
        currentUser = {
            username: 'UNKNOWN',
            name: 'UNKNOWN',
            rcno: 'N/A',
            level: 'OPERATOR'
        };
        updateUserDisplay();
    }
}

function updateUserDisplay() {
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userRcnoDisplay = document.getElementById('userRcnoDisplay');
    const userLevelDisplay = document.getElementById('userLevelDisplay');
    
    if (userNameDisplay) userNameDisplay.textContent = currentUser.name || currentUser.username || 'N/A';
    if (userRcnoDisplay) userRcnoDisplay.textContent = currentUser.rcno || 'N/A';
    if (userLevelDisplay) userLevelDisplay.textContent = currentUser.level || 'N/A';
}

function logout() {
    localStorage.removeItem('username');
    localStorage.removeItem('level');
    localStorage.removeItem('rcno');
    localStorage.removeItem('loggedInUser');
    
    window.location.href = 'login.html';
}

// ========== MULTI-DATABASE FUNCTIONS ==========

/**
 * Returns the appropriate Firestore database based on flight number
 * @param {string} flightNo - The flight number (e.g., "BA123", "EK456")
 * @returns {Object} - The Firestore database instance and info
 */
function getFirestoreForFlight(flightNo) {
    if (!flightNo || typeof flightNo !== 'string') {
        console.log("No valid flight number provided, using default database");
        return {
            db: window.defaultCardDb || window.db,
            name: "Default Database (cardentry-7bad1)"
        };
    }

    const flightPrefix = flightNo.substring(0, 2).toUpperCase();
    
    switch(flightPrefix) {
        case 'BA':
            console.log(`‚úàÔ∏è BA flight detected (${flightNo}) - using BA database`);
            return {
                db: window.baDb,
                name: "BA Database (cardentryba)"
            };
            
        case 'EK':
            console.log(`‚úàÔ∏è EK flight detected (${flightNo}) - using EK database`);
            return {
                db: window.ekDb,
                name: "EK Database (cardentryek)"
            };
            
        case 'QR':
            console.log(`‚úàÔ∏è QR flight detected (${flightNo}) - using QR database`);
            return {
                db: window.qrDb,
                name: "QR Database (cardentryqr)"
            };
            
        case 'SQ':
            console.log(`‚úàÔ∏è SQ flight detected (${flightNo}) - using SQ database`);
            return {
                db: window.sqDb,
                name: "SQ Database (dcleeli)"
            };
            
        default:
            console.log(`‚úàÔ∏è Other flight detected (${flightNo}) - using default database`);
            return {
                db: window.defaultCardDb,
                name: "Default Database (cardentry-7bad1)"
            };
    }
}

/**
 * Gets all available database configurations
 * @returns {Array} - Array of database objects with db reference and name
 */
function getAllDatabases() {
    const databases = [];
    
    if (window.baDb) {
        databases.push({
            db: window.baDb,
            name: "BA Database (cardentryba)",
            prefix: 'BA'
        });
    }
    
    if (window.ekDb) {
        databases.push({
            db: window.ekDb,
            name: "EK Database (cardentryek)",
            prefix: 'EK'
        });
    }
    
    if (window.qrDb) {
        databases.push({
            db: window.qrDb,
            name: "QR Database (cardentryqr)",
            prefix: 'QR'
        });
    }
    
    if (window.sqDb) {
        databases.push({
            db: window.sqDb,
            name: "SQ Database (dcleeli)",
            prefix: 'SQ'
        });
    }
    
    if (window.defaultCardDb) {
        databases.push({
            db: window.defaultCardDb,
            name: "Default Database (cardentry-7bad1)",
            prefix: 'OTHER'
        });
    }
    
    return databases;
}

// ========== LOAD DATES FUNCTION ==========
async function loadDates() {
    try {
        const dateSelect = document.getElementById('dateSelect');
        dateSelect.innerHTML = '<option value="">Loading dates...</option>';
        
        const databases = getAllDatabases();
        const allDates = new Set();
        
        // Show loading state
        document.getElementById('resultsCount').textContent = 'Loading dates from all databases...';
        
        // Query each database for distinct dates
        for (const dbInfo of databases) {
            try {
                console.log(`Loading dates from ${dbInfo.name}`);
                
                // Get all documents from KoveliPass collection
                const snapshot = await dbInfo.db.collection('KoveliPass')
                    .orderBy('date', 'desc')
                    .get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.date) {
                            allDates.add(data.date);
                        }
                    });
                }
                
                console.log(`Found ${snapshot.size} documents in ${dbInfo.name}`);
                
            } catch (error) {
                console.error(`‚ùå Error querying ${dbInfo.name}:`, error);
            }
        }
        
        // Convert set to array and sort (newest first)
        const sortedDates = Array.from(allDates).sort().reverse();
        
        // Populate the select dropdown
        dateSelect.innerHTML = '<option value="">Select Date</option>';
        
        if (sortedDates.length === 0) {
            dateSelect.innerHTML += '<option value="" disabled>No dates found</option>';
            document.getElementById('resultsCount').textContent = 'No data found in any database';
        } else {
            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });
            
            document.getElementById('resultsCount').textContent = `Found ${sortedDates.length} dates across all databases`;
        }
        
    } catch (error) {
        console.error('Error loading dates:', error);
        document.getElementById('dateSelect').innerHTML = '<option value="">Error loading dates</option>';
        document.getElementById('resultsCount').textContent = 'Error loading dates';
    }
}

// ========== SEARCH PASSENGERS FUNCTION ==========
async function searchPassengers() {
    try {
        // Get search criteria
        const date = document.getElementById('dateSelect').value;
        const flightNo = document.getElementById('flightInput').value.trim().toUpperCase();
        const passengerName = document.getElementById('nameInput').value.trim().toUpperCase();
        const seatNo = document.getElementById('seatInput').value.trim().toUpperCase();
        const selectedDb = document.getElementById('databaseSelect').value;
        
        if (!date && !flightNo && !passengerName && !seatNo) {
            alert('Please enter at least one search criteria');
            return;
        }
        
        // Show loading state
        isLoading = true;
        document.getElementById('resultsCount').textContent = 'Searching...';
        document.getElementById('passengerTableBody').innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #e6b800;"></i>
                    <br>Searching across databases...
                </td>
            </tr>
        `;
        
        allPassengers = [];
        
        // Determine which databases to search
        let databasesToSearch = [];
        
        if (selectedDb === 'all') {
            databasesToSearch = getAllDatabases();
        } else {
            // Search only the selected database
            let targetDb = null;
            let dbName = '';
            
            switch(selectedDb) {
                case 'ba':
                    targetDb = window.baDb;
                    dbName = "BA Database (cardentryba)";
                    break;
                case 'ek':
                    targetDb = window.ekDb;
                    dbName = "EK Database (cardentryek)";
                    break;
                case 'qr':
                    targetDb = window.qrDb;
                    dbName = "QR Database (cardentryqr)";
                    break;
                case 'sq':
                    targetDb = window.sqDb;
                    dbName = "SQ Database (dcleeli)";
                    break;
                default:
                    targetDb = window.defaultCardDb;
                    dbName = "Default Database (cardentry-7bad1)";
            }
            
            if (targetDb) {
                databasesToSearch.push({
                    db: targetDb,
                    name: dbName,
                    prefix: selectedDb.toUpperCase()
                });
            }
        }
        
        // Search each database
        for (const dbInfo of databasesToSearch) {
            try {
                console.log(`Searching ${dbInfo.name}...`);
                
                // Build query
                let query = dbInfo.db.collection('KoveliPass');
                
                // Apply filters based on criteria
                if (date) {
                    query = query.where('date', '==', date);
                }
                
                // Execute the query
                const snapshot = await query.get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // Apply additional client-side filtering for fields that can't be filtered in query
                        let matches = true;
                        
                        if (flightNo && data.flightNo) {
                            matches = matches && data.flightNo.toUpperCase().includes(flightNo);
                        }
                        
                        if (passengerName && data.pName) {
                            matches = matches && data.pName.toUpperCase().includes(passengerName);
                        }
                        
                        if (seatNo && data.seatNo) {
                            matches = matches && data.seatNo.toUpperCase().includes(seatNo);
                        }
                        
                        if (matches) {
                            allPassengers.push({
                                id: doc.id,
                                ...data,
                                sourceDb: dbInfo.name,
                                sourceDbPrefix: dbInfo.prefix
                            });
                        }
                    });
                }
                
                console.log(`Found ${snapshot.size} documents in ${dbInfo.name}, ${allPassengers.length} match after filtering`);
                
            } catch (error) {
                console.error(`‚ùå Error searching ${dbInfo.name}:`, error);
            }
        }
        
        // Sort results (by date, then flight, then name)
        allPassengers.sort((a, b) => {
            if (a.date !== b.date) return (b.date || '').localeCompare(a.date || '');
            if (a.flightNo !== b.flightNo) return (a.flightNo || '').localeCompare(b.flightNo || '');
            return (a.pName || '').localeCompare(b.pName || '');
        });
        
        filteredPassengers = [...allPassengers];
        
        // Update results count
        document.getElementById('resultsCount').textContent = `Found ${filteredPassengers.length} passenger(s)`;
        
        // Render results
        renderResults();
        
        isLoading = false;
        
    } catch (error) {
        console.error('Error searching passengers:', error);
        document.getElementById('resultsCount').textContent = 'Error searching';
        document.getElementById('passengerTableBody').innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 20px; color: #c68b5e;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <br>Error: ${error.message}
                </td>
            </tr>
        `;
        isLoading = false;
    }
}

// ========== RENDER RESULTS FUNCTION ==========
function renderResults() {
    const tbody = document.getElementById('passengerTableBody');
    tbody.innerHTML = '';
    
    if (filteredPassengers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 20px;">
                    <i class="fas fa-search" style="font-size: 24px; color: #ccc;"></i>
                    <br>No passengers found
                </td>
            </tr>
        `;
        return;
    }
    
    filteredPassengers.forEach((passenger, index) => {
        const row = document.createElement('tr');
        
        // Add class based on source database
        if (passenger.sourceDbPrefix === 'BA') {
            row.classList.add('ba-row');
        } else if (passenger.sourceDbPrefix === 'EK') {
            row.classList.add('ek-row');
        } else if (passenger.sourceDbPrefix === 'QR') {
            row.classList.add('qr-row');
        } else if (passenger.sourceDbPrefix === 'SQ') {
            row.classList.add('sq-row');
        }
        
        // Serial number
        const serialCell = document.createElement('td');
        serialCell.textContent = index + 1;
        
        // Database source
        const dbCell = document.createElement('td');
        dbCell.innerHTML = `<span class="db-badge db-${passenger.sourceDbPrefix?.toLowerCase() || 'other'}">${passenger.sourceDbPrefix || 'OTHER'}</span>`;
        dbCell.title = passenger.sourceDb || 'Unknown database';
        
        // Date
        const dateCell = document.createElement('td');
        dateCell.textContent = passenger.date || '‚Äî';
        
        // Shift
        const shiftCell = document.createElement('td');
        shiftCell.textContent = passenger.shift || '‚Äî';
        
        // Entry Time
        const timeCell = document.createElement('td');
        timeCell.textContent = passenger.entryTime || '‚Äî';
        
        // Name
        const nameCell = document.createElement('td');
        nameCell.textContent = passenger.pName || '‚Äî';
        
        // Flight No
        const flightCell = document.createElement('td');
        flightCell.textContent = passenger.flightNo || '‚Äî';
        
        // Seat No
        const seatCell = document.createElement('td');
        seatCell.textContent = passenger.seatNo || '‚Äî';
        
        // Class
        const classCell = document.createElement('td');
        classCell.textContent = passenger.class || '‚Äî';
        
        // Airline
        const airlineCell = document.createElement('td');
        airlineCell.textContent = passenger.airline || '‚Äî';
        
        // FQTV
        const fqtvCell = document.createElement('td');
        fqtvCell.textContent = passenger.FQTV || '‚Äî';
        
        // PAX
        const paxCell = document.createElement('td');
        paxCell.textContent = passenger.pax || '‚Äî';
        
        // Serial No
        const serialNoCell = document.createElement('td');
        serialNoCell.textContent = passenger.serialNo || '‚Äî';
        
        // Remarks
        const remarksCell = document.createElement('td');
        remarksCell.textContent = passenger.remarks || '‚Äî';
        
        // Guest indicator
        const guestCell = document.createElement('td');
        if (passenger.isGuest) {
            guestCell.innerHTML = '<span class="guest-badge">GUEST</span>';
            guestCell.title = `Main: ${passenger.mainPassengerName || 'Unknown'} (${passenger.mainPassengerSeat || 'No seat'})`;
        } else {
            guestCell.textContent = '‚Äî';
        }
        
        // Entered By
        const enteredByCell = document.createElement('td');
        enteredByCell.innerHTML = `
            <div>${passenger.enteredBy || '‚Äî'}</div>
            <small style="color: #666;">${passenger.enteredByLevel || ''} | ${passenger.enteredByRCNo || ''}</small>
        `;
        
        // Entered At
        const enteredAtCell = document.createElement('td');
        if (passenger.enteredAt) {
            const date = new Date(passenger.enteredAt);
            enteredAtCell.innerHTML = `
                <div>${date.toLocaleDateString()}</div>
                <small>${date.toLocaleTimeString()}</small>
            `;
        } else {
            enteredAtCell.textContent = '‚Äî';
        }
        
        // Actions
        const actionsCell = document.createElement('td');
        actionsCell.className = 'action-buttons';
        actionsCell.innerHTML = `
            <button class="view-btn" onclick="viewPassenger('${passenger.id}')" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
            <button class="print-btn" onclick="printPassenger('${passenger.id}')" title="Print">
                <i class="fas fa-print"></i>
            </button>
        `;
        
        // Append all cells
        row.appendChild(serialCell);
        row.appendChild(dbCell);
        row.appendChild(dateCell);
        row.appendChild(shiftCell);
        row.appendChild(timeCell);
        row.appendChild(nameCell);
        row.appendChild(flightCell);
        row.appendChild(seatCell);
        row.appendChild(classCell);
        row.appendChild(airlineCell);
        row.appendChild(fqtvCell);
        row.appendChild(paxCell);
        row.appendChild(serialNoCell);
        row.appendChild(remarksCell);
        row.appendChild(guestCell);
        row.appendChild(enteredByCell);
        row.appendChild(enteredAtCell);
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
    });
}

// ========== CLEAR SEARCH FUNCTION ==========
function clearSearch() {
    document.getElementById('dateSelect').value = '';
    document.getElementById('flightInput').value = '';
    document.getElementById('nameInput').value = '';
    document.getElementById('seatInput').value = '';
    
    filteredPassengers = [];
    allPassengers = [];
    
    document.getElementById('passengerTableBody').innerHTML = `
        <tr>
            <td colspan="14" style="text-align: center; padding: 20px;">
                <i class="fas fa-search" style="font-size: 24px; color: #ccc;"></i>
                <br>Enter search criteria and click Search
            </td>
        </tr>
    `;
    
    document.getElementById('resultsCount').textContent = '0 passengers';
}

// ========== VIEW PASSENGER FUNCTION ==========
function viewPassenger(id) {
    const passenger = allPassengers.find(p => p.id === id);
    if (!passenger) return;
    
    // Create a modal or show details (simplified - just alert for now)
    alert(`
        Passenger Details:
        Name: ${passenger.pName || 'N/A'}
        Flight: ${passenger.flightNo || 'N/A'}
        Seat: ${passenger.seatNo || 'N/A'}
        Class: ${passenger.class || 'N/A'}
        Airline: ${passenger.airline || 'N/A'}
        FQTV: ${passenger.FQTV || 'N/A'}
        PAX: ${passenger.pax || 'N/A'}
        Serial No: ${passenger.serialNo || 'N/A'}
        Remarks: ${passenger.remarks || 'N/A'}
        Date: ${passenger.date || 'N/A'}
        Shift: ${passenger.shift || 'N/A'}
        Entry Time: ${passenger.entryTime || 'N/A'}
        Guest: ${passenger.isGuest ? 'Yes' : 'No'}
        ${passenger.isGuest ? `Main Passenger: ${passenger.mainPassengerName || 'N/A'} (${passenger.mainPassengerSeat || 'N/A'})` : ''}
        Entered By: ${passenger.enteredBy || 'N/A'} (${passenger.enteredByLevel || 'N/A'}) - ${passenger.enteredByRCNo || 'N/A'}
        Entered At: ${passenger.enteredAt ? new Date(passenger.enteredAt).toLocaleString() : 'N/A'}
        Database: ${passenger.sourceDb || 'N/A'}
    `);
}

// ========== PRINT PASSENGER FUNCTION ==========
function printPassenger(id) {
    const passenger = allPassengers.find(p => p.id === id);
    if (!passenger) return;
    
    const printContent = document.createElement('div');
    printContent.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <h1 style="text-align: center; color: #8b6913;">PASSENGER DETAILS</h1>
            <hr>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Passenger Name:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.pName || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Flight Number:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.flightNo || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Seat Number:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.seatNo || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Class:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.class || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Airline:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.airline || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>FQTV:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.FQTV || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>PAX:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.pax || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Serial Number:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.serialNo || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Remarks:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.remarks || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Date:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.date || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Shift:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.shift || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Entry Time:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.entryTime || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Guest:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.isGuest ? 'Yes' : 'No'}</td></tr>
                ${passenger.isGuest ? `
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Main Passenger:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.mainPassengerName || '‚Äî'} (${passenger.mainPassengerSeat || '‚Äî'})</td></tr>
                ` : ''}
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Entered By:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.enteredBy || '‚Äî'} (${passenger.enteredByLevel || '‚Äî'}) - ${passenger.enteredByRCNo || '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Entered At:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.enteredAt ? new Date(passenger.enteredAt).toLocaleString() : '‚Äî'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Database:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.sourceDb || '‚Äî'}</td></tr>
            </table>
            <hr>
            <p style="text-align: center; font-size: 12px; color: #666;">Printed: ${new Date().toLocaleString()}</p>
        </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Passenger Details - ${passenger.pName || 'Unknown'}</title>
            <style>
                body { font-family: Arial, sans-serif; }
                @media print {
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            ${printContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// ========== EXPORT TO CSV FUNCTION ==========
function exportToCSV() {
    if (filteredPassengers.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Define CSV headers
    const headers = [
        'S.No',
        'Database',
        'Date',
        'Shift',
        'Entry Time',
        'Passenger Name',
        'Flight No',
        'Seat No',
        'Class',
        'Airline',
        'FQTV',
        'PAX',
        'Serial No',
        'Remarks',
        'Guest',
        'Main Passenger',
        'Main Seat',
        'Entered By',
        'Entered By Level',
        'Entered By RC No',
        'Entered At'
    ];
    
    // Convert data to CSV rows
    const rows = filteredPassengers.map((p, index) => [
        index + 1,
        p.sourceDbPrefix || 'OTHER',
        p.date || '',
        p.shift || '',
        p.entryTime || '',
        p.pName || '',
        p.flightNo || '',
        p.seatNo || '',
        p.class || '',
        p.airline || '',
        p.FQTV || '',
        p.pax || '',
        p.serialNo || '',
        p.remarks || '',
        p.isGuest ? 'Yes' : 'No',
        p.isGuest ? (p.mainPassengerName || '') : '',
        p.isGuest ? (p.mainPassengerSeat || '') : '',
        p.enteredBy || '',
        p.enteredByLevel || '',
        p.enteredByRCNo || '',
        p.enteredAt ? new Date(p.enteredAt).toLocaleString() : ''
    ]);
    
    // Combine headers and rows
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `passenger_report_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ========== PRINT REPORT FUNCTION ==========
function printReport() {
    if (filteredPassengers.length === 0) {
        alert('No data to print');
        return;
    }
    
    // Create print content
    const printContent = document.createElement('div');
    printContent.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
            <h1 style="text-align: center; color: #8b6913;">PASSENGER REPORT</h1>
            <p style="text-align: center;">
                Generated: ${new Date().toLocaleString()}<br>
                Total Passengers: ${filteredPassengers.length}
            </p>
            <hr>
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="border: 1px solid #ccc; padding: 4px;">S.No</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">DB</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Date</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Shift</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Time</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Name</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Flight</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Seat</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Class</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Airline</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">FQTV</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">PAX</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Serial</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Remarks</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Guest</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredPassengers.map((p, index) => `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 2px;">${index + 1}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.sourceDbPrefix || 'OT'}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.date || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.shift || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.entryTime || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.pName || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.flightNo || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.seatNo || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.class || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.airline || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.FQTV || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.pax || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.serialNo || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.remarks || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.isGuest ? 'Y' : 'N'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <hr>
            <p style="text-align: center; font-size: 10px; color: #666;">
                Report generated by: ${currentUser.name || currentUser.username || 'Unknown'} (${currentUser.level || 'Operator'}) - RC: ${currentUser.rcno || 'N/A'}
            </p>
        </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Passenger Report</title>
            <style>
                body { font-family: Arial, sans-serif; }
                @media print {
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            ${printContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// Make functions global
window.logout = logout;
window.searchPassengers = searchPassengers;
window.clearSearch = clearSearch;
window.exportToCSV = exportToCSV;
window.printReport = printReport;
window.viewPassenger = viewPassenger;
window.printPassenger = printPassenger;
</script>
