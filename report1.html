<script>
// ========== REPORT.JS - FIXED VERSION ==========

// Global variables
let allPassengers = [];
let filteredPassengers = [];
let currentUser = {
    name: '',
    rcno: '',
    level: '',
    username: ''
};
let currentShiftData = {
    date: '',
    shift: '',
    status: '',
    openTime: ''
};
let selectedDb = 'all'; // 'all', 'ba', 'ek', 'qr', 'sq', 'default'
let isLoading = false;

// ========== CHECK LOGIN AND INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    const isLoggedIn = checkLoginStatus();
    if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
    }
    
    loadUserData();
    
    // Set up event listeners
    document.getElementById('searchBtn').addEventListener('click', function() {
        searchPassengers();
    });
    
    document.getElementById('clearBtn').addEventListener('click', function() {
        clearSearch();
    });
    
    document.getElementById('exportBtn').addEventListener('click', function() {
        exportToCSV();
    });
    
    document.getElementById('printBtn').addEventListener('click', function() {
        printReport();
    });
    
    document.getElementById('databaseSelect').addEventListener('change', function(e) {
        selectedDb = e.target.value;
        if (selectedDb === 'all') {
            document.getElementById('dateSelect').style.display = 'inline-block';
            document.getElementById('flightInput').style.display = 'inline-block';
        } else {
            document.getElementById('dateSelect').style.display = 'inline-block';
            document.getElementById('flightInput').style.display = 'inline-block';
        }
    });
    
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadDates();
    });
    
    // Load available dates
    loadDates();
});

// ========== LOGIN CHECK FUNCTION ==========
function checkLoginStatus() {
    try {
        const username = localStorage.getItem('username');
        const level = localStorage.getItem('level');
        const rcno = localStorage.getItem('rcno');
        const loggedInUser = localStorage.getItem('loggedInUser');
        
        if (username && (level || rcno)) {
            return true;
        }
        
        if (loggedInUser) {
            try {
                const userData = JSON.parse(loggedInUser);
                if (userData && userData.username) {
                    return true;
                }
            } catch (e) {
                console.error('Error parsing loggedInUser:', e);
            }
        }
        
        return false;
    } catch (error) {
        console.error('Error checking login status:', error);
        return false;
    }
}

// ========== USER DATA FUNCTIONS ==========
function loadUserData() {
    try {
        console.log('Loading user data from localStorage...');
        
        const storedUsername = localStorage.getItem('username');
        const storedLevel = localStorage.getItem('level');
        const storedRcno = localStorage.getItem('rcno');
        const loggedInUser = localStorage.getItem('loggedInUser');
        
        if (loggedInUser) {
            try {
                const parsedUser = JSON.parse(loggedInUser);
                currentUser.username = parsedUser.username || storedUsername || '';
                currentUser.name = parsedUser.name || parsedUser.username || storedUsername || '';
                currentUser.rcno = parsedUser.rcno || storedRcno || '';
                currentUser.level = parsedUser.level || storedLevel || '';
            } catch (e) {
                console.error('Error parsing loggedInUser:', e);
            }
        }
        
        if (storedUsername) currentUser.username = storedUsername;
        if (!currentUser.name && storedUsername) currentUser.name = storedUsername;
        if (storedRcno) currentUser.rcno = storedRcno;
        if (storedLevel) currentUser.level = storedLevel;
        
        if (!currentUser.username) {
            console.warn('No user data found in localStorage');
            currentUser.username = 'UNKNOWN';
            currentUser.name = 'UNKNOWN';
            currentUser.rcno = 'N/A';
            currentUser.level = 'OPERATOR';
        }
        
        if (!currentUser.name) {
            currentUser.name = currentUser.username;
        }
        
        console.log('Final currentUser object:', currentUser);
        updateUserDisplay();
        
    } catch (error) {
        console.error('Error loading user data:', error);
        currentUser = {
            username: 'UNKNOWN',
            name: 'UNKNOWN',
            rcno: 'N/A',
            level: 'OPERATOR'
        };
        updateUserDisplay();
    }
}

function updateUserDisplay() {
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userRcnoDisplay = document.getElementById('userRcnoDisplay');
    const userLevelDisplay = document.getElementById('userLevelDisplay');
    
    if (userNameDisplay) userNameDisplay.textContent = currentUser.name || currentUser.username || 'N/A';
    if (userRcnoDisplay) userRcnoDisplay.textContent = currentUser.rcno || 'N/A';
    if (userLevelDisplay) userLevelDisplay.textContent = currentUser.level || 'N/A';
}

function logout() {
    localStorage.removeItem('username');
    localStorage.removeItem('level');
    localStorage.removeItem('rcno');
    localStorage.removeItem('loggedInUser');
    
    window.location.href = 'login.html';
}

// ========== MULTI-DATABASE FUNCTIONS ==========

/**
 * Returns the appropriate Firestore database based on flight number
 * @param {string} flightNo - The flight number (e.g., "BA123", "EK456")
 * @returns {Object} - The Firestore database instance and info
 */
function getFirestoreForFlight(flightNo) {
    if (!flightNo || typeof flightNo !== 'string') {
        console.log("No valid flight number provided, using default database");
        return {
            db: window.defaultCardDb || window.db,
            name: "Default Database (cardentry-7bad1)"
        };
    }

    const flightPrefix = flightNo.substring(0, 2).toUpperCase();
    
    switch(flightPrefix) {
        case 'BA':
            console.log(`✈️ BA flight detected (${flightNo}) - using BA database`);
            return {
                db: window.baDb,
                name: "BA Database (cardentryba)"
            };
            
        case 'EK':
            console.log(`✈️ EK flight detected (${flightNo}) - using EK database`);
            return {
                db: window.ekDb,
                name: "EK Database (cardentryek)"
            };
            
        case 'QR':
            console.log(`✈️ QR flight detected (${flightNo}) - using QR database`);
            return {
                db: window.qrDb,
                name: "QR Database (cardentryqr)"
            };
            
        case 'SQ':
            console.log(`✈️ SQ flight detected (${flightNo}) - using SQ database`);
            return {
                db: window.sqDb,
                name: "SQ Database (dcleeli)"
            };
            
        default:
            console.log(`✈️ Other flight detected (${flightNo}) - using default database`);
            return {
                db: window.defaultCardDb,
                name: "Default Database (cardentry-7bad1)"
            };
    }
}

/**
 * Gets all available database configurations
 * @returns {Array} - Array of database objects with db reference and name
 */
function getAllDatabases() {
    const databases = [];
    
    if (window.baDb) {
        databases.push({
            db: window.baDb,
            name: "BA Database (cardentryba)",
            prefix: 'BA'
        });
    }
    
    if (window.ekDb) {
        databases.push({
            db: window.ekDb,
            name: "EK Database (cardentryek)",
            prefix: 'EK'
        });
    }
    
    if (window.qrDb) {
        databases.push({
            db: window.qrDb,
            name: "QR Database (cardentryqr)",
            prefix: 'QR'
        });
    }
    
    if (window.sqDb) {
        databases.push({
            db: window.sqDb,
            name: "SQ Database (dcleeli)",
            prefix: 'SQ'
        });
    }
    
    if (window.defaultCardDb) {
        databases.push({
            db: window.defaultCardDb,
            name: "Default Database (cardentry-7bad1)",
            prefix: 'OTHER'
        });
    }
    
    return databases;
}

// ========== LOAD DATES FUNCTION ==========
async function loadDates() {
    try {
        const dateSelect = document.getElementById('dateSelect');
        dateSelect.innerHTML = '<option value="">Loading dates...</option>';
        
        const databases = getAllDatabases();
        const allDates = new Set();
        
        // Show loading state
        document.getElementById('resultsCount').textContent = 'Loading dates from all databases...';
        
        // Query each database for distinct dates
        for (const dbInfo of databases) {
            try {
                console.log(`Loading dates from ${dbInfo.name}`);
                
                // Get all documents from KoveliPass collection
                const snapshot = await dbInfo.db.collection('KoveliPass')
                    .orderBy('date', 'desc')
                    .get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.date) {
                            allDates.add(data.date);
                        }
                    });
                }
                
                console.log(`Found ${snapshot.size} documents in ${dbInfo.name}`);
                
            } catch (error) {
                console.error(`❌ Error querying ${dbInfo.name}:`, error);
            }
        }
        
        // Convert set to array and sort (newest first)
        const sortedDates = Array.from(allDates).sort().reverse();
        
        // Populate the select dropdown
        dateSelect.innerHTML = '<option value="">Select Date</option>';
        
        if (sortedDates.length === 0) {
            dateSelect.innerHTML += '<option value="" disabled>No dates found</option>';
            document.getElementById('resultsCount').textContent = 'No data found in any database';
        } else {
            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });
            
            document.getElementById('resultsCount').textContent = `Found ${sortedDates.length} dates across all databases`;
        }
        
    } catch (error) {
        console.error('Error loading dates:', error);
        document.getElementById('dateSelect').innerHTML = '<option value="">Error loading dates</option>';
        document.getElementById('resultsCount').textContent = 'Error loading dates';
    }
}

// ========== SEARCH PASSENGERS FUNCTION ==========
async function searchPassengers() {
    try {
        // Get search criteria
        const date = document.getElementById('dateSelect').value;
        const flightNo = document.getElementById('flightInput').value.trim().toUpperCase();
        const passengerName = document.getElementById('nameInput').value.trim().toUpperCase();
        const seatNo = document.getElementById('seatInput').value.trim().toUpperCase();
        const selectedDb = document.getElementById('databaseSelect').value;
        
        if (!date && !flightNo && !passengerName && !seatNo) {
            alert('Please enter at least one search criteria');
            return;
        }
        
        // Show loading state
        isLoading = true;
        document.getElementById('resultsCount').textContent = 'Searching...';
        document.getElementById('passengerTableBody').innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #e6b800;"></i>
                    <br>Searching across databases...
                </td>
            </tr>
        `;
        
        allPassengers = [];
        
        // Determine which databases to search
        let databasesToSearch = [];
        
        if (selectedDb === 'all') {
            databasesToSearch = getAllDatabases();
        } else {
            // Search only the selected database
            let targetDb = null;
            let dbName = '';
            
            switch(selectedDb) {
                case 'ba':
                    targetDb = window.baDb;
                    dbName = "BA Database (cardentryba)";
                    break;
                case 'ek':
                    targetDb = window.ekDb;
                    dbName = "EK Database (cardentryek)";
                    break;
                case 'qr':
                    targetDb = window.qrDb;
                    dbName = "QR Database (cardentryqr)";
                    break;
                case 'sq':
                    targetDb = window.sqDb;
                    dbName = "SQ Database (dcleeli)";
                    break;
                default:
                    targetDb = window.defaultCardDb;
                    dbName = "Default Database (cardentry-7bad1)";
            }
            
            if (targetDb) {
                databasesToSearch.push({
                    db: targetDb,
                    name: dbName,
                    prefix: selectedDb.toUpperCase()
                });
            }
        }
        
        // Search each database
        for (const dbInfo of databasesToSearch) {
            try {
                console.log(`Searching ${dbInfo.name}...`);
                
                // Build query
                let query = dbInfo.db.collection('KoveliPass');
                
                // Apply filters based on criteria
                if (date) {
                    query = query.where('date', '==', date);
                }
                
                // Execute the query
                const snapshot = await query.get();
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // Apply additional client-side filtering for fields that can't be filtered in query
                        let matches = true;
                        
                        if (flightNo && data.flightNo) {
                            matches = matches && data.flightNo.toUpperCase().includes(flightNo);
                        }
                        
                        if (passengerName && data.pName) {
                            matches = matches && data.pName.toUpperCase().includes(passengerName);
                        }
                        
                        if (seatNo && data.seatNo) {
                            matches = matches && data.seatNo.toUpperCase().includes(seatNo);
                        }
                        
                        if (matches) {
                            allPassengers.push({
                                id: doc.id,
                                ...data,
                                sourceDb: dbInfo.name,
                                sourceDbPrefix: dbInfo.prefix
                            });
                        }
                    });
                }
                
                console.log(`Found ${snapshot.size} documents in ${dbInfo.name}, ${allPassengers.length} match after filtering`);
                
            } catch (error) {
                console.error(`❌ Error searching ${dbInfo.name}:`, error);
            }
        }
        
        // Sort results (by date, then flight, then name)
        allPassengers.sort((a, b) => {
            if (a.date !== b.date) return (b.date || '').localeCompare(a.date || '');
            if (a.flightNo !== b.flightNo) return (a.flightNo || '').localeCompare(b.flightNo || '');
            return (a.pName || '').localeCompare(b.pName || '');
        });
        
        filteredPassengers = [...allPassengers];
        
        // Update results count
        document.getElementById('resultsCount').textContent = `Found ${filteredPassengers.length} passenger(s)`;
        
        // Render results
        renderResults();
        
        isLoading = false;
        
    } catch (error) {
        console.error('Error searching passengers:', error);
        document.getElementById('resultsCount').textContent = 'Error searching';
        document.getElementById('passengerTableBody').innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 20px; color: #c68b5e;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <br>Error: ${error.message}
                </td>
            </tr>
        `;
        isLoading = false;
    }
}

// ========== RENDER RESULTS FUNCTION ==========
function renderResults() {
    const tbody = document.getElementById('passengerTableBody');
    tbody.innerHTML = '';
    
    if (filteredPassengers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="14" style="text-align: center; padding: 20px;">
                    <i class="fas fa-search" style="font-size: 24px; color: #ccc;"></i>
                    <br>No passengers found
                </td>
            </tr>
        `;
        return;
    }
    
    filteredPassengers.forEach((passenger, index) => {
        const row = document.createElement('tr');
        
        // Add class based on source database
        if (passenger.sourceDbPrefix === 'BA') {
            row.classList.add('ba-row');
        } else if (passenger.sourceDbPrefix === 'EK') {
            row.classList.add('ek-row');
        } else if (passenger.sourceDbPrefix === 'QR') {
            row.classList.add('qr-row');
        } else if (passenger.sourceDbPrefix === 'SQ') {
            row.classList.add('sq-row');
        }
        
        // Serial number
        const serialCell = document.createElement('td');
        serialCell.textContent = index + 1;
        
        // Database source
        const dbCell = document.createElement('td');
        dbCell.innerHTML = `<span class="db-badge db-${passenger.sourceDbPrefix?.toLowerCase() || 'other'}">${passenger.sourceDbPrefix || 'OTHER'}</span>`;
        dbCell.title = passenger.sourceDb || 'Unknown database';
        
        // Date
        const dateCell = document.createElement('td');
        dateCell.textContent = passenger.date || '—';
        
        // Shift
        const shiftCell = document.createElement('td');
        shiftCell.textContent = passenger.shift || '—';
        
        // Entry Time
        const timeCell = document.createElement('td');
        timeCell.textContent = passenger.entryTime || '—';
        
        // Name
        const nameCell = document.createElement('td');
        nameCell.textContent = passenger.pName || '—';
        
        // Flight No
        const flightCell = document.createElement('td');
        flightCell.textContent = passenger.flightNo || '—';
        
        // Seat No
        const seatCell = document.createElement('td');
        seatCell.textContent = passenger.seatNo || '—';
        
        // Class
        const classCell = document.createElement('td');
        classCell.textContent = passenger.class || '—';
        
        // Airline
        const airlineCell = document.createElement('td');
        airlineCell.textContent = passenger.airline || '—';
        
        // FQTV
        const fqtvCell = document.createElement('td');
        fqtvCell.textContent = passenger.FQTV || '—';
        
        // PAX
        const paxCell = document.createElement('td');
        paxCell.textContent = passenger.pax || '—';
        
        // Serial No
        const serialNoCell = document.createElement('td');
        serialNoCell.textContent = passenger.serialNo || '—';
        
        // Remarks
        const remarksCell = document.createElement('td');
        remarksCell.textContent = passenger.remarks || '—';
        
        // Guest indicator
        const guestCell = document.createElement('td');
        if (passenger.isGuest) {
            guestCell.innerHTML = '<span class="guest-badge">GUEST</span>';
            guestCell.title = `Main: ${passenger.mainPassengerName || 'Unknown'} (${passenger.mainPassengerSeat || 'No seat'})`;
        } else {
            guestCell.textContent = '—';
        }
        
        // Entered By
        const enteredByCell = document.createElement('td');
        enteredByCell.innerHTML = `
            <div>${passenger.enteredBy || '—'}</div>
            <small style="color: #666;">${passenger.enteredByLevel || ''} | ${passenger.enteredByRCNo || ''}</small>
        `;
        
        // Entered At
        const enteredAtCell = document.createElement('td');
        if (passenger.enteredAt) {
            const date = new Date(passenger.enteredAt);
            enteredAtCell.innerHTML = `
                <div>${date.toLocaleDateString()}</div>
                <small>${date.toLocaleTimeString()}</small>
            `;
        } else {
            enteredAtCell.textContent = '—';
        }
        
        // Actions
        const actionsCell = document.createElement('td');
        actionsCell.className = 'action-buttons';
        actionsCell.innerHTML = `
            <button class="view-btn" onclick="viewPassenger('${passenger.id}')" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
            <button class="print-btn" onclick="printPassenger('${passenger.id}')" title="Print">
                <i class="fas fa-print"></i>
            </button>
        `;
        
        // Append all cells
        row.appendChild(serialCell);
        row.appendChild(dbCell);
        row.appendChild(dateCell);
        row.appendChild(shiftCell);
        row.appendChild(timeCell);
        row.appendChild(nameCell);
        row.appendChild(flightCell);
        row.appendChild(seatCell);
        row.appendChild(classCell);
        row.appendChild(airlineCell);
        row.appendChild(fqtvCell);
        row.appendChild(paxCell);
        row.appendChild(serialNoCell);
        row.appendChild(remarksCell);
        row.appendChild(guestCell);
        row.appendChild(enteredByCell);
        row.appendChild(enteredAtCell);
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
    });
}

// ========== CLEAR SEARCH FUNCTION ==========
function clearSearch() {
    document.getElementById('dateSelect').value = '';
    document.getElementById('flightInput').value = '';
    document.getElementById('nameInput').value = '';
    document.getElementById('seatInput').value = '';
    
    filteredPassengers = [];
    allPassengers = [];
    
    document.getElementById('passengerTableBody').innerHTML = `
        <tr>
            <td colspan="14" style="text-align: center; padding: 20px;">
                <i class="fas fa-search" style="font-size: 24px; color: #ccc;"></i>
                <br>Enter search criteria and click Search
            </td>
        </tr>
    `;
    
    document.getElementById('resultsCount').textContent = '0 passengers';
}

// ========== VIEW PASSENGER FUNCTION ==========
function viewPassenger(id) {
    const passenger = allPassengers.find(p => p.id === id);
    if (!passenger) return;
    
    // Create a modal or show details (simplified - just alert for now)
    alert(`
        Passenger Details:
        Name: ${passenger.pName || 'N/A'}
        Flight: ${passenger.flightNo || 'N/A'}
        Seat: ${passenger.seatNo || 'N/A'}
        Class: ${passenger.class || 'N/A'}
        Airline: ${passenger.airline || 'N/A'}
        FQTV: ${passenger.FQTV || 'N/A'}
        PAX: ${passenger.pax || 'N/A'}
        Serial No: ${passenger.serialNo || 'N/A'}
        Remarks: ${passenger.remarks || 'N/A'}
        Date: ${passenger.date || 'N/A'}
        Shift: ${passenger.shift || 'N/A'}
        Entry Time: ${passenger.entryTime || 'N/A'}
        Guest: ${passenger.isGuest ? 'Yes' : 'No'}
        ${passenger.isGuest ? `Main Passenger: ${passenger.mainPassengerName || 'N/A'} (${passenger.mainPassengerSeat || 'N/A'})` : ''}
        Entered By: ${passenger.enteredBy || 'N/A'} (${passenger.enteredByLevel || 'N/A'}) - ${passenger.enteredByRCNo || 'N/A'}
        Entered At: ${passenger.enteredAt ? new Date(passenger.enteredAt).toLocaleString() : 'N/A'}
        Database: ${passenger.sourceDb || 'N/A'}
    `);
}

// ========== PRINT PASSENGER FUNCTION ==========
function printPassenger(id) {
    const passenger = allPassengers.find(p => p.id === id);
    if (!passenger) return;
    
    const printContent = document.createElement('div');
    printContent.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <h1 style="text-align: center; color: #8b6913;">PASSENGER DETAILS</h1>
            <hr>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Passenger Name:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.pName || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Flight Number:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.flightNo || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Seat Number:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.seatNo || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Class:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.class || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Airline:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.airline || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>FQTV:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.FQTV || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>PAX:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.pax || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Serial Number:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.serialNo || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Remarks:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.remarks || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Date:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.date || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Shift:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.shift || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Entry Time:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.entryTime || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Guest:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.isGuest ? 'Yes' : 'No'}</td></tr>
                ${passenger.isGuest ? `
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Main Passenger:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.mainPassengerName || '—'} (${passenger.mainPassengerSeat || '—'})</td></tr>
                ` : ''}
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Entered By:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.enteredBy || '—'} (${passenger.enteredByLevel || '—'}) - ${passenger.enteredByRCNo || '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Entered At:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.enteredAt ? new Date(passenger.enteredAt).toLocaleString() : '—'}</td></tr>
                <tr><td style="padding: 8px; border: 1px solid #ccc; background: #f5f5f5;"><strong>Database:</strong></td><td style="padding: 8px; border: 1px solid #ccc;">${passenger.sourceDb || '—'}</td></tr>
            </table>
            <hr>
            <p style="text-align: center; font-size: 12px; color: #666;">Printed: ${new Date().toLocaleString()}</p>
        </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Passenger Details - ${passenger.pName || 'Unknown'}</title>
            <style>
                body { font-family: Arial, sans-serif; }
                @media print {
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            ${printContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// ========== EXPORT TO CSV FUNCTION ==========
function exportToCSV() {
    if (filteredPassengers.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Define CSV headers
    const headers = [
        'S.No',
        'Database',
        'Date',
        'Shift',
        'Entry Time',
        'Passenger Name',
        'Flight No',
        'Seat No',
        'Class',
        'Airline',
        'FQTV',
        'PAX',
        'Serial No',
        'Remarks',
        'Guest',
        'Main Passenger',
        'Main Seat',
        'Entered By',
        'Entered By Level',
        'Entered By RC No',
        'Entered At'
    ];
    
    // Convert data to CSV rows
    const rows = filteredPassengers.map((p, index) => [
        index + 1,
        p.sourceDbPrefix || 'OTHER',
        p.date || '',
        p.shift || '',
        p.entryTime || '',
        p.pName || '',
        p.flightNo || '',
        p.seatNo || '',
        p.class || '',
        p.airline || '',
        p.FQTV || '',
        p.pax || '',
        p.serialNo || '',
        p.remarks || '',
        p.isGuest ? 'Yes' : 'No',
        p.isGuest ? (p.mainPassengerName || '') : '',
        p.isGuest ? (p.mainPassengerSeat || '') : '',
        p.enteredBy || '',
        p.enteredByLevel || '',
        p.enteredByRCNo || '',
        p.enteredAt ? new Date(p.enteredAt).toLocaleString() : ''
    ]);
    
    // Combine headers and rows
    const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `passenger_report_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// ========== PRINT REPORT FUNCTION ==========
function printReport() {
    if (filteredPassengers.length === 0) {
        alert('No data to print');
        return;
    }
    
    // Create print content
    const printContent = document.createElement('div');
    printContent.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
            <h1 style="text-align: center; color: #8b6913;">PASSENGER REPORT</h1>
            <p style="text-align: center;">
                Generated: ${new Date().toLocaleString()}<br>
                Total Passengers: ${filteredPassengers.length}
            </p>
            <hr>
            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                <thead>
                    <tr style="background: #f5f5f5;">
                        <th style="border: 1px solid #ccc; padding: 4px;">S.No</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">DB</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Date</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Shift</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Time</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Name</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Flight</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Seat</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Class</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Airline</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">FQTV</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">PAX</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Serial</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Remarks</th>
                        <th style="border: 1px solid #ccc; padding: 4px;">Guest</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredPassengers.map((p, index) => `
                        <tr>
                            <td style="border: 1px solid #ccc; padding: 2px;">${index + 1}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.sourceDbPrefix || 'OT'}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.date || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.shift || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.entryTime || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.pName || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.flightNo || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.seatNo || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.class || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.airline || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.FQTV || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.pax || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.serialNo || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.remarks || ''}</td>
                            <td style="border: 1px solid #ccc; padding: 2px;">${p.isGuest ? 'Y' : 'N'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <hr>
            <p style="text-align: center; font-size: 10px; color: #666;">
                Report generated by: ${currentUser.name || currentUser.username || 'Unknown'} (${currentUser.level || 'Operator'}) - RC: ${currentUser.rcno || 'N/A'}
            </p>
        </div>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Passenger Report</title>
            <style>
                body { font-family: Arial, sans-serif; }
                @media print {
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            ${printContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// Make functions global
window.logout = logout;
window.searchPassengers = searchPassengers;
window.clearSearch = clearSearch;
window.exportToCSV = exportToCSV;
window.printReport = printReport;
window.viewPassenger = viewPassenger;
window.printPassenger = printPassenger;
</script>
