<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koveli Lounge ¬∑ shift command</title>
    <!-- Firebase (same as original) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shiftfire.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at 10% 30%, #f6f0e0, #efe3cc 90%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* main panel ‚Äì elevated, clean, minimal card */
        .command-panel {
            width: 480px;
            background: rgba(255, 253, 247, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 48px;
            padding: 30px 28px;
            box-shadow: 
                0 30px 50px -30px #bb9d70,
                0 0 0 1px rgba(250, 230, 190, 0.7) inset,
                0 0 0 3px rgba(255, 245, 220, 0.5) inset,
                0 12px 24px -12px #ba9d78;
            border: 1px solid #fbddb0;
            transition: all 0.25s ease;
        }

        /* user hero section ‚Äì big & bold */
        .user-hero {
            background: linear-gradient(105deg, #faf1dd 0%, #f9e9cb 100%);
            border-radius: 100px;
            padding: 16px 24px 16px 28px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #fadbb0;
            box-shadow: 0 8px 0 #d2a96a, 0 12px 24px -10px #c9a059;
        }

        .user-info {
            display: flex;
            align-items: baseline;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-name {
            font-size: 1.7rem;
            font-weight: 550;
            background: linear-gradient(145deg, #60471b, #8f6e2e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.3px;
        }

        .user-level {
            background: #8b6f40;
            color: #fef7e9;
            padding: 5px 18px;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border: 1px solid #eac384;
            box-shadow: inset 0 1px 3px #ffe1a4, 0 2px 0 #614c28;
        }

        .logout-btn {
            background: #f3dfc3;
            border: none;
            border-radius: 50px;
            padding: 8px 18px 8px 22px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #563f19;
            border: 1px solid #fad09a;
            box-shadow: 0 4px 0 #b88744;
            cursor: pointer;
            transition: 0.1s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #b88744;
        }

        /* date capsule */
        .date-capsule {
            background: #e8dcc6;
            border-radius: 60px;
            padding: 12px 24px;
            margin: 20px 0 28px;
            text-align: center;
            font-weight: 600;
            font-size: 1.3rem;
            color: #4f3f20;
            border: 1px solid #ffdd9e;
            box-shadow: 0 6px 0 #b79357, 0 12px 22px -12px #b48b48;
            letter-spacing: 0.5px;
        }

        /* shift cards ‚Äì flatter, modern, with pastel accents */
        .shift-card {
            background: rgba(255, 251, 240, 0.7);
            border-radius: 36px;
            padding: 24px 24px;
            margin-bottom: 26px;
            border: 1px solid #f7dbb2;
            box-shadow: 0 10px 16px -12px #b69054, 0 4px 0 #cfaa70, 0 0 0 1px #ffeecc inset;
            transition: 0.15s;
        }

        .shift-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .shift-header span {
            font-size: 2.2rem;
            filter: drop-shadow(2px 2px 4px #ffdcaa);
        }

        .shift-header h3 {
            font-size: 1.7rem;
            font-weight: 500;
            color: #6b522b;
            letter-spacing: -0.3px;
        }

        .status-badge {
            padding: 12px 20px;
            border-radius: 80px;
            font-size: 1.05rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 24px;
            background: #fcf3e0;
            border: 1px solid #f5cf9b;
            box-shadow: inset 0 2px 5px #fae1b5, 0 3px 0 #b18548;
            color: #4f3a18;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge.open {
            background: #e3f2da;
            border-color: #a6c89a;
            box-shadow: inset 0 2px 5px #d5f0c5, 0 3px 0 #5e8746;
            color: #235d23;
        }

        .status-badge.closed {
            background: #ffe3e3;
            border-color: #f8b4b4;
            box-shadow: inset 0 2px 5px #ffd7d7, 0 3px 0 #b05a5a;
            color: #a23b3b;
        }

        .status-badge.pending {
            background: #fff0cf;
            border-color: #f5cf8c;
            box-shadow: inset 0 2px 5px #ffe6b3, 0 3px 0 #b88744;
            color: #8f6327;
        }

        .action-row {
            display: flex;
            gap: 14px;
        }

        .action-btn {
            flex: 1;
            padding: 15px 6px;
            border: none;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.05rem;
            background: white;
            color: #5c451e;
            border: 1px solid #f3cb93;
            box-shadow: 0 6px 0 #b18548, 0 6px 14px rgba(155, 115, 48, 0.25);
            cursor: pointer;
            transition: 0.1s;
            letter-spacing: 0.3px;
        }

        .action-btn:active:not(:disabled) {
            transform: translateY(5px);
            box-shadow: 0 1px 0 #b18548, 0 6px 14px rgba(133, 96, 36, 0.2);
        }

        .action-btn:disabled {
            opacity: 0.4;
            box-shadow: 0 3px 0 #997f50;
            transform: translateY(3px);
            background: #e8dac6;
            border-color: #c8a973;
            color: #6f562d;
            cursor: not-allowed;
        }

        .btn-open {
            background: #ecfae3;
            box-shadow: 0 6px 0 #59853d, 0 6px 14px #90b47b50;
            color: #276127;
            border-color: #abcf94;
        }

        .btn-close {
            background: #ffefea;
            box-shadow: 0 6px 0 #b15555, 0 6px 14px #d69b9b50;
            color: #aa3d3d;
            border-color: #f7adad;
        }

        .command-footer {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 24px;
        }

        .footer-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.1rem;
            background: #f6e4ce;
            color: #664a20;
            border: 1px solid #f5cf97;
            box-shadow: 0 7px 0 #b18548, 0 8px 16px #b4864a40;
            cursor: pointer;
            transition: 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .footer-btn:active {
            transform: translateY(6px);
            box-shadow: 0 1px 0 #b18548, 0 8px 16px #b1854840;
        }

        .footer-btn:disabled {
            opacity: 0.5;
            background: #dacbb4;
            box-shadow: 0 3px 0 #8c6f42;
            transform: translateY(4px);
            pointer-events: none;
        }

        #message {
            margin: 20px 0 8px;
            padding: 14px 20px;
            border-radius: 60px;
            text-align: center;
            font-weight: 500;
            display: none;
            border: 1px solid;
            backdrop-filter: blur(4px);
        }

        .success {
            background: #e3f0d4;
            color: #2d5a1e;
            border-color: #b4da8f;
            box-shadow: inset 0 2px 6px #dff0ca;
        }

        .error {
            background: #fadfdb;
            color: #923b2b;
            border-color: #fbbcac;
            box-shadow: inset 0 2px 6px #ffd3c9;
        }
    </style>
</head>
<body>
    <div class="command-panel">
        <!-- user hero: name & level always on top, prominent -->
        <div class="user-hero">
            <div class="user-info">
                <span class="user-name" id="displayName">loading...</span>
                <span class="user-level" id="displayLevel">‚óâ</span>
            </div>
            <button class="logout-btn" onclick="logout()">
                <span>‚Ü™</span> exit
            </button>
        </div>

        <!-- dynamic date display (shift-date) -->
        <div class="date-capsule" id="dateDisplay">üìÜ</div>

        <!-- feedback message area -->
        <div id="message"></div>

        <!-- morning shift card -->
        <div class="shift-card">
            <div class="shift-header">
                <span>‚òÄÔ∏è</span>
                <h3>morning</h3>
            </div>
            <div class="status-badge" id="morningStatus">pending</div>
            <div class="action-row">
                <button class="action-btn btn-open" id="openMorning" onclick="handleShift('morning', 'open')">open</button>
                <button class="action-btn btn-close" id="closeMorning" onclick="handleShift('morning', 'close')">close</button>
            </div>
        </div>

        <!-- evening shift card -->
        <div class="shift-card">
            <div class="shift-header">
                <span>üåô</span>
                <h3>evening</h3>
            </div>
            <div class="status-badge" id="eveningStatus">pending</div>
            <div class="action-row">
                <button class="action-btn btn-open" id="openEvening" onclick="handleShift('evening', 'open')">open</button>
                <button class="action-btn btn-close" id="closeEvening" onclick="handleShift('evening', 'close')">close</button>
            </div>
        </div>

        <!-- footer actions -->
        <div class="command-footer">
            <button class="footer-btn" onclick="loadTodayData()">‚Üª refresh status</button>
            <button class="footer-btn" id="resetBtn" onclick="supervisorReset()">‚úß new day reset (supervisor)</button>
        </div>
    </div>

    <script>
        // -------------------------------------------------------------
        // SHIFT MANAGER ‚Äì with user from localStorage (login page)
        // displays username & level prominently at top
        // -------------------------------------------------------------
        let currentUser = { username: 'guest', Level: 99, RCNo: '' };

        // load user data from localStorage (set by login.html)
        function loadSessionUser() {
            const stored = localStorage.getItem('loggedInUser');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    currentUser = {
                        username: parsed.username || 'unknown',
                        RCNo: parsed.RCNo || '',
                        Level: parsed.Level !== undefined ? parsed.Level : 99,
                        name: parsed.name || ''
                    };
                } catch (e) {
                    console.warn('invalid user in localStorage');
                }
            } else {
                currentUser = { username: 'not signed in', Level: 99, RCNo: '' };
            }

            // update top hero
            document.getElementById('displayName').textContent = currentUser.username;
            const levelEl = document.getElementById('displayLevel');
            let levelLabel = '';
            if (currentUser.Level == 1) levelLabel = 'SUPERVISOR';
            else if (currentUser.Level == 2) levelLabel = 'MANAGER';
            else if (currentUser.Level == 0) levelLabel = 'ADMIN';
            else levelLabel = `LEVEL ${currentUser.Level}`;
            levelEl.textContent = levelLabel;

            // reset button enabled only if Level == 1
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.disabled = (currentUser.Level != 1);
        }

        // logout
        window.logout = function() {
            localStorage.removeItem('loggedInUser');
            showMessage('logged out ¬∑ redirecting');
            setTimeout(() => {
                window.location.href = 'login.html'; // change if needed
            }, 1000);
        };

        // helper date
        function getLocalDate() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function showMessage(text, isError = false) {
            const msg = document.getElementById('message');
            msg.style.display = 'block';
            msg.textContent = text;
            msg.className = isError ? 'error' : 'success';
            setTimeout(() => msg.style.display = 'none', 2500);
        }

        // main UI update
        function updateUIBasedOnStatus(morningStatus, eveningStatus, storedDate) {
            const morningStat = document.getElementById('morningStatus');
            const openMorning = document.getElementById('openMorning');
            const closeMorning = document.getElementById('closeMorning');
            
            morningStat.textContent = morningStatus === 'open' ? 'üü¢ open' : 
                                    morningStatus === 'closed' ? 'üî¥ closed' : 'üü° pending';
            morningStat.className = `status-badge ${morningStatus}`;
            
            const eveningStat = document.getElementById('eveningStatus');
            const openEvening = document.getElementById('openEvening');
            const closeEvening = document.getElementById('closeEvening');
            
            eveningStat.textContent = eveningStatus === 'open' ? 'üü¢ open' : 
                                     eveningStatus === 'closed' ? 'üî¥ closed' : 'üü° pending';
            eveningStat.className = `status-badge ${eveningStatus}`;

            document.getElementById('dateDisplay').textContent = `üìÜ ${storedDate || getLocalDate()}`;

            // shift logic (same state machine)
            if (morningStatus === 'pending') {
                openMorning.disabled = false;
                closeMorning.disabled = true;
                openEvening.disabled = true;
                closeEvening.disabled = true;
            } else if (morningStatus === 'open') {
                openMorning.disabled = true;
                closeMorning.disabled = false;
                openEvening.disabled = true;
                closeEvening.disabled = true;
            } else if (morningStatus === 'closed') {
                openMorning.disabled = true;
                closeMorning.disabled = true;
                if (eveningStatus === 'pending') {
                    openEvening.disabled = false;
                    closeEvening.disabled = true;
                } else if (eveningStatus === 'open') {
                    openEvening.disabled = true;
                    closeEvening.disabled = false;
                } else if (eveningStatus === 'closed') {
                    openEvening.disabled = true;
                    closeEvening.disabled = true;
                }
            }
        }

        async function loadTodayData() {
            try {
                const doc = await db.collection('shifts').doc('currentshift').get();
                if (doc.exists) {
                    const data = doc.data();
                    const storedDate = data.date || getLocalDate();
                    updateUIBasedOnStatus(data.morning || 'pending', data.evening || 'pending', storedDate);
                } else {
                    updateUIBasedOnStatus('pending', 'pending', getLocalDate());
                }
            } catch (error) {
                console.error('Load error:', error);
                showMessage('error loading', true);
            }
        }

        async function handleShift(shift, action) {
            try {
                const doc = await db.collection('shifts').doc('currentshift').get();
                const currentData = doc.exists ? doc.data() : {};
                const existingDate = currentData.date;
                const todayStr = getLocalDate();
                let shiftDate = existingDate || todayStr;

                // validations
                if (shift === 'morning') {
                    if (action === 'open') {
                        if (currentData.morning === 'open') {
                            showMessage('morning already open!', true); return;
                        }
                        if (currentData.morning === 'closed' && existingDate === shiftDate) {
                            showMessage('morning already closed. supervisor reset needed.', true); return;
                        }
                    }
                    if (action === 'close' && currentData.morning !== 'open') {
                        showMessage('open morning first!', true); return;
                    }
                }

                if (shift === 'evening') {
                    if (currentData.morning !== 'closed') {
                        showMessage('close morning first!', true); return;
                    }
                    if (action === 'open') {
                        if (currentData.evening === 'open') {
                            showMessage('evening already open!', true); return;
                        }
                        if (currentData.evening === 'closed' && existingDate === shiftDate) {
                            showMessage('evening already closed.', true); return;
                        }
                    }
                    if (action === 'close' && currentData.evening !== 'open') {
                        showMessage('open evening first!', true); return;
                    }
                }

                const newStatus = action === 'open' ? 'open' : 'closed';
                const updateData = {
                    [shift]: newStatus,
                    updated: new Date().toLocaleString()
                };
                if (!existingDate) {
                    updateData.date = todayStr;
                } else {
                    updateData.date = existingDate;   // keep original shift date
                }

                await db.collection('shifts').doc('currentshift').set(updateData, { merge: true });
                showMessage(`‚ú® ${shift} ‚Üí ${newStatus}`);
                loadTodayData();

            } catch (error) {
                console.error('Save error:', error);
                showMessage('error saving', true);
            }
        }

        async function supervisorReset() {
            if (currentUser.Level != 1) {
                showMessage('only supervisor (level 1) can reset', true);
                return;
            }
            const today = getLocalDate();
            try {
                await db.collection('shifts').doc('currentshift').set({
                    morning: 'pending',
                    evening: 'pending',
                    date: today,
                    updated: new Date().toLocaleString()
                });
                showMessage('‚úÖ supervisor reset ¬∑ new day');
                loadTodayData();
            } catch (error) {
                showMessage('reset error', true);
            }
        }

        // expose globals
        window.handleShift = handleShift;
        window.loadTodayData = loadTodayData;
        window.supervisorReset = supervisorReset;

        // startup
        window.onload = () => {
            loadSessionUser();
            if (typeof db !== 'undefined') {
                loadTodayData();
            } else {
                showMessage('firebase unavailable', true);
            }
        };
    </script>
</body>
</html>
