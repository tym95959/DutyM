<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koveli Lounge ¬∑ shift manager</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shiftfire.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f2f4f8;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1.5rem;
        }

        /* professional card ‚Äì clean, sharp, neutral */
        .dashboard {
            width: 100%;
            max-width: 560px;
            background: #ffffff;
            border-radius: 28px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .dashboard-inner {
            padding: 2rem 2rem 2.25rem;
        }

        /* header with user info ‚Äì professional & compact */
        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9fafc;
            border-radius: 60px;
            padding: 0.6rem 0.6rem 0.6rem 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #edf0f5;
            box-shadow: inset 0 1px 3px #ffffff, 0 2px 4px rgba(0,0,0,0.02);
        }

        .user-details {
            display: flex;
            align-items: baseline;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .user-full {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .user-badge {
            background: #e9eef3;
            color: #2c3e50;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.8rem;
            border-radius: 30px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            border: 1px solid #d0d9e3;
        }

        .logout-btn {
            background: white;
            border: 1px solid #dae0e8;
            border-radius: 40px;
            padding: 0.45rem 1.2rem;
            font-size: 0.85rem;
            font-weight: 500;
            color: #3f4a5a;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .logout-btn:hover {
            background: #f1f4f9;
            border-color: #bcc6d2;
        }

        .date-panel {
            background: #f0f3f7;
            border-radius: 18px;
            padding: 0.9rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #dde3eb;
            color: #1e2b3c;
        }

        .date-label {
            font-weight: 500;
            color: #59748f;
            letter-spacing: 0.2px;
            font-size: 0.9rem;
        }

        .date-value {
            font-weight: 600;
            font-size: 1.25rem;
            background: white;
            padding: 0.2rem 1.2rem;
            border-radius: 40px;
            border: 1px solid #d1dbe8;
            box-shadow: inset 0 1px 3px #ffffff;
        }

        .shift-grid {
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
            margin: 2rem 0 1.5rem;
        }

        .shift-card {
            background: #f9fbfe;
            border-radius: 24px;
            padding: 1.6rem 1.8rem;
            border: 1px solid #e5eaf2;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }

        .shift-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .shift-title span {
            font-size: 1.9rem;
        }

        .shift-title h3 {
            font-weight: 550;
            font-size: 1.45rem;
            color: #1c2a3a;
            letter-spacing: -0.3px;
        }

        .status-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 60px;
            padding: 0.8rem 1.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 4px #f1f5f9;
            color: #2d3f55;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .status-box.open {
            background: #e6f2e6;
            border-color: #aacfae;
            color: #1d5e2b;
        }

        .status-box.closed {
            background: #fce9e9;
            border-color: #f3b5b5;
            color: #ab3c3c;
        }

        .status-box.pending {
            background: #fff4e0;
            border-color: #f5cf9b;
            color: #8f6327;
        }

        .button-group {
            display: flex;
            gap: 1rem;
        }

        .shift-btn {
            flex: 1;
            background: white;
            border: 1px solid #d2dceb;
            border-radius: 60px;
            padding: 0.9rem 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            color: #2c3f5c;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .shift-btn:hover:not(:disabled) {
            background: #f1f7ff;
            border-color: #a9bbd4;
        }

        .shift-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: none;
        }

        .shift-btn:disabled {
            opacity: 0.4;
            background: #f0f3f8;
            border-color: #d4deec;
            cursor: not-allowed;
        }

        .btn-open {
            background: #eaf2e9;
            border-color: #b9d2b9;
            color: #1d562d;
        }

        .btn-close {
            background: #fde9e7;
            border-color: #efc1c1;
            color: #a13b3b;
        }

        .footer-actions {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            margin-top: 2rem;
        }

        .action-btn {
            background: white;
            border: 1px solid #dbe2ec;
            border-radius: 60px;
            padding: 1rem 1.2rem;
            font-weight: 500;
            font-size: 1rem;
            color: #2f4057;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn:hover:not(:disabled) {
            background: #f6f9ff;
            border-color: #b7c7e0;
        }

        .action-btn.reset-btn:disabled {
            opacity: 0.35;
            background: #f0f4fc;
            border-color: #cbd5e6;
            cursor: not-allowed;
        }

        .message-area {
            margin: 1.5rem 0 0.5rem;
            padding: 1rem 1.2rem;
            border-radius: 60px;
            text-align: center;
            font-weight: 500;
            display: none;
            border: 1px solid;
            background: #f2f7ff;
        }

        .message-area.success {
            background: #e5f2e5;
            border-color: #aacfaa;
            color: #21672e;
        }

        .message-area.error {
            background: #fee9e7;
            border-color: #fbb3af;
            color: #ac3e2e;
        }

        hr {
            border: none;
            border-top: 1px solid #eef2f8;
            margin: 0.5rem 0 0.5rem;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="dashboard-inner">
            <!-- user header ‚Äì shows name & level exactly from localStorage -->
            <div class="user-header">
                <div class="user-details">
                    <div class="user-full">
                        <span class="user-name" id="displayUsername">loading...</span>
                        <span class="user-badge" id="displayLevelBadge">‚óè</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <span>‚á¢</span> sign out
                </button>
            </div>

            <!-- current shift date (preserved from firestore) -->
            <div class="date-panel">
                <span class="date-label">shift date</span>
                <span class="date-value" id="dateDisplay">‚Äî</span>
            </div>

            <!-- message feedback -->
            <div id="message" class="message-area"></div>

            <!-- morning shift -->
            <div class="shift-grid">
                <div class="shift-card">
                    <div class="shift-title">
                        <span>üåÖ</span>
                        <h3>morning shift</h3>
                    </div>
                    <div class="status-box" id="morningStatus">pending</div>
                    <div class="button-group">
                        <button class="shift-btn btn-open" id="openMorning" onclick="handleShift('morning', 'open')">open</button>
                        <button class="shift-btn btn-close" id="closeMorning" onclick="handleShift('morning', 'close')">close</button>
                    </div>
                </div>

                <!-- evening shift -->
                <div class="shift-card">
                    <div class="shift-title">
                        <span>üåÜ</span>
                        <h3>evening shift</h3>
                    </div>
                    <div class="status-box" id="eveningStatus">pending</div>
                    <div class="button-group">
                        <button class="shift-btn btn-open" id="openEvening" onclick="handleShift('evening', 'open')">open</button>
                        <button class="shift-btn btn-close" id="closeEvening" onclick="handleShift('evening', 'close')">close</button>
                    </div>
                </div>
            </div>

            <!-- footer controls -->
            <div class="footer-actions">
                <button class="action-btn" onclick="loadTodayData()">‚Üª refresh</button>
                <button class="action-btn reset-btn" id="resetBtn" onclick="supervisorReset()">‚óà new day reset (supervisor only)</button>
            </div>
            <hr>
            <div style="font-size: 0.75rem; color: #8a9bb5; text-align: center; margin-top: 0.5rem;">Koveli Lounge ¬∑ secure shift control</div>
        </div>
    </div>

    <script>
        // --------------------------------------------------------------------
        // PROFESSIONAL DASHBOARD ‚Äì reads loggedInUser from localStorage
        // shows name & level from stored data (set by login page)
        // --------------------------------------------------------------------
        let currentUser = { username: 'guest', Level: 99, RCNo: '' };

        function loadSessionUser() {
            const stored = localStorage.getItem('loggedInUser');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    currentUser = {
                        username: parsed.username || 'unknown',
                        RCNo: parsed.RCNo || '',
                        Level: parsed.Level !== undefined ? parsed.Level : 99,
                        name: parsed.name || ''
                    };
                } catch (e) {
                    console.warn('invalid user in localStorage');
                }
            } else {
                // if no user, set guest but also redirect maybe? we keep as is
                currentUser = { username: 'not logged in', Level: 99, RCNo: '' };
            }

            // update UI with name + level
            document.getElementById('displayUsername').textContent = currentUser.username;

            let levelText = '';
            if (currentUser.Level == 1) levelText = 'supervisor';
            else if (currentUser.Level == 2) levelText = 'manager';
            else if (currentUser.Level == 0) levelText = 'admin';
            else levelText = `level ${currentUser.Level}`;
            document.getElementById('displayLevelBadge').textContent = levelText;

            // reset button enabled only for Level 1 (supervisor)
            const resetBtn = document.getElementById('resetBtn');
            if (currentUser.Level == 1) {
                resetBtn.disabled = false;
            } else {
                resetBtn.disabled = true;
            }
        }

        // logout: clear and go to login page
        window.logout = function() {
            localStorage.removeItem('loggedInUser');
            showMessage('signed out ¬∑ redirecting', false);
            setTimeout(() => {
                window.location.href = 'login.html';  // adjust path if needed
            }, 1200);
        };

        // helpers
        function getLocalDate() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function showMessage(text, isError = false) {
            const msg = document.getElementById('message');
            msg.style.display = 'block';
            msg.textContent = text;
            msg.className = 'message-area ' + (isError ? 'error' : 'success');
            setTimeout(() => msg.style.display = 'none', 2500);
        }

        // UI updater
        function updateUIBasedOnStatus(morningStatus, eveningStatus, storedDate) {
            const morningStat = document.getElementById('morningStatus');
            const openMorning = document.getElementById('openMorning');
            const closeMorning = document.getElementById('closeMorning');
            
            morningStat.textContent = morningStatus === 'open' ? 'üü¢ open' : 
                                    morningStatus === 'closed' ? 'üî¥ closed' : 'üü° pending';
            morningStat.className = `status-box ${morningStatus}`;
            
            const eveningStat = document.getElementById('eveningStatus');
            const openEvening = document.getElementById('openEvening');
            const closeEvening = document.getElementById('closeEvening');
            
            eveningStat.textContent = eveningStatus === 'open' ? 'üü¢ open' : 
                                     eveningStatus === 'closed' ? 'üî¥ closed' : 'üü° pending';
            eveningStat.className = `status-box ${eveningStatus}`;

            document.getElementById('dateDisplay').textContent = storedDate || getLocalDate();

            // sequence logic (identical to original)
            if (morningStatus === 'pending') {
                openMorning.disabled = false;
                closeMorning.disabled = true;
                openEvening.disabled = true;
                closeEvening.disabled = true;
            } else if (morningStatus === 'open') {
                openMorning.disabled = true;
                closeMorning.disabled = false;
                openEvening.disabled = true;
                closeEvening.disabled = true;
            } else if (morningStatus === 'closed') {
                openMorning.disabled = true;
                closeMorning.disabled = true;
                if (eveningStatus === 'pending') {
                    openEvening.disabled = false;
                    closeEvening.disabled = true;
                } else if (eveningStatus === 'open') {
                    openEvening.disabled = true;
                    closeEvening.disabled = false;
                } else if (eveningStatus === 'closed') {
                    openEvening.disabled = true;
                    closeEvening.disabled = true;
                }
            }
        }

        async function loadTodayData() {
            try {
                const doc = await db.collection('shifts').doc('currentshift').get();
                if (doc.exists) {
                    const data = doc.data();
                    const storedDate = data.date || getLocalDate();
                    updateUIBasedOnStatus(data.morning || 'pending', data.evening || 'pending', storedDate);
                } else {
                    updateUIBasedOnStatus('pending', 'pending', getLocalDate());
                }
            } catch (error) {
                console.error('Load error:', error);
                showMessage('error loading data', true);
            }
        }

        async function handleShift(shift, action) {
            try {
                const doc = await db.collection('shifts').doc('currentshift').get();
                const currentData = doc.exists ? doc.data() : {};
                const existingDate = currentData.date;
                const todayStr = getLocalDate();
                let shiftDate = existingDate || todayStr;

                // validations (persistent date)
                if (shift === 'morning') {
                    if (action === 'open') {
                        if (currentData.morning === 'open') {
                            showMessage('morning already open!', true); return;
                        }
                        if (currentData.morning === 'closed' && existingDate === shiftDate) {
                            showMessage('morning closed for this day. supervisor reset.', true); return;
                        }
                    }
                    if (action === 'close' && currentData.morning !== 'open') {
                        showMessage('open morning first!', true); return;
                    }
                }

                if (shift === 'evening') {
                    if (currentData.morning !== 'closed') {
                        showMessage('close morning first!', true); return;
                    }
                    if (action === 'open') {
                        if (currentData.evening === 'open') {
                            showMessage('evening already open!', true); return;
                        }
                        if (currentData.evening === 'closed' && existingDate === shiftDate) {
                            showMessage('evening already closed.', true); return;
                        }
                    }
                    if (action === 'close' && currentData.evening !== 'open') {
                        showMessage('open evening first!', true); return;
                    }
                }

                const newStatus = action === 'open' ? 'open' : 'closed';
                const updateData = {
                    [shift]: newStatus,
                    updated: new Date().toLocaleString()
                };
                if (!existingDate) {
                    updateData.date = todayStr;
                } else {
                    updateData.date = existingDate;
                }

                await db.collection('shifts').doc('currentshift').set(updateData, { merge: true });
                showMessage(`${shift} ‚Üí ${newStatus}`);
                loadTodayData();

            } catch (error) {
                console.error('Save error:', error);
                showMessage('error saving', true);
            }
        }

        async function supervisorReset() {
            if (currentUser.Level != 1) {
                showMessage('only supervisor (level 1) can reset', true);
                return;
            }
            const today = getLocalDate();
            try {
                await db.collection('shifts').doc('currentshift').set({
                    morning: 'pending',
                    evening: 'pending',
                    date: today,
                    updated: new Date().toLocaleString()
                });
                showMessage('supervisor: new day reset');
                loadTodayData();
            } catch (error) {
                showMessage('reset error', true);
            }
        }

        // expose
        window.handleShift = handleShift;
        window.loadTodayData = loadTodayData;
        window.supervisorReset = supervisorReset;

        // init
        window.onload = () => {
            loadSessionUser();  // reads localStorage
            if (typeof db !== 'undefined') {
                loadTodayData();
            } else {
                showMessage('firebase unavailable', true);
            }
        };
    </script>
</body>
</html>
