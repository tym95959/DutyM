<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Koveli Lounge shift </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #fbf7e9 0%, #f5e7d3 100%);
            padding: 1rem;
        }

        .container {
            width: 440px;
            background: rgba(255, 250, 240, 0.75);
            backdrop-filter: blur(4px);
            border-radius: 36px;
            padding: 28px 24px;
            box-shadow: 0 20px 40px -10px rgba(196, 146, 70, 0.25),
                        0 0 0 1px rgba(255, 215, 140, 0.4) inset,
                        0 0 0 2px rgba(255, 242, 215, 0.6) inset;
            border: 1px solid #ffeac2;
        }

        .date {
            background: linear-gradient(115deg, #fff5df, #fdeece);
            color: #7a5c2e;
            font-weight: 600;
            font-size: 1.35rem;
            padding: 16px 12px;
            border-radius: 60px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 0 #dbb67b, 0 8px 12px -8px #d9b382;
            border: 1px solid #ffdd9e;
            letter-spacing: 0.3px;
        }

        /* supervisor badge / login info */
        .user-badge {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fcf3e0;
            border-radius: 40px;
            padding: 8px 16px 8px 20px;
            margin-bottom: 20px;
            border: 1px solid #f8d4a5;
            box-shadow: inset 0 1px 4px #fff3db, 0 2px 0 #e2bc84;
            font-weight: 500;
            color: #74592d;
        }

        .user-badge button {
            background: #f7d9aa;
            border: none;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 3px 0 #b88744;
            color: #533f1f;
            cursor: pointer;
            transition: 0.1s;
            border: 1px solid #edc690;
            flex: 0 0 auto;
        }

        .user-badge button:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #b88744;
        }

        .shift {
            background: rgba(255, 245, 225, 0.7);
            border-radius: 28px;
            padding: 22px 20px;
            margin-bottom: 24px;
            border: 1px solid #f8d9a8;
            box-shadow: 0 6px 0 #e5c294, 0 10px 18px -12px #b38b51;
            transition: 0.2s;
        }

        .shift-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .shift-header span {
            font-size: 2rem;
            filter: drop-shadow(0 2px 2px #ffcf9a);
        }

        .shift-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #936e2e, #b4843c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.3px;
        }

        .status {
            padding: 10px 16px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            background: #faf1dd;
            border: 1px solid #eeddbb;
            box-shadow: inset 0 2px 3px #f0ddc0, 0 3px 0 #c7a15e;
            color: #4a3a1f;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .status.open {
            background: #ebf7e4;
            border-color: #b8d9a6;
            box-shadow: inset 0 2px 3px #dceacd, 0 3px 0 #749b50;
            color: #2b6e2b;
        }

        .status.closed {
            background: #ffe8e8;
            border-color: #fbbdbd;
            box-shadow: inset 0 2px 3px #fedfdf, 0 3px 0 #b47373;
            color: #ac3a3a;
        }

        .status.pending {
            background: #fff2cf;
            border-color: #f5d797;
            box-shadow: inset 0 2px 3px #fbebc3, 0 3px 0 #bc8f4a;
            color: #8f6327;
        }

        .btn-group {
            display: flex;
            gap: 14px;
        }

        button {
            flex: 1;
            padding: 14px 8px;
            border: none;
            border-radius: 40px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
            background: white;
            color: #6b4e2a;
            border: 1px solid #f7cf9a;
            box-shadow: 0 5px 0 #d6a56b, 0 6px 12px rgba(184, 135, 65, 0.15);
            letter-spacing: 0.3px;
        }

        button:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #d6a56b, 0 6px 12px rgba(160, 115, 45, 0.1);
        }

        button:disabled {
            opacity: 0.45;
            box-shadow: 0 3px 0 #b5915f, 0 4px 8px rgba(128, 92, 41, 0.1);
            transform: translateY(2px);
            background: #f3e4d1;
            border-color: #dbbc8b;
            color: #7b623e;
            cursor: not-allowed;
        }

        .btn-open {
            background: #fef6e6;
            box-shadow: 0 5px 0 #699e4c, 0 6px 12px #b0b07a30;
            color: #2b6e2b;
            border-color: #aacf94;
        }

        .btn-open:hover:not(:disabled) {
            background: #f7ffec;
        }

        .btn-close {
            background: #ffefe7;
            box-shadow: 0 5px 0 #c25e5e, 0 6px 12px #dba1a130;
            color: #b13e3e;
            border-color: #fbb5b5;
        }

        .btn-close:hover:not(:disabled) {
            background: #ffe1d6;
        }

        .btn-refresh, .reset-btn {
            width: 100%;
            margin-top: 12px;
            padding: 16px;
            background: #f7e9d2;
            color: #7b592b;
            border: 1px solid #fad19e;
            box-shadow: 0 6px 0 #cb9f62, 0 8px 16px #b5824b30;
            font-size: 1.1rem;
        }

        .reset-btn {
            background: #fbe7c4;
            box-shadow: 0 6px 0 #cb9f62, 0 8px 16px #b5824b30;
        }

        .btn-refresh:hover:not(:disabled), .reset-btn:hover:not(:disabled) {
            background: #fef0da;
            transform: translateY(-1px);
            box-shadow: 0 7px 0 #cb9f62, 0 10px 20px #b5824b40;
        }

        .reset-btn:disabled {
            opacity: 0.5;
            background: #d9c6ac;
            box-shadow: 0 3px 0 #a58354;
            transform: translateY(3px);
        }

        #message {
            margin: 16px 0 22px;
            padding: 14px 16px;
            border-radius: 60px;
            text-align: center;
            font-weight: 500;
            display: none;
            border: 1px solid;
            backdrop-filter: blur(2px);
        }

        .success {
            background: #f1f9e8;
            color: #476b36;
            border-color: #bcdb9c;
            box-shadow: inset 0 1px 4px #e3ffcf;
        }

        .error {
            background: #ffedea;
            color: #9f4d4d;
            border-color: #feb3af;
            box-shadow: inset 0 1px 4px #ffd9d4;
        }

        .shift::after {
            content: '';
            display: block;
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #fdcd87, #fdaf5e, #fdcd87, transparent);
            border-radius: 4px;
            margin: 18px auto 2px;
            opacity: 0.7;
        }
        .shift:last-child::after { display: none; }
    </style>

    <!-- Firebase (same as original) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shiftfire.js"></script>
</head>
<body>
    <div class="container">
        <div class="date" id="dateDisplay">üìÖ loading...</div>
        
        <!-- simple login / user badge with supervisor flag stored in localStorage -->
        <div class="user-badge" id="userBadge">
            <span id="userDisplay">üë§ loading...</span>
            <button id="loginBtn" onclick="cycleUser()">switch user</button>
        </div>

        <div id="message"></div>
        
        <!-- morning shift -->
        <div class="shift">
            <div class="shift-header">
                <span>‚òÄÔ∏è</span>
                <h3>morning shift</h3>
            </div>
            <div class="status" id="morningStatus">pending</div>
            <div class="btn-group">
                <button class="btn-open" id="openMorning" onclick="handleShift('morning', 'open')">open</button>
                <button class="btn-close" id="closeMorning" onclick="handleShift('morning', 'close')">close</button>
            </div>
        </div>
        
        <!-- evening shift (was afternoon/evening) -->
        <div class="shift">
            <div class="shift-header">
                <span>üåô</span>
                <h3>evening shift</h3>
            </div>
            <div class="status" id="eveningStatus">pending</div>
            <div class="btn-group">
                <button class="btn-open" id="openEvening" onclick="handleShift('evening', 'open')">open</button>
                <button class="btn-close" id="closeEvening" onclick="handleShift('evening', 'close')">close</button>
            </div>
        </div>
        
        <button class="btn-refresh" onclick="loadTodayData()">‚ü≥ refresh</button>
        <!-- reset button: only enabled if supervisor -->
        <button class="reset-btn" id="resetBtn" onclick="supervisorReset()">‚ú® new day reset (supervisor)</button>
    </div>

    <script>
        // ---------- PERSISTENT SHIFT LOGIC + LOCALSTORAGE USER RIGHTS ----------
        // users: "operator" (default) , "supervisor"
        let currentUser = { name: 'operator', isSupervisor: false };

        // load from localStorage if exists
        function loadUserFromStorage() {
            const stored = localStorage.getItem('shiftManager_user');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    currentUser = parsed;
                } catch (e) {}
            } else {
                // default: operator
                currentUser = { name: 'operator', isSupervisor: false };
                localStorage.setItem('shiftManager_user', JSON.stringify(currentUser));
            }
            updateUserBadge();
        }

        function updateUserBadge() {
            const badge = document.getElementById('userDisplay');
            const resetBtn = document.getElementById('resetBtn');
            if (currentUser.isSupervisor) {
                badge.innerHTML = 'üëë supervisor';
                resetBtn.disabled = false;
            } else {
                badge.innerHTML = 'üë§ operator';
                resetBtn.disabled = true;
            }
        }

        // cycle between operator & supervisor (demo)
        window.cycleUser = function() {
            if (currentUser.isSupervisor) {
                currentUser = { name: 'operator', isSupervisor: false };
            } else {
                currentUser = { name: 'supervisor', isSupervisor: true };
            }
            localStorage.setItem('shiftManager_user', JSON.stringify(currentUser));
            updateUserBadge();
            showMessage(`switched to ${currentUser.name}`);
        };

        // today's date BUT we will NOT auto-advance if a shift is open.
        // The date shown is the date stored in the 'currentshift' document,
        // because the shift "belongs" to that day until closed.
        function getLocalDate() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function showMessage(text, isError = false) {
            const msg = document.getElementById('message');
            msg.style.display = 'block';
            msg.textContent = text;
            msg.className = isError ? 'error' : 'success';
            setTimeout(() => msg.style.display = 'none', 2500);
        }

        // UI updater using data from firestore (morningStatus, eveningStatus, storedDate)
        function updateUIBasedOnStatus(morningStatus, eveningStatus, storedDate) {
            const morningStat = document.getElementById('morningStatus');
            const openMorning = document.getElementById('openMorning');
            const closeMorning = document.getElementById('closeMorning');
            
            morningStat.textContent = morningStatus === 'open' ? 'üü¢ open' : 
                                    morningStatus === 'closed' ? 'üî¥ closed' : 'üü° pending';
            morningStat.className = `status ${morningStatus}`;
            
            const eveningStat = document.getElementById('eveningStatus');
            const openEvening = document.getElementById('openEvening');
            const closeEvening = document.getElementById('closeEvening');
            
            eveningStat.textContent = eveningStatus === 'open' ? 'üü¢ open' : 
                                     eveningStatus === 'closed' ? 'üî¥ closed' : 'üü° pending';
            eveningStat.className = `status ${eveningStatus}`;

            // DATE DISPLAY: always show the stored date (the day the shift belongs to)
            if (storedDate) {
                document.getElementById('dateDisplay').textContent = `üìÖ ${storedDate}`;
            } else {
                document.getElementById('dateDisplay').textContent = `üìÖ ${getLocalDate()}`;
            }

            // ----- SEQUENCE with persistent date rule -----
            // If morning is pending: only open morning enabled.
            if (morningStatus === 'pending') {
                openMorning.disabled = false;
                closeMorning.disabled = true;
                openEvening.disabled = true;
                closeEvening.disabled = true;
            } 
            else if (morningStatus === 'open') {
                openMorning.disabled = true;
                closeMorning.disabled = false;   // can close morning (completes the day)
                openEvening.disabled = true;      // evening not enabled until morning closed
                closeEvening.disabled = true;
            }
            else if (morningStatus === 'closed') {
                openMorning.disabled = true;
                closeMorning.disabled = true;
                
                // morning closed ‚Üí evening can be opened (regardless of date)
                if (eveningStatus === 'pending') {
                    openEvening.disabled = false;
                    closeEvening.disabled = true;
                }
                else if (eveningStatus === 'open') {
                    openEvening.disabled = true;
                    closeEvening.disabled = false;   // close evening finishes the whole day
                }
                else if (eveningStatus === 'closed') {
                    openEvening.disabled = true;
                    closeEvening.disabled = true;
                    // both shifts closed -> day is fully finished.
                    // (supervisor can reset to pending for new day)
                }
            }
        }

        // Load data: from "currentshift" ‚Äì we keep the date from the document.
        async function loadTodayData() {
            try {
                const doc = await db.collection('shifts').doc('currentshift').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    // use the stored date (even if it's old). That's the persistent date.
                    const storedDate = data.date || getLocalDate();
                    updateUIBasedOnStatus(data.morning || 'pending', data.evening || 'pending', storedDate);
                } else {
                    // no document: start with today, pending
                    const today = getLocalDate();
                    updateUIBasedOnStatus('pending', 'pending', today);
                }
            } catch (error) {
                console.error('Load error:', error);
                showMessage('Error loading data', true);
            }
        }

        // Handle shift open/close
        async function handleShift(shift, action) {
            try {
                // get current document
                const doc = await db.collection('shifts').doc('currentshift').get();
                const currentData = doc.exists ? doc.data() : {};
                
                // The date we persist: if there's already a date in the doc, we keep it.
                // If it's a brand new doc (no date), we set it to today.
                const existingDate = currentData.date;
                const todayStr = getLocalDate();
                
                // Determine the effective date for this shift (never auto-advance)
                let shiftDate = existingDate || todayStr;

                // --- validation rules ---
                if (shift === 'morning') {
                    if (action === 'open') {
                        if (currentData.morning === 'open') {
                            showMessage('morning already open!', true); return;
                        }
                        if (currentData.morning === 'closed' && existingDate === shiftDate) {
                            // morning already closed today (same date) -> cannot open again unless supervisor reset
                            showMessage('morning already closed for this day. supervisor can reset.', true); return;
                        }
                        // If morning is pending or undefined, allowed.
                    }
                    if (action === 'close' && currentData.morning !== 'open') {
                        showMessage('open morning first!', true); return;
                    }
                }

                if (shift === 'evening') {
                    // For evening: morning must be closed (in the stored document)
                    if (currentData.morning !== 'closed') {
                        showMessage('close morning first!', true); return;
                    }
                    if (action === 'open') {
                        if (currentData.evening === 'open') {
                            showMessage('evening already open!', true); return;
                        }
                        if (currentData.evening === 'closed' && existingDate === shiftDate) {
                            showMessage('evening already closed for this day.', true); return;
                        }
                    }
                    if (action === 'close' && currentData.evening !== 'open') {
                        showMessage('open evening first!', true); return;
                    }
                }

                // new status
                const newStatus = action === 'open' ? 'open' : 'closed';
                
                // preserve the existing date! do NOT update to today automatically.
                // only set date if it's missing (first creation)
                const updateData = {
                    [shift]: newStatus,
                    updated: new Date().toLocaleString()
                };
                if (!existingDate) {
                    updateData.date = todayStr;   // set initial date only once
                } else {
                    // keep the original shift date (so if it's 15th, remains 15th)
                    updateData.date = existingDate;
                }

                // merge into firestore
                await db.collection('shifts').doc('currentshift').set(updateData, { merge: true });
                
                showMessage(`‚ú® ${shift} shift ${newStatus} (date preserved: ${updateData.date})`);
                loadTodayData();
                
            } catch (error) {
                console.error('Save error:', error);
                showMessage('Error saving', true);
            }
        }

        // SUPERVISOR RESET: only if currentUser.isSupervisor === true
        async function supervisorReset() {
            if (!currentUser.isSupervisor) {
                showMessage('only supervisor can reset', true);
                return;
            }

            const today = getLocalDate();
            try {
                // Reset both shifts to pending AND set date to today (new day)
                const updateData = {
                    morning: 'pending',
                    evening: 'pending',
                    date: today,
                    updated: new Date().toLocaleString()
                };
                
                await db.collection('shifts').doc('currentshift').set(updateData);
                showMessage('‚úÖ supervisor reset ¬∑ new day started');
                loadTodayData();
            } catch (error) {
                showMessage('Error resetting', true);
            }
        }

        // Override resetForNewDay to point to supervisorReset (preserve old function name for button, but we call supervisorReset)
        window.resetForNewDay = function() {
            supervisorReset();
        };

        // initial load
        window.onload = () => {
            loadUserFromStorage();
            if (typeof db !== 'undefined') {
                loadTodayData();
            } else {
                showMessage('firebase not connected', true);
            }
        };
    </script>
</body>
</html>
