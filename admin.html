<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Leeli Announcements</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .admin-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        header h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .admin-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .announcement-history {
            margin-top: 30px;
        }
        
        .history-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .announcement-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .announcement-item h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .announcement-item p {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .announcement-item .meta {
            display: flex;
            justify-content: space-between;
            color: #888;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status.sent {
            background: #d4edda;
            color: #155724;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4757;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
        }
        
        .notification-test {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            display: flex;
            gap: 10px;
        }
        
        .notification-test input {
            flex: 1;
        }
        
        .notification-test button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .success-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
    </style>
</head>
<body>
    <a href="#" class="logout-btn" id="logoutBtn">Logout</a>
    
    <div class="success-message" id="successMessage">
        Announcement sent successfully! âœ“
    </div>
    
    <div class="admin-container">
        <header>
            <h1>ðŸ”§ Admin Panel</h1>
            <p>Send announcements to all users</p>
        </header>
        
        <div class="admin-form">
            <div class="form-group">
                <label for="announcementTitle">Title</label>
                <input type="text" id="announcementTitle" placeholder="Enter announcement title" maxlength="100">
            </div>
            
            <div class="form-group">
                <label for="announcementMessage">Message</label>
                <textarea id="announcementMessage" placeholder="Enter announcement message"></textarea>
            </div>
            
            <div class="form-group">
                <label for="announcementPriority">
                    <input type="checkbox" id="announcementPriority">
                    High Priority (Send push notification)
                </label>
            </div>
            
            <button class="btn" id="sendAnnouncement">
                ðŸ“¢ Send Announcement
            </button>
            
            <div class="notification-test">
                <input type="text" id="testToken" placeholder="Enter device token for testing">
                <button id="testNotification">Test Notification</button>
            </div>
        </div>
        
        <div class="announcement-history">
            <h2 class="history-title">ðŸ“œ Announcement History</h2>
            <div id="announcementsList">
                <div class="announcement-item">
                    <h3>System Ready</h3>
                    <p>Announcement system is now active.</p>
                    <div class="meta">
                        <span>Just now</span>
                        <span class="status sent">Sent</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { 
            db, 
            collection, 
            addDoc, 
            serverTimestamp,
            query,
            orderBy,
            onSnapshot,
            getDocs
        } from './dcfire.js';

        // Admin credentials (In production, use Firebase Authentication)
        const ADMIN_PASSWORD = 'leeli2024';

        // Check admin authentication
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('admin_authenticated');
            if (!isAuthenticated) {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    localStorage.setItem('admin_authenticated', 'true');
                } else {
                    alert('Access denied');
                    window.location.href = 'index.html';
                }
            }
        }

        // Send announcement
        async function sendAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            const priority = document.getElementById('announcementPriority').checked;
            
            if (!title || !message) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                // Save to Firestore
                const docRef = await addDoc(collection(db, 'announcements'), {
                    title: title,
                    message: message,
                    priority: priority,
                    timestamp: serverTimestamp(),
                    sentBy: 'Admin'
                });
                
                console.log('Announcement saved with ID:', docRef.id);
                
                // If priority is checked, send push notification
                if (priority) {
                    await sendPushNotification(title, message);
                }
                
                // Show success message
                showSuccessMessage();
                
                // Clear form
                document.getElementById('announcementTitle').value = '';
                document.getElementById('announcementMessage').value = '';
                document.getElementById('announcementPriority').checked = false;
                
            } catch (error) {
                console.error('Error sending announcement:', error);
                alert('Error sending announcement. Please try again.');
            }
        }

        // Send push notification (using Firebase Cloud Functions)
        async function sendPushNotification(title, message) {
            try {
                // This requires a Firebase Cloud Function
                // For now, we'll just log it
                console.log('Sending push notification:', { title, message });
                
                // In production, you would call your Cloud Function
                // const response = await fetch('https://your-region-your-project.cloudfunctions.net/sendNotification', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify({
                //         title: title,
                //         body: message,
                //         data: {
                //             type: 'announcement',
                //             priority: 'high'
                //         }
                //     })
                // });
                
            } catch (error) {
                console.error('Error sending push notification:', error);
            }
        }

        // Load announcement history
        function loadAnnouncementHistory() {
            const announcementsRef = collection(db, 'announcements');
            const q = query(announcementsRef, orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('announcementsList');
                list.innerHTML = '';
                
                if (snapshot.empty) {
                    list.innerHTML = '<div class="announcement-item">No announcements yet</div>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'announcement-item';
                    item.innerHTML = `
                        <h3>${data.title}</h3>
                        <p>${data.message}</p>
                        <div class="meta">
                            <span>${formatTime(data.timestamp?.toDate()) || 'Sending...'}</span>
                            <span class="status ${data.priority ? 'sent' : 'pending'}">
                                ${data.priority ? 'Push Sent' : 'In-app Only'}
                            </span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        // Format timestamp
        function formatTime(date) {
            if (!date) return '';
            return date.toLocaleString();
        }

        // Show success message
        function showSuccessMessage() {
            const message = document.getElementById('successMessage');
            message.style.display = 'block';
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        // Test notification
        async function testNotification() {
            const token = document.getElementById('testToken').value.trim();
            if (!token) {
                alert('Please enter a device token');
                return;
            }
            
            // Call Cloud Function to send test notification
            console.log('Sending test notification to:', token);
            alert('Test notification would be sent to: ' + token);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadAnnouncementHistory();
            
            // Event listeners
            document.getElementById('sendAnnouncement').addEventListener('click', sendAnnouncement);
            document.getElementById('testNotification').addEventListener('click', testNotification);
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('admin_authenticated');
                window.location.href = 'index.html';
            });
            
            // Allow Enter key to send announcement
            document.getElementById('announcementMessage').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    sendAnnouncement();
                }
            });
        });

        // Auto-save draft
        setInterval(() => {
            const title = document.getElementById('announcementTitle').value;
            const message = document.getElementById('announcementMessage').value;
            if (title || message) {
                localStorage.setItem('announcement_draft', JSON.stringify({ title, message }));
            }
        }, 5000);

        // Load draft
        const draft = localStorage.getItem('announcement_draft');
        if (draft) {
            const { title, message } = JSON.parse(draft);
            document.getElementById('announcementTitle').value = title;
            document.getElementById('announcementMessage').value = message;
        }

    </script>
</body>
</html>
