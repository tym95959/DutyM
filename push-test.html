<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Real-time Notification Tester (WebSocket)</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; padding: 20px; text-align: center; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { background: white; border-bottom: 3px solid #4facfe; color: #4facfe; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-left: 10px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-danger { background: #f8d7da; color: #721c24; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; margin: 10px 0; }
        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, textarea, select { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        textarea { min-height: 120px; resize: vertical; font-family: monospace; }
        .token-display { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; font-family: monospace; font-size: 14px; word-break: break-all; max-height: 100px; overflow-y: auto; }
        .notification-list { max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .notification-item { padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #f8f9fa; border-left: 4px solid #4facfe; animation: slideIn 0.3s ease; }
        .notification-title { font-weight: 600; margin-bottom: 5px; color: #2c3e50; }
        .notification-body { color: #6c757d; margin-bottom: 5px; }
        .notification-time { font-size: 12px; color: #adb5bd; text-align: right; }
        .copy-btn { background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-left: 10px; }
        .copy-btn:hover { background: #5a6268; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 600px) { .container { border-radius: 15px; } .header { padding: 20px; } .tab-content { padding: 20px; } .btn { padding: 12px 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Real-time Notification Tester</h1>
            <p>Send and receive notifications between devices instantly (No CORS!)</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('receive')">üì≤ Receive</div>
            <div class="tab" onclick="switchTab('send')">üì§ Send</div>
            <div class="tab" onclick="switchTab('status')">üìä Status</div>
        </div>
        
        <!-- RECEIVE TAB -->
        <div class="tab-content active" id="receiveTab">
            <div class="card">
                <h3><span>üîî</span> Your Device Status</h3>
                <div id="statusMessage">Initializing WebSocket connection...</div>
                
                <div class="input-group">
                    <label>Your Device ID:</label>
                    <div class="token-display" id="deviceId">Generating...</div>
                    <button class="copy-btn" onclick="copyDeviceId()">Copy</button>
                </div>
                
                <button class="btn btn-primary" onclick="initWebSocket()" id="initBtn">
                    <span>üîó</span> Connect to Server
                </button>
                
                <div class="input-group" id="connectionStatus" style="display: none;">
                    <label>Connection Status:</label>
                    <div class="status-badge" id="connectionBadge">Disconnected</div>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üì®</span> Received Notifications</h3>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item">
                        <div class="notification-title">Waiting for notifications...</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîó</span> Share This Device</h3>
                <p>Share your Device ID with others so they can send you notifications:</p>
                <div class="input-group">
                    <label>Your Device ID to Share:</label>
                    <input type="text" id="shareDeviceId" readonly>
                    <button class="copy-btn" onclick="copyDeviceId()">Copy ID</button>
                </div>
                <p><small>Others can enter your Device ID in the Send tab to send you notifications</small></p>
            </div>
        </div>
        
        <!-- SEND TAB -->
        <div class="tab-content" id="sendTab">
            <div class="card">
                <h3><span>üì§</span> Send Notification</h3>
                
                <div class="input-group">
                    <label>Target Device ID:</label>
                    <input type="text" id="targetDeviceId" placeholder="Enter the target device's ID">
                </div>
                
                <div class="input-group">
                    <label>Notification Title:</label>
                    <input type="text" id="sendTitle" value="Test Notification" placeholder="Enter notification title">
                </div>
                
                <div class="input-group">
                    <label>Notification Message:</label>
                    <textarea id="sendMessage" placeholder="Enter notification message">Hello from another device! üì±</textarea>
                </div>
                
                <div class="input-group">
                    <label>Notification Type:</label>
                    <select id="notificationType">
                        <option value="test">Test</option>
                        <option value="alert">Alert</option>
                        <option value="message">Message</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="sendWebSocketNotification()" id="sendBtn">
                    <span>üì§</span> Send via WebSocket
                </button>
                
                <div id="sendResult"></div>
            </div>
            
            <div class="card">
                <h3><span>üì±</span> Recent Devices</h3>
                <div id="recentDevices">
                    <p>Devices you've sent to will appear here</p>
                </div>
            </div>
        </div>
        
        <!-- STATUS TAB -->
        <div class="tab-content" id="statusTab">
            <div class="card">
                <h3><span>üìä</span> System Status</h3>
                <div id="systemStatus">
                    <p>Loading system status...</p>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîÑ</span> Test Tools</h3>
                <button class="btn btn-primary" onclick="testSelfNotification()">
                    <span>üß™</span> Send Test to Yourself
                </button>
                <button class="btn" onclick="clearNotifications()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>üóëÔ∏è</span> Clear All Notifications
                </button>
                <button class="btn btn-danger" onclick="resetAll()" style="margin-top: 10px;">
                    <span>üîÑ</span> Reset Everything
                </button>
            </div>
        </div>
    </div>

    <script>
        // WebSocket server URL - Using free public WebSocket servers
        // Option 1: ws-server (free, no registration needed)
        const WS_SERVER = "wss://ws.postman-echo.com/raw";
        // Option 2: Your own server (recommended for production)
        // const WS_SERVER = "wss://your-server.com/ws";
        
        // Global variables
        let ws = null;
        let deviceId = null;
        let isConnected = false;
        let notifications = [];
        let recentDevices = [];
        
        // Generate unique device ID
        function generateDeviceId() {
            return "device_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
        }
        
        // Initialize WebSocket connection
        function initWebSocket() {
            const initBtn = document.getElementById("initBtn");
            initBtn.disabled = true;
            initBtn.innerHTML = '<span>‚è≥</span> Connecting...';
            
            try {
                // Close existing connection if any
                if (ws) {
                    ws.close();
                }
                
                updateStatus("Connecting to WebSocket server...", "warning");
                
                // Create WebSocket connection
                ws = new WebSocket(WS_SERVER);
                
                ws.onopen = function() {
                    console.log("‚úÖ WebSocket connected");
                    isConnected = true;
                    
                    document.getElementById("connectionBadge").textContent = "Connected";
                    document.getElementById("connectionBadge").className = "status-badge status-success";
                    document.getElementById("connectionStatus").style.display = "block";
                    
                    initBtn.innerHTML = '<span>‚úÖ</span> Connected';
                    initBtn.className = "btn btn-success";
                    
                    updateStatus("‚úÖ Connected to server! You can now send/receive notifications.", "success");
                    
                    // Send registration message
                    const registerMsg = {
                        type: "register",
                        deviceId: deviceId,
                        timestamp: Date.now()
                    };
                    ws.send(JSON.stringify(registerMsg));
                    
                    playSound("success");
                };
                
                ws.onmessage = function(event) {
                    console.log("üì® Received message:", event.data);
                    try {
                        const data = JSON.parse(event.data);
                        handleIncomingMessage(data);
                    } catch (e) {
                        // Handle raw message
                        handleIncomingMessage(event.data);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error("‚ùå WebSocket error:", error);
                    updateStatus("WebSocket error. Trying fallback server...", "danger");
                    
                    // Try fallback server
                    setTimeout(() => {
                        tryFallbackServer();
                    }, 1000);
                };
                
                ws.onclose = function() {
                    console.log("üîå WebSocket disconnected");
                    isConnected = false;
                    
                    document.getElementById("connectionBadge").textContent = "Disconnected";
                    document.getElementById("connectionBadge").className = "status-badge status-danger";
                    
                    initBtn.disabled = false;
                    initBtn.innerHTML = '<span>üîó</span> Reconnect';
                    initBtn.className = "btn btn-primary";
                    
                    updateStatus("Disconnected from server. Click 'Reconnect' to try again.", "warning");
                    
                    // Try to reconnect after 5 seconds
                    setTimeout(() => {
                        if (!isConnected) {
                            initWebSocket();
                        }
                    }, 5000);
                };
                
            } catch (error) {
                console.error("‚ùå WebSocket init error:", error);
                updateStatus(`Connection error: ${error.message}`, "danger");
                initBtn.disabled = false;
                initBtn.innerHTML = '<span>üîó</span> Connect to Server';
                playSound("error");
            }
        }
        
        // Try fallback WebSocket server
        function tryFallbackServer() {
            const fallbackServers = [
                "wss://echo.websocket.org",
                "wss://ws.ifelse.io",
                "wss://demos.kaazing.com/echo"
            ];
            
            for (const server of fallbackServers) {
                try {
                    console.log(`Trying fallback server: ${server}`);
                    ws = new WebSocket(server);
                    ws.onopen = function() {
                        console.log(`‚úÖ Connected to fallback server: ${server}`);
                        isConnected = true;
                        updateStatus(`‚úÖ Connected to fallback server`, "success");
                    };
                    break;
                } catch (e) {
                    console.log(`Fallback server ${server} failed:`, e);
                }
            }
        }
        
        // Handle incoming messages
        function handleIncomingMessage(data) {
            // Check if it's a notification
            if (typeof data === 'object' && data.type === 'notification') {
                showNotification(data);
            } else if (typeof data === 'string' && data.includes('"type":"notification"')) {
                // Try to parse as JSON
                try {
                    const parsed = JSON.parse(data);
                    if (parsed.type === 'notification') {
                        showNotification(parsed);
                    }
                } catch (e) {
                    // If it's just text, treat as notification
                    showNotification({
                        title: "Message Received",
                        message: data,
                        type: "info"
                    });
                }
            } else if (typeof data === 'string') {
                // Plain text message
                showNotification({
                    title: "Message Received",
                    message: data,
                    type: "info"
                });
            }
        }
        
        // Send notification via WebSocket
        function sendWebSocketNotification() {
            const sendBtn = document.getElementById("sendBtn");
            const sendResult = document.getElementById("sendResult");
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span>‚è≥</span> Sending...';
            sendResult.innerHTML = "";
            
            try {
                if (!isConnected || !ws) {
                    throw new Error("Not connected to server. Please connect first.");
                }
                
                const targetDeviceId = document.getElementById("targetDeviceId").value.trim();
                const title = document.getElementById("sendTitle").value.trim();
                const message = document.getElementById("sendMessage").value.trim();
                const type = document.getElementById("notificationType").value;
                
                if (!targetDeviceId) {
                    throw new Error("Please enter a target Device ID");
                }
                
                if (!title) {
                    throw new Error("Please enter a title");
                }
                
                if (!message) {
                    throw new Error("Please enter a message");
                }
                
                // Create notification message
                const notification = {
                    type: "notification",
                    from: deviceId,
                    to: targetDeviceId,
                    title: title,
                    message: message,
                    notificationType: type,
                    timestamp: Date.now()
                };
                
                console.log("Sending notification:", notification);
                
                // Send via WebSocket
                ws.send(JSON.stringify(notification));
                
                // Add to recent devices
                addRecentDevice(targetDeviceId, title);
                
                // Show success
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                        <div class="notification-title">‚úÖ Notification Sent!</div>
                        <div class="notification-body">To: ${targetDeviceId}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚úÖ Notification sent to ${targetDeviceId}`, "success");
                playSound("success");
                
                // Add to sent history
                addNotification(`Sent: ${title}`, `To: ${targetDeviceId}`, "sent");
                
            } catch (error) {
                console.error("‚ùå Send error:", error);
                
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #f8d7da; border-left-color: #dc3545;">
                        <div class="notification-title">‚ùå Failed to Send</div>
                        <div class="notification-body">${error.message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚ùå Send failed: ${error.message}`, "danger");
                playSound("error");
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>üì§</span> Send via WebSocket';
            }
        }
        
        // Show received notification
        function showNotification(data) {
            const title = data.title || "Notification";
            const message = data.message || data.body || "New notification";
            const type = data.notificationType || data.type || "info";
            const from = data.from ? `From: ${data.from}` : "";
            
            addNotification(title, `${message} ${from}`, type);
            
            // Show browser notification
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: message,
                    icon: "https://cdn-icons-png.flaticon.com/512/733/733585.png",
                    vibrate: [200, 100, 200]
                });
            }
            
            playSound("notification");
            updateStatus(`üì® Received: ${title}`, "success");
        }
        
        // Add notification to list
        function addNotification(title, body, type = "info") {
            const notification = {
                id: Date.now(),
                title: title,
                body: body,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString()
            };
            
            notifications.unshift(notification);
            localStorage.setItem("notifications", JSON.stringify(notifications.slice(0, 50)));
            updateNotificationList();
        }
        
        // Update notification list UI
        function updateNotificationList() {
            const list = document.getElementById("notificationList");
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-item">
                        <div class="notification-title">No notifications yet</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = "";
            notifications.slice(0, 20).forEach(notif => {
                const item = document.createElement("div");
                item.className = `notification-item ${notif.type === 'test' ? 'new' : ''}`;
                item.innerHTML = `
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-body">${notif.body}</div>
                    <div class="notification-time">${notif.timestamp} ‚Ä¢ ${notif.date}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Add recent device
        function addRecentDevice(deviceId, lastMessage) {
            recentDevices = recentDevices.filter(d => d.deviceId !== deviceId);
            recentDevices.unshift({
                deviceId: deviceId,
                lastMessage: lastMessage,
                lastSent: new Date().toLocaleTimeString()
            });
            recentDevices = recentDevices.slice(0, 5);
            localStorage.setItem("recentDevices", JSON.stringify(recentDevices));
            updateRecentDevices();
        }
        
        // Update recent devices UI
        function updateRecentDevices() {
            const container = document.getElementById("recentDevices");
            
            if (recentDevices.length === 0) {
                container.innerHTML = "<p>No recent devices. Send a notification first.</p>";
                return;
            }
            
            container.innerHTML = "";
            recentDevices.forEach(device => {
                const div = document.createElement("div");
                div.className = "notification-item";
                div.innerHTML = `
                    <div class="notification-title">${device.deviceId.substring(0, 30)}...</div>
                    <div class="notification-body">Last: ${device.lastMessage}</div>
                    <div class="notification-time">${device.lastSent}</div>
                    <button class="copy-btn" onclick="document.getElementById('targetDeviceId').value='${device.deviceId}'; switchTab('send');">Use</button>
                `;
                container.appendChild(div);
            });
        }
        
        // Update status message
        function updateStatus(message, type = "info") {
            const statusEl = document.getElementById("statusMessage");
            statusEl.innerHTML = `<div class="status-badge status-${type}">${message}</div>`;
        }
        
        // Update system status
        function updateSystemStatus() {
            const systemStatus = document.getElementById("systemStatus");
            
            systemStatus.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>Device ID:</strong> ${deviceId || "Not set"}</div>
                    <div><strong>Connection:</strong> ${isConnected ? "‚úÖ Connected" : "‚ùå Disconnected"}</div>
                    <div><strong>WebSocket:</strong> ${ws ? "‚úÖ Initialized" : "‚ùå Not initialized"}</div>
                    <div><strong>Notifications:</strong> ${notifications.length} received</div>
                    <div><strong>Server:</strong> ${WS_SERVER}</div>
                    <div><strong>Protocol:</strong> WebSocket</div>
                </div>
            `;
        }
        
        // Utility functions
        function switchTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabName + "Tab").classList.add("active");
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
        }
        
        function copyDeviceId() {
            navigator.clipboard.writeText(deviceId);
            updateStatus("Device ID copied to clipboard!", "success");
        }
        
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (type === "success") playBeep(audioContext, 800, 0.3);
                else if (type === "error") playBeep(audioContext, 400, 0.3);
                else if (type === "notification") {
                    playBeep(audioContext, 600, 0.2);
                    setTimeout(() => playBeep(audioContext, 800, 0.2), 100);
                }
            } catch (e) {}
        }
        
        function playBeep(audioContext, frequency, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = "sine";
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Test functions
        function testSelfNotification() {
            document.getElementById("targetDeviceId").value = deviceId;
            document.getElementById("sendTitle").value = "Test to Yourself";
            document.getElementById("sendMessage").value = "This is a test notification sent to yourself!";
            document.getElementById("notificationType").value = "test";
            
            switchTab("send");
            
            setTimeout(() => {
                document.getElementById("sendBtn").click();
            }, 500);
        }
        
        function clearNotifications() {
            if (confirm("Clear all notifications?")) {
                notifications = [];
                localStorage.removeItem("notifications");
                updateNotificationList();
                updateStatus("All notifications cleared", "warning");
            }
        }
        
        function resetAll() {
            if (confirm("Reset everything? This will clear all data and restart.")) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // Initialize on load
        window.onload = function() {
            console.log("üöÄ WebSocket Notification Tester Loaded");
            
            // Request notification permission
            if ("Notification" in window) {
                Notification.requestPermission();
            }
            
            // Generate or load device ID
            deviceId = localStorage.getItem("deviceId") || generateDeviceId();
            localStorage.setItem("deviceId", deviceId);
            
            // Load saved data
            notifications = JSON.parse(localStorage.getItem("notifications") || "[]");
            recentDevices = JSON.parse(localStorage.getItem("recentDevices") || "[]");
            
            // Update UI
            document.getElementById("deviceId").textContent = deviceId;
            document.getElementById("shareDeviceId").value = deviceId;
            
            updateNotificationList();
            updateRecentDevices();
            updateSystemStatus();
            
            // Check URL for target parameter
            const urlParams = new URLSearchParams(window.location.search);
            const target = urlParams.get('sendTo');
            if (target) {
                document.getElementById("targetDeviceId").value = target;
                switchTab("send");
            }
            
            // Auto-connect after 1 second
            setTimeout(() => {
                initWebSocket();
            }, 1000);
        };
    </script>
</body>
</html>
