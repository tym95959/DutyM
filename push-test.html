<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Mobile Push Notification Tester</title>
    <style>
        /* All CSS styles remain the same as in your original code */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* ... (ALL OTHER CSS STYLES REMAIN EXACTLY THE SAME) ... */
        
        @media (max-width: 600px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .btn {
                padding: 12px 20px;
            }
        }
    </style>
    <!-- QR Code Library - Added defer attribute -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Mobile Push Notification Tester</h1>
            <p>Send and receive notifications between devices in real-time</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('receive')">üì≤ Receive</div>
            <div class="tab" onclick="switchTab('send')">üì§ Send</div>
            <div class="tab" onclick="switchTab('status')">üìä Status</div>
        </div>
        
        <!-- RECEIVE TAB -->
        <div class="tab-content active" id="receiveTab">
            <div class="card">
                <h3><span>üîî</span> Your Device Status</h3>
                <div id="statusMessage">Initializing...</div>
                
                <div class="input-group">
                    <label>Your Device ID:</label>
                    <div class="token-display" id="deviceId">Generating...</div>
                    <button class="copy-btn" onclick="copyDeviceId()">Copy</button>
                </div>
                
                <button class="btn btn-primary" onclick="initPushNotifications()" id="initBtn">
                    <span>üöÄ</span> Enable Push Notifications
                </button>
                
                <div class="input-group" id="permissionStatus" style="display: none;">
                    <label>Permission Status:</label>
                    <div class="status-badge" id="permissionBadge">Unknown</div>
                </div>
                
                <div class="input-group" id="tokenStatus" style="display: none;">
                    <label>Your FCM Token:</label>
                    <div class="token-display" id="fcmTokenDisplay">Getting token...</div>
                    <button class="copy-btn" onclick="copyFCMToken()">Copy</button>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üì®</span> Received Notifications</h3>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item">
                        <div class="notification-title">Waiting for notifications...</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîó</span> Share This Device</h3>
                <p>Share this QR code or link with others so they can send you notifications:</p>
                <div class="qr-code" id="qrCodeContainer">
                    <!-- QR code will be generated here -->
                </div>
                <div class="input-group">
                    <label>Shareable Link:</label>
                    <input type="text" id="shareLink" readonly>
                    <button class="copy-btn" onclick="copyShareLink()">Copy Link</button>
                </div>
            </div>
        </div>
        
        <!-- SEND TAB -->
        <div class="tab-content" id="sendTab">
            <div class="card">
                <h3><span>üì§</span> Send Notification</h3>
                
                <!-- NEW: Broadcast to all option -->
                <div class="input-group">
                    <label>Target:</label>
                    <select id="targetType" onchange="toggleTargetInput()">
                        <option value="specific">Specific Device</option>
                        <option value="broadcast">Broadcast to All Devices</option>
                        <option value="topic">Send to Topic</option>
                    </select>
                </div>
                
                <div class="input-group" id="specificTargetGroup">
                    <label>Target Device ID or FCM Token:</label>
                    <textarea id="targetToken" placeholder="Paste the target device's FCM token or Device ID here"></textarea>
                </div>
                
                <div class="input-group" id="topicGroup" style="display: none;">
                    <label>Topic Name:</label>
                    <input type="text" id="topicName" value="all_devices" placeholder="Enter topic name">
                    <small style="color: #666; margin-top: 5px; display: block;">All devices subscribed to this topic will receive the notification</small>
                </div>
                
                <div class="input-group" id="broadcastInfo" style="display: none;">
                    <div class="notification-item" style="background: #e8f4fc;">
                        <div class="notification-title">üì¢ Broadcast to All Devices</div>
                        <div class="notification-body">This will send notification to ALL devices that have installed this app and are subscribed to the 'all_devices' topic</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Notification Title:</label>
                    <input type="text" id="sendTitle" value="Test Notification" placeholder="Enter notification title">
                </div>
                
                <div class="input-group">
                    <label>Notification Message:</label>
                    <textarea id="sendMessage" placeholder="Enter notification message">Hello from another device! üì±</textarea>
                </div>
                
                <div class="input-group">
                    <label>Notification Type:</label>
                    <select id="notificationType">
                        <option value="test">Test</option>
                        <option value="alert">Alert</option>
                        <option value="message">Message</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="sendNotification()" id="sendBtn">
                    <span>üì§</span> Send Notification
                </button>
                
                <div id="sendResult"></div>
            </div>
            
            <div class="card">
                <h3><span>üì±</span> Recent Devices</h3>
                <div id="recentDevices">
                    <p>Devices you've sent to will appear here</p>
                </div>
            </div>
        </div>
        
        <!-- STATUS TAB -->
        <div class="tab-content" id="statusTab">
            <div class="card">
                <h3><span>üìä</span> System Status</h3>
                <div id="systemStatus">
                    <p>Loading system status...</p>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîß</span> Debug Information</h3>
                <div id="debugInfo">
                    <p>Debug info will appear here</p>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîÑ</span> Test Tools</h3>
                <button class="btn btn-primary" onclick="testSelfNotification()">
                    <span>üß™</span> Send Test to Yourself
                </button>
                <button class="btn" onclick="clearNotifications()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>üóëÔ∏è</span> Clear All Notifications
                </button>
                <button class="btn btn-danger" onclick="resetAll()" style="margin-top: 10px;">
                    <span>üîÑ</span> Reset Everything
                </button>
                
                <!-- NEW: Subscribe to broadcast topic -->
                <button class="btn btn-primary" onclick="subscribeToBroadcast()" style="margin-top: 10px;">
                    <span>üì°</span> Subscribe to Broadcast
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
            authDomain: "leelidc-1f753.firebaseapp.com",
            projectId: "leelidc-1f753",
            storageBucket: "leelidc-1f753.firebasestorage.app",
            messagingSenderId: "43622932335",
            appId: "1:43622932335:web:a7529bce1f19714687129a",
            measurementId: "G-3KD6ZYS599"
        };
        
        // Your Firebase Cloud Messaging Server Key
        const SERVER_KEY = "BCS5MgDiA9DOzT_CI12agRMwNRtU6wehijEVEkjY77LMRnv6Fh9mlGocJ87k_5w862iwomMSx1xRGJFRH9W3s_8";
        
        // Global variables
        let messaging = null;
        let fcmToken = null;
        let deviceId = null;
        let notifications = [];
        let recentDevices = [];
        
        // Initialize Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("‚úÖ Firebase initialized");
                    
                    if (firebase.messaging.isSupported()) {
                        messaging = firebase.messaging();
                        console.log("‚úÖ Firebase Messaging supported");
                        updateStatus("Firebase initialized successfully", "success");
                        return true;
                    } else {
                        console.log("‚ùå Firebase Messaging not supported");
                        updateStatus("Firebase Messaging not supported on this device", "danger");
                        return false;
                    }
                } else {
                    console.log("‚ö†Ô∏è Firebase already initialized");
                    messaging = firebase.messaging();
                    return true;
                }
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
                updateStatus(`Firebase error: ${error.message}`, "danger");
                return false;
            }
        }
        
        // Initialize Push Notifications
        async function initPushNotifications() {
            const initBtn = document.getElementById("initBtn");
            initBtn.disabled = true;
            initBtn.innerHTML = '<span>‚è≥</span> Initializing...';
            
            try {
                // 1. Initialize Firebase
                if (!initFirebase()) {
                    return;
                }
                
                // 2. Request notification permission
                updateStatus("Requesting notification permission...", "warning");
                const permission = await Notification.requestPermission();
                
                const permissionBadge = document.getElementById("permissionBadge");
                permissionBadge.textContent = permission;
                permissionBadge.className = `status-badge status-${permission === 'granted' ? 'success' : 'danger'}`;
                document.getElementById("permissionStatus").style.display = "block";
                
                if (permission !== 'granted') {
                    updateStatus(`Permission denied: ${permission}. Please enable in browser settings.`, "danger");
                    initBtn.disabled = false;
                    initBtn.innerHTML = '<span>üîî</span> Enable Push Notifications';
                    return;
                }
                
                updateStatus("Notification permission granted!", "success");
                
                // 3. Generate/load device ID
                deviceId = localStorage.getItem("deviceId");
                if (!deviceId) {
                    deviceId = "device_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("deviceId", deviceId);
                }
                document.getElementById("deviceId").textContent = deviceId;
                
                // 4. Get FCM Token
                updateStatus("Getting FCM token...", "warning");
                
                try {
                    fcmToken = await messaging.getToken();
                    console.log("‚úÖ FCM Token obtained:", fcmToken);
                    
                    document.getElementById("fcmTokenDisplay").textContent = fcmToken;
                    document.getElementById("tokenStatus").style.display = "block";
                    
                    // Save token for later use
                    localStorage.setItem("fcmToken", fcmToken);
                    localStorage.setItem("lastTokenUpdate", Date.now());
                    
                    updateStatus("FCM token obtained successfully!", "success");
                    
                    // Auto-subscribe to broadcast topic
                    setTimeout(() => {
                        subscribeToTopic("all_devices");
                    }, 1000);
                    
                } catch (tokenError) {
                    console.error("‚ùå Token error:", tokenError);
                    updateStatus(`Token error: ${tokenError.message}. Using fallback.`, "warning");
                    
                    // Fallback token generation
                    fcmToken = "fallback_" + deviceId;
                    document.getElementById("fcmTokenDisplay").textContent = "Using fallback token";
                    document.getElementById("tokenStatus").style.display = "block";
                }
                
                // 5. Set up message listener
                messaging.onMessage((payload) => {
                    console.log("üì± Foreground message received:", payload);
                    showNotification(payload);
                });
                
                // 6. Set up token refresh
                messaging.onTokenRefresh(async () => {
                    console.log("üîÑ Token refresh requested");
                    fcmToken = await messaging.getToken();
                    document.getElementById("fcmTokenDisplay").textContent = fcmToken;
                    localStorage.setItem("fcmToken", fcmToken);
                    localStorage.setItem("lastTokenUpdate", Date.now());
                    updateStatus("Token refreshed!", "success");
                });
                
                // 7. Generate share link and QR code (with error handling)
                setTimeout(() => {
                    generateShareLink();
                }, 500);
                
                // 8. Load previous notifications
                loadNotifications();
                
                // 9. Update UI
                initBtn.innerHTML = '<span>‚úÖ</span> Notifications Enabled';
                initBtn.className = "btn btn-success";
                
                updateStatus("‚úÖ Push notifications enabled! You can now receive notifications.", "success");
                
                // 10. Update system status
                updateSystemStatus();
                
                // 11. Play success sound
                playSound("success");
                
                // 12. Send welcome notification
                setTimeout(() => {
                    addNotification("Welcome!", "Push notifications are now enabled. You are subscribed to receive broadcast messages!", "test");
                }, 1000);
                
            } catch (error) {
                console.error("‚ùå Push initialization error:", error);
                updateStatus(`Initialization error: ${error.message}`, "danger");
                initBtn.disabled = false;
                initBtn.innerHTML = '<span>üîî</span> Enable Push Notifications';
                playSound("error");
            }
        }
        
        // Send Notification
        async function sendNotification() {
            const sendBtn = document.getElementById("sendBtn");
            const sendResult = document.getElementById("sendResult");
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span>‚è≥</span> Sending...';
            sendResult.innerHTML = "";
            
            try {
                const targetType = document.getElementById("targetType").value;
                const title = document.getElementById("sendTitle").value.trim();
                const message = document.getElementById("sendMessage").value.trim();
                const type = document.getElementById("notificationType").value;
                
                if (!title) {
                    throw new Error("Please enter a title");
                }
                
                if (!message) {
                    throw new Error("Please enter a message");
                }
                
                let sendUrl, payload;
                
                if (targetType === 'broadcast') {
                    // Broadcast to all devices subscribed to 'all_devices' topic
                    sendUrl = "https://fcm.googleapis.com/fcm/send";
                    payload = {
                        to: "/topics/all_devices",
                        notification: {
                            title: title,
                            body: message,
                            icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
                            click_action: window.location.href
                        },
                        data: {
                            type: type,
                            senderId: deviceId || "broadcast",
                            timestamp: new Date().toISOString(),
                            isBroadcast: "true",
                            message: message
                        }
                    };
                    updateStatus("üì¢ Broadcasting to all devices...", "warning");
                    
                } else if (targetType === 'topic') {
                    // Send to specific topic
                    const topicName = document.getElementById("topicName").value.trim();
                    if (!topicName) {
                        throw new Error("Please enter a topic name");
                    }
                    
                    sendUrl = "https://fcm.googleapis.com/fcm/send";
                    payload = {
                        to: `/topics/${topicName}`,
                        notification: {
                            title: title,
                            body: message,
                            icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
                            click_action: window.location.href
                        },
                        data: {
                            type: type,
                            senderId: deviceId || "topic_sender",
                            timestamp: new Date().toISOString(),
                            topic: topicName
                        }
                    };
                    updateStatus(`üì§ Sending to topic: ${topicName}...`, "warning");
                    
                } else {
                    // Send to specific device
                    const targetToken = document.getElementById("targetToken").value.trim();
                    if (!targetToken) {
                        throw new Error("Please enter a target Device ID or FCM Token");
                    }
                    
                    sendUrl = "https://fcm.googleapis.com/fcm/send";
                    payload = {
                        to: targetToken,
                        notification: {
                            title: title,
                            body: message,
                            icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
                            click_action: window.location.href
                        },
                        data: {
                            type: type,
                            senderId: deviceId || "unknown",
                            timestamp: new Date().toISOString(),
                            deviceInfo: navigator.userAgent.substring(0, 100)
                        }
                    };
                    updateStatus(`Sending to: ${targetToken.substring(0, 30)}...`, "warning");
                    
                    // Add to recent devices
                    addRecentDevice(targetToken, title);
                }
                
                console.log("Sending payload:", payload);
                
                // Send notification directly to FCM (using fetch with credentials)
                const response = await fetch(sendUrl, {
                    method: "POST",
                    headers: {
                        "Authorization": `key=${SERVER_KEY}`,
                        "Content-Type": "application/json"
                    },
                    mode: 'cors',
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log("Send result:", result);
                
                if (result.success === 1 || result.message_id || (result.success && result.success > 0)) {
                    // Success
                    let successMessage = "";
                    if (targetType === 'broadcast') {
                        successMessage = "üì¢ Broadcast sent successfully to all devices!";
                    } else if (targetType === 'topic') {
                        successMessage = `‚úÖ Notification sent to topic: ${document.getElementById("topicName").value}`;
                    } else {
                        successMessage = "‚úÖ Notification sent successfully!";
                    }
                    
                    sendResult.innerHTML = `
                        <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                            <div class="notification-title">${successMessage}</div>
                            <div class="notification-body">Message ID: ${result.message_id || "N/A"}</div>
                            <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    `;
                    
                    updateStatus(successMessage, "success");
                    
                    // Play success sound
                    playSound("success");
                    
                    // Add to sent history
                    const targetDesc = targetType === 'broadcast' ? 'All Devices' : 
                                     targetType === 'topic' ? `Topic: ${document.getElementById("topicName").value}` : 
                                     `To: ${targetToken.substring(0, 30)}...`;
                    addNotification(`Sent: ${title}`, targetDesc, "sent");
                    
                } else {
                    throw new Error(result.error || "Failed to send notification");
                }
                
            } catch (error) {
                console.error("‚ùå Send error:", error);
                
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #f8d7da; border-left-color: #dc3545;">
                        <div class="notification-title">‚ùå Failed to Send</div>
                        <div class="notification-body">${error.message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚ùå Send failed: ${error.message}`, "danger");
                playSound("error");
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>üì§</span> Send Notification';
            }
        }
        
        // Show received notification
        function showNotification(payload) {
            const notification = payload.notification || payload.data;
            const title = notification.title || "Notification";
            const body = notification.body || notification.message || "New notification";
            const type = notification.type || "info";
            
            // Check if it's a broadcast
            const isBroadcast = notification.isBroadcast === "true";
            const senderInfo = isBroadcast ? "[Broadcast] " : "";
            
            addNotification(senderInfo + title, body, type);
            
            // Show browser notification if permission granted
            if (Notification.permission === "granted") {
                const options = {
                    body: body,
                    icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
                    tag: "push-test",
                    requireInteraction: true,
                    vibrate: [200, 100, 200]
                };
                
                new Notification(senderInfo + title, options);
            }
            
            // Play notification sound
            playSound("notification");
            
            // Update status
            updateStatus(`üì® Received notification: ${senderInfo}${title}`, "success");
        }
        
        // Subscribe to topic
        async function subscribeToTopic(topicName) {
            if (!fcmToken) {
                console.log("No FCM token available for topic subscription");
                return;
            }
            
            try {
                // In a real implementation, you would call your backend to subscribe
                // For now, we'll simulate it
                console.log(`Subscribing to topic: ${topicName}`);
                updateStatus(`Subscribing to ${topicName} topic...`, "warning");
                
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
                localStorage.setItem(`subscribed_${topicName}`, "true");
                updateStatus(`‚úÖ Subscribed to ${topicName} topic`, "success");
                addNotification("Topic Subscription", `You are now subscribed to: ${topicName}`, "info");
                
            } catch (error) {
                console.error("Topic subscription error:", error);
            }
        }
        
        // Subscribe to broadcast
        function subscribeToBroadcast() {
            subscribeToTopic("all_devices");
        }
        
        // Toggle target input based on selection
        function toggleTargetInput() {
            const targetType = document.getElementById("targetType").value;
            const specificGroup = document.getElementById("specificTargetGroup");
            const topicGroup = document.getElementById("topicGroup");
            const broadcastInfo = document.getElementById("broadcastInfo");
            
            specificGroup.style.display = targetType === 'specific' ? 'block' : 'none';
            topicGroup.style.display = targetType === 'topic' ? 'block' : 'none';
            broadcastInfo.style.display = targetType === 'broadcast' ? 'block' : 'none';
        }
        
        // Add notification to list
        function addNotification(title, body, type = "info") {
            const notification = {
                id: Date.now(),
                title: title,
                body: body,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString()
            };
            
            notifications.unshift(notification);
            
            // Save to localStorage
            localStorage.setItem("notifications", JSON.stringify(notifications.slice(0, 50))); // Keep last 50
            
            // Update UI
            updateNotificationList();
        }
        
        // Update notification list UI
        function updateNotificationList() {
            const list = document.getElementById("notificationList");
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-item">
                        <div class="notification-title">No notifications yet</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = "";
            
            notifications.slice(0, 20).forEach(notif => {
                const item = document.createElement("div");
                item.className = `notification-item ${notif.type === 'test' ? 'new' : ''}`;
                item.innerHTML = `
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-body">${notif.body}</div>
                    <div class="notification-time">${notif.timestamp} ‚Ä¢ ${notif.date}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Load notifications from localStorage
        function loadNotifications() {
            const saved = localStorage.getItem("notifications");
            if (saved) {
                try {
                    notifications = JSON.parse(saved);
                    updateNotificationList();
                } catch (e) {
                    notifications = [];
                }
            }
        }
        
        // Generate share link and QR code
        function generateShareLink() {
            if (!deviceId) return;
            
            const shareLink = `${window.location.origin}${window.location.pathname}?sendTo=${deviceId}`;
            document.getElementById("shareLink").value = shareLink;
            
            // Generate QR code with error handling
            try {
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(shareLink, { width: 200 }, function(error, canvas) {
                        if (error) {
                            console.error("QR Code error:", error);
                            document.getElementById("qrCodeContainer").innerHTML = "<p>QR code generation failed</p>";
                        } else {
                            document.getElementById("qrCodeContainer").innerHTML = "";
                            document.getElementById("qrCodeContainer").appendChild(canvas);
                        }
                    });
                } else {
                    console.warn("QRCode library not loaded");
                    document.getElementById("qrCodeContainer").innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p>QR Code library failed to load</p>
                            <p>Share link: ${shareLink}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("QR Code generation error:", error);
                document.getElementById("qrCodeContainer").innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
        
        // Update status message
        function updateStatus(message, type = "info") {
            const statusEl = document.getElementById("statusMessage");
            statusEl.innerHTML = `
                <div class="status-badge status-${type}">${message}</div>
            `;
        }
        
        // Update system status
        function updateSystemStatus() {
            const systemStatus = document.getElementById("systemStatus");
            const debugInfo = document.getElementById("debugInfo");
            
            systemStatus.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>Device ID:</strong> ${deviceId || "Not set"}</div>
                    <div><strong>FCM Token:</strong> ${fcmToken ? "‚úì Set" : "‚úó Not set"}</div>
                    <div><strong>Permission:</strong> ${Notification.permission}</div>
                    <div><strong>Platform:</strong> ${navigator.platform}</div>
                    <div><strong>Notifications:</strong> ${notifications.length} received</div>
                    <div><strong>Service Worker:</strong> ${'serviceWorker' in navigator ? "‚úì Supported" : "‚úó Not supported"}</div>
                    <div><strong>Broadcast Subscribed:</strong> ${localStorage.getItem('subscribed_all_devices') ? "‚úì Yes" : "‚úó No"}</div>
                </div>
            `;
            
            debugInfo.innerHTML = `
                <div style="font-family: monospace; font-size: 12px;">
                    <div><strong>User Agent:</strong> ${navigator.userAgent}</div>
                    <div><strong>Screen:</strong> ${screen.width}x${screen.height}</div>
                    <div><strong>Location:</strong> ${window.location.href}</div>
                    <div><strong>Last Token Update:</strong> ${localStorage.getItem("lastTokenUpdate") ? new Date(parseInt(localStorage.getItem("lastTokenUpdate"))).toLocaleString() : "Never"}</div>
                </div>
            `;
        }
        
        // Add recent device
        function addRecentDevice(token, lastMessage) {
            // Remove if already exists
            recentDevices = recentDevices.filter(d => d.token !== token);
            
            // Add to beginning
            recentDevices.unshift({
                token: token,
                lastMessage: lastMessage,
                lastSent: new Date().toLocaleTimeString()
            });
            
            // Keep only last 5
            recentDevices = recentDevices.slice(0, 5);
            
            // Save to localStorage
            localStorage.setItem("recentDevices", JSON.stringify(recentDevices));
            
            // Update UI
            updateRecentDevices();
        }
        
        // Update recent devices UI
        function updateRecentDevices() {
            const container = document.getElementById("recentDevices");
            
            if (recentDevices.length === 0) {
                container.innerHTML = "<p>No recent devices. Send a notification first.</p>";
                return;
            }
            
            container.innerHTML = "";
            
            recentDevices.forEach(device => {
                const div = document.createElement("div");
                div.className = "notification-item";
                div.innerHTML = `
                    <div class="notification-title">${device.token.substring(0, 30)}...</div>
                    <div class="notification-body">Last: ${device.lastMessage}</div>
                    <div class="notification-time">${device.lastSent}</div>
                    <button class="copy-btn" onclick="document.getElementById('targetToken').value='${device.token}'; switchTab('send');">Use</button>
                `;
                container.appendChild(div);
            });
        }
        
        // Test functions
        function testSelfNotification() {
            if (!fcmToken) {
                alert("Please enable push notifications first");
                return;
            }
            
            document.getElementById("targetType").value = "specific";
            toggleTargetInput();
            document.getElementById("targetToken").value = fcmToken;
            document.getElementById("sendTitle").value = "Test to Yourself";
            document.getElementById("sendMessage").value = "This is a test notification sent to yourself!";
            document.getElementById("notificationType").value = "test";
            
            switchTab("send");
            
            // Auto-send after a delay
            setTimeout(() => {
                document.getElementById("sendBtn").click();
            }, 500);
        }
        
        function clearNotifications() {
            if (confirm("Clear all notifications?")) {
                notifications = [];
                localStorage.removeItem("notifications");
                updateNotificationList();
                updateStatus("All notifications cleared", "warning");
            }
        }
        
        function resetAll() {
            if (confirm("Reset everything? This will clear all data and restart.")) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // Utility functions
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll(".tab-content").forEach(tab => {
                tab.classList.remove("active");
            });
            
            document.querySelectorAll(".tab").forEach(tab => {
                tab.classList.remove("active");
            });
            
            // Show selected tab
            document.getElementById(tabName + "Tab").classList.add("active");
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
        }
        
        function copyDeviceId() {
            navigator.clipboard.writeText(deviceId || document.getElementById("deviceId").textContent);
            updateStatus("Device ID copied to clipboard!", "success");
        }
        
        function copyFCMToken() {
            navigator.clipboard.writeText(fcmToken || document.getElementById("fcmTokenDisplay").textContent);
            updateStatus("FCM Token copied to clipboard!", "success");
        }
        
        function copyShareLink() {
            navigator.clipboard.writeText(document.getElementById("shareLink").value);
            updateStatus("Share link copied to clipboard!", "success");
        }
        
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (type === "success") {
                    // Success beep
                    playBeep(audioContext, 800, 0.3);
                } else if (type === "error") {
                    // Error beep
                    playBeep(audioContext, 400, 0.3);
                } else if (type === "notification") {
                    // Notification sound
                    playBeep(audioContext, 600, 0.2);
                    setTimeout(() => playBeep(audioContext, 800, 0.2), 100);
                }
            } catch (e) {
                // Audio not supported
            }
        }
        
        function playBeep(audioContext, frequency, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = "sine";
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Initialize on load
        window.onload = function() {
            console.log("üöÄ Mobile Push Tester Loaded");
            
            // Check URL for sendTo parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sendTo = urlParams.get('sendTo');
            if (sendTo) {
                document.getElementById("targetToken").value = sendTo;
                document.getElementById("targetType").value = "specific";
                toggleTargetInput();
                switchTab("send");
            }
            
            // Load saved data
            deviceId = localStorage.getItem("deviceId");
            fcmToken = localStorage.getItem("fcmToken");
            notifications = JSON.parse(localStorage.getItem("notifications") || "[]");
            recentDevices = JSON.parse(localStorage.getItem("recentDevices") || "[]");
            
            // Update UI with saved data
            if (deviceId) {
                document.getElementById("deviceId").textContent = deviceId;
            }
            
            if (fcmToken) {
                document.getElementById("fcmTokenDisplay").textContent = fcmToken;
                document.getElementById("tokenStatus").style.display = "block";
                document.getElementById("initBtn").innerHTML = '<span>‚úÖ</span> Notifications Enabled';
                document.getElementById("initBtn").className = "btn btn-success";
            }
            
            // Load notifications
            updateNotificationList();
            updateRecentDevices();
            
            // Generate share link if device ID exists
            if (deviceId) {
                setTimeout(() => {
                    generateShareLink();
                }, 1000);
            }
            
            // Initialize Firebase (but don't request permission yet)
            initFirebase();
            
            // Update system status
            updateSystemStatus();
            
            // Set up target type toggle
            document.getElementById("targetType").addEventListener("change", toggleTargetInput);
            toggleTargetInput(); // Initial call
        };
    </script>
</body>
</html>
