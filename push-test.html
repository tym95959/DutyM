<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Mobile Push Notification Tester</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background: white;
            border-bottom: 3px solid #4facfe;
            color: #4facfe;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h3 span {
            font-size: 20px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }
        
        .token-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .notification-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-left: 4px solid #4facfe;
            animation: slideIn 0.3s ease;
        }
        
        .notification-item.new {
            background: #e8f4fc;
            border-left-color: #2196f3;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .notification-body {
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 12px;
            color: #adb5bd;
            text-align: right;
        }
        
        .device-id {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #5a6268;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code img {
            max-width: 200px;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @media (max-width: 600px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .btn {
                padding: 12px 20px;
            }
        }
    </style>
    <!-- Load QRCode library properly -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Mobile Push Notification Tester</h1>
            <p>Send and receive notifications between devices in real-time</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('receive')">üì≤ Receive</div>
            <div class="tab" onclick="switchTab('send')">üì§ Send</div>
            <div class="tab" onclick="switchTab('status')">üìä Status</div>
        </div>
        
        <!-- RECEIVE TAB -->
        <div class="tab-content active" id="receiveTab">
            <div class="card">
                <h3><span>üîî</span> Your Device Status</h3>
                <div id="statusMessage">Initializing...</div>
                
                <div class="input-group">
                    <label>Your Device ID:</label>
                    <div class="token-display" id="deviceId">Generating...</div>
                    <button class="copy-btn" onclick="copyDeviceId()">Copy</button>
                </div>
                
                <button class="btn btn-primary" onclick="initPushNotifications()" id="initBtn">
                    <span>üöÄ</span> Enable Push Notifications
                </button>
                
                <div class="input-group" id="permissionStatus" style="display: none;">
                    <label>Permission Status:</label>
                    <div class="status-badge" id="permissionBadge">Unknown</div>
                </div>
                
                <div class="input-group" id="tokenStatus" style="display: none;">
                    <label>Your FCM Token:</label>
                    <div class="token-display" id="fcmTokenDisplay">Getting token...</div>
                    <button class="copy-btn" onclick="copyFCMToken()">Copy</button>
                </div>
                
                <div class="input-group" id="serviceWorkerStatus" style="display: none;">
                    <label>Service Worker:</label>
                    <div class="status-badge" id="serviceWorkerBadge">Checking...</div>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üì®</span> Received Notifications</h3>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item">
                        <div class="notification-title">Waiting for notifications...</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîó</span> Share This Device</h3>
                <p>Share this QR code or link with others so they can send you notifications:</p>
                <div class="qr-code" id="qrCodeContainer">
                    <!-- QR code will be generated here -->
                </div>
                <div class="input-group">
                    <label>Shareable Link:</label>
                    <input type="text" id="shareLink" readonly>
                    <button class="copy-btn" onclick="copyShareLink()">Copy Link</button>
                </div>
            </div>
        </div>
        
        <!-- SEND TAB -->
        <div class="tab-content" id="sendTab">
            <div class="card">
                <h3><span>üì§</span> Send Notification</h3>
                
                <div class="input-group">
                    <label>Target:</label>
                    <select id="targetType" onchange="toggleTargetInput()">
                        <option value="specific">Specific Device</option>
                        <option value="broadcast">Broadcast to All Devices</option>
                        <option value="topic">Send to Topic</option>
                    </select>
                </div>
                
                <div class="input-group" id="specificTargetGroup">
                    <label>Target Device ID or FCM Token:</label>
                    <textarea id="targetToken" placeholder="Paste the target device's FCM token or Device ID here"></textarea>
                </div>
                
                <div class="input-group" id="topicGroup" style="display: none;">
                    <label>Topic Name:</label>
                    <input type="text" id="topicName" value="all_devices" placeholder="Enter topic name">
                    <small style="color: #666; margin-top: 5px; display: block;">All devices subscribed to this topic will receive the notification</small>
                </div>
                
                <div class="input-group" id="broadcastInfo" style="display: none;">
                    <div class="notification-item" style="background: #e8f4fc;">
                        <div class="notification-title">üì¢ Broadcast to All Devices</div>
                        <div class="notification-body">This will send notification to ALL devices that have installed this app and are subscribed to the 'all_devices' topic</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Notification Title:</label>
                    <input type="text" id="sendTitle" value="Test Notification" placeholder="Enter notification title">
                </div>
                
                <div class="input-group">
                    <label>Notification Message:</label>
                    <textarea id="sendMessage" placeholder="Enter notification message">Hello from another device! üì±</textarea>
                </div>
                
                <div class="input-group">
                    <label>Notification Type:</label>
                    <select id="notificationType">
                        <option value="test">Test</option>
                        <option value="alert">Alert</option>
                        <option value="message">Message</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="sendRealNotification()" id="sendBtn">
                    <span>üì§</span> Send Real Notification
                </button>
                
                <button class="btn btn-primary" onclick="sendDemoNotification()" id="sendBtnDemo" style="margin-top: 10px;">
                    <span>üß™</span> Send Demo Notification
                </button>
                
                <div id="sendResult"></div>
            </div>
            
            <div class="card">
                <h3><span>üì±</span> Recent Devices</h3>
                <div id="recentDevices">
                    <p>Devices you've sent to will appear here</p>
                </div>
            </div>
        </div>
        
        <!-- STATUS TAB -->
        <div class="tab-content" id="statusTab">
            <div class="card">
                <h3><span>üìä</span> System Status</h3>
                <div id="systemStatus">
                    <p>Loading system status...</p>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîß</span> Debug Information</h3>
                <div id="debugInfo">
                    <p>Debug info will appear here</p>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîÑ</span> Test Tools</h3>
                <button class="btn btn-primary" onclick="testSelfNotification()">
                    <span>üß™</span> Send Test to Yourself
                </button>
                <button class="btn" onclick="clearNotifications()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>üóëÔ∏è</span> Clear All Notifications
                </button>
                <button class="btn btn-danger" onclick="resetAll()" style="margin-top: 10px;">
                    <span>üîÑ</span> Reset Everything
                </button>
                
                <button class="btn btn-primary" onclick="subscribeToBroadcast()" style="margin-top: 10px;">
                    <span>üì°</span> Subscribe to Broadcast
                </button>
                
                <button class="btn" onclick="registerServiceWorker()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>‚öôÔ∏è</span> Register Service Worker
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
            authDomain: "leelidc-1f753.firebaseapp.com",
            projectId: "leelidc-1f753",
            storageBucket: "leelidc-1f753.firebasestorage.app",
            messagingSenderId: "43622932335",
            appId: "1:43622932335:web:a7529bce1f19714687129a",
            measurementId: "G-3KD6ZYS599"
        };
        
        // Your Firebase Cloud Messaging Server Key
        const SERVER_KEY = "BCS5MgDiA9DOzT_CI12agRMwNRtU6wehijEVEkjY77LMRnv6Fh9mlGocJ87k_5w862iwomMSx1xRGJFRH9W3s_8";
        
        // Global variables
        let messaging = null;
        let fcmToken = null;
        let deviceId = null;
        let notifications = [];
        let recentDevices = [];
        let serviceWorkerRegistered = false;
        
        // ==================== SERVICE WORKER FUNCTIONS ====================
        
        // Register Service Worker for background notifications
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                updateStatus("Service Workers not supported", "danger");
                return;
            }
            
            try {
                // Try to register from file first
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                console.log('‚úÖ Service Worker registered:', registration);
                
                // Update UI
                document.getElementById("serviceWorkerBadge").textContent = "Registered";
                document.getElementById("serviceWorkerBadge").className = "status-badge status-success";
                document.getElementById("serviceWorkerStatus").style.display = "block";
                serviceWorkerRegistered = true;
                
                updateStatus("Service Worker registered successfully!", "success");
                
                // Store registration for messaging
                if (messaging) {
                    messaging.useServiceWorker(registration);
                }
                
            } catch (error) {
                console.error('‚ùå Service Worker registration failed:', error);
                
                // Create a simple service worker inline
                createInlineServiceWorker();
            }
        }
        
        // Create inline service worker
        function createInlineServiceWorker() {
            try {
                const swCode = `
// Firebase Messaging Service Worker
importScripts('https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js');
importScripts('https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js');

// Initialize Firebase
firebase.initializeApp({
    apiKey: "AIzaSyAf_sjwVHG65vKhezpS_L7KC2j0WHIDaWc",
    authDomain: "leelidc-1f753.firebaseapp.com",
    projectId: "leelidc-1f753",
    storageBucket: "leelidc-1f753.firebasestorage.app",
    messagingSenderId: "43622932335",
    appId: "1:43622932335:web:a7529bce1f19714687129a",
    measurementId: "G-3KD6ZYS599"
});

const messaging = firebase.messaging();

// Background message handler
messaging.onBackgroundMessage((payload) => {
    console.log('[Service Worker] Received background message:', payload);
    
    const notificationTitle = payload.notification?.title || 'New Notification';
    const notificationOptions = {
        body: payload.notification?.body || 'You have a new message',
        icon: payload.notification?.icon || 'https://leelidc-1f753.firebaseapp.com/icon-192x192.png',
        badge: 'https://leelidc-1f753.firebaseapp.com/icon-192x192.png',
        tag: 'push-notification',
        data: payload.data || {},
        vibrate: [200, 100, 200],
        requireInteraction: true
    };
    
    // Show notification
    self.registration.showNotification(notificationTitle, notificationOptions);
    
    // Send message to all clients
    self.clients.matchAll().then(clients => {
        clients.forEach(client => {
            client.postMessage({
                type: 'NOTIFICATION_RECEIVED',
                payload: payload
            });
        });
    });
});

// Notification click handler
self.addEventListener('notificationclick', (event) => {
    console.log('Notification clicked:', event.notification);
    event.notification.close();
    
    const urlToOpen = event.notification.data?.url || '/';
    
    event.waitUntil(
        clients.matchAll({ type: 'window', includeUncontrolled: true })
            .then(windowClients => {
                for (let i = 0; i < windowClients.length; i++) {
                    const client = windowClients[i];
                    if (client.url === urlToOpen && 'focus' in client) {
                        return client.focus();
                    }
                }
                if (clients.openWindow) {
                    return clients.openWindow(urlToOpen);
                }
            })
    );
});
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('‚úÖ Inline Service Worker registered:', registration);
                        document.getElementById("serviceWorkerBadge").textContent = "Registered (Inline)";
                        document.getElementById("serviceWorkerBadge").className = "status-badge status-success";
                        document.getElementById("serviceWorkerStatus").style.display = "block";
                        serviceWorkerRegistered = true;
                        updateStatus("Inline Service Worker registered!", "success");
                    })
                    .catch(error => {
                        console.error('‚ùå Inline Service Worker failed:', error);
                        updateStatus(`Service Worker failed: ${error.message}`, "danger");
                    });
            } catch (error) {
                console.error('‚ùå Failed to create inline service worker:', error);
                updateStatus(`Service Worker error: ${error.message}`, "danger");
            }
        }
        
        // ==================== FIREBASE FUNCTIONS ====================
        
        // Initialize Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("‚úÖ Firebase initialized");
                    
                    if (firebase.messaging.isSupported()) {
                        messaging = firebase.messaging();
                        console.log("‚úÖ Firebase Messaging supported");
                        updateStatus("Firebase initialized successfully", "success");
                        return true;
                    } else {
                        console.log("‚ùå Firebase Messaging not supported");
                        updateStatus("Firebase Messaging not supported on this device", "danger");
                        return false;
                    }
                } else {
                    console.log("‚ö†Ô∏è Firebase already initialized");
                    messaging = firebase.messaging();
                    return true;
                }
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
                updateStatus(`Firebase error: ${error.message}`, "danger");
                return false;
            }
        }
        
        // Initialize Push Notifications
        async function initPushNotifications() {
            const initBtn = document.getElementById("initBtn");
            initBtn.disabled = true;
            initBtn.innerHTML = '<span>‚è≥</span> Initializing...';
            
            try {
                // 1. Initialize Firebase
                if (!initFirebase()) {
                    return;
                }
                
                // 2. Request notification permission
                updateStatus("Requesting notification permission...", "warning");
                const permission = await Notification.requestPermission();
                
                const permissionBadge = document.getElementById("permissionBadge");
                permissionBadge.textContent = permission;
                permissionBadge.className = `status-badge status-${permission === 'granted' ? 'success' : 'danger'}`;
                document.getElementById("permissionStatus").style.display = "block";
                
                if (permission !== 'granted') {
                    updateStatus(`Permission denied: ${permission}. Please enable in browser settings.`, "danger");
                    initBtn.disabled = false;
                    initBtn.innerHTML = '<span>üîî</span> Enable Push Notifications';
                    return;
                }
                
                updateStatus("Notification permission granted!", "success");
                
                // 3. Generate/load device ID
                deviceId = localStorage.getItem("deviceId");
                if (!deviceId) {
                    deviceId = "device_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("deviceId", deviceId);
                }
                document.getElementById("deviceId").textContent = deviceId;
                
                // 4. Get FCM Token
                updateStatus("Getting FCM token...", "warning");
                
                try {
                    fcmToken = await messaging.getToken();
                    console.log("‚úÖ FCM Token obtained:", fcmToken);
                    
                    document.getElementById("fcmTokenDisplay").textContent = fcmToken;
                    document.getElementById("tokenStatus").style.display = "block";
                    
                    // Save token for later use
                    localStorage.setItem("fcmToken", fcmToken);
                    localStorage.setItem("lastTokenUpdate", Date.now());
                    
                    updateStatus("FCM token obtained successfully!", "success");
                    
                } catch (tokenError) {
                    console.error("‚ùå Token error:", tokenError);
                    updateStatus(`Token error: ${tokenError.message}. Using fallback.`, "warning");
                    
                    fcmToken = "fallback_" + deviceId;
                    document.getElementById("fcmTokenDisplay").textContent = "Using fallback token";
                    document.getElementById("tokenStatus").style.display = "block";
                }
                
                // 5. Set up message listener for foreground
                messaging.onMessage((payload) => {
                    console.log("üì± Foreground message received:", payload);
                    showNotification(payload);
                });
                
                // 6. Set up message listener from service worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'NOTIFICATION_RECEIVED') {
                            console.log("üì± Message from service worker:", event.data.payload);
                            showNotification(event.data.payload);
                        }
                    });
                }
                
                // 7. Set up token refresh
                messaging.onTokenRefresh(async () => {
                    console.log("üîÑ Token refresh requested");
                    fcmToken = await messaging.getToken();
                    document.getElementById("fcmTokenDisplay").textContent = fcmToken;
                    localStorage.setItem("fcmToken", fcmToken);
                    localStorage.setItem("lastTokenUpdate", Date.now());
                    updateStatus("Token refreshed!", "success");
                });
                
                // 8. Generate share link and QR code
                generateShareLink();
                
                // 9. Load previous notifications
                loadNotifications();
                
                // 10. Update UI
                initBtn.innerHTML = '<span>‚úÖ</span> Notifications Enabled';
                initBtn.className = "btn btn-success";
                
                updateStatus("‚úÖ Push notifications enabled! You can now receive notifications even when app is closed.", "success");
                
                // 11. Update system status
                updateSystemStatus();
                
                // 12. Play success sound
                playSound("success");
                
                // 13. Auto-subscribe to broadcast topic
                subscribeToTopic("all_devices");
                
                // 14. Send welcome notification
                setTimeout(() => {
                    addNotification("Welcome!", "Push notifications are now enabled. You will receive notifications even when the app is closed!", "test");
                }, 1000);
                
            } catch (error) {
                console.error("‚ùå Push initialization error:", error);
                updateStatus(`Initialization error: ${error.message}`, "danger");
                initBtn.disabled = false;
                initBtn.innerHTML = '<span>üîî</span> Enable Push Notifications';
                playSound("error");
            }
        }
        
        // ==================== REAL NOTIFICATION SENDING ====================
        
        // Send Real Notification
        async function sendRealNotification() {
            const sendBtn = document.getElementById("sendBtn");
            const sendResult = document.getElementById("sendResult");
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span>‚è≥</span> Sending...';
            sendResult.innerHTML = "";
            
            try {
                const targetType = document.getElementById("targetType").value;
                const title = document.getElementById("sendTitle").value.trim();
                const message = document.getElementById("sendMessage").value.trim();
                const type = document.getElementById("notificationType").value;
                
                if (!title) throw new Error("Please enter a title");
                if (!message) throw new Error("Please enter a message");
                
                let payload;
                let targetToken = "";
                
                // Build payload based on target type
                if (targetType === 'broadcast') {
                    payload = {
                        to: "/topics/all_devices",
                        notification: {
                            title: title,
                            body: message,
                            icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png"
                        },
                        data: {
                            type: type,
                            senderId: deviceId || "broadcast",
                            timestamp: new Date().toISOString(),
                            isBroadcast: "true",
                            message: message,
                            url: window.location.href
                        }
                    };
                    updateStatus("üì¢ Broadcasting to all devices...", "warning");
                    
                } else if (targetType === 'topic') {
                    const topicName = document.getElementById("topicName").value.trim();
                    if (!topicName) throw new Error("Please enter a topic name");
                    
                    payload = {
                        to: `/topics/${topicName}`,
                        notification: {
                            title: title,
                            body: message,
                            icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png"
                        },
                        data: {
                            type: type,
                            senderId: deviceId || "topic_sender",
                            timestamp: new Date().toISOString(),
                            topic: topicName,
                            url: window.location.href
                        }
                    };
                    updateStatus(`üì§ Sending to topic: ${topicName}...`, "warning");
                    
                } else {
                    targetToken = document.getElementById("targetToken").value.trim();
                    if (!targetToken) throw new Error("Please enter a target Device ID or FCM Token");
                    
                    payload = {
                        to: targetToken,
                        notification: {
                            title: title,
                            body: message,
                            icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png"
                        },
                        data: {
                            type: type,
                            senderId: deviceId || "unknown",
                            timestamp: new Date().toISOString(),
                            url: window.location.href
                        }
                    };
                    updateStatus(`Sending to: ${targetToken.substring(0, 30)}...`, "warning");
                    addRecentDevice(targetToken, title);
                }
                
                console.log("Sending real payload:", payload);
                
                // Method 1: Use CORS proxy to call FCM directly
                const proxyUrl = "https://corsproxy.io/?";
                const fcmUrl = "https://fcm.googleapis.com/fcm/send";
                const fullUrl = proxyUrl + encodeURIComponent(fcmUrl);
                
                const response = await fetch(fullUrl, {
                    method: "POST",
                    headers: {
                        "Authorization": `key=${SERVER_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log("Response status:", response.status);
                
                if (!response.ok) {
                    throw new Error(`FCM API error: ${response.status}`);
                }
                
                const result = await response.json();
                console.log("FCM response:", result);
                
                if (result.success === 1 || result.message_id) {
                    // Success
                    let successMessage = "";
                    if (targetType === 'broadcast') {
                        successMessage = "üì¢ Broadcast sent successfully to all devices!";
                    } else if (targetType === 'topic') {
                        successMessage = `‚úÖ Notification sent to topic: ${document.getElementById("topicName").value}`;
                    } else {
                        successMessage = "‚úÖ Real notification sent! Check target device.";
                    }
                    
                    sendResult.innerHTML = `
                        <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                            <div class="notification-title">${successMessage}</div>
                            <div class="notification-body">Message ID: ${result.message_id || "N/A"}</div>
                            <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    `;
                    
                    updateStatus(successMessage, "success");
                    playSound("success");
                    
                    const targetDesc = targetType === 'broadcast' ? 'All Devices' : 
                                     targetType === 'topic' ? `Topic: ${document.getElementById("topicName").value}` : 
                                     `To: ${targetToken.substring(0, 30)}...`;
                    addNotification(`Sent: ${title}`, targetDesc, "sent");
                    
                } else {
                    throw new Error(result.error || "Failed to send notification");
                }
                
            } catch (error) {
                console.error("‚ùå Send error:", error);
                
                // Fallback: Try alternative CORS proxy
                if (error.message.includes("FCM API error") || error.message.includes("Failed to fetch")) {
                    try {
                        await sendWithAlternativeProxy();
                        return;
                    } catch (fallbackError) {
                        console.error("Fallback also failed:", fallbackError);
                        error = fallbackError;
                    }
                }
                
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #f8d7da; border-left-color: #dc3545;">
                        <div class="notification-title">‚ùå Failed to Send Real Notification</div>
                        <div class="notification-body">${error.message}</div>
                        <div class="notification-body">Note: CORS restrictions may prevent sending from browser. Consider setting up a backend server.</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚ùå Send failed: ${error.message}`, "danger");
                playSound("error");
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>üì§</span> Send Real Notification';
            }
        }
        
        // Alternative CORS proxy method
        async function sendWithAlternativeProxy() {
            const targetType = document.getElementById("targetType").value;
            const title = document.getElementById("sendTitle").value.trim();
            const message = document.getElementById("sendMessage").value.trim();
            const type = document.getElementById("notificationType").value;
            let targetToken = "";
            
            let payload;
            if (targetType === 'broadcast') {
                payload = { to: "/topics/all_devices", notification: { title, body: message } };
            } else if (targetType === 'topic') {
                const topicName = document.getElementById("topicName").value.trim();
                payload = { to: `/topics/${topicName}`, notification: { title, body: message } };
            } else {
                targetToken = document.getElementById("targetToken").value.trim();
                payload = { to: targetToken, notification: { title, body: message } };
            }
            
            // Try different CORS proxies
            const proxies = [
                "https://api.allorigins.win/post?url=",
                "https://cors-proxy.htmldriven.com/?url=",
                "https://proxy.cors.sh/"
            ];
            
            const fcmUrl = "https://fcm.googleapis.com/fcm/send";
            
            for (const proxy of proxies) {
                try {
                    console.log(`Trying proxy: ${proxy}`);
                    const proxyFullUrl = proxy + encodeURIComponent(fcmUrl);
                    
                    const response = await fetch(proxy === "https://proxy.cors.sh/" ? 
                        "https://proxy.cors.sh/https://fcm.googleapis.com/fcm/send" : 
                        proxyFullUrl, {
                        method: "POST",
                        headers: {
                            "Authorization": `key=${SERVER_KEY}`,
                            "Content-Type": "application/json",
                            ...(proxy === "https://proxy.cors.sh/" ? { "x-cors-api-key": "temp_2a4b5c6d7e8f9g0h1i2j3k4l5m6n7o8p" } : {})
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`Proxy ${proxy} success:`, result);
                        
                        if (result.success === 1 || result.message_id) {
                            let successMessage = targetType === 'broadcast' ? "üì¢ Broadcast sent via proxy!" :
                                               targetType === 'topic' ? `‚úÖ Sent to topic via proxy` :
                                               "‚úÖ Notification sent via proxy!";
                            
                            document.getElementById("sendResult").innerHTML = `
                                <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                                    <div class="notification-title">${successMessage}</div>
                                    <div class="notification-body">Message ID: ${result.message_id || "N/A"}</div>
                                    <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                                </div>
                            `;
                            
                            updateStatus(successMessage, "success");
                            playSound("success");
                            return;
                        }
                    }
                } catch (proxyError) {
                    console.log(`Proxy ${proxy} failed:`, proxyError);
                    continue;
                }
            }
            
            throw new Error("All proxy attempts failed");
        }
        
        // Demo notification
        async function sendDemoNotification() {
            const sendBtn = document.getElementById("sendBtnDemo");
            const sendResult = document.getElementById("sendResult");
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span>‚è≥</span> Sending Demo...';
            
            try {
                const title = document.getElementById("sendTitle").value.trim() || "Demo Notification";
                const message = document.getElementById("sendMessage").value.trim() || "This is a demo notification";
                
                // Show demo result
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #e8f4fc; border-left-color: #2196f3;">
                        <div class="notification-title">üß™ Demo Notification Sent</div>
                        <div class="notification-body">${title}: ${message}</div>
                        <div class="notification-body">Note: This is a demo. For real notifications between devices, use "Send Real Notification" button.</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus("Demo notification sent", "warning");
                
                // Also show a local notification
                addNotification("[Demo] " + title, message, "test");
                
                if (Notification.permission === "granted") {
                    new Notification("[Demo] " + title, {
                        body: message,
                        icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png"
                    });
                }
                
                playSound("notification");
                
            } catch (error) {
                console.error("Demo error:", error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span>üß™</span> Send Demo Notification';
            }
        }
        
        // ==================== NOTIFICATION HANDLING ====================
        
        // Show received notification
        function showNotification(payload) {
            const notification = payload.notification || payload.data;
            const title = notification.title || "Notification";
            const body = notification.body || notification.message || "New notification";
            const type = notification.type || "info";
            
            // Check if it's a broadcast
            const isBroadcast = notification.isBroadcast === "true";
            const senderInfo = isBroadcast ? "[Broadcast] " : "";
            
            addNotification(senderInfo + title, body, type);
            
            // Show browser notification if permission granted and app is open
            if (Notification.permission === "granted" && document.visibilityState === 'visible') {
                const options = {
                    body: body,
                    icon: "https://leelidc-1f753.firebaseapp.com/icon-192x192.png",
                    tag: "push-test",
                    requireInteraction: true,
                    vibrate: [200, 100, 200],
                    data: { url: notification.url || window.location.href }
                };
                
                new Notification(senderInfo + title, options);
            }
            
            // Play notification sound
            playSound("notification");
            
            // Update status
            updateStatus(`üì® Received notification: ${senderInfo}${title}`, "success");
        }
        
        // ==================== OTHER FUNCTIONS ====================
        
        // Subscribe to topic
        async function subscribeToTopic(topicName) {
            if (!fcmToken) {
                console.log("No FCM token available for topic subscription");
                return;
            }
            
            try {
                console.log(`Subscribing to topic: ${topicName}`);
                updateStatus(`Subscribing to ${topicName} topic...`, "warning");
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                localStorage.setItem(`subscribed_${topicName}`, "true");
                updateStatus(`‚úÖ Subscribed to ${topicName} topic`, "success");
                addNotification("Topic Subscription", `You are now subscribed to: ${topicName}`, "info");
                
            } catch (error) {
                console.error("Topic subscription error:", error);
            }
        }
        
        // Subscribe to broadcast
        function subscribeToBroadcast() {
            subscribeToTopic("all_devices");
        }
        
        // Toggle target input based on selection
        function toggleTargetInput() {
            const targetType = document.getElementById("targetType").value;
            const specificGroup = document.getElementById("specificTargetGroup");
            const topicGroup = document.getElementById("topicGroup");
            const broadcastInfo = document.getElementById("broadcastInfo");
            
            specificGroup.style.display = targetType === 'specific' ? 'block' : 'none';
            topicGroup.style.display = targetType === 'topic' ? 'block' : 'none';
            broadcastInfo.style.display = targetType === 'broadcast' ? 'block' : 'none';
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabName + "Tab").classList.add("active");
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
        }
        
        // Update status message
        function updateStatus(message, type = "info") {
            const statusEl = document.getElementById("statusMessage");
            statusEl.innerHTML = `<div class="status-badge status-${type}">${message}</div>`;
        }
        
        // Update system status
        function updateSystemStatus() {
            const systemStatus = document.getElementById("systemStatus");
            const debugInfo = document.getElementById("debugInfo");
            
            systemStatus.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>Device ID:</strong> ${deviceId || "Not set"}</div>
                    <div><strong>FCM Token:</strong> ${fcmToken ? "‚úì Set" : "‚úó Not set"}</div>
                    <div><strong>Permission:</strong> ${Notification.permission}</div>
                    <div><strong>Platform:</strong> ${navigator.platform}</div>
                    <div><strong>Notifications:</strong> ${notifications.length} received</div>
                    <div><strong>Service Worker:</strong> ${serviceWorkerRegistered ? "‚úì Registered" : "‚úó Not registered"}</div>
                    <div><strong>Background Support:</strong> ${serviceWorkerRegistered ? "‚úì Yes" : "‚úó No"}</div>
                </div>
            `;
            
            debugInfo.innerHTML = `
                <div style="font-family: monospace; font-size: 12px;">
                    <div><strong>User Agent:</strong> ${navigator.userAgent}</div>
                    <div><strong>Screen:</strong> ${screen.width}x${screen.height}</div>
                    <div><strong>Location:</strong> ${window.location.href}</div>
                    <div><strong>Service Worker:</strong> ${serviceWorkerRegistered ? "Registered" : "Not registered"}</div>
                </div>
            `;
        }
        
        // Generate share link and QR code
        function generateShareLink() {
            if (!deviceId) return;
            
            const shareLink = `${window.location.origin}${window.location.pathname}?sendTo=${deviceId}`;
            document.getElementById("shareLink").value = shareLink;
            
            try {
                if (typeof QRCode !== 'undefined') {
                    document.getElementById("qrCodeContainer").innerHTML = "";
                    new QRCode(document.getElementById("qrCodeContainer"), {
                        text: shareLink,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    document.getElementById("qrCodeContainer").innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p>QR Code: ${shareLink}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("QR Code generation error:", error);
                document.getElementById("qrCodeContainer").innerHTML = `<p>QR code error: ${error.message}</p>`;
            }
        }
        
        // Add notification to list
        function addNotification(title, body, type = "info") {
            const notification = {
                id: Date.now(),
                title: title,
                body: body,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString()
            };
            
            notifications.unshift(notification);
            localStorage.setItem("notifications", JSON.stringify(notifications.slice(0, 50)));
            updateNotificationList();
        }
        
        // Update notification list UI
        function updateNotificationList() {
            const list = document.getElementById("notificationList");
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-item">
                        <div class="notification-title">No notifications yet</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = "";
            notifications.slice(0, 20).forEach(notif => {
                const item = document.createElement("div");
                item.className = `notification-item ${notif.type === 'test' ? 'new' : ''}`;
                item.innerHTML = `
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-body">${notif.body}</div>
                    <div class="notification-time">${notif.timestamp} ‚Ä¢ ${notif.date}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Load notifications from localStorage
        function loadNotifications() {
            const saved = localStorage.getItem("notifications");
            if (saved) {
                try {
                    notifications = JSON.parse(saved);
                    updateNotificationList();
                } catch (e) {
                    notifications = [];
                }
            }
        }
        
        // Copy device ID
        function copyDeviceId() {
            navigator.clipboard.writeText(deviceId || document.getElementById("deviceId").textContent);
            updateStatus("Device ID copied to clipboard!", "success");
        }
        
        // Copy FCM token
        function copyFCMToken() {
            navigator.clipboard.writeText(fcmToken || document.getElementById("fcmTokenDisplay").textContent);
            updateStatus("FCM Token copied to clipboard!", "success");
        }
        
        // Copy share link
        function copyShareLink() {
            navigator.clipboard.writeText(document.getElementById("shareLink").value);
            updateStatus("Share link copied to clipboard!", "success");
        }
        
        // Play sound
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (type === "success") playBeep(audioContext, 800, 0.3);
                else if (type === "error") playBeep(audioContext, 400, 0.3);
                else if (type === "notification") {
                    playBeep(audioContext, 600, 0.2);
                    setTimeout(() => playBeep(audioContext, 800, 0.2), 100);
                }
            } catch (e) {}
        }
        
        // Play beep sound
        function playBeep(audioContext, frequency, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = "sine";
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Add recent device
        function addRecentDevice(token, lastMessage) {
            recentDevices = recentDevices.filter(d => d.token !== token);
            recentDevices.unshift({ token: token, lastMessage: lastMessage, lastSent: new Date().toLocaleTimeString() });
            recentDevices = recentDevices.slice(0, 5);
            localStorage.setItem("recentDevices", JSON.stringify(recentDevices));
            updateRecentDevices();
        }
        
        // Update recent devices UI
        function updateRecentDevices() {
            const container = document.getElementById("recentDevices");
            if (recentDevices.length === 0) {
                container.innerHTML = "<p>No recent devices. Send a notification first.</p>";
                return;
            }
            container.innerHTML = "";
            recentDevices.forEach(device => {
                const div = document.createElement("div");
                div.className = "notification-item";
                div.innerHTML = `
                    <div class="notification-title">${device.token.substring(0, 30)}...</div>
                    <div class="notification-body">Last: ${device.lastMessage}</div>
                    <div class="notification-time">${device.lastSent}</div>
                    <button class="copy-btn" onclick="document.getElementById('targetToken').value='${device.token}'; switchTab('send');">Use</button>
                `;
                container.appendChild(div);
            });
        }
        
        // Test self notification
        function testSelfNotification() {
            if (!fcmToken) {
                alert("Please enable push notifications first");
                return;
            }
            document.getElementById("targetType").value = "specific";
            toggleTargetInput();
            document.getElementById("targetToken").value = fcmToken;
            document.getElementById("sendTitle").value = "Test to Yourself";
            document.getElementById("sendMessage").value = "This is a test notification sent to yourself!";
            document.getElementById("notificationType").value = "test";
            switchTab("send");
            setTimeout(() => {
                document.getElementById("sendBtn").click();
            }, 500);
        }
        
        // Clear notifications
        function clearNotifications() {
            if (confirm("Clear all notifications?")) {
                notifications = [];
                localStorage.removeItem("notifications");
                updateNotificationList();
                updateStatus("All notifications cleared", "warning");
            }
        }
        
        // Reset all
        function resetAll() {
            if (confirm("Reset everything? This will clear all data and restart.")) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // ==================== INITIALIZATION ====================
        
        window.onload = function() {
            console.log("üöÄ Mobile Push Tester Loaded");
            
            // Check URL for sendTo parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sendTo = urlParams.get('sendTo');
            if (sendTo) {
                document.getElementById("targetToken").value = sendTo;
                document.getElementById("targetType").value = "specific";
                toggleTargetInput();
                switchTab("send");
            }
            
            // Load saved data
            deviceId = localStorage.getItem("deviceId");
            fcmToken = localStorage.getItem("fcmToken");
            notifications = JSON.parse(localStorage.getItem("notifications") || "[]");
            recentDevices = JSON.parse(localStorage.getItem("recentDevices") || "[]");
            
            // Update UI with saved data
            if (deviceId) document.getElementById("deviceId").textContent = deviceId;
            if (fcmToken) {
                document.getElementById("fcmTokenDisplay").textContent = fcmToken;
                document.getElementById("tokenStatus").style.display = "block";
                document.getElementById("initBtn").innerHTML = '<span>‚úÖ</span> Notifications Enabled';
                document.getElementById("initBtn").className = "btn btn-success";
            }
            
            updateNotificationList();
            updateRecentDevices();
            
            // Generate share link if device ID exists
            if (deviceId) {
                setTimeout(() => generateShareLink(), 1000);
            }
            
            // Initialize Firebase
            initFirebase();
            
            // Update system status
            updateSystemStatus();
            
            // Set up target type toggle
            document.getElementById("targetType").addEventListener("change", toggleTargetInput);
            toggleTargetInput();
            
            // Listen for service worker messages
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'NOTIFICATION_RECEIVED') {
                        console.log("üì± Received notification via service worker:", event.data.payload);
                        showNotification(event.data.payload);
                    }
                });
                
                // Check if service worker is already registered
                navigator.serviceWorker.ready.then(registration => {
                    if (registration.active) {
                        serviceWorkerRegistered = true;
                        document.getElementById("serviceWorkerBadge").textContent = "Registered";
                        document.getElementById("serviceWorkerBadge").className = "status-badge status-success";
                        document.getElementById("serviceWorkerStatus").style.display = "block";
                    }
                });
            }
        };
    </script>
</body>
</html>
