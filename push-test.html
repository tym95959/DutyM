<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¢ Broadcast Notification Tester</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; padding: 20px; text-align: center; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { background: white; border-bottom: 3px solid #4facfe; color: #4facfe; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-left: 10px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-danger { background: #f8d7da; color: #721c24; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; margin: 10px 0; }
        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, textarea, select { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        textarea { min-height: 120px; resize: vertical; font-family: monospace; }
        .token-display { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; font-family: monospace; font-size: 14px; word-break: break-all; max-height: 100px; overflow-y: auto; }
        .notification-list { max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .notification-item { padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #f8f9fa; border-left: 4px solid #4facfe; animation: slideIn 0.3s ease; }
        .notification-title { font-weight: 600; margin-bottom: 5px; color: #2c3e50; }
        .notification-body { color: #6c757d; margin-bottom: 5px; }
        .notification-time { font-size: 12px; color: #adb5bd; text-align: right; }
        .online-users { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .user-badge { background: #e3f2fd; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .broadcast-info { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 600px) { .container { border-radius: 15px; } .header { padding: 20px; } .tab-content { padding: 20px; } .btn { padding: 12px 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¢ Broadcast Notification Tester</h1>
            <p>Send notifications to ALL connected devices in real-time</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('receive')">üì≤ Receive</div>
            <div class="tab" onclick="switchTab('send')">üì§ Send</div>
            <div class="tab" onclick="switchTab('status')">üìä Status</div>
        </div>
        
        <!-- RECEIVE TAB -->
        <div class="tab-content active" id="receiveTab">
            <div class="card">
                <h3><span>üîî</span> Your Device Status</h3>
                <div id="statusMessage">Initializing connection...</div>
                
                <div class="input-group">
                    <label>Your Device ID:</label>
                    <div class="token-display" id="deviceId">Generating...</div>
                    <button class="btn copy-btn" onclick="copyDeviceId()" style="width: auto; padding: 8px 15px;">Copy</button>
                </div>
                
                <div class="input-group">
                    <label>Connection Status:</label>
                    <div class="status-badge" id="connectionBadge">Disconnected</div>
                </div>
                
                <div class="input-group">
                    <label>Connected Users:</label>
                    <div id="onlineCount">0 users online</div>
                    <div class="online-users" id="onlineUsers"></div>
                </div>
                
                <button class="btn btn-primary" onclick="connectToServer()" id="connectBtn">
                    <span>üîó</span> Connect to Server
                </button>
            </div>
            
            <div class="card">
                <h3><span>üì®</span> Received Notifications</h3>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item">
                        <div class="notification-title">Waiting for notifications...</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SEND TAB -->
        <div class="tab-content" id="sendTab">
            <div class="card">
                <h3><span>üì§</span> Send Notification</h3>
                
                <div class="broadcast-info">
                    <div class="notification-title">üì¢ Broadcast to All Devices</div>
                    <div class="notification-body">This will send notification to ALL connected devices. Currently <span id="currentUsers">0</span> devices are online.</div>
                </div>
                
                <div class="input-group">
                    <label>Notification Title:</label>
                    <input type="text" id="sendTitle" value="Important Announcement" placeholder="Enter notification title">
                </div>
                
                <div class="input-group">
                    <label>Notification Message:</label>
                    <textarea id="sendMessage" placeholder="Enter notification message">Attention all users! This is a broadcast message to everyone.</textarea>
                </div>
                
                <div class="input-group">
                    <label>Notification Type:</label>
                    <select id="notificationType">
                        <option value="announcement">üì¢ Announcement</option>
                        <option value="alert">‚ö†Ô∏è Alert</option>
                        <option value="message">üí¨ Message</option>
                        <option value="urgent">üö® Urgent</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="sendBroadcast()" id="broadcastBtn">
                    <span>üì¢</span> Broadcast to All Devices
                </button>
                
                <button class="btn btn-primary" onclick="sendToSelected()" id="selectiveBtn" style="margin-top: 10px;">
                    <span>üë•</span> Send to Selected Users
                </button>
                
                <div id="sendResult"></div>
            </div>
            
            <div class="card">
                <h3><span>üë•</span> Select Users to Send</h3>
                <div id="userSelection">
                    <p>Select specific users to send notifications to:</p>
                    <div id="userCheckboxes"></div>
                    <button class="btn" onclick="selectAllUsers()" style="background: #6c757d; color: white; margin-top: 10px;">
                        <span>‚úì</span> Select All
                    </button>
                    <button class="btn" onclick="deselectAllUsers()" style="background: #6c757d; color: white; margin-top: 10px;">
                        <span>‚úó</span> Deselect All
                    </button>
                </div>
            </div>
        </div>
        
        <!-- STATUS TAB -->
        <div class="tab-content" id="statusTab">
            <div class="card">
                <h3><span>üìä</span> System Status</h3>
                <div id="systemStatus">
                    <p>Loading system status...</p>
                </div>
            </div>
            
            <div class="card">
                <h3><span>üîÑ</span> Test Tools</h3>
                <button class="btn btn-primary" onclick="testBroadcast()">
                    <span>üß™</span> Test Broadcast
                </button>
                <button class="btn" onclick="clearNotifications()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>üóëÔ∏è</span> Clear All Notifications
                </button>
                <button class="btn btn-danger" onclick="resetAll()" style="margin-top: 10px;">
                    <span>üîÑ</span> Reset Everything
                </button>
            </div>
        </div>
    </div>

    <script>
        // WebSocket server - Using a free public WebSocket server with broadcast capability
        // For production, deploy your own server (see instructions below)
        const WS_SERVER = "wss://ws.broadcast-server.freewebhost.com"; // Free broadcast server
        // Alternative: "wss://your-broadcast-server.herokuapp.com" (deploy your own)
        
        // Global variables
        let ws = null;
        let deviceId = null;
        let deviceName = null;
        let isConnected = false;
        let notifications = [];
        let onlineUsers = new Map(); // deviceId -> {name, joined}
        let selectedUsers = new Set();
        
        // Generate unique device ID
        function generateDeviceId() {
            const prefix = "device";
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 9);
            return `${prefix}_${timestamp}_${random}`;
        }
        
        // Generate device name
        function generateDeviceName() {
            const names = ["Mobile", "Tablet", "Desktop", "Laptop", "Phone", "Browser"];
            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomNum = Math.floor(Math.random() * 1000);
            return `${randomName}_${randomNum}`;
        }
        
        // Connect to WebSocket server
        function connectToServer() {
            const connectBtn = document.getElementById("connectBtn");
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<span>‚è≥</span> Connecting...';
            
            try {
                // Close existing connection if any
                if (ws) {
                    ws.close();
                }
                
                updateStatus("Connecting to broadcast server...", "warning");
                
                // Create WebSocket connection
                ws = new WebSocket(WS_SERVER);
                
                ws.onopen = function() {
                    console.log("‚úÖ Connected to broadcast server");
                    isConnected = true;
                    
                    document.getElementById("connectionBadge").textContent = "Connected";
                    document.getElementById("connectionBadge").className = "status-badge status-success";
                    
                    connectBtn.innerHTML = '<span>‚úÖ</span> Connected';
                    connectBtn.className = "btn btn-success";
                    
                    updateStatus("‚úÖ Connected to broadcast server! You can send/receive notifications.", "success");
                    
                    // Send registration message
                    const registerMsg = {
                        type: "register",
                        deviceId: deviceId,
                        deviceName: deviceName,
                        timestamp: Date.now()
                    };
                    ws.send(JSON.stringify(registerMsg));
                    
                    playSound("success");
                };
                
                ws.onmessage = function(event) {
                    console.log("üì® Received:", event.data);
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        console.log("Received non-JSON message:", event.data);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error("‚ùå WebSocket error:", error);
                    updateStatus("Server connection error. Trying fallback...", "danger");
                    tryFallbackServer();
                };
                
                ws.onclose = function() {
                    console.log("üîå Disconnected from server");
                    isConnected = false;
                    
                    document.getElementById("connectionBadge").textContent = "Disconnected";
                    document.getElementById("connectionBadge").className = "status-badge status-danger";
                    
                    connectBtn.disabled = false;
                    connectBtn.innerHTML = '<span>üîó</span> Reconnect';
                    connectBtn.className = "btn btn-primary";
                    
                    updateStatus("Disconnected. Click 'Reconnect' to try again.", "warning");
                    
                    // Clear online users
                    onlineUsers.clear();
                    updateOnlineUsers();
                    
                    // Auto-reconnect after 3 seconds
                    setTimeout(() => {
                        if (!isConnected) {
                            connectToServer();
                        }
                    }, 3000);
                };
                
            } catch (error) {
                console.error("‚ùå Connection error:", error);
                updateStatus(`Connection error: ${error.message}`, "danger");
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<span>üîó</span> Connect to Server';
                playSound("error");
            }
        }
        
        // Try fallback server
        function tryFallbackServer() {
            // For now, we'll just try to reconnect to the same server
            setTimeout(() => {
                if (!isConnected) {
                    connectToServer();
                }
            }, 2000);
        }
        
        // Handle messages from server
        function handleServerMessage(data) {
            switch(data.type) {
                case 'welcome':
                    updateStatus(`‚úÖ ${data.message}`, "success");
                    break;
                    
                case 'user_joined':
                    onlineUsers.set(data.deviceId, {
                        name: data.deviceName,
                        joined: data.timestamp
                    });
                    updateOnlineUsers();
                    addNotification("User Joined", `${data.deviceName} connected`, "info");
                    break;
                    
                case 'user_left':
                    onlineUsers.delete(data.deviceId);
                    updateOnlineUsers();
                    addNotification("User Left", `${data.deviceName} disconnected`, "info");
                    break;
                    
                case 'user_list':
                    onlineUsers.clear();
                    data.users.forEach(user => {
                        onlineUsers.set(user.deviceId, {
                            name: user.deviceName,
                            joined: user.joined
                        });
                    });
                    updateOnlineUsers();
                    break;
                    
                case 'notification':
                    showNotification(data);
                    break;
                    
                case 'broadcast':
                    showNotification(data);
                    break;
                    
                case 'private_message':
                    if (data.to === deviceId) {
                        showNotification(data);
                    }
                    break;
                    
                default:
                    console.log("Unknown message type:", data.type);
            }
        }
        
        // Send broadcast to ALL devices
        function sendBroadcast() {
            const broadcastBtn = document.getElementById("broadcastBtn");
            const sendResult = document.getElementById("sendResult");
            
            broadcastBtn.disabled = true;
            broadcastBtn.innerHTML = '<span>‚è≥</span> Broadcasting...';
            sendResult.innerHTML = "";
            
            try {
                if (!isConnected || !ws) {
                    throw new Error("Not connected to server. Please connect first.");
                }
                
                const title = document.getElementById("sendTitle").value.trim();
                const message = document.getElementById("sendMessage").value.trim();
                const type = document.getElementById("notificationType").value;
                
                if (!title) {
                    throw new Error("Please enter a title");
                }
                
                if (!message) {
                    throw new Error("Please enter a message");
                }
                
                // Create broadcast message
                const broadcast = {
                    type: "broadcast",
                    from: deviceId,
                    fromName: deviceName,
                    title: title,
                    message: message,
                    notificationType: type,
                    timestamp: Date.now()
                };
                
                console.log("Sending broadcast:", broadcast);
                
                // Send via WebSocket
                ws.send(JSON.stringify(broadcast));
                
                // Show success
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                        <div class="notification-title">üì¢ Broadcast Sent to All Devices!</div>
                        <div class="notification-body">${title}: ${message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`üì¢ Broadcast sent to ${onlineUsers.size} devices`, "success");
                playSound("success");
                
                // Also show locally
                addNotification(`[Broadcast] ${title}`, message, type);
                
            } catch (error) {
                console.error("‚ùå Broadcast error:", error);
                
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #f8d7da; border-left-color: #dc3545;">
                        <div class="notification-title">‚ùå Broadcast Failed</div>
                        <div class="notification-body">${error.message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚ùå Broadcast failed: ${error.message}`, "danger");
                playSound("error");
            } finally {
                broadcastBtn.disabled = false;
                broadcastBtn.innerHTML = '<span>üì¢</span> Broadcast to All Devices';
            }
        }
        
        // Send to selected users
        function sendToSelected() {
            if (selectedUsers.size === 0) {
                alert("Please select at least one user to send to");
                return;
            }
            
            const selectiveBtn = document.getElementById("selectiveBtn");
            const sendResult = document.getElementById("sendResult");
            
            selectiveBtn.disabled = true;
            selectiveBtn.innerHTML = '<span>‚è≥</span> Sending...';
            sendResult.innerHTML = "";
            
            try {
                if (!isConnected || !ws) {
                    throw new Error("Not connected to server");
                }
                
                const title = document.getElementById("sendTitle").value.trim();
                const message = document.getElementById("sendMessage").value.trim();
                const type = document.getElementById("notificationType").value;
                
                // Send to each selected user
                selectedUsers.forEach(userId => {
                    const privateMsg = {
                        type: "private_message",
                        from: deviceId,
                        fromName: deviceName,
                        to: userId,
                        title: title,
                        message: message,
                        notificationType: type,
                        timestamp: Date.now()
                    };
                    
                    ws.send(JSON.stringify(privateMsg));
                });
                
                // Show success
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                        <div class="notification-title">‚úÖ Sent to ${selectedUsers.size} Users</div>
                        <div class="notification-body">${title}: ${message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚úÖ Sent to ${selectedUsers.size} selected users`, "success");
                playSound("success");
                
            } catch (error) {
                console.error("‚ùå Send error:", error);
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #f8d7da; border-left-color: #dc3545;">
                        <div class="notification-title">‚ùå Send Failed</div>
                        <div class="notification-body">${error.message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                updateStatus(`‚ùå Send failed: ${error.message}`, "danger");
                playSound("error");
            } finally {
                selectiveBtn.disabled = false;
                selectiveBtn.innerHTML = '<span>üë•</span> Send to Selected Users';
            }
        }
        
        // Update online users display
        function updateOnlineUsers() {
            const onlineCount = document.getElementById("onlineCount");
            const onlineUsersDiv = document.getElementById("onlineUsers");
            const currentUsers = document.getElementById("currentUsers");
            
            onlineCount.textContent = `${onlineUsers.size} user${onlineUsers.size !== 1 ? 's' : ''} online`;
            currentUsers.textContent = onlineUsers.size;
            
            onlineUsersDiv.innerHTML = "";
            
            onlineUsers.forEach((user, userId) => {
                const userBadge = document.createElement("div");
                userBadge.className = "user-badge";
                userBadge.innerHTML = `
                    <span>üë§ ${user.name}</span>
                    <small style="color: #666; margin-left: 5px;">(${userId.substring(0, 8)})</small>
                `;
                onlineUsersDiv.appendChild(userBadge);
            });
            
            // Update user checkboxes
            updateUserCheckboxes();
        }
        
        // Update user checkboxes for selection
        function updateUserCheckboxes() {
            const userCheckboxes = document.getElementById("userCheckboxes");
            userCheckboxes.innerHTML = "";
            
            onlineUsers.forEach((user, userId) => {
                if (userId === deviceId) return; // Don't show self
                
                const checkboxDiv = document.createElement("div");
                checkboxDiv.style.marginBottom = "8px";
                checkboxDiv.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${userId}" ${selectedUsers.has(userId) ? 'checked' : ''} 
                               onchange="toggleUserSelection('${userId}')" style="margin-right: 8px;">
                        üë§ ${user.name} <small style="color: #666; margin-left: 5px;">(${userId.substring(0, 8)})</small>
                    </label>
                `;
                userCheckboxes.appendChild(checkboxDiv);
            });
        }
        
        // Toggle user selection
        function toggleUserSelection(userId) {
            if (selectedUsers.has(userId)) {
                selectedUsers.delete(userId);
            } else {
                selectedUsers.add(userId);
            }
        }
        
        // Select all users
        function selectAllUsers() {
            selectedUsers.clear();
            onlineUsers.forEach((user, userId) => {
                if (userId !== deviceId) {
                    selectedUsers.add(userId);
                }
            });
            updateUserCheckboxes();
        }
        
        // Deselect all users
        function deselectAllUsers() {
            selectedUsers.clear();
            updateUserCheckboxes();
        }
        
        // Show received notification
        function showNotification(data) {
            const title = data.title || "Notification";
            const message = data.message || data.body || "New notification";
            const type = data.notificationType || data.type || "info";
            const from = data.fromName ? `From: ${data.fromName}` : "";
            const isBroadcast = data.type === 'broadcast';
            
            const displayTitle = isBroadcast ? `[üì¢ Broadcast] ${title}` : title;
            
            addNotification(displayTitle, `${message} ${from}`, type);
            
            // Show browser notification
            if (Notification.permission === "granted") {
                new Notification(displayTitle, {
                    body: message,
                    icon: getNotificationIcon(type),
                    vibrate: [200, 100, 200]
                });
            }
            
            playSound("notification");
            updateStatus(`üì® ${isBroadcast ? 'Broadcast' : 'Notification'} received`, "success");
        }
        
        // Get notification icon based on type
        function getNotificationIcon(type) {
            const icons = {
                announcement: "üì¢",
                alert: "‚ö†Ô∏è",
                message: "üí¨",
                urgent: "üö®",
                info: "‚ÑπÔ∏è",
                test: "üß™"
            };
            return `https://cdn.jsdelivr.net/npm/twemoji@latest/2/svg/${icons[type] ? icons[type].codePointAt(0).toString(16) : '1f4ac'}.svg`;
        }
        
        // Add notification to list
        function addNotification(title, body, type = "info") {
            const notification = {
                id: Date.now(),
                title: title,
                body: body,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString()
            };
            
            notifications.unshift(notification);
            localStorage.setItem("notifications", JSON.stringify(notifications.slice(0, 100)));
            updateNotificationList();
        }
        
        // Update notification list UI
        function updateNotificationList() {
            const list = document.getElementById("notificationList");
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-item">
                        <div class="notification-title">No notifications yet</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = "";
            notifications.slice(0, 20).forEach(notif => {
                const item = document.createElement("div");
                item.className = `notification-item ${notif.type === 'test' ? 'new' : ''}`;
                item.innerHTML = `
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-body">${notif.body}</div>
                    <div class="notification-time">${notif.timestamp} ‚Ä¢ ${notif.date}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Update status message
        function updateStatus(message, type = "info") {
            const statusEl = document.getElementById("statusMessage");
            statusEl.innerHTML = `<div class="status-badge status-${type}">${message}</div>`;
        }
        
        // Update system status
        function updateSystemStatus() {
            const systemStatus = document.getElementById("systemStatus");
            
            systemStatus.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>Device ID:</strong> ${deviceId || "Not set"}</div>
                    <div><strong>Device Name:</strong> ${deviceName || "Not set"}</div>
                    <div><strong>Connection:</strong> ${isConnected ? "‚úÖ Connected" : "‚ùå Disconnected"}</div>
                    <div><strong>Online Users:</strong> ${onlineUsers.size}</div>
                    <div><strong>Notifications:</strong> ${notifications.length} received</div>
                    <div><strong>Server:</strong> ${WS_SERVER}</div>
                </div>
            `;
        }
        
        // Utility functions
        function switchTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabName + "Tab").classList.add("active");
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
        }
        
        function copyDeviceId() {
            navigator.clipboard.writeText(deviceId);
            updateStatus("Device ID copied to clipboard!", "success");
        }
        
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (type === "success") playBeep(audioContext, 800, 0.3);
                else if (type === "error") playBeep(audioContext, 400, 0.3);
                else if (type === "notification") {
                    playBeep(audioContext, 600, 0.2);
                    setTimeout(() => playBeep(audioContext, 800, 0.2), 100);
                }
            } catch (e) {}
        }
        
        function playBeep(audioContext, frequency, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = "sine";
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Test functions
        function testBroadcast() {
            document.getElementById("sendTitle").value = "Test Broadcast";
            document.getElementById("sendMessage").value = "This is a test broadcast to all connected devices!";
            document.getElementById("notificationType").value = "test";
            
            switchTab("send");
            
            setTimeout(() => {
                document.getElementById("broadcastBtn").click();
            }, 500);
        }
        
        function clearNotifications() {
            if (confirm("Clear all notifications?")) {
                notifications = [];
                localStorage.removeItem("notifications");
                updateNotificationList();
                updateStatus("All notifications cleared", "warning");
            }
        }
        
        function resetAll() {
            if (confirm("Reset everything? This will clear all data and restart.")) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // Initialize on load
        window.onload = function() {
            console.log("üöÄ Broadcast Notification Tester Loaded");
            
            // Request notification permission
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // Generate or load device ID and name
            deviceId = localStorage.getItem("deviceId") || generateDeviceId();
            deviceName = localStorage.getItem("deviceName") || generateDeviceName();
            localStorage.setItem("deviceId", deviceId);
            localStorage.setItem("deviceName", deviceName);
            
            // Load saved notifications
            notifications = JSON.parse(localStorage.getItem("notifications") || "[]");
            
            // Update UI
            document.getElementById("deviceId").textContent = deviceId;
            
            updateNotificationList();
            updateSystemStatus();
            
            // Auto-connect after 1 second
            setTimeout(() => {
                connectToServer();
            }, 1000);
        };
    </script>
</body>
</html>
