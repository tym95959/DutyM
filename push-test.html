<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì° P2P Broadcast Notifications</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab { flex: 1; padding: 20px; text-align: center; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { background: white; border-bottom: 3px solid #4facfe; color: #4facfe; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        .card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; margin-left: 10px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-danger { background: #f8d7da; color: #721c24; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 28px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; width: 100%; margin: 10px 0; }
        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, textarea, select { width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        textarea { min-height: 120px; resize: vertical; font-family: monospace; }
        .token-display { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; font-family: monospace; font-size: 14px; word-break: break-all; max-height: 100px; overflow-y: auto; }
        .notification-list { max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .notification-item { padding: 15px; border-radius: 10px; margin-bottom: 10px; background: #f8f9fa; border-left: 4px solid #4facfe; animation: slideIn 0.3s ease; }
        .notification-title { font-weight: 600; margin-bottom: 5px; color: #2c3e50; }
        .notification-body { color: #6c757d; margin-bottom: 5px; }
        .notification-time { font-size: 12px; color: #adb5bd; text-align: right; }
        .peer-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .peer-badge { background: #e3f2fd; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .broadcast-info { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107; }
        .qr-container { text-align: center; margin: 20px 0; }
        .qr-code { display: inline-block; padding: 20px; background: white; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 600px) { .container { border-radius: 15px; } .header { padding: 20px; } .tab-content { padding: 20px; } .btn { padding: 12px 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° P2P Broadcast Notifications</h1>
            <p>Direct device-to-device notifications - No servers needed!</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('receive')">üì≤ Receive</div>
            <div class="tab" onclick="switchTab('send')">üì§ Send</div>
            <div class="tab" onclick="switchTab('peers')">üîó Peers</div>
        </div>
        
        <!-- RECEIVE TAB -->
        <div class="tab-content active" id="receiveTab">
            <div class="card">
                <h3><span>üîî</span> Your Device Status</h3>
                <div id="statusMessage">Initializing P2P network...</div>
                
                <div class="input-group">
                    <label>Your Peer ID:</label>
                    <div class="token-display" id="peerId">Generating...</div>
                    <button class="btn copy-btn" onclick="copyPeerId()" style="width: auto; padding: 8px 15px; margin-top: 10px;">Copy Peer ID</button>
                </div>
                
                <div class="input-group">
                    <label>Connection Status:</label>
                    <div class="status-badge" id="connectionBadge">Disconnected</div>
                </div>
                
                <div class="input-group">
                    <label>Connected Peers:</label>
                    <div id="peerCount">0 peers connected</div>
                </div>
                
                <button class="btn btn-primary" onclick="startP2P()" id="startBtn">
                    <span>üîó</span> Start P2P Network
                </button>
                
                <button class="btn" onclick="generateQR()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>üîó</span> Generate Connection QR Code
                </button>
            </div>
            
            <div class="card">
                <h3><span>üì®</span> Received Notifications</h3>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item">
                        <div class="notification-title">Waiting for notifications...</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                </div>
                <button class="btn" onclick="clearNotifications()" style="background: #6c757d; color: white; margin-top: 10px;">
                    <span>üóëÔ∏è</span> Clear All Notifications
                </button>
            </div>
        </div>
        
        <!-- SEND TAB -->
        <div class="tab-content" id="sendTab">
            <div class="card">
                <h3><span>üì§</span> Send Broadcast</h3>
                
                <div class="broadcast-info">
                    <div class="notification-title">üì¢ Broadcast to All Connected Devices</div>
                    <div class="notification-body">This will send notification to ALL connected peers. Currently <span id="currentPeers">0</span> devices are connected.</div>
                </div>
                
                <div class="input-group">
                    <label>Notification Title:</label>
                    <input type="text" id="sendTitle" value="Important Broadcast" placeholder="Enter notification title">
                </div>
                
                <div class="input-group">
                    <label>Notification Message:</label>
                    <textarea id="sendMessage" placeholder="Enter notification message">This message will be sent to all connected devices instantly!</textarea>
                </div>
                
                <div class="input-group">
                    <label>Notification Type:</label>
                    <select id="notificationType">
                        <option value="announcement">üì¢ Announcement</option>
                        <option value="alert">‚ö†Ô∏è Alert</option>
                        <option value="message">üí¨ Message</option>
                        <option value="urgent">üö® Urgent</option>
                        <option value="test">üß™ Test</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="sendBroadcast()" id="broadcastBtn">
                    <span>üì¢</span> Broadcast to All Peers
                </button>
                
                <button class="btn" onclick="testBroadcast()" style="background: #17a2b8; color: white; margin-top: 10px;">
                    <span>üß™</span> Send Test Broadcast
                </button>
                
                <div id="sendResult"></div>
            </div>
            
            <div class="card">
                <h3><span>üîó</span> Connect to Peer</h3>
                <div class="input-group">
                    <label>Peer ID to Connect:</label>
                    <input type="text" id="connectPeerId" placeholder="Enter peer ID or paste connection data">
                    <button class="btn" onclick="connectToPeer()" style="background: #4facfe; color: white; margin-top: 10px;">
                        <span>üîó</span> Connect to Peer
                    </button>
                </div>
                
                <div class="input-group">
                    <label>Or Scan QR Code:</label>
                    <div id="qrCodeContainer"></div>
                    <button class="btn" onclick="scanQR()" style="background: #6c757d; color: white; margin-top: 10px;">
                        <span>üì∑</span> Scan QR Code
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PEERS TAB -->
        <div class="tab-content" id="peersTab">
            <div class="card">
                <h3><span>üîó</span> Connected Peers</h3>
                <div id="connectedPeers">
                    <p>No peers connected yet</p>
                </div>
                
                <div class="input-group">
                    <label>Your Connection Data:</label>
                    <div class="token-display" id="connectionData">Loading...</div>
                    <button class="btn copy-btn" onclick="copyConnectionData()" style="width: auto; padding: 8px 15px; margin-top: 10px;">Copy Connection Data</button>
                </div>
            </div>
            
            <div class="card">
                <h3><span>‚öôÔ∏è</span> P2P Settings</h3>
                <div class="input-group">
                    <label>Network Discovery:</label>
                    <select id="discoveryMode" onchange="changeDiscoveryMode()">
                        <option value="manual">Manual Connection</option>
                        <option value="webrtc">WebRTC Discovery</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Auto-reconnect:</label>
                    <input type="checkbox" id="autoReconnect" checked> Enable auto-reconnect
                </div>
                
                <button class="btn btn-danger" onclick="disconnectAll()">
                    <span>üîå</span> Disconnect All Peers
                </button>
            </div>
        </div>
    </div>

    <!-- QR Code library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        // P2P Notification System - No Server Required!
        // This uses BroadcastChannel, localStorage, and IndexedDB for peer-to-peer communication
        
        // Global variables
        let peerId = null;
        let peerName = null;
        let isConnected = false;
        let notifications = [];
        let connectedPeers = new Map(); // peerId -> {name, connectedAt, channel}
        let broadcastChannel = null;
        let dataChannel = null;
        let peerDiscoveryInterval = null;
        
        // Generate unique peer ID
        function generatePeerId() {
            const prefix = "peer";
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 9);
            return `${prefix}_${timestamp}_${random}`;
        }
        
        // Generate peer name
        function generatePeerName() {
            const names = ["Mobile", "Tablet", "Desktop", "Laptop", "Phone", "Browser"];
            const adjectives = ["Quick", "Smart", "Fast", "Cool", "Awesome", "Super"];
            const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomNum = Math.floor(Math.random() * 1000);
            return `${randomAdj}_${randomName}_${randomNum}`;
        }
        
        // Start P2P network
        function startP2P() {
            const startBtn = document.getElementById("startBtn");
            startBtn.disabled = true;
            startBtn.innerHTML = '<span>‚è≥</span> Starting...';
            
            updateStatus("Initializing P2P network...", "warning");
            
            try {
                // Generate peer ID if not exists
                if (!peerId) {
                    peerId = localStorage.getItem("peerId") || generatePeerId();
                    peerName = localStorage.getItem("peerName") || generatePeerName();
                    localStorage.setItem("peerId", peerId);
                    localStorage.setItem("peerName", peerName);
                }
                
                // Update UI
                document.getElementById("peerId").textContent = peerId;
                document.getElementById("connectionData").textContent = JSON.stringify({
                    peerId: peerId,
                    peerName: peerName,
                    timestamp: Date.now()
                });
                
                // Initialize BroadcastChannel for same-origin communication
                try {
                    broadcastChannel = new BroadcastChannel('p2p-notifications');
                    setupBroadcastChannel();
                } catch (e) {
                    console.log("BroadcastChannel not supported, using fallback");
                    setupLocalStorageFallback();
                }
                
                // Setup IndexedDB for cross-tab communication
                setupIndexedDB();
                
                // Setup service worker for background notifications
                setupServiceWorker();
                
                // Start peer discovery
                startPeerDiscovery();
                
                // Update status
                isConnected = true;
                document.getElementById("connectionBadge").textContent = "Connected";
                document.getElementById("connectionBadge").className = "status-badge status-success";
                
                startBtn.innerHTML = '<span>‚úÖ</span> P2P Network Active';
                startBtn.className = "btn btn-success";
                
                updateStatus("‚úÖ P2P network active! You can now send/receive notifications.", "success");
                playSound("success");
                
                // Load existing notifications
                loadNotifications();
                
                // Try to discover peers
                discoverPeers();
                
            } catch (error) {
                console.error("‚ùå P2P init error:", error);
                updateStatus(`P2P error: ${error.message}`, "danger");
                startBtn.disabled = false;
                startBtn.innerHTML = '<span>üîó</span> Start P2P Network';
                playSound("error");
            }
        }
        
        // Setup BroadcastChannel
        function setupBroadcastChannel() {
            broadcastChannel.onmessage = (event) => {
                handleP2PMessage(event.data);
            };
            
            // Send hello message
            broadcastChannel.postMessage({
                type: 'hello',
                peerId: peerId,
                peerName: peerName,
                timestamp: Date.now()
            });
        }
        
        // Fallback using localStorage events
        function setupLocalStorageFallback() {
            window.addEventListener('storage', (event) => {
                if (event.key === 'p2p_message') {
                    try {
                        const message = JSON.parse(event.newValue);
                        if (message && message.peerId !== peerId) {
                            handleP2PMessage(message);
                        }
                    } catch (e) {
                        console.error("Error parsing localStorage message:", e);
                    }
                }
            });
        }
        
        // Setup IndexedDB for reliable messaging
        function setupIndexedDB() {
            const request = indexedDB.open('P2PNotifications', 1);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('messages')) {
                    db.createObjectStore('messages', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('peers')) {
                    db.createObjectStore('peers', { keyPath: 'peerId' });
                }
            };
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                setInterval(() => checkForMessages(db), 2000);
            };
        }
        
        // Check for new messages in IndexedDB
        function checkForMessages(db) {
            const transaction = db.transaction(['messages'], 'readonly');
            const store = transaction.objectStore('messages');
            const request = store.getAll();
            
            request.onsuccess = (event) => {
                const messages = event.target.result;
                messages.forEach(message => {
                    if (message.to === peerId || message.type === 'broadcast') {
                        handleP2PMessage(message);
                        // Remove processed message
                        const deleteTransaction = db.transaction(['messages'], 'readwrite');
                        const deleteStore = deleteTransaction.objectStore('messages');
                        deleteStore.delete(message.id);
                    }
                });
            };
        }
        
        // Setup service worker for background notifications
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/p2p-sw.js').catch(console.error);
                
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'NOTIFICATION_CLICKED') {
                        // Handle notification click
                        switchTab('receive');
                    }
                });
            }
        }
        
        // Start peer discovery
        function startPeerDiscovery() {
            if (peerDiscoveryInterval) {
                clearInterval(peerDiscoveryInterval);
            }
            
            peerDiscoveryInterval = setInterval(() => {
                discoverPeers();
                pingPeers();
            }, 5000); // Discover every 5 seconds
        }
        
        // Discover peers
        function discoverPeers() {
            // Send discovery message
            sendP2PMessage({
                type: 'discovery',
                peerId: peerId,
                peerName: peerName,
                timestamp: Date.now()
            }, 'broadcast');
            
            // Check for existing peers in localStorage
            const storedPeers = JSON.parse(localStorage.getItem('knownPeers') || '{}');
            Object.keys(storedPeers).forEach(storedPeerId => {
                if (storedPeerId !== peerId && !connectedPeers.has(storedPeerId)) {
                    connectToPeer(storedPeerId);
                }
            });
        }
        
        // Ping connected peers
        function pingPeers() {
            connectedPeers.forEach((peer, peerId) => {
                sendP2PMessage({
                    type: 'ping',
                    peerId: peerId,
                    timestamp: Date.now()
                }, peerId);
                
                // Check if peer is still alive (last seen > 30 seconds ago)
                if (Date.now() - peer.lastSeen > 30000) {
                    connectedPeers.delete(peerId);
                    updatePeerList();
                    addNotification("Peer Disconnected", `${peer.name} disconnected due to timeout`, "warning");
                }
            });
        }
        
        // Handle P2P messages
        function handleP2PMessage(data) {
            console.log("üì® Received P2P message:", data);
            
            switch(data.type) {
                case 'hello':
                case 'discovery':
                    if (data.peerId !== peerId && !connectedPeers.has(data.peerId)) {
                        // New peer discovered
                        connectedPeers.set(data.peerId, {
                            name: data.peerName,
                            connectedAt: Date.now(),
                            lastSeen: Date.now()
                        });
                        
                        updatePeerList();
                        
                        // Send welcome response
                        sendP2PMessage({
                            type: 'welcome',
                            peerId: peerId,
                            peerName: peerName,
                            timestamp: Date.now()
                        }, data.peerId);
                        
                        addNotification("Peer Connected", `${data.peerName} connected`, "info");
                    }
                    break;
                    
                case 'welcome':
                    if (data.peerId !== peerId && !connectedPeers.has(data.peerId)) {
                        connectedPeers.set(data.peerId, {
                            name: data.peerName,
                            connectedAt: Date.now(),
                            lastSeen: Date.now()
                        });
                        updatePeerList();
                    }
                    break;
                    
                case 'notification':
                case 'broadcast':
                    showNotification(data);
                    break;
                    
                case 'ping':
                    sendP2PMessage({
                        type: 'pong',
                        peerId: peerId,
                        timestamp: Date.now()
                    }, data.peerId);
                    break;
                    
                case 'pong':
                    const peer = connectedPeers.get(data.peerId);
                    if (peer) {
                        peer.lastSeen = Date.now();
                    }
                    break;
            }
        }
        
        // Send P2P message
        function sendP2PMessage(message, to = 'broadcast') {
            message.from = peerId;
            message.fromName = peerName;
            message.timestamp = Date.now();
            
            if (to === 'broadcast') {
                // Broadcast to all connected peers
                connectedPeers.forEach((peer, peerId) => {
                    sendToPeer(peerId, message);
                });
                
                // Also broadcast via BroadcastChannel
                if (broadcastChannel) {
                    broadcastChannel.postMessage(message);
                }
                
                // Store in localStorage for cross-tab
                localStorage.setItem('p2p_message', JSON.stringify(message));
                setTimeout(() => {
                    localStorage.removeItem('p2p_message');
                }, 100);
                
            } else {
                // Send to specific peer
                sendToPeer(to, message);
            }
        }
        
        // Send to specific peer
        function sendToPeer(peerId, message) {
            // Store message in IndexedDB for the peer to pick up
            const dbRequest = indexedDB.open('P2PNotifications', 1);
            
            dbRequest.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['messages'], 'readwrite');
                const store = transaction.objectStore('messages');
                
                const messageWithId = {
                    ...message,
                    id: `${peerId}_${Date.now()}_${Math.random()}`,
                    to: peerId
                };
                
                store.add(messageWithId);
            };
        }
        
        // Send broadcast to ALL peers
        function sendBroadcast() {
            const broadcastBtn = document.getElementById("broadcastBtn");
            const sendResult = document.getElementById("sendResult");
            
            broadcastBtn.disabled = true;
            broadcastBtn.innerHTML = '<span>‚è≥</span> Broadcasting...';
            sendResult.innerHTML = "";
            
            try {
                if (!isConnected) {
                    throw new Error("P2P network not active. Start network first.");
                }
                
                const title = document.getElementById("sendTitle").value.trim();
                const message = document.getElementById("sendMessage").value.trim();
                const type = document.getElementById("notificationType").value;
                
                if (!title) throw new Error("Please enter a title");
                if (!message) throw new Error("Please enter a message");
                
                // Create broadcast message
                const broadcast = {
                    type: 'broadcast',
                    title: title,
                    message: message,
                    notificationType: type
                };
                
                console.log("Sending broadcast:", broadcast);
                
                // Send to all peers
                sendP2PMessage(broadcast, 'broadcast');
                
                // Show success
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #d4edda; border-left-color: #28a745;">
                        <div class="notification-title">üì¢ Broadcast Sent!</div>
                        <div class="notification-body">${title}: ${message}</div>
                        <div class="notification-body">Sent to ${connectedPeers.size} connected peers</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`üì¢ Broadcast sent to ${connectedPeers.size} peers`, "success");
                playSound("success");
                
                // Also show locally
                addNotification(`[Broadcast] ${title}`, message, type);
                
                // Show browser notification
                if (Notification.permission === "granted") {
                    new Notification(`üì¢ ${title}`, {
                        body: message,
                        icon: getNotificationIcon(type),
                        vibrate: [200, 100, 200]
                    });
                }
                
            } catch (error) {
                console.error("‚ùå Broadcast error:", error);
                
                sendResult.innerHTML = `
                    <div class="notification-item" style="background: #f8d7da; border-left-color: #dc3545;">
                        <div class="notification-title">‚ùå Broadcast Failed</div>
                        <div class="notification-body">${error.message}</div>
                        <div class="notification-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                updateStatus(`‚ùå Broadcast failed: ${error.message}`, "danger");
                playSound("error");
            } finally {
                broadcastBtn.disabled = false;
                broadcastBtn.innerHTML = '<span>üì¢</span> Broadcast to All Peers';
            }
        }
        
        // Connect to specific peer
        function connectToPeer() {
            const peerInput = document.getElementById("connectPeerId").value.trim();
            if (!peerInput) {
                alert("Please enter a peer ID");
                return;
            }
            
            try {
                let peerData;
                try {
                    peerData = JSON.parse(peerInput);
                } catch (e) {
                    peerData = { peerId: peerInput };
                }
                
                if (!peerData.peerId) {
                    throw new Error("Invalid peer data");
                }
                
                // Add to known peers
                const knownPeers = JSON.parse(localStorage.getItem('knownPeers') || '{}');
                knownPeers[peerData.peerId] = {
                    name: peerData.peerName || 'Unknown',
                    lastConnected: Date.now()
                };
                localStorage.setItem('knownPeers', JSON.stringify(knownPeers));
                
                // Send discovery message
                sendP2PMessage({
                    type: 'discovery',
                    peerId: peerId,
                    peerName: peerName
                }, peerData.peerId);
                
                updateStatus(`Attempting to connect to ${peerData.peerId}`, "warning");
                
                // Clear input
                document.getElementById("connectPeerId").value = "";
                
            } catch (error) {
                alert(`Connection error: ${error.message}`);
            }
        }
        
        // Update peer list
        function updatePeerList() {
            const peerCount = document.getElementById("peerCount");
            const currentPeers = document.getElementById("currentPeers");
            const connectedPeersDiv = document.getElementById("connectedPeers");
            
            peerCount.textContent = `${connectedPeers.size} peer${connectedPeers.size !== 1 ? 's' : ''} connected`;
            currentPeers.textContent = connectedPeers.size;
            
            connectedPeersDiv.innerHTML = "";
            
            if (connectedPeers.size === 0) {
                connectedPeersDiv.innerHTML = "<p>No peers connected yet</p>";
                return;
            }
            
            connectedPeers.forEach((peer, peerId) => {
                const peerDiv = document.createElement("div");
                peerDiv.className = "notification-item";
                peerDiv.innerHTML = `
                    <div class="notification-title">üë§ ${peer.name}</div>
                    <div class="notification-body">ID: ${peerId.substring(0, 12)}...</div>
                    <div class="notification-time">Connected: ${new Date(peer.connectedAt).toLocaleTimeString()}</div>
                `;
                connectedPeersDiv.appendChild(peerDiv);
            });
        }
        
        // Show received notification
        function showNotification(data) {
            const title = data.title || "Notification";
            const message = data.message || data.body || "New notification";
            const type = data.notificationType || data.type || "info";
            const from = data.fromName ? `From: ${data.fromName}` : "";
            const isBroadcast = data.type === 'broadcast';
            
            const displayTitle = isBroadcast ? `[üì¢ Broadcast] ${title}` : title;
            
            addNotification(displayTitle, `${message} ${from}`, type);
            
            // Show browser notification
            if (Notification.permission === "granted") {
                new Notification(displayTitle, {
                    body: message,
                    icon: getNotificationIcon(type),
                    vibrate: [200, 100, 200]
                });
            }
            
            playSound("notification");
            updateStatus(`${isBroadcast ? 'üì¢ Broadcast' : 'üì® Notification'} received`, "success");
        }
        
        // Get notification icon
        function getNotificationIcon(type) {
            const icons = {
                announcement: "üì¢",
                alert: "‚ö†Ô∏è",
                message: "üí¨",
                urgent: "üö®",
                info: "‚ÑπÔ∏è",
                test: "üß™"
            };
            return icons[type] || "üì¢";
        }
        
        // Add notification to list
        function addNotification(title, body, type = "info") {
            const notification = {
                id: Date.now(),
                title: title,
                body: body,
                type: type,
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString()
            };
            
            notifications.unshift(notification);
            localStorage.setItem("notifications", JSON.stringify(notifications.slice(0, 100)));
            updateNotificationList();
        }
        
        // Update notification list
        function updateNotificationList() {
            const list = document.getElementById("notificationList");
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-item">
                        <div class="notification-title">No notifications yet</div>
                        <div class="notification-body">Notifications will appear here when you receive them</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = "";
            notifications.slice(0, 20).forEach(notif => {
                const item = document.createElement("div");
                item.className = `notification-item ${notif.type === 'test' ? 'new' : ''}`;
                item.innerHTML = `
                    <div class="notification-title">${notif.title}</div>
                    <div class="notification-body">${notif.body}</div>
                    <div class="notification-time">${notif.timestamp} ‚Ä¢ ${notif.date}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Load notifications
        function loadNotifications() {
            notifications = JSON.parse(localStorage.getItem("notifications") || "[]");
            updateNotificationList();
        }
        
        // Generate QR code for connection
        function generateQR() {
            const qrContainer = document.getElementById("qrCodeContainer");
            qrContainer.innerHTML = "";
            
            const connectionData = {
                peerId: peerId,
                peerName: peerName,
                type: "p2p_connection",
                timestamp: Date.now(),
                url: window.location.href
            };
            
            const qr = new QRCode(qrContainer, {
                text: JSON.stringify(connectionData),
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // Scan QR code (simulated)
        function scanQR() {
            alert("On a real device, this would open the camera to scan a QR code.\n\nFor now, you can manually enter the peer ID or connection data.");
        }
        
        // Update status
        function updateStatus(message, type = "info") {
            const statusEl = document.getElementById("statusMessage");
            statusEl.innerHTML = `<div class="status-badge status-${type}">${message}</div>`;
        }
        
        // Disconnect all peers
        function disconnectAll() {
            if (confirm("Disconnect from all peers?")) {
                connectedPeers.clear();
                updatePeerList();
                
                if (broadcastChannel) {
                    broadcastChannel.close();
                    broadcastChannel = null;
                }
                
                if (peerDiscoveryInterval) {
                    clearInterval(peerDiscoveryInterval);
                    peerDiscoveryInterval = null;
                }
                
                isConnected = false;
                document.getElementById("connectionBadge").textContent = "Disconnected";
                document.getElementById("connectionBadge").className = "status-badge status-danger";
                
                document.getElementById("startBtn").innerHTML = '<span>üîó</span> Start P2P Network';
                document.getElementById("startBtn").className = "btn btn-primary";
                document.getElementById("startBtn").disabled = false;
                
                updateStatus("Disconnected from all peers", "warning");
                playSound("error");
                
                // Remove known peers
                localStorage.removeItem('knownPeers');
            }
        }
        
        // Utility functions
        function switchTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabName + "Tab").classList.add("active");
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
        }
        
        function copyPeerId() {
            navigator.clipboard.writeText(peerId);
            updateStatus("Peer ID copied to clipboard!", "success");
        }
        
        function copyConnectionData() {
            const connectionData = JSON.stringify({
                peerId: peerId,
                peerName: peerName,
                timestamp: Date.now()
            });
            navigator.clipboard.writeText(connectionData);
            updateStatus("Connection data copied!", "success");
        }
        
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (type === "success") playBeep(audioContext, 800, 0.3);
                else if (type === "error") playBeep(audioContext, 400, 0.3);
                else if (type === "notification") {
                    playBeep(audioContext, 600, 0.2);
                    setTimeout(() => playBeep(audioContext, 800, 0.2), 100);
                }
            } catch (e) {}
        }
        
        function playBeep(audioContext, frequency, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = "sine";
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        // Test functions
        function testBroadcast() {
            document.getElementById("sendTitle").value = "Test Broadcast";
            document.getElementById("sendMessage").value = "This is a test broadcast from P2P Notification System! Current time: " + new Date().toLocaleTimeString();
            document.getElementById("notificationType").value = "test";
            
            switchTab("send");
            
            setTimeout(() => {
                document.getElementById("broadcastBtn").click();
            }, 500);
        }
        
        function clearNotifications() {
            if (confirm("Clear all notifications?")) {
                notifications = [];
                localStorage.removeItem("notifications");
                updateNotificationList();
                updateStatus("All notifications cleared", "warning");
            }
        }
        
        function changeDiscoveryMode() {
            const mode = document.getElementById("discoveryMode").value;
            updateStatus(`Discovery mode changed to: ${mode}`, "info");
        }
        
        // Initialize on page load
        window.onload = function() {
            // Request notification permission
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // Load existing peer ID if exists
            const savedPeerId = localStorage.getItem("peerId");
            const savedPeerName = localStorage.getItem("peerName");
            
            if (savedPeerId) {
                peerId = savedPeerId;
                peerName = savedPeerName;
                document.getElementById("peerId").textContent = peerId;
                document.getElementById("connectionData").textContent = JSON.stringify({
                    peerId: peerId,
                    peerName: peerName,
                    timestamp: Date.now()
                });
                updateStatus("Ready to connect. Click 'Start P2P Network' to begin.", "info");
            } else {
                // Generate new peer ID
                peerId = generatePeerId();
                peerName = generatePeerName();
                localStorage.setItem("peerId", peerId);
                localStorage.setItem("peerName", peerName);
                document.getElementById("peerId").textContent = peerId;
                document.getElementById("connectionData").textContent = JSON.stringify({
                    peerId: peerId,
                    peerName: peerName,
                    timestamp: Date.now()
                });
                updateStatus("New peer generated. Click 'Start P2P Network' to begin.", "info");
            }
            
            // Load notifications
            loadNotifications();
            
            // Set up periodic status updates
            setInterval(() => {
                if (isConnected) {
                    document.getElementById("peerCount").textContent = 
                        `${connectedPeers.size} peer${connectedPeers.size !== 1 ? 's' : ''} connected`;
                }
            }, 1000);
        };
    </script>
</body>
</html>
